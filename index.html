<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#ffffff">
<link rel="manifest" href="manifest.json">
<title>PhysioFlow</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f4f2ed;--bg2:#e6e2d6;--surface:#ffffff;--surface2:#f7f6f3;
  --text:#111122;--text2:#555566;--text3:#888899;
  --accent:#206b5e;--accent2:#3bb5a0;--accentbg:rgba(32,107,94,.08);
  --border:#ccc6bc;--border2:#e0ded8;
  --shadow:0 4px 12px rgba(0,0,0,.08);--shadowlg:0 8px 30px rgba(0,0,0,.15);
  --radius:8px;--radiuslg:16px;--radiusxl:24px;
  --c0:#3b72b8;--c0bg:#e3ecf6;--c0t:#162e4a;
  --c1:#d66a2a;--c1bg:#fce8d8;--c1t:#572608;
  --c2:#6d4cbd;--c2bg:#ece4f8;--c2t:#301860;
  --c3:#b83a5a;--c3bg:#fce0e8;--c3t:#5c0820;
  --c4:#2e9e4d;--c4bg:#d8f2e0;--c4t:#0b471d;
  --c5:#b89520;--c5bg:#f8f2d8;--c5t:#4d3d05;
  --absence:#455a64;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;outline:none}
html,body{height:100%;font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);overflow:hidden;-webkit-tap-highlight-color:transparent;font-size:14px}
button{font-family:inherit;cursor:pointer;border:none;background:none;color:inherit;font-size:inherit;user-select:none}
input,select,textarea{font-family:inherit;color:var(--text);font-size:14px;background:var(--surface)}
::-webkit-scrollbar{width:4px;height:4px}::-webkit-scrollbar-thumb{background:#bdc3c7;border-radius:4px}

#app{display:flex;flex-direction:column;height:100dvh;height:100vh;overflow:hidden}
.hdr{background:var(--surface);border-bottom:1px solid var(--border);padding:10px 16px;display:flex;align-items:center;gap:12px;flex-shrink:0;z-index:100}
.logo{font-family:'JetBrains Mono',monospace;font-weight:700;font-size:17px;color:var(--accent);letter-spacing:-.5px}
.logo b{color:var(--text)}
.hdr-c{flex:1;display:flex;align-items:center;justify-content:center;gap:8px}
.hdr-c span{font-weight:700;font-size:15px;min-width:130px;text-align:center;text-transform:capitalize}
.nb{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:var(--surface2);color:var(--text);font-weight:700;border:1px solid var(--border2)}
.nb:active{background:var(--border2)}
.ha{display:flex;gap:8px}
.ib{width:36px;height:36px;border-radius:var(--radius);display:flex;align-items:center;justify-content:center;background:var(--surface2);color:var(--text2);font-size:18px;border:1px solid transparent}
.ib:active{background:var(--border2)}
.ib.on{background:var(--accent);color:#fff;border-color:var(--accent)}

.wbar{display:flex;background:var(--surface);border-bottom:1px solid var(--border);flex-shrink:0;padding:0 4px}
.wd{flex:1;text-align:center;padding:8px 2px 10px;cursor:pointer;position:relative;border-radius:4px}
.wd:active{background:var(--bg2)}
.wd.act .wn{background:var(--accent);color:#fff;box-shadow:0 2px 8px rgba(32,107,94,0.3)}
.wd.act .wl{color:var(--accent);font-weight:700}
.wd.dis{opacity:.4}
.wd .wl{font-size:11px;font-weight:600;color:var(--text3);text-transform:uppercase;margin-bottom:2px}
.wd .wn{font-size:15px;font-weight:700;width:30px;height:30px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;transition:0.2s}
.wd.today::after{content:'';position:absolute;bottom:4px;left:50%;transform:translateX(-50%);width:4px;height:4px;background:var(--c1);border-radius:50%}

.pw{flex:1;overflow-y:auto;overflow-x:hidden;background:var(--surface2);position:relative}
.pg{position:relative;background:var(--surface2)}
.tc{position:absolute;left:0;top:0;bottom:0;width:50px;z-index:2;pointer-events:none;background:var(--surface2);border-right:1px solid var(--border2)}
.tl{position:absolute;left:0;width:50px;text-align:right;padding-right:8px;font-size:11px;font-weight:600;color:var(--text2);font-family:'JetBrains Mono',monospace;transform:translateY(-50%)}
.gl-w{position:absolute;left:50px;right:0;top:0;bottom:0}
.gl{position:absolute;left:0;right:0;height:1px;background:var(--border2)}
.gl.h{opacity:.6}.gl.q{opacity:.3;border-bottom:1px dashed var(--border2);background:none}
.sa{position:absolute;left:51px;right:4px;top:0;bottom:0}
.op{position:absolute;left:0;right:0;background:#ffffff;border:1px solid var(--border2);border-width:0 1px;z-index:1}

.nl{position:absolute;left:0;right:0;height:2px;background:#e74c3c;z-index:8;pointer-events:none}
.nl::before{content:'';position:absolute;left:-5px;top:-3px;width:8px;height:8px;background:#e74c3c;border-radius:50%}

.ap{position:absolute;border-radius:6px;padding:3px 6px;overflow:hidden;cursor:pointer;border-left:4px solid;font-size:11px;line-height:1.25;display:flex;flex-direction:column;z-index:5;box-shadow:0 2px 4px rgba(0,0,0,0.05);transition:transform 0.1s}
.ap:active{transform:scale(0.98)}
.ap .an{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:flex;align-items:center;gap:4px;color:var(--text)}
.ap .am{font-size:10px;opacity:.85;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:1px}
.ap .at{font-size:9px;opacity:.7;font-family:'JetBrains Mono',monospace;margin-top:auto}
.ap.cncl{opacity:.6;background:#eee!important;border-color:#999!important;color:#777!important}
.ap.cncl .an{text-decoration:line-through}
.ap.abs{background:var(--absence)!important;border-left-color:#263238!important;color:#fff;opacity:.9}
.ap.abs .an{color:#fff}
.bo{color:var(--c1);font-size:12px}.bm{color:var(--c3);font-size:12px}

/* Classes dynamiques pour les couleurs */
.mc0{background:var(--c0bg);border-left-color:var(--c0);color:var(--c0t)}
.mc1{background:var(--c1bg);border-left-color:var(--c1);color:var(--c1t)}
.mc2{background:var(--c2bg);border-left-color:var(--c2);color:var(--c2t)}
.mc3{background:var(--c3bg);border-left-color:var(--c3);color:var(--c3t)}
.mc4{background:var(--c4bg);border-left-color:var(--c4);color:var(--c4t)}
.mc5{background:var(--c5bg);border-left-color:var(--c5);color:var(--c5t)}

.lv{flex:1;overflow-y:auto;padding:12px;display:none}
.lv.on{display:block}
.pw.off{display:none}
.li{display:flex;align-items:center;gap:12px;padding:12px 14px;background:var(--surface);border-radius:var(--radius);margin-bottom:8px;border-left:4px solid var(--border);cursor:pointer;box-shadow:var(--shadow)}
.li:active{transform:scale(0.99)}
.li .lt{font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:600;color:var(--text2);min-width:48px}
.li .lb{flex:1;min-width:0}
.li .ln{font-weight:700;font-size:14px;display:flex;align-items:center;gap:4px}
.li .lm{font-size:12px;color:var(--text2);margin-top:2px}

.plw{flex:1;overflow-y:auto;padding:12px;display:none}
.plw.on{display:block}
.pls{margin-bottom:12px;position:sticky;top:0;z-index:10;background:var(--bg);padding-bottom:8px}
.pls input{width:100%;padding:10px 12px 10px 36px;border:1px solid var(--border);border-radius:var(--radius);font-size:14px;box-shadow:var(--shadow)}
.pls::before{content:'üîç';position:absolute;left:12px;top:19px;transform:translateY(-50%);font-size:14px;pointer-events:none;opacity:0.5}
.pi{display:flex;align-items:center;gap:12px;padding:12px;background:var(--surface);border-radius:var(--radius);margin-bottom:6px;cursor:pointer;border-bottom:1px solid var(--border2)}
.pi:active{background:var(--surface2)}
.pi .pa{width:40px;height:40px;border-radius:50%;background:var(--accentbg);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--accent);font-size:14px;flex-shrink:0}
.pi .pn{font-weight:700;font-size:14px;margin-bottom:2px}
.pi .pd{font-size:12px;color:var(--text2)}

.fab{position:fixed;bottom:24px;right:20px;width:56px;height:56px;border-radius:50%;background:var(--text);color:#fff;font-size:28px;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 24px rgba(0,0,0,.25);z-index:90;transition:transform 0.1s}
.fab:active{transform:scale(0.9)}

.mo{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(2px);z-index:200;display:flex;align-items:flex-end;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s}
.mo.open{opacity:1;pointer-events:all}
.mop{background:var(--surface);border-radius:var(--radiusxl) var(--radiusxl) 0 0;width:100%;max-width:500px;max-height:90vh;overflow-y:auto;transform:translateY(100%);transition:transform .3s cubic-bezier(.2,.8,.2,1);padding:0 20px 30px;position:relative}
.mo.open .mop{transform:translateY(0)}
.moh{width:40px;height:5px;background:var(--border);border-radius:4px;margin:12px auto 20px}
.mop h2{font-size:18px;font-weight:700;margin-bottom:16px;color:var(--text)}
.mop h3{font-size:13px;font-weight:700;margin:16px 0 8px;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px}

.fg{margin-bottom:14px}
.fg label{display:block;font-size:12px;font-weight:700;color:var(--text2);margin-bottom:4px}
.fg input,.fg select,.fg textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:var(--radius);font-size:15px;background:var(--surface2)}
.fg input:focus{border-color:var(--accent);background:#fff;box-shadow:0 0 0 2px var(--accentbg)}
.fr{display:flex;gap:10px}
.fr .fg{flex:1}

.btn{padding:12px 16px;border-radius:var(--radius);font-size:14px;font-weight:600;display:inline-flex;align-items:center;justify-content:center;gap:6px;transition:0.1s}
.btn:active{transform:scale(0.98)}
.bp{background:var(--accent);color:#fff;box-shadow:0 4px 12px rgba(32,107,94,0.25)}
.bd{background:#e74c3c;color:#fff}
.bs{background:var(--surface);border:1px solid var(--border);color:var(--text)}
.bw{width:100%}
.br{display:flex;gap:8px;margin-top:20px}
.br .btn{flex:1}

.chips{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px}
.chip{padding:6px 12px;border-radius:20px;font-size:12px;font-weight:600;cursor:pointer;border:2px solid transparent;transition:0.1s}
.chip.sel{border-color:var(--text);transform:scale(1.05);box-shadow:0 2px 8px rgba(0,0,0,0.1)}

.acw{position:relative}
.acl{position:absolute;top:100%;left:0;right:0;background:var(--surface);border:1px solid var(--border);border-radius:0 0 var(--radius) var(--radius);max-height:200px;overflow-y:auto;z-index:20;display:none;box-shadow:var(--shadowlg)}
.acl.open{display:block}
.aci{padding:10px 12px;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border2)}
.aci:active{background:var(--bg)}
.aci .acs{font-size:12px;color:var(--text3)}
.acn{color:var(--accent);font-weight:700;justify-content:center;background:var(--accentbg)}

.ctx{position:fixed;background:var(--surface);border-radius:var(--radiuslg);box-shadow:var(--shadowlg);z-index:300;min-width:180px;padding:6px;opacity:0;pointer-events:none;transform:scale(0.95);transition:.1s}
.ctx.open{opacity:1;pointer-events:all;transform:scale(1)}
.ci{padding:10px 14px;border-radius:var(--radius);font-size:13px;font-weight:600;display:flex;align-items:center;gap:10px;cursor:pointer;color:var(--text2)}
.ci:active{background:var(--bg)}
.ci.dng{color:#e74c3c}

.toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--text);color:#fff;padding:10px 20px;border-radius:30px;font-size:13px;font-weight:600;z-index:400;opacity:0;transition:.25s;pointer-events:none;white-space:nowrap;box-shadow:var(--shadowlg)}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

@media(min-width:600px){.mop{border-radius:var(--radiusxl);margin-bottom:auto;max-height:85vh;top:50%;transform:translateY(-50%)!important}}
</style>
</head>
<body>
<div id="app">
  <div class="hdr">
    <div class="logo"><b>Physio</b>Flow</div>
    <div class="hdr-c"><button class="nb" onclick="navW(-1)">‚Äπ</button><span id="hd"></span><button class="nb" onclick="navW(1)">‚Ä∫</button></div>
    <div class="ha">
      <button class="ib" id="bL" onclick="togV('list')" title="Liste">‚ò∞</button>
      <button class="ib" id="bP" onclick="togV('patients')" title="Patients">üë•</button>
      <button class="ib" onclick="openSet()" title="Param√®tres">‚öô</button>
    </div>
  </div>
  <div class="wbar" id="wb"></div>
  <div class="pw" id="pw"><div class="pg" id="pg"><div class="tc" id="tc"></div><div class="gl-w" id="glw"></div><div class="sa" id="sa"></div></div></div>
  <div class="lv" id="lv"></div>
  <div class="plw" id="plw"></div>
  <button class="fab" onclick="newAp()">+</button>
</div>

<div class="toast" id="tst"></div>
<div class="ctx" id="ctx"></div>

<div class="mo" id="mA"><div class="mop"><div class="moh"></div><h2 id="mAT"></h2><div id="mAB"></div></div></div>
<div class="mo" id="mS"><div class="mop"><div class="moh"></div><h2>‚öô Param√®tres</h2><div id="mSB"></div></div></div>
<div class="mo" id="mP"><div class="mop"><div class="moh"></div><h2 id="mPT"></h2><div id="mPB"></div></div></div>
<div class="mo" id="mH"><div class="mop"><div class="moh"></div><h2 id="mHT"></h2><div id="mHB"></div></div></div>
<div class="mo" id="mM"><div class="mop"><div class="moh"></div><h2 id="mMT"></h2><div id="mMB"></div></div></div>
<div class="mo" id="mR"><div class="mop"><div class="moh"></div><h2>üîÅ R√©currence</h2><div id="mRB"></div></div></div>

<script>
/* ‚ïê‚ïê‚ïê 1. CONSTANTS & UTILS ‚ïê‚ïê‚ïê */
const SK='physioflow_v4'; // Nouvelle version stockage
const CL=[
  {css:'mc0',bg:'var(--c0bg)',bd:'var(--c0)',lb:'Bleu'},
  {css:'mc1',bg:'var(--c1bg)',bd:'var(--c1)',lb:'Orange'},
  {css:'mc2',bg:'var(--c2bg)',bd:'var(--c2)',lb:'Violet'},
  {css:'mc3',bg:'var(--c3bg)',bd:'var(--c3)',lb:'Rose'},
  {css:'mc4',bg:'var(--c4bg)',bd:'var(--c4)',lb:'Vert'},
  {css:'mc5',bg:'var(--c5bg)',bd:'var(--c5)',lb:'Jaune'}
];

// Helper Date Local (Fix Timezone issues)
const fmtDateLocal=d=>{
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,'0');
  const day=String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
};
const dk=d=>fmtDateLocal(d);
const t2m=t=>{if(!t)return 0;const p=t.split(':').map(Number);return p[0]*60+(p[1]||0)};
const m2t=m=>String(Math.floor(m/60)).padStart(2,'0')+':'+String(m%60).padStart(2,'0');
const uid=()=>Date.now().toString(36)+Math.random().toString(36).slice(2);
const esc=s=>(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
const same=(a,b)=>a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate();
const calcAge=dob=>{if(!dob)return'';const b=new Date(dob);const n=new Date();let a=n.getFullYear()-b.getFullYear();if(n.getMonth()<b.getMonth()||(n.getMonth()===b.getMonth()&&n.getDate()<b.getDate()))a--;return a};
const alrt=p=>{if(!p)return'';let h='';if(p.needOrdo)h+=' <span class="bo" title="Ordonnance">‚ùó</span>';if(p.needMut)h+=' <span class="bm" title="Mutuelle">‚ÄºÔ∏è</span>';return h};
const ini=p=>((p.lastName||'?')[0]+(p.firstName||'')[0]).toUpperCase();

/* ‚ïê‚ïê‚ïê 2. DATA ‚ïê‚ïê‚ïê */
function defD(){return{
  motifs:[
    {id:'reeduc',label:'R√©√©ducation',duration:30,ci:0},
    {id:'balneo',label:'Baln√©oth√©rapie',duration:45,ci:1},
    {id:'domicile',label:'Domicile',duration:30,ci:2},
    {id:'massage',label:'Massage',duration:20,ci:3}
  ],
  openings:[
    {day:1,start:'08:00',end:'12:00'},{day:1,start:'13:00',end:'19:00'},
    {day:4,start:'08:00',end:'12:00'},{day:4,start:'13:00',end:'19:00'}
  ],
  appointments:[],patients:[],startH:8,endH:20
}}

let D;
try{
  const r=localStorage.getItem(SK);
  D=r?JSON.parse(r):defD();
  if(!D.patients)D.patients=[];
  if(!D.motifs)D.motifs=defD().motifs;
  // Migration s√©curit√©
  D.motifs.forEach((m,i)=>{if(m.ci===undefined)m.ci=i%6});
}catch(e){D=defD()}
function sv(){localStorage.setItem(SK,JSON.stringify(D))}
const gp=id=>D.patients.find(p=>p.id===id);
const gm=id=>D.motifs.find(m=>m.id===id);

/* ‚ïê‚ïê‚ïê 3. STATE & NAVIGATION ‚ïê‚ïê‚ïê */
let cD=new Date(); // Current Date
let vM='grid'; // View Mode
let selId=null; // Selected Item ID

// Navigation Initiale: Si on est le WE, aller au Lundi
if(cD.getDay()===0) cD.setDate(cD.getDate()+1);
if(cD.getDay()===6) cD.setDate(cD.getDate()+2);

function R(){
  rWB();
  document.getElementById('pw').classList.toggle('off',vM!=='grid');
  document.getElementById('lv').classList.toggle('on',vM==='list');
  document.getElementById('plw').classList.toggle('on',vM==='patients');
  document.getElementById('bL').classList.toggle('on',vM==='list');
  document.getElementById('bP').classList.toggle('on',vM==='patients');
  
  if(vM==='grid'){ rGrid(); rAps(); }
  else if(vM==='list') rList();
  else if(vM==='patients') rPats();
}

/* ‚ïê‚ïê‚ïê 4. RENDER COMPONENTS ‚ïê‚ïê‚ïê */

/* Header & Week Bar */
function rWB(){
  const d=new Date(cD);
  // Trouver le lundi de la semaine affich√©e
  const day = d.getDay(), diff = d.getDate() - day + (day == 0 ? -6:1);
  const mon = new Date(d.setDate(diff));
  
  const today=new Date();
  const L=['L','M','M','J','V','S','D'];
  let h='';
  for(let i=0;i<6;i++){ // Lundi au Samedi
    const curr=new Date(mon); curr.setDate(mon.getDate()+i);
    const k=dk(curr);
    const isToday=same(curr,today);
    const isSel=same(curr,cD);
    const w=curr.getDay();
    // On garde la logique user: 1=Lun, 4=Jeu comme jours principaux, mais on laisse cliquer les autres
    const isMain=(w===1||w===4);
    
    h+=`<div class="wd${isSel?' act':''}${isMain?'':' dis'}${isToday?' today':''}" onclick="selD('${k}')">
        <div class="wl">${L[i]}</div><div class="wn">${curr.getDate()}</div>
        </div>`;
  }
  document.getElementById('wb').innerHTML=h;
  // Format Header Date
  const opt={weekday:'long',day:'numeric',month:'long'};
  document.getElementById('hd').textContent=cD.toLocaleDateString('fr-FR',opt);
}

function selD(k){ cD=new Date(k+'T00:00:00'); R(); }
function navW(dir){ cD.setDate(cD.getDate()+dir*7); R(); }
function togV(v){ vM=vM===v?'grid':v; R(); }

/* Grid View */
function rGrid(){
  const sh=D.startH, eh=D.endH, th=eh-sh, gh=th*80;
  const pg=document.getElementById('pg');
  pg.style.minHeight=gh+'px';
  pg.style.height=gh+'px'; // Force height

  let tH='', lH='';
  for(let h=sh;h<eh;h++){
    const top=(h-sh)*80;
    tH+=`<div class="tl" style="top:${top}px">${h}:00</div>`;
    lH+=`<div class="gl" style="top:${top}px"></div>
         <div class="gl q" style="top:${top+20}px"></div>
         <div class="gl h" style="top:${top+40}px"></div>
         <div class="gl q" style="top:${top+60}px"></div>`;
  }
  // Ligne de fin
  lH+=`<div class="gl" style="top:${(eh-sh)*80}px"></div>`;
  tH+=`<div class="tl" style="top:${(eh-sh)*80}px">${eh}:00</div>`;

  document.getElementById('tc').innerHTML=tH;
  document.getElementById('glw').innerHTML=lH;

  // Ouvertures (Openings)
  const dow=cD.getDay();
  const ops=D.openings.filter(o=>o.day===dow);
  let oH='';
  if(ops.length===0 && (dow===1||dow===4)){
     // Fallback si pas de config pour Lun/Jeu
     oH=`<div class="op" style="top:0;bottom:0;background:#fff"></div>`; 
  } else {
      // Afficher les zones blanches (dispo). Le fond par d√©faut est gris√© (surface2)
      for(const o of ops){
        const s=t2m(o.start), e=t2m(o.end);
        if(s<e){
           const top = Math.max(0, ((s/60)-sh)*80);
           const ht = ((e-s)/60)*80;
           oH+=`<div class="op" style="top:${top}px;height:${ht}px"></div>`;
        }
      }
  }
  // Ligne "Maintenant"
  const now=new Date();
  if(same(now,cD)){
    const nm=now.getHours()*60+now.getMinutes();
    const top=((nm/60)-sh)*80;
    if(top>=0 && top<=gh) oH+=`<div class="nl" style="top:${top}px"></div>`;
  }
  document.getElementById('sa').innerHTML=oH;
}

function rAps(){
  const area=document.getElementById('sa');
  const key=dk(cD);
  const dayA=D.appointments.filter(a=>a.date===key && !a.deleted).sort((a,b)=>t2m(a.time)-t2m(b.time));

  // Algorithme de chevauchement (Overlap)
  const columns=[];
  dayA.forEach(ap=>{
    const s=t2m(ap.time), e=s+ap.duration;
    let placed=false;
    for(let i=0;i<columns.length;i++){
      let col=columns[i];
      // V√©rifier si collision dans cette colonne
      if(!col.some(x => (s < (t2m(x.time)+x.duration)) && (e > t2m(x.time)) )){
        col.push(ap); ap._col=i; placed=true; break;
      }
    }
    if(!placed){ columns.push([ap]); ap._col=columns.length-1; }
  });
  
  const totalCols=columns.length;

  const sh=D.startH;
  dayA.forEach(ap=>{
    const s=t2m(ap.time);
    const top=((s/60)-sh)*80;
    const ht=Math.max((ap.duration/60)*80, 24); // Min height visual
    const w = 100/totalCols;
    const l = ap._col * w;
    
    const mot=gm(ap.motifId), pat=ap.patientId?gp(ap.patientId):null;
    const isAbs=ap.type==='absence';
    const css=isAbs?'abs':(mot?CL[mot.ci%6].css:'mc0');
    const txt=isAbs?(ap.label||'Absence'):(pat?`${pat.lastName} ${pat.firstName}`:'?');
    const sub=isAbs?'':(mot?mot.label:'');
    const timeTxt = `${ap.time} - ${m2t(s+ap.duration)}`;

    const el=document.createElement('div');
    el.className=`ap ${css} ${ap.cancelled?'cncl':''}`;
    el.style.cssText=`top:${top}px;height:${ht}px;left:${l}%;width:${w}%;`;
    el.innerHTML=`<div class="an">${esc(txt)}${alrt(pat)}</div>
                  ${ht>35 ? `<div class="am">${esc(sub)}</div>` : ''}
                  ${ht>50 ? `<div class="at">${timeTxt}</div>` : ''}`;
    el.onclick=e=>showCtx(e,ap.id);
    area.appendChild(el);
  });
}

/* List View */
function rList(){
  const el=document.getElementById('lv');
  const key=dk(cD);
  const dayA=D.appointments.filter(a=>a.date===key).sort((a,b)=>t2m(a.time)-t2m(b.time));
  
  if(!dayA.length){el.innerHTML='<div style="text-align:center;padding:50px;color:var(--text3)">Aucun rendez-vous ce jour.</div>';return;}
  
  let h='';
  dayA.forEach(ap=>{
    const mot=gm(ap.motifId), pat=ap.patientId?gp(ap.patientId):null;
    const isAbs=ap.type==='absence';
    const col=isAbs?'var(--absence)':(mot?CL[mot.ci%6].bd:'var(--c0)');
    const txt=isAbs?(ap.label||'Absence'):(pat?`${pat.lastName} ${pat.firstName}`:'Unknown');
    
    h+=`<div class="li ${ap.cancelled?'cncl':''}" style="border-left-color:${col}" onclick="showCtx(event,'${ap.id}')">
          <div class="lt">${ap.time}</div>
          <div class="lb">
            <div class="ln">${esc(txt)} ${alrt(pat)}</div>
            <div class="lm">${isAbs?'Absence':(mot?mot.label:'')} ¬∑ ${ap.duration} min</div>
          </div>
        </div>`;
  });
  el.innerHTML=h;
}

/* Patients View */
function rPats(){
  const w=document.getElementById('plw');
  // Sort alphabetical
  const sP=D.patients.slice().sort((a,b)=>a.lastName.localeCompare(b.lastName));
  let h='<div class="pls"><input id="psch" placeholder="Rechercher..." oninput="fPats()"></div><div id="plst">';
  sP.forEach(p=>{
    h+=`<div class="pi" onclick="openPC('${p.id}')">
          <div class="pa">${ini(p)}</div>
          <div style="flex:1">
            <div class="pn">${esc(p.lastName)} ${esc(p.firstName)} ${alrt(p)}</div>
            <div class="pd">${p.phone||'Sans t√©l√©phone'}</div>
          </div>
        </div>`;
  });
  h+='</div>';
  w.innerHTML=h;
}
function fPats(){
  const q=document.getElementById('psch').value.toLowerCase();
  const els=document.querySelectorAll('#plst .pi');
  els.forEach(e=>e.style.display=e.innerText.toLowerCase().includes(q)?'flex':'none');
}

/* ‚ïê‚ïê‚ïê 5. INTERACTIONS ‚ïê‚ïê‚ïê */

/* Context Menu */
function showCtx(e,id){
  e.stopPropagation(); e.preventDefault();
  selId=id;
  const ap=D.appointments.find(a=>a.id===id); if(!ap)return;
  const pat=ap.patientId?gp(ap.patientId):null;
  const m=document.getElementById('ctx');
  
  let h=`<div class="ci" onclick="editAp()">‚úèÔ∏è Modifier</div>`;
  if(pat){
    h+=`<div class="ci" onclick="openPC('${pat.id}');clCtx()">üë§ Patient</div>
        <div class="ci" onclick="openHist('${pat.id}');clCtx()">üìã Historique</div>`;
  }
  if(!ap.cancelled) h+=`<div class="ci dng" onclick="cancelAp()">üö´ Annuler</div>`;
  else h+=`<div class="ci" onclick="uncancelAp()">‚Ü©Ô∏è R√©tablir</div>`;
  
  if(ap.type!=='absence') h+=`<div class="ci" onclick="recurAp()">üîÅ R√©currence</div>`;
  h+=`<div class="ci dng" onclick="delAp()">üóë Supprimer</div>`;
  
  m.innerHTML=h;
  
  // Smart Positioning
  m.classList.add('open');
  const mw=m.offsetWidth, mh=m.offsetHeight;
  let x=e.clientX, y=e.clientY;
  
  if(x+mw > window.innerWidth) x = window.innerWidth - mw - 10;
  if(y+mh > window.innerHeight) y = window.innerHeight - mh - 10;
  
  m.style.left=x+'px'; m.style.top=y+'px';
  
  // Close logic
  setTimeout(()=>document.addEventListener('click',clCtx,{once:true}),50);
}
function clCtx(){document.getElementById('ctx').classList.remove('open')}

/* Form Logic (APPOINTMENT) */
function newAp(){openAF(null)}
function editAp(){clCtx(); const ap=D.appointments.find(a=>a.id===selId); if(ap) openAF(ap)}

function openAF(ex){
  const t=document.getElementById('mAT');
  const b=document.getElementById('mAB');
  t.textContent=ex?'Modifier le rendez-vous':'Nouveau rendez-vous';
  
  const isAbs=ex && ex.type==='absence';
  const selMot=ex ? ex.motifId : (D.motifs[0]?D.motifs[0].id:null);
  
  // Chips motifs
  let ch=D.motifs.map(m=>`<div class="chip ${(m.id===selMot&&!isAbs)?'sel':''}" data-m="${m.id}" style="background:${CL[m.ci%6].bg};color:${CL[m.ci%6].bd}">${esc(m.label)}</div>`).join('');
  ch+=`<div class="chip ${isAbs?'sel':''}" data-m="__abs" style="background:var(--absence);color:#fff">Absence</div>`;
  
  const pName = (ex && ex.patientId) ? (gp(ex.patientId)?.lastName+' '+gp(ex.patientId)?.firstName) : '';
  const date = ex ? ex.date : dk(cD);
  const time = ex ? ex.time : '09:00';
  const dur = ex ? ex.duration : (D.motifs[0]?.duration || 30);
  
  b.innerHTML=`
    <div class="chips" id="mCh">${ch}</div>
    
    <div id="patB" style="${isAbs?'display:none':''}">
      <div class="fg acw">
        <label>Patient</label>
        <input id="fP" value="${esc(pName)}" placeholder="Nom du patient..." autocomplete="off">
        <input type="hidden" id="fPi" value="${ex?ex.patientId:''}">
        <div class="acl" id="acl"></div>
      </div>
    </div>
    
    <div id="absB" style="${isAbs?'':'display:none'}">
      <div class="fg"><label>Libell√© de l'absence</label><input id="fAL" value="${esc(ex?.label||'Absence')}"></div>
    </div>
    
    <div class="fr">
      <div class="fg"><label>Date</label><input type="date" id="fDt" value="${date}"></div>
      <div class="fg"><label>Heure</label><input type="time" id="fTm" value="${time}" step="300"></div>
    </div>
    <div class="fg"><label>Dur√©e (min)</label><input type="number" id="fDu" value="${dur}" step="5"></div>
    <div class="fg"><label>Note</label><textarea id="fNo" rows="2">${esc(ex?.notes||'')}</textarea></div>
    
    <div class="br">
      <button class="btn bp bw" onclick="svAF('${ex?ex.id:''}')">Enregistrer</button>
    </div>
  `;
  
  // Events Chips
  document.querySelectorAll('#mCh .chip').forEach(c=>{
    c.onclick=()=>{
      document.querySelectorAll('#mCh .chip').forEach(x=>x.classList.remove('sel'));
      c.classList.add('sel');
      const mid=c.dataset.m, isA=(mid==='__abs');
      document.getElementById('patB').style.display=isA?'none':'block';
      document.getElementById('absB').style.display=isA?'block':'none';
      if(!isA){ const m=gm(mid); if(m) document.getElementById('fDu').value=m.duration; }
    }
  });
  
  setupAC();
  opM('mA');
}

/* AutoComplete */
function setupAC(){
  const inp=document.getElementById('fP'), list=document.getElementById('acl'), hid=document.getElementById('fPi');
  if(!inp)return;
  
  inp.oninput=()=>{
    const q=inp.value.toLowerCase().trim();
    if(q.length<1){list.classList.remove('open');return}
    
    const res=D.patients.filter(p=>(p.lastName+' '+p.firstName).toLowerCase().includes(q)).slice(0,5);
    let h=res.map(p=>`<div class="aci" onclick="selAC('${p.id}')"><span>${esc(p.lastName)} ${esc(p.firstName)}</span></div>`).join('');
    h+=`<div class="aci acn" onclick="quickPat()">+ Cr√©er "${esc(inp.value)}"</div>`;
    
    list.innerHTML=h; list.classList.add('open');
  };
  
  window.selAC=pid=>{
    const p=gp(pid);
    inp.value=p.lastName+' '+p.firstName;
    hid.value=pid;
    list.classList.remove('open');
  };
  
  window.quickPat=()=>{
    const parts=inp.value.trim().split(' ');
    const ln=parts[0]||'Nouveau', fn=parts.slice(1).join(' ')||'';
    const np={id:uid(),lastName:ln,firstName:fn,phone:'',needOrdo:false,needMut:false};
    D.patients.push(np); sv();
    selAC(np.id);
  };
  
  inp.onblur=()=>setTimeout(()=>list.classList.remove('open'),200);
}

function svAF(eid){
  const chip=document.querySelector('#mCh .chip.sel');
  if(!chip){toast('S√©lectionnez un motif');return}
  const mid=chip.dataset.m, isAbs=(mid==='__abs');
  
  const pid=document.getElementById('fPi').value;
  if(!isAbs && !pid){toast('Patient requis');return}
  
  const dt=document.getElementById('fDt').value;
  const tm=document.getElementById('fTm').value;
  if(!dt || !tm){toast('Date et heure requises');return}
  
  const ap={
    id: eid || uid(),
    type: isAbs?'absence':'rdv',
    motifId: isAbs?null:mid,
    patientId: isAbs?null:pid,
    label: isAbs?document.getElementById('fAL').value:'',
    date: dt,
    time: tm,
    duration: parseInt(document.getElementById('fDu').value)||30,
    notes: document.getElementById('fNo').value,
    cancelled: false
  };
  
  if(eid){
    const idx=D.appointments.findIndex(a=>a.id===eid);
    if(idx>=0) D.appointments[idx]={...D.appointments[idx], ...ap};
  } else {
    D.appointments.push(ap);
  }
  
  sv(); clM('mA');
  cD=new Date(dt+'T00:00:00'); R();
  toast('Enregistr√©');
}

/* Actions */
function cancelAp(){
  const a=D.appointments.find(x=>x.id===selId);
  if(a){ a.cancelled=true; sv(); R(); clCtx(); toast('RDV annul√©'); }
}
function uncancelAp(){
  const a=D.appointments.find(x=>x.id===selId);
  if(a){ a.cancelled=false; sv(); R(); clCtx(); toast('RDV r√©tabli'); }
}
function delAp(){
  if(confirm('Supprimer d√©finitivement ?')){
    D.appointments=D.appointments.filter(x=>x.id!==selId);
    sv(); R(); clCtx(); toast('Supprim√©');
  }
}

/* ‚ïê‚ïê‚ïê 6. PATIENT DETAILS ‚ïê‚ïê‚ïê */
function openPC(id){
  clCtx();
  const p=gp(id); if(!p)return;
  document.getElementById('mPT').innerHTML=esc(p.lastName)+' '+esc(p.firstName);
  const d=document.getElementById('mPB');
  
  d.innerHTML=`
    <div class="fg">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div style="font-size:13px;color:var(--text2)">${p.phone||'Pas de t√©l√©phone'}</div>
        <button class="btn bs" style="padding:6px 10px;font-size:12px" onclick="editPat('${id}')">Modifier</button>
      </div>
      <div style="display:flex;gap:15px;margin-bottom:15px;padding:10px;background:var(--surface2);border-radius:8px">
        <label style="display:flex;align-items:center;gap:6px;font-size:13px"><input type="checkbox" ${p.needOrdo?'checked':''} onchange="togP('${id}','needOrdo')"> ‚ùó Ordonnance</label>
        <label style="display:flex;align-items:center;gap:6px;font-size:13px"><input type="checkbox" ${p.needMut?'checked':''} onchange="togP('${id}','needMut')"> ‚ÄºÔ∏è Mutuelle</label>
      </div>
      <div class="br">
        <button class="btn bp bw" onclick="openHist('${id}');clM('mP')">Voir historique</button>
        <button class="btn bd" onclick="delPat('${id}')">Supprimer</button>
      </div>
    </div>
  `;
  opM('mP');
}
function togP(id,k){ const p=gp(id); if(p){p[k]=!p[k]; sv(); R();} }

function editPat(id){
  clM('mP'); const p=gp(id);
  const b=document.getElementById('mAB');
  document.getElementById('mAT').textContent='Modifier Patient';
  b.innerHTML=`
    <div class="fr"><div class="fg"><label>Nom</label><input id="epL" value="${esc(p.lastName)}"></div>
    <div class="fg"><label>Pr√©nom</label><input id="epF" value="${esc(p.firstName)}"></div></div>
    <div class="fg"><label>T√©l√©phone</label><input id="epP" value="${esc(p.phone)}"></div>
    <div class="br"><button class="btn bp bw" onclick="svPat('${id}')">Sauvegarder</button></div>
  `;
  opM('mA');
}
function svPat(id){
  const p=gp(id);
  p.lastName=document.getElementById('epL').value;
  p.firstName=document.getElementById('epF').value;
  p.phone=document.getElementById('epP').value;
  sv(); clM('mA'); openPC(id); R();
}
function delPat(id){
  if(confirm('Supprimer ce patient et ses RDV ?')){
    D.patients=D.patients.filter(p=>p.id!==id);
    D.appointments=D.appointments.filter(a=>a.patientId!==id);
    sv(); clM('mP'); R(); toast('Patient supprim√©');
  }
}

/* ‚ïê‚ïê‚ïê 7. SETTINGS & RECURRENCE ‚ïê‚ïê‚ïê */
function openSet(){
  const b=document.getElementById('mSB');
  // Motifs editor
  let mh=D.motifs.map((m,i)=>`<div class="ci" style="justify-content:space-between;background:var(--surface2);margin-bottom:4px">
    <div style="display:flex;gap:8px;align-items:center"><div style="width:12px;height:12px;border-radius:50%;background:${CL[m.ci%6].bd}"></div>${esc(m.label)} (${m.duration}m)</div>
    <button style="color:#e74c3c" onclick="delMot(${i})">√ó</button>
  </div>`).join('');
  
  b.innerHTML=`
    <h3>Configuration</h3>
    <div class="fg"><label>Amplitude Horaire</label>
      <div style="display:flex;gap:10px;align-items:center">
        <input type="number" id="shIn" value="${D.startH}" min="6" max="10" onchange="udCfg()"> √† 
        <input type="number" id="ehIn" value="${D.endH}" min="16" max="23" onchange="udCfg()">
      </div>
    </div>
    <h3>Motifs</h3>
    ${mh}
    <button class="btn bs bw" onclick="addMot()">+ Ajouter Motif</button>
    <div class="br"><button class="btn bd bw" onclick="resetAll()">‚ö†Ô∏è Tout Effacer</button></div>
  `;
  opM('mS');
}
function udCfg(){
  D.startH=parseInt(document.getElementById('shIn').value);
  D.endH=parseInt(document.getElementById('ehIn').value);
  sv(); R();
}
function addMot(){
  const n=prompt('Nom du motif?'); if(!n)return;
  D.motifs.push({id:uid(),label:n,duration:30,ci:D.motifs.length});
  sv(); openSet();
}
function delMot(i){ D.motifs.splice(i,1); sv(); openSet(); }
function resetAll(){ if(confirm('RESET TOTAL?')) { localStorage.removeItem(SK); location.reload(); } }

function recurAp(){
  clCtx(); const ap=D.appointments.find(a=>a.id===selId);
  if(!ap)return;
  document.getElementById('mRB').innerHTML=`
    <p style="font-size:13px;color:var(--text2);margin-bottom:15px">R√©p√©ter le RDV de <b>${ap.time}</b> (${ap.duration} min).</p>
    <div class="fg"><label>Nombre de semaines</label><input type="number" id="rcW" value="5"></div>
    <div class="br"><button class="btn bp bw" onclick="doRecur('${selId}')">Valider</button></div>
  `;
  opM('mR');
}
function doRecur(id){
  const src=D.appointments.find(a=>a.id===id);
  const w=parseInt(document.getElementById('rcW').value)||1;
  const d=new Date(src.date+'T00:00:00');
  let c=0;
  for(let i=1;i<=w;i++){
    const nd=new Date(d); nd.setDate(d.getDate()+(i*7));
    const k=dk(nd);
    // Check collision strict same time/date
    if(!D.appointments.some(x=>x.date===k && x.time===src.time)){
      D.appointments.push({...src, id:uid(), date:k});
      c++;
    }
  }
  sv(); clM('mR'); R(); toast(`${c} s√©ances cr√©√©es`);
}

function openHist(pid){
  const p=gp(pid); if(!p)return;
  document.getElementById('mHT').textContent='Historique';
  const aps=D.appointments.filter(a=>a.patientId===pid).sort((a,b)=>a.date.localeCompare(b.date));
  let h='';
  aps.forEach(a=>{
    const m=gm(a.motifId);
    h+=`<div class="li" style="padding:8px;font-size:13px;border-left:3px solid ${a.cancelled?'#ccc':'var(--accent)'}">
      <b>${fmtDateLocal(new Date(a.date+'T00:00:00'))}</b> √† ${a.time} - ${m?m.label:'?'} ${a.cancelled?'(Annul√©)':''}
    </div>`;
  });
  document.getElementById('mHB').innerHTML=h||'<p>Rien.</p>';
  opM('mH');
}

/* ‚ïê‚ïê‚ïê 8. SYSTEM & EVENTS ‚ïê‚ïê‚ïê */
function toast(m){
  const t=document.getElementById('tst');
  t.textContent=m; t.classList.add('show');
  clearTimeout(t._to); t._to=setTimeout(()=>t.classList.remove('show'),2000);
}
function opM(id){document.getElementById(id).classList.add('open');}
function clM(id){document.getElementById(id).classList.remove('open');}

document.querySelectorAll('.mo').forEach(m=>{
  m.onclick=e=>{if(e.target===m) clM(m.id)}
});

// Double Click / Long Press on Grid
const grid=document.getElementById('sa');
let tmr;
grid.addEventListener('touchstart', e=>{
  tmr = setTimeout(()=>{ handleGridClick(e,true) }, 600);
});
grid.addEventListener('touchend', ()=>{ clearTimeout(tmr) });
grid.addEventListener('dblclick', e=>handleGridClick(e,false));

function handleGridClick(e, isTouch){
  if(e.target.closest('.ap')) return; // Ignore clicks on appts
  const rect=grid.getBoundingClientRect();
  const clientY = isTouch ? e.touches[0].clientY : e.clientY;
  const y = clientY - rect.top + document.getElementById('pw').scrollTop;
  
  // Snap to 5 min
  const minTotal = Math.floor(y/80 * 60) + D.startH*60;
  const snap = Math.round(minTotal/5)*5;
  
  openAF(null);
  setTimeout(()=>{
    document.getElementById('fTm').value = m2t(snap);
  }, 50);
  if(navigator.vibrate) navigator.vibrate(50);
}

// Init
if(location.hash === '#reset') localStorage.clear();
R();
// Auto scroll to 8h
setTimeout(()=>{
  document.getElementById('pw').scrollTop = ((8 - D.startH) * 80) - 20;
}, 100);

</script>
</body>
</html>
