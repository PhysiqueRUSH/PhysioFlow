<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0f1923">
<link rel="manifest" href="manifest.json">
<title>PhysioFlow</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f2efe9;--bg2:#e8e4dc;--surface:#fff;--surface2:#faf9f6;
  --text:#1a1a2e;--text2:#6a6a7e;--text3:#8a8a9a;
  --accent:#2a7c6f;--accent2:#3bb5a0;--accentbg:rgba(42,124,111,.07);
  --border:#ccc8bf;--border2:#ddd8cf;
  --shadow:0 4px 16px rgba(0,0,0,.08);--shadowlg:0 8px 32px rgba(0,0,0,.12);
  --radius:8px;--radiuslg:14px;--radiusxl:20px;
  --c0:#4a80c4;--c0bg:#dce7f5;--c0t:#1e3a5c;
  --c1:#e07a3a;--c1bg:#fce8d8;--c1t:#6b3210;
  --c2:#7b5bbf;--c2bg:#ece4f8;--c2t:#3a2070;
  --c3:#c44a6a;--c3bg:#fce0e8;--c3t:#6b1030;
  --c4:#3aad5c;--c4bg:#d8f2e0;--c4t:#105c28;
  --c5:#c4a030;--c5bg:#f8f2d8;--c5t:#5c4a08;
  --absence:#546e7a;
  --grid-line:#c5c0b5;
  --grid-half:#d5d0c8;
  --grid-quarter:#e0dcd5;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);overflow:hidden;-webkit-tap-highlight-color:transparent}
button{font-family:inherit;cursor:pointer;border:none;background:none;color:inherit;font-size:inherit}
input,select,textarea{font-family:inherit;color:var(--text);font-size:14px}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
#app{display:flex;flex-direction:column;height:100dvh;height:100vh;overflow:hidden}

/* ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê */
.hdr{background:var(--surface);border-bottom:1px solid var(--border);padding:10px 14px;display:flex;align-items:center;gap:10px;flex-shrink:0;z-index:100}
.logo{font-family:'JetBrains Mono',monospace;font-weight:600;font-size:16px;color:var(--accent);letter-spacing:-.5px;white-space:nowrap}
.logo b{color:var(--text)}
.logoWrap{display:flex;flex-direction:column;line-height:1}
.ver{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text3);margin-top:2px;letter-spacing:-.2px}
.hdr-c{flex:1;display:flex;align-items:center;justify-content:center;gap:6px}
.hdr-c span{font-weight:600;font-size:14px;min-width:140px;text-align:center}
.nb{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:var(--accentbg);color:var(--accent);font-size:18px;font-weight:700;-webkit-tap-highlight-color:transparent;touch-action:manipulation}
.nb:active{transform:scale(.9);background:var(--accent);color:#fff}
.ha{display:flex;gap:5px}
.ib{width:34px;height:34px;border-radius:var(--radius);display:flex;align-items:center;justify-content:center;background:var(--accentbg);color:var(--accent);font-size:16px}
.ib:active{transform:scale(.92)}
.ib.on{background:var(--accent);color:#fff}

/* ‚ïê‚ïê‚ïê WEEK BAR - IMPROVED TOUCH TARGETS ‚ïê‚ïê‚ïê */
.wbar{display:flex;background:var(--surface);border-bottom:1px solid var(--border);flex-shrink:0;padding:4px 0}
.wd{flex:1;text-align:center;padding:10px 2px 12px;cursor:pointer;position:relative;-webkit-tap-highlight-color:transparent;touch-action:manipulation;border-radius:8px;margin:0 2px;transition:background .15s,transform .1s}
.wd.act{background:var(--accentbg)}
.wd.act::after{content:'';position:absolute;bottom:2px;left:20%;right:20%;height:3px;background:var(--accent);border-radius:2px}
.wd.dis{opacity:.2;pointer-events:none}
.wd:not(.dis):active{transform:scale(.95);background:rgba(42,124,111,.12)}
.wd .wl{font-size:11px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.5px}
.wd .wn{font-size:16px;font-weight:700;margin-top:2px;display:inline-flex;align-items:center;justify-content:center;width:30px;height:30px;border-radius:50%;transition:all .15s}
.wd.tod .wn{background:var(--accent);color:#fff}
.wd.act:not(.tod) .wn{color:var(--accent)}

/* ‚ïê‚ïê‚ïê GRID VIEW ‚ïê‚ïê‚ïê */
.pw{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;touch-action:pan-y}
.pg{position:relative}

/* Time column - HIGH CONTRAST */
.tc{position:absolute;left:0;top:0;bottom:0;width:54px;z-index:2;pointer-events:none;background:linear-gradient(to right,var(--bg) 48px,transparent)}
.tl{position:absolute;left:0;width:52px;text-align:right;padding-right:6px;font-size:12px;font-weight:700;color:var(--text2);font-family:'JetBrains Mono',monospace;transform:translateY(-50%)}

/* Grid lines - HIGH CONTRAST */
.gl-w{position:absolute;left:54px;right:4px;top:0;bottom:0}
.gl{position:absolute;left:0;right:0;border-top-style:solid}
.gl.full{border-top-width:1.5px;border-top-color:var(--grid-line)}
.gl.half{border-top-width:1px;border-top-color:var(--grid-half)}
.gl.quarter{border-top-width:1px;border-top-color:var(--grid-quarter);border-top-style:dashed}

/* Hour labels on grid */
.gl-label{position:absolute;right:4px;font-size:9px;font-weight:600;color:var(--text3);font-family:'JetBrains Mono',monospace;transform:translateY(-50%);pointer-events:none;opacity:.6}

/* Slots area */
.sa{position:absolute;left:54px;right:4px;top:0;bottom:0}
.op{position:absolute;left:0;right:0;background:rgba(42,124,111,.05);border-left:3px solid rgba(42,124,111,.18);z-index:1;pointer-events:none;border-radius:0 4px 4px 0}
.nl{position:absolute;left:0;right:0;height:2px;background:var(--accent);z-index:8;pointer-events:none}
.nl::before{content:'';position:absolute;left:-5px;top:-4px;width:10px;height:10px;background:var(--accent);border-radius:50%}
.nl-time{position:absolute;left:14px;top:-8px;font-size:9px;font-weight:700;color:#fff;background:var(--accent);padding:1px 5px;border-radius:4px;font-family:'JetBrains Mono',monospace}

/* Appointments */
.ap{position:absolute;border-radius:6px;padding:4px 7px;overflow:hidden;cursor:pointer;border-left:3px solid;font-size:11px;line-height:1.25;display:flex;flex-direction:column;z-index:5;transition:box-shadow .15s}
.ap.msel-on,.li.msel-on,.pi.msel-on{box-shadow:0 0 0 2px var(--accent);outline:2px solid var(--accent)}
.ap:active{box-shadow:var(--shadow);z-index:10;transform:scale(.98)}
.ap .an{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:flex;align-items:center;gap:3px}
.ap .am{font-size:9px;opacity:.7;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ap .at{font-size:9px;opacity:.5;font-family:'JetBrains Mono',monospace}
.ap.cncl .an{text-decoration:line-through;opacity:.6}
.ap.cncl{opacity:.5}
.ap.abs{background:var(--absence)!important;border-left-color:#37474f!important;color:#fff;opacity:.8}
/* Blinking name/time for very short motifs only */
.ap.vshort .an .blink-name,.ap.vshort .an .blink-time{animation:blinker 3s ease-in-out infinite}
.ap.vshort .an .blink-time{animation-delay:1.5s;position:absolute;left:7px;right:7px;opacity:0}
@keyframes blinker{0%,40%{opacity:1}50%,90%{opacity:0}100%{opacity:1}}
/* Short appointments: compact layout with smaller text */
.ap.short{padding:2px 5px;line-height:1.15}
.ap.short .an{font-size:10px}
.ap.short .at{font-size:8px;opacity:.6}
.bo{color:var(--c1);font-size:10px;flex-shrink:0}
.bm{color:var(--c3);font-size:10px;flex-shrink:0}
.emji{font-size:11px;cursor:pointer;vertical-align:middle}
.ap.mc0{background:var(--c0bg);border-left-color:var(--c0);color:var(--c0t)}
.ap.mc1{background:var(--c1bg);border-left-color:var(--c1);color:var(--c1t)}
.ap.mc2{background:var(--c2bg);border-left-color:var(--c2);color:var(--c2t)}
.ap.mc3{background:var(--c3bg);border-left-color:var(--c3);color:var(--c3t)}
.ap.mc4{background:var(--c4bg);border-left-color:var(--c4);color:var(--c4t)}
.ap.mc5{background:var(--c5bg);border-left-color:var(--c5);color:var(--c5t)}

/* ‚ïê‚ïê‚ïê LIST VIEW ‚ïê‚ïê‚ïê */
.lv{flex:1;overflow-y:auto;padding:8px 12px;display:none}
.lv.on{display:block}
.pw.off{display:none}
.li{display:flex;align-items:center;gap:10px;padding:12px 14px;background:var(--surface);border-radius:var(--radius);margin-bottom:6px;border-left:3px solid var(--border);cursor:pointer}
.li:active{background:var(--bg2)}
.li.cncl{opacity:.5}
.li.cncl .ln{text-decoration:line-through}
.li .lt{font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:600;color:var(--text2);min-width:44px}
.li .lb{flex:1;min-width:0}
.li .ln{font-weight:600;font-size:14px;display:flex;align-items:center;gap:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.li .lm{font-size:11px;color:var(--text2);margin-top:1px}

/* ‚ïê‚ïê‚ïê PATIENTS LIST ‚ïê‚ïê‚ïê */
.plw{flex:1;overflow-y:auto;padding:8px 12px;display:none}
.plw.on{display:block}
.pls{margin-bottom:8px;position:relative}
.pls input{width:100%;padding:9px 11px 9px 34px;border:1.5px solid var(--border);border-radius:var(--radius);background:var(--surface);font-size:13px;outline:none}
.pls input:focus{border-color:var(--accent)}
.pls::before{content:'üîç';position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:13px;pointer-events:none}
.pi{display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--surface);border-radius:var(--radius);margin-bottom:4px;cursor:pointer}
.pi:active{background:var(--bg2)}
.pi .pa{width:36px;height:36px;border-radius:50%;background:var(--accentbg);display:flex;align-items:center;justify-content:center;font-weight:600;color:var(--accent);font-size:13px;flex-shrink:0}
.pi .pif{flex:1;min-width:0}
.pi .pn{font-weight:600;font-size:13px;display:flex;align-items:center;gap:3px}
.pi .pd{font-size:11px;color:var(--text2)}

/* ‚ïê‚ïê‚ïê FAB ‚ïê‚ïê‚ïê */
.fab{position:fixed;bottom:20px;right:16px;width:52px;height:52px;border-radius:50%;background:var(--accent);color:#fff;font-size:26px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 16px rgba(42,124,111,.35);z-index:50}
.fab:active{transform:scale(.92)}

/* ‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê */
.mo{position:fixed;inset:0;background:rgba(10,15,30,.4);backdrop-filter:blur(3px);z-index:200;display:flex;align-items:flex-end;justify-content:center;opacity:0;pointer-events:none;transition:.2s}
.mo.open{opacity:1;pointer-events:all}
.mop{background:var(--surface);border-radius:var(--radiusxl) var(--radiusxl) 0 0;width:100%;max-width:460px;max-height:88vh;overflow-y:auto;transform:translateY(100%);transition:transform .28s cubic-bezier(.22,1,.36,1);padding:0 18px 28px}
.mo.open .mop{transform:translateY(0)}
.moh{width:32px;height:4px;background:var(--border);border-radius:4px;margin:10px auto 14px;cursor:grab;touch-action:none}
.mop h2{font-size:17px;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.mop h3{font-size:13px;font-weight:600;margin:14px 0 6px;color:var(--text2)}
.fg{margin-bottom:12px}
.fg label{display:block;font-size:11px;font-weight:600;color:var(--text2);margin-bottom:3px;text-transform:uppercase;letter-spacing:.5px}
.fg input,.fg select,.fg textarea{width:100%;padding:9px 11px;border:1.5px solid var(--border);border-radius:var(--radius);background:var(--bg);outline:none}
.fg input:focus,.fg select:focus,.fg textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(42,124,111,.1)}
.fr{display:flex;gap:8px}
.fr .fg{flex:1}
.btn{padding:10px 16px;border-radius:var(--radius);font-size:13px;font-weight:600;display:inline-flex;align-items:center;justify-content:center;gap:5px}
.btn:active{transform:scale(.97)}
.bp{background:var(--accent);color:#fff}
.bd{background:#e74c3c;color:#fff}
.bs{background:var(--bg);border:1.5px solid var(--border)}
.bw{width:100%}
.br{display:flex;gap:6px;margin-top:16px}
.br .btn{flex:1}
.chips{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:12px}
.chip{padding:5px 11px;border-radius:16px;font-size:11px;font-weight:600;cursor:pointer;border:2px solid transparent}
.chip.sel{border-color:var(--text);transform:scale(1.05)}

/* Autocomplete */
.acw{position:relative}
.acl{position:absolute;top:100%;left:0;right:0;background:var(--surface);border:1.5px solid var(--border);border-top:none;border-radius:0 0 var(--radius) var(--radius);max-height:180px;overflow-y:auto;z-index:10;display:none;box-shadow:var(--shadow)}
.acl.open{display:block}
.aci{padding:8px 11px;cursor:pointer;font-size:13px;display:flex;align-items:center;gap:6px}
.aci:hover,.aci.hl{background:var(--accentbg)}
.aci .acs{font-size:11px;color:var(--text2)}
.acn{color:var(--accent);font-weight:600}

/* Context menu */
.ctx{position:fixed;background:#fff;border-radius:var(--radiuslg);box-shadow:var(--shadowlg);z-index:250;min-width:170px;max-height:70vh;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:4px;opacity:0;pointer-events:none;transition:.08s;border:1px solid var(--border)}
.ctx.open{opacity:1;pointer-events:all}
.ci{padding:9px 13px;border-radius:var(--radius);font-size:12px;font-weight:500;display:flex;align-items:center;gap:7px;cursor:pointer}
.ci:active{background:var(--accentbg)}
.ci.dng{color:#e74c3c}

/* Toast */
.toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(60px);background:var(--text);color:#fff;padding:9px 18px;border-radius:var(--radius);font-size:12px;font-weight:500;z-index:9999;opacity:0;transition:.25s;pointer-events:none;white-space:nowrap}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);pointer-events:auto}

/* History */
.hs{display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap}
.hst{background:var(--bg);border-radius:var(--radius);padding:8px 12px;text-align:center;flex:1;min-width:60px}
.hst .hn{font-size:20px;font-weight:700;font-family:'JetBrains Mono',monospace}
.hst .hl{font-size:10px;color:var(--text2);margin-top:2px}
.hi{display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--surface);border-radius:var(--radius);margin-bottom:4px;border-left:3px solid var(--border);font-size:12px}
.hi.cncl{opacity:.5}.hi.cncl .him{text-decoration:line-through}
.hi.fut{opacity:.7;border-style:dashed}
.hi .hid{font-family:'JetBrains Mono',monospace;min-width:80px;color:var(--text2);font-size:11px}
.hi .him{flex:1}
.hi .hib{font-size:10px;padding:2px 6px;border-radius:8px;font-weight:600}

/* Settings */
.ss{margin-bottom:16px;padding-bottom:14px;border-bottom:1px solid var(--border2)}
.ss:last-child{border:none}
.si{display:flex;align-items:center;gap:6px;padding:7px 9px;background:var(--bg);border-radius:var(--radius);margin-bottom:5px;font-size:13px}
.si input[type=time]{padding:4px 6px;border:1.5px solid var(--border);border-radius:6px;font-size:12px;background:var(--surface)}
.si .sd{font-weight:600;min-width:48px;font-size:12px}
.si .sa2{color:var(--text3);font-size:11px}
.si .sb{margin-left:auto;width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.si .sb.del{background:#fce0e8;color:var(--c3)}
.si .sb.edt{background:var(--accentbg);color:var(--accent)}
.mi{display:flex;align-items:center;gap:8px;padding:7px 9px;background:var(--bg);border-radius:var(--radius);margin-bottom:5px}
.mi .md{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.mi .ml{flex:1;font-size:13px;font-weight:500}
.mi .mu{font-size:11px;color:var(--text2);font-family:'JetBrains Mono',monospace}
.addb{display:flex;align-items:center;gap:5px;padding:7px 10px;border:1.5px dashed var(--border);border-radius:var(--radius);width:100%;font-size:12px;font-weight:500;color:var(--text2);justify-content:center}
.addb:active{border-color:var(--accent);color:var(--accent)}

/* Patient card */
.pcard{background:var(--surface);border-radius:var(--radiuslg);padding:16px;margin-bottom:12px;border:1px solid var(--border2)}
.pcard .pt{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.pcard .pav{width:44px;height:44px;border-radius:50%;background:var(--accentbg);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--accent);font-size:16px;flex-shrink:0}
.pcard .pinf{flex:1;min-width:0}
.pcard .pnm{font-weight:700;font-size:15px;display:flex;align-items:center;gap:4px;flex-wrap:wrap}
.pcard .pag{font-size:12px;color:var(--text2)}
.pcard .pacts{display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap}
.pcard .pacts a,.pcard .pacts button{padding:7px 12px;border-radius:var(--radius);font-size:12px;font-weight:600;background:var(--bg);border:1px solid var(--border);display:inline-flex;align-items:center;gap:4px;text-decoration:none;color:var(--text)}
.pcks{display:flex;gap:14px;margin-bottom:10px}
.pcks label{display:flex;align-items:center;gap:5px;font-size:12px;font-weight:500;cursor:pointer}
.pcks input[type=checkbox]{width:16px;height:16px;accent-color:var(--accent)}
.pdocs{margin-top:8px}
.pdi{display:flex;align-items:center;gap:6px;padding:5px 0;font-size:12px;border-bottom:1px solid var(--border2)}
.pdi:last-child{border:none}
.pdi a{color:var(--accent);font-weight:500;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-decoration:none}

/* Empty state */
.empty-grid{position:absolute;left:54px;right:4px;top:50%;transform:translateY(-50%);text-align:center;color:var(--text3);font-size:13px;z-index:0;pointer-events:none}
.empty-grid .eg-icon{font-size:32px;margin-bottom:6px}



/* Responsive header: keep action buttons visible on narrow screens */
@media(max-width:430px){
  .hdr{flex-wrap:wrap;padding:8px 10px}
  .hdr-c{order:3;flex:1 1 100%;justify-content:space-between}
  .hdr-c span{min-width:0;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:13px}
  .ha{margin-left:auto}
  .nb{width:34px;height:34px}
  .ib{width:32px;height:32px}
}

@media(min-width:500px){.mop{border-radius:var(--radiusxl);margin-bottom:32px;max-height:82vh}}

.bill{margin-left:6px;cursor:pointer}
.tri{margin-right:6px}
.ub{font-size:11px;color:var(--text2);margin-top:2px}


/* calendar density badges */
.calBtn{position:relative}
.calN{position:absolute;top:4px;right:6px;font-size:10px;font-weight:900;line-height:1;opacity:.95}
.calCool{position:absolute;bottom:4px;right:6px;font-size:10px;font-weight:900;line-height:1;opacity:.95}

/* ===== UI tweaks (v14.6) ===== */
#mCAL .mop{max-height:92vh;}
#mCAL .calBtn{position:relative; overflow:hidden; min-height:58px; padding:0 !important;}
#mCAL .calD{
  position:absolute;
  left:6px;
  top:50%;
  transform:translateY(-50%);
  font-size:21px;
  font-weight:900;
  background:rgba(255,255,255,.55);
  padding:2px 7px;
  border-radius:12px;
  line-height:1;
  z-index:4;
}
#mCAL .calN, #mCAL .calCool{
  background:transparent !important;
  padding:0 !important;
  border-radius:0 !important;
}
.pls::before{
  top:13px !important;
  transform:none !important;
}
/* ===== Modal scroll fix (v14.7) ===== */
.mo{overflow:auto;}
.mop{max-height:92vh; overflow:auto; -webkit-overflow-scrolling:touch;}

/* ===== Calendar today highlight (v14.7) ===== */
#mCAL .calBtn.today{ outline:2px solid rgba(255,255,255,.85); outline-offset:-2px; }
/* ===== Calendar UI (v14.7) ===== */
#mCAL .calBtn{position:relative; overflow:hidden; min-height:58px; padding:0 !important;}
#mCAL .calD{
  position:absolute;
  left:6px;
  top:50%;
  transform:translateY(-50%);
  font-size:21px;
  font-weight:900;
  background:rgba(255,255,255,.55);
  padding:2px 7px;
  border-radius:12px;
  line-height:1;
  z-index:4;
}
#mCAL .calN{position:absolute; top:6px; right:8px; font-size:11px; font-weight:900; background:transparent; padding:0; line-height:1; z-index:3;}
#mCAL .calCool{position:absolute; bottom:6px; right:8px; font-size:11px; font-weight:900; background:transparent; padding:0; line-height:1; z-index:3;}
/* ===== Scroll menu seance (v14.8) ===== */
#mA .mop{max-height:92vh; display:flex; flex-direction:column; overflow:hidden;}
#mA #mAB{overflow:auto; -webkit-overflow-scrolling:touch; padding-bottom:16px;}
/* ===== FIX: scroll menu s√©ance (v14.8) ===== */
#mA .mop{
  max-height:92vh;
  height:auto;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}
#mA #mAT{flex:0 0 auto;}
#mA #mAB{
  flex:1 1 auto;
  overflow:auto;
  -webkit-overflow-scrolling:touch;
  padding-bottom:18px;
}
</style>
<link rel="icon" href="PhysioFlow.png">
<link rel="apple-touch-icon" href="PhysioFlow.png">
</head>
<body>
<div id="app">
  <div class="hdr">
    <div class="logoWrap"><div class="logo"><b>Physio</b>Flow</div><div class="ver">version 43 ¬∑ Firebase</div></div>
    <div class="hdr-c"><button class="nb" onclick="navW(-1)">‚Äπ</button><span id="hd" onclick="openCalModal()" title="Ouvrir le calendrier" style="cursor:pointer"></span><button class="nb" onclick="navW(1)">‚Ä∫</button></div>
    <div class="ha">
      <button class="ib" id="bL" onclick="togV('list')" title="Liste du jour">‚ò∞</button>
      <button class="ib" id="bP" onclick="togV('patients')" title="Patients">üë•</button>
      <button class="ib" onclick="openDashboard()" title="Tableau de bord">üè†</button>
      <button class="ib" onclick="openStats()" title="Statistiques">üìä</button>
      <button class="ib" onclick="openGroup()" title="Groupe sp√©cial du jour">üèãÔ∏è</button>
      <button class="ib" onclick="openBillingHistory()" title="Historique facturation">üí∞</button>
      <button class="ib" onclick="openVacationMode()" title="Mode vacances">üèñÔ∏è</button>
      <button class="ib" onclick="shareLink()" title="Partager lien r√©servation">üîó</button>
      <button class="ib" onclick="openSet()" title="Param√®tres">‚öô</button>
      <button class="ib" onclick="showCloseDialog()" title="Fermer">‚úï</button>
    </div>
  </div>
  <div class="wbar" id="wb"></div>
  <div id="mselBar" style="display:none;position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:2px solid var(--accent);padding:8px 12px;z-index:500;flex-wrap:wrap;gap:6px;align-items:center;box-shadow:0 -2px 10px rgba(0,0,0,.15)"></div>
  <div class="pw" id="pw"><div class="pg" id="pg"><div class="tc" id="tc"></div><div class="gl-w" id="glw"></div><div class="sa" id="sa"></div></div></div>
  <div class="lv" id="lv"></div>
  <div class="plw" id="plw"></div>
  <button class="fab" onclick="fabClick()">+</button>
</div>

<div class="mo" id="mCAL"><div class="mop"><div class="moh"></div>
  <h2>üìÖ Calendrier</h2>
  <div id="mCALB"></div>
</div></div>

<div class="mo" id="mST"><div class="mop"><div class="moh"></div>
  <h2>üìä Statistiques</h2>
  <div id="mSTB"></div>
</div></div>

<div class="toast" id="tst"></div>
<div class="ctx" id="ctx"></div>
<div class="mo" id="mA"><div class="mop"><div class="moh"></div><h2 id="mAT"></h2><div id="mAB"></div></div></div>
<div class="mo" id="mS"><div class="mop"><div class="moh"></div><h2>‚öô Param√®tres</h2><div id="mSB"></div></div></div>
<div class="mo" id="mP"><div class="mop"><div class="moh"></div><h2 id="mPT">Patient</h2><div id="mPB"></div></div></div>
<div class="mo" id="mH"><div class="mop"><div class="moh"></div><h2 id="mHT">Historique</h2><div id="mHB"></div></div></div>
<div class="mo" id="mM"><div class="mop"><div class="moh"></div><h2 id="mMT">Motif</h2><div id="mMB"></div></div></div>
<div class="mo" id="mR"><div class="mop"><div class="moh"></div><h2>üîÅ Planifier r√©currence</h2><div id="mRB"></div></div></div>

<div class="mo" id="mDelR"><div class="mop"><div class="moh"></div><h2>üóë Supprimer et occurrences</h2><div id="mDelRB"></div></div></div>
<div class="mo" id="mOCR"><div class="mop"><div class="moh"></div><h2>üì∑ Import patients OCR</h2><div id="mOCRB"></div></div></div>
<div class="mo" id="mGRP"><div class="mop"><div class="moh"></div><h2 id="mGRPT">üèãÔ∏è Groupe sp√©cial du jour</h2><div id="mGRPB"></div></div></div>

<script src="https://unpkg.com/tesseract.js@5/dist/tesseract.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging-compat.js"></script>

<script>
/* ‚ïê‚ïê‚ïê FIREBASE INIT ‚ïê‚ïê‚ïê */
const firebaseConfig = {
  apiKey: "AIzaSyDuV0ajg1O-Aw9CFFelwJlXy3_QDte7vPs",
  authDomain: "physioflow-7fcfd.firebaseapp.com",
  databaseURL: "https://physioflow-7fcfd-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "physioflow-7fcfd",
  storageBucket: "physioflow-7fcfd.firebasestorage.app",
  messagingSenderId: "1065055310692",
  appId: "1:1065055310692:web:ae35f143f6aad77b8c6071"
};
firebase.initializeApp(firebaseConfig);
const FB=firebase.database();
const FB_REF=FB.ref('physioflow');
let _fbPushLock=false;

/* ‚ïê‚ïê‚ïê FCM PUSH NOTIFICATIONS ‚ïê‚ïê‚ïê */
let _fcmMessaging=null;
function initFCM(){
  if(!('Notification' in window)||!('serviceWorker' in navigator))return;
  try{
    _fcmMessaging=firebase.messaging();
    _fcmMessaging.onMessage(function(payload){
      var n=payload.notification||{};
      var title=n.title||'PhysioFlow';
      var body=n.body||'';
      toast('üîî '+body);
      if(Notification.permission==='granted'){
        new Notification(title,{body:body,icon:'PhysioFlow.png',badge:'PhysioFlow.png'});
      }
    });
  }catch(e){console.warn('FCM init failed',e)}
}
function requestNotifPermission(){
  if(!('Notification' in window))return;
  if(Notification.permission==='granted'){
    /* Always re-register token (it can change) */
    setTimeout(registerFCMToken,1000);
    return;
  }
  if(Notification.permission==='denied')return;
  Notification.requestPermission().then(function(p){
    if(p==='granted')setTimeout(registerFCMToken,500);
  });
}
function registerFCMToken(){
  if(!_fcmMessaging)return;
  var opts={vapidKey:'BHs6QaNOKQZvDDA_-Sgwk0raMLKJ1j41KxN9Qocl3p16kWsC5SDhCdGdGDpW6o-zCFScBaClxsaBMjhPt6IbLJM'};
  if(window._swReg)opts.serviceWorkerRegistration=window._swReg;
  _fcmMessaging.getToken(opts).then(function(token){
    if(token){
      FB_REF.child('fcmTokens/pro').set(token);
      console.log('FCM token registered');
    }
  }).catch(function(e){console.warn('FCM getToken error',e)});
}
initFCM();

/* Push local data D to Firebase */
function fbPush(){
  if(_fbPushLock)return;
  _fbPushLock=true;
  var _pushNow=Date.now();
  var _pending=2; /* Two async ops: appointments transaction + full set */
  function _done(){_pending--;if(_pending<=0){_fbPushLock=false;autoBackup()}}
  try{
    /* Push config (readable by patient app) */
    FB_REF.child('config').set({
      days:D.days||[],
      motifs:(D.motifs||[]).map(function(m){return{id:m.id,label:m.label,duration:m.duration,ci:m.ci,times:m.times||[],slots:m.slots||1,allowSimul:!!m.allowSimul,simulWith:m.simulWith||'',hiddenForPatient:!!m.hiddenForPatient,description:m.description||'',slotExceptions:m.slotExceptions||{}}}),
      openings:D.openings||[],
      startH:D.startH||8,
      endH:D.endH||19,
      bookingRules:D.bookingRules||{minHoursBefore:2,maxDaysAhead:60},
      proPhone:D.proPhone||'',
      proName:D.proName||'',
      refuseNewPatients:!!(D.bookingRules&&D.bookingRules.refuseNewPatients),
      refuseNewTreatments:!!(D.bookingRules&&D.bookingRules.refuseNewTreatments),
      refuseInactiveMonths:(D.bookingRules&&D.bookingRules.refuseInactiveMonths)||3,
      vacationMode:D.vacationMode||{enabled:false,from:'',to:'',msg:''},
      waitlist:D.waitlist||[]
    });
    /* Snapshot local appointments for closure safety */
    var _localApts=JSON.parse(JSON.stringify(D.appointments||[]));
    var _localPatients=D.patients||[];
    /* Push appointments ‚Äî atomic merge, keep only very recent unprocessed patient bookings */
    FB_REF.child('appointments').transaction(function(current){
      var remoteArr=current;
      if(!Array.isArray(remoteArr))remoteArr=remoteArr?Object.values(remoteArr):[];
      var localMap={};
      _localApts.forEach(function(a){localMap[a.id]=true});
      /* Only keep patient bookings not yet processed AND created within last 60 seconds */
      var extras=remoteArr.filter(function(ra){
        if(!ra||!ra.id||localMap[ra.id])return false;
        if(ra.source!=='patient'||ra.cancelled)return false;
        var bookedAt=ra.bookedAt?new Date(ra.bookedAt).getTime():0;
        return(_pushNow-bookedAt)<60000;
      });
      var merged=_localApts.map(function(a){return{
        id:a.id,date:a.date,time:a.time,duration:a.duration,
        motifId:a.motifId||'',cancelled:!!a.cancelled,type:a.type||'rdv',
        patientId:a.patientId||'',patientName:a.patientName||'',
        patientPhone:(function(){var p=a.patientId?_localPatients.find(function(x){return x.id===a.patientId}):null;return p?p.phone:''})(),
        source:a.source||'pro'
      }}).concat(extras);
      return merged;
    }).then(function(){_done()}).catch(function(e){console.error('appointments tx error',e);_done()});
    /* Push full data */
    FB_REF.child('full').set(D).then(function(){_done()}).catch(function(){_done()});
  }catch(e){
    console.error('fbPush error',e);
    _fbPushLock=false;
  }
}

/* ‚ïê‚ïê‚ïê AUTO BACKUP ‚ïê‚ïê‚ïê */
function autoBackup(){
  try{
    var today=todayKey();
    var lastBackup=D._lastBackupDate||'';
    /* Only backup once per day max */
    if(lastBackup===today)return;
    D._lastBackupDate=today;
    try{localStorage.setItem(SK,JSON.stringify(D));}catch(e){}
    
    /* Create backup object with metadata */
    var backup={
      date:today,
      timestamp:new Date().toISOString(),
      version:24,
      stats:{
        patients:(D.patients||[]).length,
        appointments:(D.appointments||[]).length,
        motifs:(D.motifs||[]).length
      },
      data:D
    };
    /* Save to Firebase under backups/YYYY-MM-DD */
    FB_REF.child('backups/'+today).set(backup);
    /* Keep only last 30 backups: clean old ones */
    FB_REF.child('backups').once('value').then(function(snap){
      var bk=snap.val();
      if(!bk)return;
      var keys=Object.keys(bk).sort();
      if(keys.length>30){
        var toRemove=keys.slice(0,keys.length-30);
        var updates={};
        toRemove.forEach(function(k){updates[k]=null;});
        FB_REF.child('backups').update(updates);
      }
    });
  }catch(e){console.warn('autoBackup error',e)}
}

/* Manual backup download */
function downloadBackup(){
  var backup={
    exportDate:new Date().toISOString(),
    version:24,
    appData:D,
    stats:{
      patients:(D.patients||[]).length,
      appointments:(D.appointments||[]).length,
      motifs:(D.motifs||[]).length,
      openings:(D.openings||[]).length,
      groups:Object.keys(D.groups||{}).length
    }
  };
  var json=JSON.stringify(backup,null,2);
  var blob=new Blob([json],{type:'application/json'});
  var url=URL.createObjectURL(blob);
  var a=document.createElement('a');
  a.href=url;
  a.download='physioflow-backup-'+todayKey()+'.json';
  a.click();
  URL.revokeObjectURL(url);
  toast('Sauvegarde t√©l√©charg√©e ‚úì');
}

/* Restore from Firebase backup */
function showRestoreBackups(){
  FB_REF.child('backups').once('value').then(function(snap){
    var bk=snap.val();
    if(!bk){toast('Aucune sauvegarde trouv√©e');return;}
    var keys=Object.keys(bk).sort().reverse();
    var h='<h3>üîÑ Restaurer une sauvegarde</h3>'+
      '<div style="font-size:12px;color:var(--text2);margin-bottom:12px">'+keys.length+' sauvegarde(s) disponibles sur Firebase.</div>';
    keys.forEach(function(k){
      var b=bk[k];
      var st=b.stats||{};
      h+='<div style="display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg);border-radius:8px;margin-bottom:4px">'+
        '<div style="flex:1"><div style="font-weight:600;font-size:13px">'+k+'</div>'+
        '<div style="font-size:11px;color:var(--text2)">'+
          (st.patients||'?')+' patients ¬∑ '+(st.appointments||'?')+' RDV ¬∑ v'+(b.version||'?')+
        '</div></div>'+
        '<button class="btn bs" style="font-size:11px;padding:4px 10px" onclick="restoreBackup(\''+k+'\')">Restaurer</button></div>';
    });
    h+='<div class="br"><button class="btn" onclick="clM(\'mM\')">Fermer</button></div>';
    document.getElementById('mMT').textContent='üíæ Sauvegardes';
    document.getElementById('mMB').innerHTML=h;
    opM('mM');
  });
}

function restoreBackup(key){
  if(!confirm('Restaurer la sauvegarde du '+key+' ?\nCela remplacera TOUTES vos donn√©es actuelles.'))return;
  FB_REF.child('backups/'+key+'/data').once('value').then(function(snap){
    var d=snap.val();
    if(!d||!d.motifs){toast('Sauvegarde invalide');return;}
    D=d;
    try{localStorage.setItem(SK,JSON.stringify(D));}catch(e){}
    sv();if(typeof R==='function')R();
    toast('Sauvegarde du '+key+' restaur√©e ‚úì');
    clM('mM');
  });
}

/* Listen for changes from Firebase (patient bookings, or other Pro device) */
let _fbInited=false;
function fbListen(){
  FB_REF.child('full').on('value',function(snap){
    if(!_fbInited){_fbInited=true;return;} /* skip initial load */
    if(_fbPushLock)return;
    var d=snap.val();
    if(!d||!d.motifs)return;
    /* Only accept remote data if it's newer than local */
    var remoteTime=d._lastSaved||0;
    var localTime=D._lastSaved||0;
    if(remoteTime<=localTime)return;
    D=d;
    try{localStorage.setItem(SK,JSON.stringify(D));}catch(e){}
    if(typeof R==='function')R();
    toast('üîÑ Donn√©es synchronis√©es');
  });
  /* Also listen for waitlist entries */
  FB_REF.child('waitlist').on('child_added',function(snap){
    var w=snap.val();
    snap.ref.remove(); /* Toujours supprimer en premier */
    if(!w||!w.patientName)return;
    if(!D.waitlist)D.waitlist=[];
    var exists=D.waitlist.some(function(x){return x.timestamp===w.timestamp});
    if(!exists){
      D.waitlist.push(w);
      sv();
      toast('‚è≥ Nouveau sur liste d\'attente : '+w.patientName,4000);
    }
  });
/* Also listen for patient bookings specifically */
FB_REF.child('patientBookings').on('child_added',function(snap){
  var b=snap.val();

  /* TOUJOURS supprimer de Firebase en premier ‚Äî emp√™che tout re-traitement futur */
  snap.ref.remove();

  /* Entr√©e invalide ? On a d√©j√† nettoy√©, on sort. */
  if(!b || !b.id) return;

  if(!Array.isArray(D.appointments)) D.appointments=[];
  if(!Array.isArray(D.patients)) D.patients=[];

  /* Si d√©j√† import√©, ne rien faire */
  if(D.appointments.some(function(a){return a.id===b.id;})) return;

  /* Check if patient exists (by name similarity or phone), create if not */
  var pid=b.patientId||'';
  var existingPat=findMatchingPatient(
    b.patientLastName||'',
    b.patientFirstName||'',
    b.patientPhone||''
  );

  if(existingPat){
    pid=existingPat.id;
    if(!existingPat.phone && b.patientPhone) existingPat.phone=b.patientPhone;
  } else if(pid && !D.patients.some(function(p){return p.id===pid;})){
    D.patients.push({
      id:pid,
      lastName:b.patientLastName||'Patient',
      firstName:b.patientFirstName||'',
      phone:b.patientPhone||'',
      dob:'',
      notes:'R√©servation en ligne',
      sessionFee:18.20,
      billMode:'each',
      billEvery:3,
      lastBillAt:'',
      needOrdo:false,
      needMut:false,
      needSecu:false,
      rejectReason:'',
      rejectCount:0,
      documents:[]
    });
  }

  D.appointments.push({
    id:b.id,
    type:'rdv',
    motifId:b.motifId||'',
    patientId:pid,
    label:'',
    date:b.date,
    time:b.time,
    duration:b.duration||30,
    notes:'üì± R√©serv√© en ligne'+(b.patientNote?(' ‚Äî '+b.patientNote):''),
    cancelled:false,
    billed:false,
    billedAt:'',
    billedAmount:0,
    source:'patient'
  });

  sv();
  if(typeof R==='function')R();

  var _bDate=b.date,_bTime=b.time;
  toast('üì± Nouveau RDV patient en ligne ! (toucher pour voir)',5000,function(){
    cD=new Date(_bDate+'T00:00:00');
    if(typeof R==='function')R();
    setTimeout(function(){
      var mins=t2m(_bTime);
      var w=document.getElementById('pw');
      if(w)w.scrollTop=Math.max(0,((mins/60)-D.startH-0.5)*80);
    },200);
  });

  /* Browser notification */
  if('Notification' in window && Notification.permission==='granted'){
    var patN=(b.patientLastName||'')+' '+(b.patientFirstName||'');
    var dP=b.date.split('-');
    var dateFr=(dP[2]||'')+'/'+(dP[1]||'');
    var isToday=b.date===dk(new Date());
    new Notification('üì± Nouveau RDV en ligne',{
      body:patN+' ‚Äî '+dateFr+(isToday?' (aujourd\'hui)':'')+' √† '+b.time,
      icon:'PhysioFlow.png',
      tag:'booking-'+b.id,
      requireInteraction:true
    });
  }

  /* Push updated full data */
  fbPush();
});

  /* Listen for patient cancellations */
  FB_REF.child('patientCancellations').on('child_added',function(snap){
    var c=snap.val();
    snap.ref.remove(); /* Toujours supprimer de Firebase en premier */
    if(!c||!c.appointmentId)return;
    var ap=D.appointments.find(function(a){return a.id===c.appointmentId});
    if(!ap||ap.cancelled)return;
    ap.cancelled=true;
    ap.cancelledBy='patient';
    ap.cancelReason=c.reason||'';
    sv();if(typeof R==='function')R();
    var pat=ap.patientId?gp(ap.patientId):null;
    var patName=pat?(pat.lastName+' '+pat.firstName):'Patient inconnu';
    toast('üö´ Annulation patient : '+patName);
    if('Notification' in window && Notification.permission==='granted'){
      var dP2=ap.date.split('-');var dateFr2=(dP2[2]||'')+'/'+(dP2[1]||'');
      var isToday2=ap.date===dk(new Date());
      new Notification('üö´ Annulation patient',{
        body:patName+' ‚Äî '+dateFr2+(isToday2?' (aujourd\'hui)':'')+' √† '+ap.time+'\nMotif : '+(c.reason||'Non pr√©cis√©'),
        icon:'PhysioFlow.png',
        tag:'cancel-'+c.appointmentId,
        requireInteraction:true
      });
    }
    fbPush();
  });
}
fbListen();

/* ‚ïê‚ïê‚ïê STORAGE ‚ïê‚ïê‚ïê */
const SK='physioflow_v3';
const CL=[
  {css:'mc0',bg:'var(--c0bg)',bd:'var(--c0)',lb:'Bleu'},
  {css:'mc1',bg:'var(--c1bg)',bd:'var(--c1)',lb:'Orange'},
  {css:'mc2',bg:'var(--c2bg)',bd:'var(--c2)',lb:'Violet'},
  {css:'mc3',bg:'var(--c3bg)',bd:'var(--c3)',lb:'Rose'},
  {css:'mc4',bg:'var(--c4bg)',bd:'var(--c4)',lb:'Vert'},
  {css:'mc5',bg:'var(--c5bg)',bd:'var(--c5)',lb:'Jaune'}
];
function defD(){return{days:[1,4],motifs:[
  {id:'reeduc',label:'R√©√©ducation Active',duration:45,ci:0,times:[]},
  {id:'premiere',label:'Premi√®re S√©ance',duration:30,ci:1,times:[]},
  {id:'soin',label:'Soin Kin√© Classique',duration:20,ci:2,times:[]},
  {id:'ondes',label:'Ondes de Choc',duration:10,ci:3,times:[]}
],openings:[
  {day:1,start:'08:45',end:'12:35'},{day:1,start:'13:15',end:'18:40'},
  {day:4,start:'08:45',end:'12:35'},{day:4,start:'13:15',end:'18:40'}
],appointments:[],patients:[],bilanFee:30,startH:8,endH:19,bookingRules:{minHoursBefore:2,maxDaysAhead:60},proPhone:'',proName:'',billsPerDay:3}}

let D;
var _loadedFromDefaults=false;
try{const r=localStorage.getItem(SK);
  if(r){
    D=JSON.parse(r);
  } else {
    D=defD();
    _loadedFromDefaults=true;
  }
    // migrations / defaults
    if(D.bilanFee===undefined)D.bilanFee=30;
    if(!Array.isArray(D.patients))D.patients=[];
    D.patients.forEach(function(p){
      if(p.sessionFee===undefined)p.sessionFee=18.20;
      if(!p.billMode)p.billMode='each';
      if(p.billEvery===undefined)p.billEvery=3;
      if(!p.lastBillAt)p.lastBillAt='';
      if(p.needSecu===undefined)p.needSecu=false;
      if(p.rejectReason===undefined)p.rejectReason='';
      if(p.rejectCount===undefined)p.rejectCount=0;
      /* Migration: cool patients get tutoie=true */
      if(p.cool&&p.tutoie===undefined)p.tutoie=true;
      /* Casse normalization: NOM en majuscules, Pr√©nom en Title Case */
      if(p.lastName)p.lastName=p.lastName.toUpperCase();
      if(p.firstName)p.firstName=toTitleCase(p.firstName);
    });
    if(!Array.isArray(D.appointments))D.appointments=[];
    D.appointments.forEach(function(a){
      if(a.billed===undefined)a.billed=false;
      if(a.billedAt===undefined)a.billedAt='';
      if(a.billedAmount===undefined)a.billedAmount=0;
      if(a.isBilan===undefined)a.isBilan=(a.type==='bilan');
      if(a.type==='bilan')a.isBilan=true;
    });
if(!D.patients)D.patients=[];if(!D.startH)D.startH=8;if(!D.endH)D.endH=19;if(!Array.isArray(D.days)||!D.days.length)D.days=[1,4];D.days=[...new Set(D.days.map(Number))].filter(d=>d>=0&&d<=6);if(!D.days.length)D.days=[1,4];D.motifs.forEach((m,i)=>{if(m.ci===undefined)m.ci=i%6;if(!Array.isArray(m.times))m.times=[];m.times=m.times.filter(Boolean)})}catch(e){D=defD();_loadedFromDefaults=true}

/* If loaded from defaults (localStorage empty), try to recover from Firebase */
if(_loadedFromDefaults){
  FB_REF.child('full').once('value').then(function(snap){
    var d=snap.val();
    if(d && d.motifs && d.motifs.length>0){
      D=d;
      D._lastSaved=Date.now();
      _loadedFromDefaults=false;
      try{localStorage.setItem(SK,JSON.stringify(D));}catch(e){}
      if(typeof R==='function')R();
      toast('üîÑ Donn√©es restaur√©es depuis Firebase',4000);
    }
  }).catch(function(){});
}

function sv(){
  D._lastSaved=Date.now();
  localStorage.setItem(SK,JSON.stringify(D));
  /* Only push to Firebase if we have real data (not defaults) */
  if(!_loadedFromDefaults || (D.patients && D.patients.length>0) || (D.appointments && D.appointments.length>0)){
    fbPush();
  }
}

/* ‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê */
let cD=new Date(),vM='grid',selId=null;
/* Multi-select */
var MSEL={active:false,ids:[],type:'appointments'}; /* type: 'appointments' or 'patients' */
function toggleMultiSel(type){
  if(type)MSEL.type=type;
  MSEL.active=!MSEL.active;MSEL.ids=[];
  renderMultiSelBar();
  if(MSEL.type==='patients')rPats();else R();
}
function toggleMSelItem(id){
  var idx=MSEL.ids.indexOf(id);
  if(idx>=0)MSEL.ids.splice(idx,1);else MSEL.ids.push(id);
  renderMultiSelBar();
}
function renderMultiSelBar(){
  var bar=document.getElementById('mselBar');
  if(!bar)return;
  if(!MSEL.active||!MSEL.ids.length){bar.style.display='none';return;}
  bar.style.display='flex';
  var n=MSEL.ids.length;
  var h='<span style="font-size:12px;font-weight:700;margin-right:8px">'+n+' s√©lectionn√©'+(n>1?'s':'')+'</span>';
  if(MSEL.type==='appointments'){
    h+='<button class="btn bs" style="font-size:11px;padding:4px 8px" onclick="mselAction(\'late\')">‚è∞ Retard</button>';
    h+='<button class="btn bs" style="font-size:11px;padding:4px 8px" onclick="mselAction(\'cancel\')">‚ùå Annuler</button>';
    h+='<button class="btn bs" style="font-size:11px;padding:4px 8px" onclick="mselAction(\'restore\')">‚ôªÔ∏è R√©tablir</button>';
    h+='<button class="btn bs" style="font-size:11px;padding:4px 8px" onclick="mselAction(\'bill\')">üíµ Facturer</button>';
    h+='<button class="btn bs" style="font-size:11px;padding:4px 8px" onclick="mselAction(\'bilan\')">üÖ±Ô∏è Bilan</button>';
    h+='<button class="btn bd" style="font-size:11px;padding:4px 8px" onclick="mselAction(\'delete\')">üóë</button>';
  }else{
    h+='<button class="btn bs" style="font-size:11px;padding:4px 8px" onclick="mselAction(\'bill\')">üíµ Facturer</button>';
    h+='<button class="btn bs" style="font-size:11px;padding:4px 8px" onclick="mselAction(\'cool\')">üòé Cool</button>';
    h+='<button class="btn bs" style="font-size:11px;padding:4px 8px" onclick="mselAction(\'tutoie\')">Tutoyer</button>';
    h+='<button class="btn bd" style="font-size:11px;padding:4px 8px" onclick="mselAction(\'delete\')">üóë</button>';
  }
  h+='<button class="btn" style="font-size:11px;padding:4px 8px;margin-left:auto" onclick="toggleMultiSel()">‚úï</button>';
  bar.innerHTML=h;
}
function mselAction(action){
  if(!MSEL.ids.length)return;
  if(MSEL.type==='appointments'){
    if(action==='cancel'){
      var motif=prompt('Motif d\'annulation :','');
      if(motif===null)return;
      MSEL.ids.forEach(function(aid){
        var ap=D.appointments.find(function(a){return a.id===aid});
        if(ap){ap.cancelled=true;ap.cancelReason=motif;
          /* Send SMS if patient has phone */
          var pat=ap.patientId?gp(ap.patientId):null;
          if(pat&&pat.phone){
            var isTu=!!(pat.tutoie||pat.cool);
            var msg=isTu?'Salut '+pat.firstName+', ta s√©ance du '+fmtS(ap.date)+' √† '+ap.time+' est annul√©e'+(motif?' ('+motif+')':'')+'. √Ä bient√¥t !':
              'Bonjour '+pat.firstName+', votre s√©ance du '+fmtS(ap.date)+' √† '+ap.time+' est annul√©e'+(motif?' ('+motif+')':'')+'. Cordialement.';
            window.open('sms:'+pat.phone+'?body='+encodeURIComponent(msg));
          }
        }
      });
      sv();R();toast(MSEL.ids.length+' s√©ances annul√©es');
    }else if(action==='late'){
      MSEL.ids.forEach(function(aid){
        var ap=D.appointments.find(function(a){return a.id===aid});
        if(ap){var pat=ap.patientId?gp(ap.patientId):null;
          if(pat&&pat.phone){
            var isTu=!!(pat.tutoie||pat.cool);
            var msg=isTu?'Salut '+pat.firstName+', je suis en retard pour ta s√©ance. D√©sol√©, j\'arrive bient√¥t !':
              'Bonjour '+pat.firstName+', veuillez m\'excuser, je suis en retard. J\'arrive dans quelques minutes. Cordialement.';
            window.open('sms:'+pat.phone+'?body='+encodeURIComponent(msg));
          }
        }
      });
      toast('SMS de retard envoy√©s');
    }else if(action==='restore'){
      MSEL.ids.forEach(function(aid){
        var ap=D.appointments.find(function(a){return a.id===aid});
        if(ap)ap.cancelled=false;
      });sv();R();toast('S√©ances r√©tablies');
    }else if(action==='bill'){
      MSEL.ids.forEach(function(aid){
        var ap=D.appointments.find(function(a){return a.id===aid});
        if(ap&&!ap.billed){
          var pat=ap.patientId?gp(ap.patientId):null;
          ap.billed=true;ap.billedAt=todayKey();
          ap.billedAmount=(ap.isBilan||ap.type==='bilan')?(D.bilanFee||30):(pat?Number(pat.sessionFee||18.20):18.20);
        }
      });sv();R();toast('Facturation forc√©e');
    }else if(action==='bilan'){
      MSEL.ids.forEach(function(aid){
        var ap=D.appointments.find(function(a){return a.id===aid});
        if(ap)ap.isBilan=true;
      });sv();R();toast('Bilans ajout√©s');
    }else if(action==='delete'){
      if(!confirm('Supprimer '+MSEL.ids.length+' s√©ances ?'))return;
      D.appointments=D.appointments.filter(function(a){return MSEL.ids.indexOf(a.id)<0});
      sv();R();toast('S√©ances supprim√©es');
    }
  }else{/* patients */
    if(action==='bill'){
      MSEL.ids.forEach(function(pid){billPatient(pid,true)});
      toast('Facturation forc√©e');
    }else if(action==='cool'){
      MSEL.ids.forEach(function(pid){var p=gp(pid);if(p)p.cool=true});
      sv();R();rPats();toast('üòé Patients cool');
    }else if(action==='tutoie'){
      MSEL.ids.forEach(function(pid){var p=gp(pid);if(p)p.tutoie=true});
      sv();R();rPats();toast('Patients tutoy√©s');
    }else if(action==='delete'){
      if(!confirm('Supprimer '+MSEL.ids.length+' patients ?'))return;
      MSEL.ids.forEach(function(pid){
        D.patients=D.patients.filter(function(p){return p.id!==pid});
        D.appointments=D.appointments.filter(function(a){return a.patientId!==pid});
      });sv();R();rPats();toast('Patients supprim√©s');
    }
  }
  MSEL.ids=[];MSEL.active=false;renderMultiSelBar();
  if(MSEL.type==='patients')rPats();else R();
}

function monIndex(dow){return (dow+6)%7} /* Monday=0 ... Sunday=6 */
function sortDows(arr){return (arr||[]).slice().sort((a,b)=>monIndex(a)-monIndex(b))}
const DAY_S=['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'];
const DAY_L=['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'];
function daysLabel(arr){return sortDows(arr).map(d=>DAY_L[d]).join(', ')}

function ensureActiveDate(base){
  if(!Array.isArray(D.days)||!D.days.length)D.days=[1,4];
  const b=base?new Date(base):new Date(cD);
  if(D.days.includes(b.getDay())){cD=b;return}
  for(let i=0;i<14;i++){
    const t=new Date(b);t.setDate(b.getDate()+i);
    if(D.days.includes(t.getDay())){cD=t;return}
  }
  cD=b;
}
ensureActiveDate();

/* ‚ïê‚ïê‚ïê UTILS ‚ïê‚ïê‚ïê */
const dk=d=>{const y=d.getFullYear();const m=String(d.getMonth()+1).padStart(2,'0');const da=String(d.getDate()).padStart(2,'0');return y+'-'+m+'-'+da};
const t2m=t=>{const p=t.split(':').map(Number);return p[0]*60+(p[1]||0)};
const m2t=m=>String(Math.floor(m/60)).padStart(2,'0')+':'+String(m%60).padStart(2,'0');
const uid=()=>Date.now().toString(36)+Math.random().toString(36).slice(2,7);
const esc=s=>(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
const gMon=d=>{const t=new Date(d);const w=t.getDay();t.setDate(t.getDate()-(w===0?6:w-1));return t};
const same=(a,b)=>dk(a)===dk(b);
function fmt(d){const ds=['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'],ms=['janv.','f√©vr.','mars','avr.','mai','juin','juil.','ao√ªt','sept.','oct.','nov.','d√©c.'];return ds[d.getDay()]+' '+d.getDate()+' '+ms[d.getMonth()]+' '+d.getFullYear()}
function fmtS(s){const d=new Date(s+'T00:00:00');return['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'][d.getDay()]+' '+d.getDate()+'/'+(d.getMonth()+1)}
function calcAge(dob){if(!dob)return'';const b=new Date(dob),n=new Date();let a=n.getFullYear()-b.getFullYear();if(n.getMonth()<b.getMonth()||(n.getMonth()===b.getMonth()&&n.getDate()<b.getDate()))a--;return a}
function toast(m,dur,onclick){const t=document.getElementById('tst');t.textContent=m;t.classList.add('show');t.style.cursor=onclick?'pointer':'';t.onclick=onclick||null;clearTimeout(t._t);t._t=setTimeout(()=>{t.classList.remove('show');t.onclick=null;t.style.cursor=''},dur||2200)}
function opM(id){
  var mo=document.getElementById(id);
  mo.classList.add('open');
  mo.onclick=function(e){if(e.target.classList.contains('mo'))clM(id)};
  var panel=mo.querySelector('.mop');
  if(panel && !panel._swipeBound){
    panel._swipeBound=true;
    var sy=0,dragging=false;
    function onDown(e){
      var t=e.target;
      var isHandle=t.classList&&t.classList.contains('moh');
      if(!isHandle){
        var rect=panel.getBoundingClientRect();
        var y=e.touches?e.touches[0].clientY:e.clientY;
        if(y-rect.top>36||panel.scrollTop>4)return;
      }
      sy=e.touches?e.touches[0].clientY:e.clientY;
      dragging=true;panel.style.transition='none';
    }
    function onMove(e){
      if(!dragging)return;
      var cy=e.touches?e.touches[0].clientY:e.clientY;
      var dy=cy-sy;if(dy<0)dy=0;
      panel.style.transform='translateY('+dy+'px)';
    }
    function onUp(e){
      if(!dragging)return;dragging=false;
      var cy=e.changedTouches?e.changedTouches[0].clientY:(e.clientY||0);
      var dy=cy-sy;panel.style.transition='';
      if(dy>100)clM(id);else panel.style.transform='';
    }
    panel.addEventListener('touchstart',onDown,{passive:true});
    panel.addEventListener('touchmove',onMove,{passive:false});
    panel.addEventListener('touchend',onUp,{passive:true});
    panel.addEventListener('mousedown',onDown);
    window.addEventListener('mousemove',onMove);
    window.addEventListener('mouseup',onUp);
  }
}
function clM(id){var mo=document.getElementById(id);var p=mo.querySelector('.mop');if(p)p.style.transform='';mo.classList.remove('open')}
const gp=id=>D.patients.find(p=>p.id===id);
function toTitleCase(s){return(s||'').toLowerCase().replace(/(?:^|\s|-)\S/g,function(c){return c.toUpperCase()})}
const gm=id=>D.motifs.find(m=>m.id===id);
function alrt(p){
  if(!p)return'';
  let h='';
  if(p.needOrdo)h+='<span class="emji" data-info="Ordonnance manquante" onclick="event.stopPropagation();showInfoBubble(this)">‚ùó</span>';
  if(p.needMut||p.needSecu){
    const t=(p.needMut&&p.needSecu)?'Rejet Mutuelle + S√©cu':(p.needMut?'Rejet Mutuelle':'Rejet S√©cu');
    h+='<span class="emji" data-info="'+t+(p.rejectReason?' ‚Äî '+esc(p.rejectReason):'')+'" onclick="event.stopPropagation();showInfoBubble(this)">‚ÄºÔ∏è</span>';
  }
  if(p.cool)h+='<span class="emji">üòé</span>';
  return h;
}

/* Session counter */
function getSessionCount(pid){
  var p=gp(pid);if(!p)return{done:0,total:0,label:'',needsRenewal:false};
  var apts=(D.appointments||[]).filter(function(a){return a.patientId===pid&&!a.cancelled&&a.type!=='absence'&&a.date<=todayKey()});
  var done=apts.length+(parseInt(p.sessionsBeforeApp)||0);
  var prescribed=parseInt(p.prescribedSessions)||0; /* 0 = illimit√© */
  var renewAfterSessions=parseInt(p.renewAfterSessions)||0;
  var renewAfterMonths=parseInt(p.renewAfterMonths)||0;
  var needsRenewal=false;
  var label='';
  
  if(prescribed>0){
    label=done+'/'+prescribed;
    if(done>=prescribed-2)needsRenewal=true; /* alert 2 sessions before end */
  } else {
    label=done+(done<2?' s√©ance':' s√©ances');
    /* Illimit√©: check renewal thresholds */
    if(renewAfterSessions>0 && done>=renewAfterSessions)needsRenewal=true;
    if(renewAfterMonths>0 && apts.length>0){
      var firstApt=apts.sort(function(a,b){return a.date.localeCompare(b.date)})[0];
      var firstDate=new Date(firstApt.date+'T00:00:00');
      var monthsSince=Math.floor((new Date()-firstDate)/(30.44*24*60*60*1000));
      if(monthsSince>=renewAfterMonths)needsRenewal=true;
    }
  }
  return{done:done,total:prescribed,label:label,needsRenewal:needsRenewal};
}

/* ‚ïê‚ïê‚ïê BILLING ‚ïê‚ïê‚ïê */
function setBilanFee(v){D.bilanFee=parseFloat(v)||0;sv();R();toast('Montant bilan enregistr√©')}
function money(v){return (Math.round((v+Number.EPSILON)*100)/100).toFixed(2).replace('.',',')+'‚Ç¨'}
function todayKey(){return dk(new Date())}
function dKeyToFr(k){
  if(!k||typeof k!=='string')return '';
  const p=k.split('-'); if(p.length!==3)return k;
  return (p[2]+'/'+p[1]+'/'+p[0]);
}
function apHasBilan(ap){
  if(!ap||!ap.id||!ap.patientId)return false;
  return D.appointments.some(a=>a.type==='bilan' && (a.parentApId===ap.id) && !a.cancelled);
}
function isBillable(ap){
  if(!ap)return false;
  if(ap.cancelled)return false;
  if(ap.type==='absence')return false;
  return ap.date<=todayKey();
}
function apAmount(ap,pat){
  if(ap.isBilan||ap.type==='bilan')return Number(D.bilanFee||0);
  return Number((pat&&pat.sessionFee!==undefined)?pat.sessionFee:18.20);
}
function unbilledApps(pid){
  const t=todayKey();
  return D.appointments.filter(a=>a.patientId===pid && !a.billed && !a.cancelled && a.type!=='absence' && a.date<=t);
}
function unbilledCount(pid){return unbilledApps(pid).length}
function unbilledAmount(pid){
  const p=gp(pid);if(!p)return 0;
  return unbilledApps(pid).reduce((s,a)=>s+apAmount(a,p),0);
}
/* Patient has alerts (ordonnance, mutuelle, s√©cu) - should NOT get üíµ */
function patHasAlert(p){
  if(!p)return false;
  return !!(p.needOrdo || p.needMut || p.needSecu);
}
/* billDue: used as secondary criterion - respects patient frequency */
function billDue(pid){
  const p=gp(pid);if(!p)return false;
  const n=unbilledCount(pid);
  if(n<=0)return false;
  if(p.billMode==='each')return true;
  const every=Math.max(1,parseInt(p.billEvery)||1);
  return n>=every;
}

/* ‚ïê‚ïê‚ïê SIMPLIFIED DAILY BILLING SYSTEM ‚ïê‚ïê‚ïê */
function computeDayBills(dateKey){
  if(!D.billsPerDay || D.billsPerDay<1) return new Set();
  var dayAps=D.appointments.filter(function(a){
    return a.date===dateKey && !a.cancelled && a.type!=='absence' && a.patientId;
  }).sort(function(a,b){return t2m(a.time)-t2m(b.time)});
  if(!dayAps.length) return new Set();
  
  /* Get unique patients for this day */
  var seen={};var dayPats=[];
  for(var i=0;i<dayAps.length;i++){
    var ap=dayAps[i];
    if(seen[ap.patientId])continue;
    seen[ap.patientId]=true;
    var p=gp(ap.patientId);
    if(!p) continue;
    if(patHasAlert(p)) continue;
    var ub=unbilledCount(p.id);
    if(ub<=0) continue;
    dayPats.push({pid:p.id, ap:ap, time:t2m(ap.time), end:t2m(ap.time)+(ap.duration||30), unbilled:ub});
  }
  
  var maxBills=Math.min(D.billsPerDay, dayPats.length);
  if(maxBills<=0) return new Set();
  
  /* Sort by unbilled count descending (most needy first) */
  dayPats.sort(function(a,b){return b.unbilled-a.unbilled});
  
  /* Select candidates respecting simultaneous constraint: max 2 üíµ for overlapping slots */
  var selected=[];
  for(var j=0;j<dayPats.length&&selected.length<maxBills;j++){
    var cand=dayPats[j];
    /* Count how many already-selected overlap with this candidate */
    var overlapCount=0;
    for(var k=0;k<selected.length;k++){
      var s=selected[k];
      if(cand.time<s.end && cand.end>s.time)overlapCount++;
    }
    if(overlapCount>=2)continue; /* skip: already 2 üíµ in this time window */
    selected.push(cand);
  }
  
  var result=new Set();
  selected.forEach(function(c){result.add(c.pid)});
  return result;
}

/* Get today's bill set (cached per render cycle) */
var _billCache={key:'',set:new Set()};
function getTodayBillSet(){
  var k=todayKey();
  if(_billCache.key!==k){
    _billCache.key=k;
    _billCache.set=computeDayBills(k);
  }
  return _billCache.set;
}
/* Invalidate cache on data change */
function invalidateBillCache(){_billCache.key='';}

function billEmoji(pid,force){
  if(!pid)return '';
  const p=gp(pid);if(!p)return '';
  if(patHasAlert(p))return ''; /* Never show üíµ for patients with alerts */
  if(unbilledCount(pid)<=0)return '';
  var billSet=getTodayBillSet();
  var due=force? true : billSet.has(pid);
  if(!due)return '';
  return '<span class="emji" title="Facturation propos√©e" onclick="event.stopPropagation();billPatient(\''+pid+'\',false)">üíµ</span>';
}
function triEmoji(pid){
  const n=unbilledCount(pid);
  if(n<=0)return '';
  var tri='üî∫';
  if(n>=21)tri='üî∫üî∫üî∫üî∫';
  else if(n>=11)tri='üî∫üî∫üî∫';
  else if(n>=6)tri='üî∫üî∫';
  return '<span class="emji" data-info="'+n+' s√©ance'+(n>1?'s':'')+' non factur√©e'+(n>1?'s':'')+'" onclick="event.stopPropagation();showInfoBubble(this)">'+tri+'</span>';
}
function docEmoji(pid){
  const p=gp(pid);if(!p)return '';
  if(p.documents&&p.documents.length>0)return '<span class="emji" data-info="'+p.documents.length+' document'+(p.documents.length>1?'s':'')+' joint'+(p.documents.length>1?'s':'')+'" onclick="event.stopPropagation();showInfoBubble(this)">üìé</span>';
  return '';
}
function billedTodayEmoji(pid){
  var tk=todayKey();
  var billedToday=(D.appointments||[]).some(function(a){return a.patientId===pid&&a.billed&&a.billedAt===tk});
  if(billedToday)return '<span class="emji" data-info="Factur√©(e) aujourd\'hui" onclick="event.stopPropagation();showInfoBubble(this)">üí∞</span>';
  return '';
}
function renewEmoji(pid){
  var sc=getSessionCount(pid);
  if(sc.needsRenewal)return '<span class="emji" data-info="Renouvellement ordonnance recommand√© ('+sc.label+')" onclick="event.stopPropagation();showInfoBubble(this)">üìã</span>';
  return '';
}
/* Info bubble */
function showInfoBubble(el){
  var msg=el.dataset.info;if(!msg)return;
  var old=document.getElementById('_infoBub');if(old)old.remove();
  var bub=document.createElement('div');bub.id='_infoBub';
  bub.style.cssText='position:fixed;z-index:9999;background:#1a1a2e;color:#fff;font-size:12px;padding:6px 12px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.3);pointer-events:none;max-width:220px;text-align:center';
  bub.textContent=msg;
  document.body.appendChild(bub);
  var r=el.getBoundingClientRect();
  bub.style.left=Math.max(8,Math.min(r.left,window.innerWidth-230))+'px';
  bub.style.top=Math.max(8,r.top-36)+'px';
  setTimeout(function(){bub.remove()},5000);
}
function allEmojis(pid){
  return triEmoji(pid)+renewEmoji(pid)+docEmoji(pid)+billedTodayEmoji(pid)+billEmoji(pid,false);
}
function billPatient(pid,force){
  const p=gp(pid);if(!p)return;
  const aps=unbilledApps(pid);
  if(!aps.length){toast('Aucune s√©ance √† facturer');return}
  const sum=aps.reduce((s,a)=>s+apAmount(a,p),0);
  if(!confirm('Facturer '+aps.length+' s√©ance(s) pour '+esc(p.lastName)+' '+esc(p.firstName)+' : '+money(sum)+' ?'))return;
  const t=todayKey();
  aps.forEach(a=>{a.billed=true;a.billedAt=t;a.billedAmount=apAmount(a,p)});
  p.lastBillAt=t;
  /* If forced on a non-üíµ patient, swap out the least-needy üíµ patient */
  var billSet=getTodayBillSet();
  if(force && !billSet.has(pid) && billSet.size>0){
    /* Find the üíµ patient with least unbilled to remove */
    var minPid=null,minUb=Infinity;
    billSet.forEach(function(bpid){
      if(bpid===pid)return;
      var ub=unbilledCount(bpid);
      if(ub<minUb){minUb=ub;minPid=bpid;}
    });
    /* We just invalidate cache so it recalculates */
  }
  invalidateBillCache();
  sv();R();
  toast('Factur√© : '+money(sum));
}
function toggleBillOne(apId){
  const ap=D.appointments.find(a=>a.id===apId);if(!ap)return;
  const p=ap.patientId?gp(ap.patientId):null;
  if(!p){toast('Patient introuvable');return}
  if(!isBillable(ap)){toast('S√©ance non facturable');return}
  ap.billed=!ap.billed;
  ap.billedAt=ap.billed?todayKey():'';
  ap.billedAmount=ap.billed?apAmount(ap,p):0;
  invalidateBillCache();
  sv();R();
}
function totalUnbilledAmount(){
  return D.patients.reduce((s,p)=>s+unbilledAmount(p.id),0);
}

/* ‚ïê‚ïê‚ïê END-OF-DAY CARRY-OVER ‚ïê‚ïê‚ïê */
/* Check if yesterday's üíµ were ignored and carry them over */
function checkBillCarryOver(){
  var today=new Date();
  var lastCheck=D._lastBillCheck||'';
  var todayK=dk(today);
  if(lastCheck===todayK)return; /* Already checked today */
  D._lastBillCheck=todayK;
  /* Find last open day before today */
  var prevDate=new Date(today);
  for(var i=1;i<30;i++){
    prevDate.setDate(prevDate.getDate()-1);
    if(D.days.includes(prevDate.getDay())){break;}
  }
  var prevK=dk(prevDate);
  var prevBills=computeDayBills(prevK);
  /* Find which üíµ patients from prevDay were NOT billed on that day */
  var carry=[];
  prevBills.forEach(function(pid){
    var wasBilled=D.appointments.some(function(a){
      return a.patientId===pid && a.date===prevK && a.billed && !a.cancelled;
    });
    if(!wasBilled) carry.push(pid);
  });
  D._billCarryOver=carry;
  sv();
}

/* ‚ïê‚ïê‚ïê PATIENT NAME NORMALIZATION & AUTO-MERGE ‚ïê‚ïê‚ïê */
function normName(s){
  if(!s)return '';
  return s.toLowerCase().trim()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'') /* remove accents */
    .replace(/[-_'']/g,' ') /* normalize separators */
    .replace(/\s+/g,' '); /* collapse spaces */
}
function namesMatch(ln1,fn1,ln2,fn2){
  var a1=normName(ln1),b1=normName(fn1);
  var a2=normName(ln2),b2=normName(fn2);
  if(!a1||!b1||!a2||!b2)return false;
  /* Direct match */
  if(a1===a2 && b1===b2) return true;
  /* Swapped name/firstName */
  if(a1===b2 && b1===a2) return true;
  /* Fuzzy: check if one is contained in the other (for compound names) */
  if((a1.includes(a2)||a2.includes(a1)) && (b1.includes(b2)||b2.includes(b1))) return true;
  if((a1.includes(b2)||b2.includes(a1)) && (b1.includes(a2)||a2.includes(b1))) return true;
  return false;
}
function findMatchingPatient(lastName,firstName,phone){
  var phoneDig=phone?phone.replace(/\D/g,''):'';
  for(var i=0;i<D.patients.length;i++){
    var p=D.patients[i];
    /* Match by phone first (strongest signal) */
    if(phoneDig && phoneDig.length>=8 && p.phone){
      var pDig=p.phone.replace(/\D/g,'');
      if(pDig===phoneDig || pDig.endsWith(phoneDig) || phoneDig.endsWith(pDig)){
        return p;
      }
    }
    /* Match by name */
    if(namesMatch(lastName,firstName,p.lastName,p.firstName)){
      return p;
    }
  }
  return null;
}
/* Merge: reassign all appointments from oldPid to newPid and remove old patient */
function mergePatients(keepPid,removePid){
  if(keepPid===removePid)return;
  D.appointments.forEach(function(a){
    if(a.patientId===removePid) a.patientId=keepPid;
  });
  D.patients=D.patients.filter(function(p){return p.id!==removePid});
}

function ini(p){return((p.lastName||'?')[0]+(p.firstName||'?')[0]).toUpperCase()}

/* ‚ïê‚ïê‚ïê RENDER ‚ïê‚ïê‚ïê */
var _rTimer=null;
function R(){
  if(_rTimer)clearTimeout(_rTimer);
  _rTimer=setTimeout(_doR,100);
}
function _doR(){_rTimer=null;invalidateBillCache();rWB();
  document.getElementById('pw').classList.toggle('off',vM!=='grid');
  document.getElementById('lv').classList.toggle('on',vM==='list');
  document.getElementById('plw').classList.toggle('on',vM==='patients');
  document.getElementById('bL').classList.toggle('on',vM==='list');
  document.getElementById('bP').classList.toggle('on',vM==='patients');
  if(vM==='grid'){rGrid();rAps()}else if(vM==='list')rList();else if(vM==='patients')rPats();}

function rWB(){
  const mon=gMon(cD);const today=new Date();const L=['L','M','M','J','V','S','D'];
  let h='';for(let i=0;i<7;i++){const d=new Date(mon);d.setDate(d.getDate()+i);const w=d.getDay();const ok=D.days.includes(w);
    h+='<div class="wd'+(same(d,cD)?' act':'')+(ok?'':' dis')+(same(d,today)?' tod':'')+'" data-date="'+dk(d)+'" onclick="selD(\''+dk(d)+'\')"><div class="wl">'+L[i]+'</div><div class="wn">'+d.getDate()+'</div></div>'}
  document.getElementById('wb').innerHTML=h;
  document.getElementById('hd').textContent=fmt(cD);
}
function selD(k){const p=k.split('-').map(Number);const n=new Date(p[0],p[1]-1,p[2]);if(!D.days.includes(n.getDay()))return;cD=n;R();scrollNow()}
function navW(dir){
  const base=new Date(cD);
  base.setDate(base.getDate()+dir*7);
  const mon=gMon(base);
  const allowed=sortDows(D.days);
  const curDow=cD.getDay();
  const chosen=D.days.includes(curDow)?curDow:(allowed.length?allowed[0]:1);
  const target=new Date(mon);
  target.setDate(mon.getDate()+monIndex(chosen));
  cD=target;
  sv();
  R();
  scrollNow();
}
function togV(v){vM=vM===v?'grid':v;R()}
/* Navigate to next/prev opening day */
function navOpenDay(dir){
  var d=new Date(cD);
  for(var i=0;i<14;i++){
    d.setDate(d.getDate()+dir);
    if(D.days.includes(d.getDay())){cD=d;R();scrollNow();return}
  }
}

/* ‚ïê‚ïê‚ïê SWIPE NAVIGATION ‚ïê‚ïê‚ïê */
(function(){
  var startX=0,startY=0,swiping=false;
  var pw=document.getElementById('pw');
  var wb=document.getElementById('wb');
  
  function handleTouchStart(e){
    startX=e.touches[0].clientX;
    startY=e.touches[0].clientY;
    swiping=true;
  }
  function handleTouchEnd(e){
    if(!swiping)return;
    swiping=false;
    var dx=e.changedTouches[0].clientX-startX;
    var dy=e.changedTouches[0].clientY-startY;
    if(Math.abs(dx)>60 && Math.abs(dx)>Math.abs(dy)*1.5){
      navOpenDay(dx>0?-1:1);
    }
  }
  wb.addEventListener('touchstart',handleTouchStart,{passive:true});
  wb.addEventListener('touchend',handleTouchEnd,{passive:true});
  /* Also swipe on main agenda area */
  if(pw){
    pw.addEventListener('touchstart',handleTouchStart,{passive:true});
    pw.addEventListener('touchend',handleTouchEnd,{passive:true});
  }
})();

/* ‚îÄ‚îÄ GRID ‚îÄ‚îÄ */
function rGrid(){
  const sh=D.startH,eh=D.endH,th=eh-sh,gh=th*80;
  document.getElementById('pg').style.minHeight=gh+'px';
  
  /* Time labels - LEFT COLUMN */
  let tH='';
  for(let h=sh;h<=eh;h++){
    const top=(h-sh)*80;
    tH+='<div class="tl" style="top:'+top+'px">'+String(h).padStart(2,'0')+':00</div>';
  }
  document.getElementById('tc').innerHTML=tH;
  
  /* Grid lines - STRONG CONTRAST */
  let lH='';
  for(let h=sh;h<=eh;h++){
    const top=(h-sh)*80;
    lH+='<div class="gl full" style="top:'+top+'px"></div>';
    if(h<eh){
      lH+='<div class="gl half" style="top:'+(top+40)+'px"></div>';
      lH+='<div class="gl quarter" style="top:'+(top+20)+'px"></div>';
      lH+='<div class="gl quarter" style="top:'+(top+60)+'px"></div>';
    }
  }
  document.getElementById('glw').innerHTML=lH;
  
  /* Openings + now line */
  const dow=cD.getDay(),ops=D.openings.filter(o=>o.day===dow);
  let oH='';for(const o of ops){const s=t2m(o.start),e=t2m(o.end),top=((s/60)-sh)*80,ht=((e-s)/60)*80;oH+='<div class="op" style="top:'+top+'px;height:'+ht+'px"></div>'}
  const now=new Date();
  if(same(now,cD)){
    const nm=now.getHours()*60+now.getMinutes(),top=((nm/60)-sh)*80;
    if(top>=0&&top<=gh){
      oH+='<div class="nl" style="top:'+top+'px"><span class="nl-time">'+m2t(nm)+'</span></div>';
    }
  }
  document.getElementById('sa').innerHTML=oH;
}

function rAps(){
  const area=document.getElementById('sa');
  const key=dk(cD),dayA=D.appointments.filter(a=>a.date===key).sort((a,b)=>t2m(a.time)-t2m(b.time));
  
  /* Remove any existing appointment elements */
  area.querySelectorAll('.ap').forEach(el=>el.remove());
  
  if(!dayA.length)return;
  
  /* overlap columns - improved for short/close appointments */
  const grps=[];
  for(const ap of dayA){const s=t2m(ap.time),e=s+ap.duration;let placed=false;
    for(const g of grps){if(s<g.end){g.items.push(ap);g.end=Math.max(g.end,e);placed=true;break}}
    if(!placed)grps.push({items:[ap],end:e})}
  for(const g of grps){const cols=[];for(const ap of g.items){const s=t2m(ap.time),e=s+ap.duration;let c=0;while(cols[c]&&cols[c]>s)c++;cols[c]=e;ap._c=c}const tc=cols.length;g.items.forEach(a=>a._tc=tc)}
  
  const sh=D.startH;
  const MIN_HT=22; /* minimum height in px */
  
  for(const ap of dayA){
    const s=t2m(ap.time);
    const top=((s/60)-sh)*80;
    const rawHt=(ap.duration/60)*80;
    const ht=Math.max(rawHt,MIN_HT);
    const cw=100/(ap._tc||1),left=(ap._c||0)*cw;
    const mot=gm(ap.motifId),pat=ap.patientId?gp(ap.patientId):null;
    const isAbs=ap.type==='absence';
    const cc=isAbs?'abs':(mot?CL[mot.ci%6].css:'mc0');
    let name=isAbs?(ap.label||'Absence'):(pat?(pat.lastName+' '+pat.firstName):(ap.label||'?'));if(ap.type==='bilan'||ap.isBilan)name+=' üÖ±Ô∏è'; else if(apHasBilan(ap))name+=' üÖ±Ô∏è';
    const al=pat?alrt(pat):'';const mL=mot?mot.label:'';
    const isVeryShort=ht<22; /* truly tiny: must blink */
    const isShort=ht<36 && !isVeryShort; /* short but can fit small text */
    const el=document.createElement('div');
    el.className='ap '+cc+(ap.cancelled?' cncl':'')+(isVeryShort?' vshort':'')+(isShort?' short':'');
    el.style.cssText='top:'+top+'px;height:'+ht+'px;left:'+left+'%;width:'+(cw-.4)+'%';
    el.dataset.id=ap.id;
    if(isVeryShort){
      el.innerHTML='<span class="an" style="position:relative"><span class="blink-name">'+(pat?allEmojis(pat.id):'')+esc(name)+al+'</span><span class="blink-time" style="font-family:JetBrains Mono,monospace;font-size:10px">'+ap.time+'‚Äì'+m2t(s+ap.duration)+'</span></span>';
    } else if(isShort){
      el.innerHTML='<span class="an" style="font-size:10px">'+(pat?allEmojis(pat.id):'')+esc(name)+al+'</span><span class="at" style="font-size:9px">'+ap.time+'‚Äì'+m2t(s+ap.duration)+'</span>';
    } else {
      el.innerHTML='<span class="an">'+(pat?allEmojis(pat.id):'')+esc(name)+al+'</span>'+(mL&&ht>22?'<span class="am">'+esc(mL)+'</span>':'')+(ht>=36?'<span class="at">'+ap.time+'‚Äì'+m2t(s+ap.duration)+'</span>':'');
    }
    el.onclick=function(e){
      if(MSEL.active&&MSEL.type==='appointments'){toggleMSelItem(ap.id);el.classList.toggle('msel-on');return;}
      showCtx(e,ap.id)
    };
    el.oncontextmenu=function(e){e.preventDefault();if(!MSEL.active){MSEL.active=true;MSEL.ids=[];MSEL.type='appointments';}toggleMSelItem(ap.id);el.classList.toggle('msel-on');renderMultiSelBar();};
    area.appendChild(el);
  }
}

/* ‚îÄ‚îÄ LIST ‚îÄ‚îÄ */
function rList(){
  const el=document.getElementById('lv');const key=dk(cD);
  const dayA=D.appointments.filter(a=>a.date===key).sort((a,b)=>t2m(a.time)-t2m(b.time));
  if(!dayA.length){el.innerHTML='<div style="text-align:center;padding:40px;color:var(--text2)"><div style="font-size:32px;margin-bottom:8px">üìã</div>Aucun rendez-vous</div>';return}
  var _billedTodayN=(D.appointments||[]).filter(function(a){return a.billed&&a.billedAt===key}).length;
  let h='<div style="padding:6px 10px;font-size:11px;color:var(--text2);display:flex;justify-content:space-between"><span>'+dayA.length+' s√©ance(s)</span><span>üí∞ '+_billedTodayN+' factur√©e(s) aujourd\'hui</span></div>';
  for(const ap of dayA){
    const mot=gm(ap.motifId),pat=ap.patientId?gp(ap.patientId):null;
    const isAbs=ap.type==='absence';const ci2=mot?mot.ci:0;
    const cv=isAbs?'var(--absence)':CL[ci2%6].bd;
    let name=isAbs?(ap.label||'Absence'):(pat?(pat.lastName+' '+pat.firstName):(ap.label||'?'));if(ap.type==='bilan'||ap.isBilan)name+=' üÖ±Ô∏è'; else if(apHasBilan(ap))name+=' üÖ±Ô∏è';
    var _scHtml='';if(pat){var _scL=getSessionCount(pat.id);if(_scL.label)_scHtml=' <span style="font-size:10px;color:var(--text3)">('+_scL.label+')</span>';}    const al=pat?alrt(pat):'';const mL=mot?mot.label:'';
    h+='<div class="li'+(ap.cancelled?' cncl':'')+(isAbs?' abs':'')+'" style="border-left-color:'+cv+'" onclick="if(MSEL.active&&MSEL.type===\'appointments\'){toggleMSelItem(\''+ap.id+'\');this.classList.toggle(\'msel-on\');return;}showCtx(event,\''+ap.id+'\')" oncontextmenu="event.preventDefault();if(!MSEL.active){MSEL.active=true;MSEL.ids=[];MSEL.type=\'appointments\';}toggleMSelItem(\''+ap.id+'\');this.classList.toggle(\'msel-on\');renderMultiSelBar();">';
    h+='<div class="lt">'+ap.time+'</div><div class="lb"><div class="ln">'+(pat?allEmojis(pat.id):'')+esc(name)+_scHtml+al+'</div><div class="lm">'+esc(mL)+' ¬∑ '+ap.duration+'min</div></div></div>'}
  el.innerHTML=h;
}

/* ‚îÄ‚îÄ PATIENTS ‚îÄ‚îÄ */
function rPats(){
  const w=document.getElementById('plw');
  const mode=(document.getElementById('psort')&&document.getElementById('psort').value)||'az';
  const motifFlt=(document.getElementById('pMotifFlt')&&document.getElementById('pMotifFlt').value)||'';
  const futureFlt=(document.getElementById('pFutureFlt')&&document.getElementById('pFutureFlt').value)||'';
  let arr=D.patients.slice();
  var _today2=todayKey();
  /* Apply filters */
  if(motifFlt){
    arr=arr.filter(function(p){return (D.appointments||[]).some(function(a){return a.patientId===p.id&&a.motifId===motifFlt&&!a.cancelled})});
  }
  if(futureFlt==='nofuture'){
    arr=arr.filter(function(p){return !(D.appointments||[]).some(function(a){return a.patientId===p.id&&a.date>_today2&&!a.cancelled})});
  }else if(futureFlt==='hasfuture'){
    arr=arr.filter(function(p){return (D.appointments||[]).some(function(a){return a.patientId===p.id&&a.date>_today2&&!a.cancelled})});
  }else if(futureFlt==='renewal'){
    arr=arr.filter(function(p){var sc=getSessionCount(p.id);return sc.needsRenewal});
  }
  function key(p){return (p.lastName+' '+p.firstName).toLowerCase()}
  if(mode==='az')arr.sort((a,b)=>key(a).localeCompare(key(b)));
  if(mode==='za')arr.sort((a,b)=>key(b).localeCompare(key(a)));
  if(mode==='new')arr.sort((a,b)=>(b.id||'').localeCompare(a.id||'')); // uid is time-ish
  if(mode==='unb')arr.sort((a,b)=>unbilledCount(b.id)-unbilledCount(a.id));

  let h='<div style="position:sticky;top:0;z-index:5;background:var(--bg);padding-bottom:6px">'+
        '<div class="pls" style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">'+
        '<input type="text" id="psrch" placeholder="Rechercher un patient." oninput="fPats()" style="flex:1;min-width:180px">'+
        '<select id="psort" onchange="rPats()" style="height:40px;border-radius:12px;border:1px solid var(--border);background:#fff;color:var(--text);padding:0 10px">'+
          '<option value="az" '+(mode==='az'?'selected':'')+'>A ‚Üí Z</option>'+
          '<option value="za" '+(mode==='za'?'selected':'')+'>Z ‚Üí A</option>'+
          '<option value="new" '+(mode==='new'?'selected':'')+'>Ajout r√©cent</option>'+
          '<option value="unb" '+(mode==='unb'?'selected':'')+'>Non factur√©es (‚Üì)</option>'+
        '</select>'+
        '<button class="btn bp bw" onclick="openOCR()">OCR</button>'+
        '<button class="btn'+(MSEL.active&&MSEL.type==='patients'?' bp':' bs')+'" style="font-size:11px" onclick="toggleMultiSel(\'patients\')">S√©lection</button>'+
        '</div>'+
        '<div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center;margin:6px 0">'+
          '<select id="pMotifFlt" onchange="rPats()" style="height:34px;border-radius:10px;border:1px solid var(--border);background:#fff;color:var(--text);padding:0 8px;font-size:11px">'+
            '<option value="">Tous les motifs</option>'+
            D.motifs.map(function(m){return '<option value="'+m.id+'"'+(motifFlt===m.id?' selected':'')+'>'+esc(m.label)+'</option>'}).join('')+
          '</select>'+
          '<select id="pFutureFlt" onchange="rPats()" style="height:34px;border-radius:10px;border:1px solid var(--border);background:#fff;color:var(--text);padding:0 8px;font-size:11px">'+
            '<option value="" '+(futureFlt===''?'selected':'')+'>Tous</option>'+
            '<option value="nofuture" '+(futureFlt==='nofuture'?'selected':'')+'>Sans RDV futur</option>'+
            '<option value="hasfuture" '+(futureFlt==='hasfuture'?'selected':'')+'>Avec RDV futur</option>'+
            '<option value="renewal" '+(futureFlt==='renewal'?'selected':'')+'>üìã Renouvellement</option>'+
          '</select>'+
        '</div>'+
        '<div class="ub" style="padding:6px 2px">Total non factur√© (tous patients) : <b>'+money(totalUnbilledAmount())+'</b> ¬∑ Affich√©s : <b>'+arr.length+'</b></div>'+
        '</div>'+ /* end sticky */
        '<div id="pres">';
  for(const p of arr){
    const ag=p.dob?calcAge(p.dob)+'ans':'';
    const al=alrt(p);
    const ub=unbilledCount(p.id);
    const ua=unbilledAmount(p.id);
    const sc=getSessionCount(p.id);
    const scBadge=sc.needsRenewal?'<span style="color:#e74c3c;font-size:11px;font-weight:700"> üìã'+sc.label+'</span>':'<span style="font-size:11px;color:var(--text3)"> '+sc.label+'</span>';
    var _piMsel=(MSEL.active&&MSEL.type==='patients'&&MSEL.ids.indexOf(p.id)>=0)?' msel-on':'';
    h+='<div class="pi'+_piMsel+'" onclick="if(MSEL.active&&MSEL.type===\'patients\'){toggleMSelItem(\''+p.id+'\');this.classList.toggle(\'msel-on\');return;}openPC(\''+p.id+'\')">'+
        '<div class="pa">'+ini(p)+'</div>'+
        '<div class="pif">'+
          '<div class="pn">'+allEmojis(p.id)+esc(p.lastName)+' '+esc(p.firstName)+' '+al+'</div>'+
          '<div class="pd">'+ag+(p.phone?' ¬∑ '+esc(p.phone):'')+scBadge+'</div>'+
          '<div class="ub">Non factur√©es : <b>'+ub+'</b> ¬∑ <b>'+money(ua)+'</b></div>'+
        '</div>'+
      '</div>';
  }
  h+='</div>';
  w.innerHTML=h;
  fPats();
}

/* ‚ïê‚ïê‚ïê OCR IMPORT PATIENTS ‚ïê‚ïê‚ïê */
let OCR_FILES=[], OCR_CAND=[];

function openOCR(){
  const b=document.getElementById('mOCRB');
  OCR_FILES=[];OCR_CAND=[];
  b.innerHTML=
    '<p style="font-size:13px;color:var(--text2);margin:0 0 10px 0">Ajoutez une ou plusieurs captures Doctolib (liste patients). L\'OCR va d√©tecter Nom, Pr√©nom et T√©l√©phone, puis vous pourrez corriger/d√©cocher avant d\'enregistrer.</p>'+
    '<div class="fg"><label>Captures d\'√©cran</label><input type="file" id="ocrIn" accept="image/*" multiple></div>'+
    '<div id="ocrPrev" style="display:flex;gap:10px;flex-wrap:wrap;margin:8px 0"></div>'+
    '<div class="br" style="display:flex;gap:10px;flex-wrap:wrap">'+
      '<button class="btn bp bw" onclick="runOCR()">Lancer OCR</button>'+
      '<button class="btn bd" onclick="saveOCR()" disabled id="ocrSave">Valider & enregistrer</button>'+
      '<button class="btn" onclick="clM(\'mOCR\')">Fermer</button>'+
    '</div>'+
    '<div id="ocrProg" style="font-size:12px;color:var(--text2);margin-top:10px"></div>'+
    '<div id="ocrRes" style="margin-top:10px"></div>';
  opM('mOCR');
  setTimeout(function(){
    const inp=document.getElementById('ocrIn');
    inp.addEventListener('change', function(){
      OCR_FILES=[...inp.files];
      renderOCRPreviews();
    });
  },0);
}

function renderOCRPreviews(){
  const p=document.getElementById('ocrPrev'); if(!p) return;
  p.innerHTML='';
  OCR_FILES.slice(0,12).forEach(function(f){
    const r=new FileReader();
    r.onload=function(){
      const img=document.createElement('img');
      img.src=r.result;
      img.style.width='64px';img.style.height='64px';img.style.objectFit='cover';
      img.style.borderRadius='12px';img.style.border='1px solid var(--border2)';
      p.appendChild(img);
    };
    r.readAsDataURL(f);
  });
  if(OCR_FILES.length>12){
    const s=document.createElement('div');
    s.textContent='+'+(OCR_FILES.length-12);
    s.style.fontSize='13px';s.style.color='var(--text2)';
    p.appendChild(s);
  }
}

function normPhoneDigits(s){
  const d=(s||'').replace(/\D+/g,'');
  if(d.length===10 && d.startsWith('0')) return d;
  if(d.length===11 && d.startsWith('33')) return '0'+d.slice(2);
  return d.length>=9?d.slice(-10):d;
}
function fmtPhone(d){
  const x=normPhoneDigits(d);
  if(x.length!==10) return d||'';
  return x.replace(/(\d\d)(?=\d)/g,'$1 ').trim();
}
function splitLines(t){
  return (t||'').split(/\r?\n/).map(function(l){return l.replace(/\s+/g,' ').trim()}).filter(Boolean);
}
function parseNameLine(line){
  // last name = consecutive ALLCAPS tokens at start
  const toks=line.split(' ').filter(Boolean);
  if(toks.length<2) return null;
  let i=0;
  while(i<toks.length && /^[A-Z√Ä-√ñ√ò-√ù'\-]+$/.test(toks[i])) i++;
  if(i===0) return null;
  const last=toks.slice(0,i).join(' ');
  const first=toks.slice(i).join(' ');
  if(!first) return null;
  return {last:last, first:first};
}
function mergeCand(arr){
  const map={};
  arr.forEach(function(c){
    const k=(c.last+'|'+c.first+'|'+normPhoneDigits(c.phone)).toLowerCase();
    if(!map[k]) map[k]=c;
  });
  return Object.values(map);
}

async function runOCR(){
  if(!OCR_FILES.length){toast('Ajoutez au moins une image');return;}
  const prog=document.getElementById('ocrProg'); const res=document.getElementById('ocrRes');
  const saveBtn=document.getElementById('ocrSave'); if(saveBtn) saveBtn.disabled=true;
  OCR_CAND=[];
  if(typeof Tesseract==='undefined'){toast('OCR indisponible (Tesseract.js non charg√©)');return;}
  prog.textContent='OCR en cours...';
  for(let i=0;i<OCR_FILES.length;i++){
    const f=OCR_FILES[i];
    prog.textContent='OCR '+(i+1)+'/'+OCR_FILES.length+' : '+f.name;
    try{
      const out=await Tesseract.recognize(f,'fra',{
        logger:m=>{
          if(m && m.status && (m.status==='recognizing text' || m.status==='loading tesseract core')){
            prog.textContent='OCR '+(i+1)+'/'+OCR_FILES.length+' : '+Math.round((m.progress||0)*100)+'%';
          }
        }
      });
      const text=(out && out.data && out.data.text)||'';
      OCR_CAND=OCR_CAND.concat(extractPatients(text));
    }catch(e){
      console.error(e);
      toast('Erreur OCR sur une image');
    }
  }
  OCR_CAND=mergeCand(OCR_CAND);
  renderOCRResults();
  prog.textContent='OCR termin√© : '+OCR_CAND.length+' patient(s) d√©tect√©(s).';
  if(saveBtn) saveBtn.disabled = OCR_CAND.length===0;
}

function extractPatients(text){
  const lines=splitLines(text);
  const out=[];
  for(let i=0;i<lines.length;i++){
    const l=lines[i];
    // phone line
    if(/0\d(?:[ .-]?\d\d){4}/.test(l) || /\b33\s?\d/.test(l)){
      const m=l.match(/(\+?33\s?\d(?:[ .-]?\d\d){4}|0\d(?:[ .-]?\d\d){4})/);
      if(!m) continue;
      const phone=fmtPhone(m[1]);
      // name likely previous line
      const prev=lines[i-1]||'';
      const nm=parseNameLine(prev);
      if(nm){
        out.push({last:nm.last, first:nm.first, phone:phone});
      }
    }
  }
  return out;
}

function renderOCRResults(){
  const res=document.getElementById('ocrRes'); if(!res) return;
  if(!OCR_CAND.length){res.innerHTML='<div style="font-size:13px;color:var(--text2)">Aucun patient d√©tect√©.</div>';return;}
  let h='<div style="font-weight:800;margin:6px 0">V√©rifier avant enregistrement</div>';
  h+='<div style="display:flex;flex-direction:column;gap:10px">';
  OCR_CAND.forEach(function(c,idx){
    h+='<div class="card" style="padding:10px;border:1px solid var(--border2);border-radius:14px">'+
        '<div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">'+
          '<label style="display:flex;align-items:center;gap:8px"><input type="checkbox" class="ocrOk" data-i="'+idx+'" checked> Importer</label>'+
          '<input class="inp ocrLast" data-i="'+idx+'" placeholder="Nom" value="'+esc(c.last)+'" style="flex:1;min-width:140px">'+
          '<input class="inp ocrFirst" data-i="'+idx+'" placeholder="Pr√©nom" value="'+esc(c.first)+'" style="flex:1;min-width:140px">'+
          '<input class="inp ocrPhone" data-i="'+idx+'" placeholder="T√©l√©phone" value="'+esc(c.phone)+'" style="min-width:150px">'+
        '</div>'+
      '</div>';
  });
  h+='</div>';
  res.innerHTML=h;
}

function saveOCR(){
  const okEls=[...document.querySelectorAll('.ocrOk')];
  if(!okEls.length){toast('Rien √† importer');return;}
  let added=0, skipped=0;
  okEls.forEach(function(cb){
    if(!cb.checked) return;
    const i=parseInt(cb.dataset.i);
    const last=(document.querySelector('.ocrLast[data-i="'+i+'"]')||{}).value||'';
    const first=(document.querySelector('.ocrFirst[data-i="'+i+'"]')||{}).value||'';
    const phone=fmtPhone((document.querySelector('.ocrPhone[data-i="'+i+'"]')||{}).value||'');
    const ln=last.trim(), fn=first.trim();
    if(!ln || !fn){skipped++;return;}
    const ph=normPhoneDigits(phone);
    const exists=D.patients.some(function(p){
      if(ph && normPhoneDigits(p.phone)===ph) return true;
      return (p.lastName||'').toLowerCase()===ln.toLowerCase() && (p.firstName||'').toLowerCase()===fn.toLowerCase();
    });
    if(exists){skipped++;return;}
    D.patients.push({id:uid(),lastName:ln,firstName:fn,phone:phone,dob:'',notes:''});
    added++;
  });
  sv();R();toast(added+' ajout√©(s)'+(skipped?(' ¬∑ '+skipped+' ignor√©(s)'):''));
  clM('mOCR');
}

function fPats(){const q=document.getElementById('psrch').value.toLowerCase();document.querySelectorAll('#pres .pi').forEach(el=>{el.style.display=el.textContent.toLowerCase().includes(q)?'':'none'})}

/* ‚ïê‚ïê‚ïê CTX MENU ‚ïê‚ïê‚ïê */
function showCtx(e,id){
  e.stopPropagation();selId=id;const ap=D.appointments.find(a=>a.id===id);if(!ap)return;
  const pat=ap.patientId?gp(ap.patientId):null;
  const isAbs=(ap.type==='absence');
  const m=document.getElementById('ctx');
  let it='<div class="ci" onclick="editAp()">‚úèÔ∏è Modifier</div>';
  if(pat)it+='<div class="ci" onclick="openPC(\''+pat.id+'\');clCtx()">üë§ Fiche patient</div>';
  if(pat)it+='<div class="ci" onclick="openHist(\''+pat.id+'\');clCtx()">üìã Historique</div>';
  if(pat && !isAbs)it+='<div class="ci" onclick="addBilanFromAp(\''+ap.id+'\')">üÖ±Ô∏è Ajouter Bilan</div>';
  if(pat && !isAbs)it+='<div class="ci" onclick="lateSMS(\''+ap.id+'\')">‚è±Ô∏è Signaler un retard</div>';
  if(pat && !isAbs)it+='<div class="ci" onclick="absenceSMS(\''+ap.id+'\')">üö´üì© Signaler une absence</div>';
  if(pat)it+='<div class="ci" onclick="billPatient(\''+pat.id+'\',true);clCtx()">üíµ Forcer facturation</div>';
  if(pat && !isAbs)it+='<div class="ci" onclick="openFixNextRdv(\''+ap.id+'\');clCtx()">üìÖ Fixer les prochains RDV</div>';
  if(!isAbs && isBillable(ap))it+='<div class="ci" onclick="toggleBillOne(\''+ap.id+'\');clCtx()">'+(ap.billed?'‚Ü©Ô∏è Annuler facturation':'üíµ Marquer factur√©e')+'</div>';
  if(!ap.cancelled)it+='<div class="ci dng" onclick="cancelAp()">üö´ Annuler s√©ance</div>';
  else it+='<div class="ci" onclick="uncancelAp()">‚Ü©Ô∏è R√©tablir</div>';
  if(ap.type!=='absence')it+='<div class="ci" onclick="recurAp()">üîÅ R√©currence</div>';
  it+='<div class="ci dng" onclick="delAp()">üóë Supprimer</div>';
  m.innerHTML=it;
  m.style.left='-9999px';m.style.top='0';m.style.maxHeight='';
  m.classList.add('open');
  /* Measure actual menu height */
  var mRect=m.getBoundingClientRect();
  var mH=mRect.height;
  var mW=mRect.width||210;
  var maxH=window.innerHeight-16;
  if(mH>maxH)mH=maxH;
  var left=e.clientX||100,top=e.clientY||100;
  /* Horizontal */
  if(left+mW>window.innerWidth)left=window.innerWidth-mW-6;
  if(left<4)left=4;
  /* Vertical: prefer below click, but move above if no space */
  if(top+mH>window.innerHeight-8){
    top=Math.max(8,(e.clientY||100)-mH-4);
  }
  if(top<4)top=4;
  m.style.left=left+'px';m.style.top=top+'px';
  m.style.maxHeight=maxH+'px';
  /* Avoid FAB button overlap (bottom-right corner) */
  var fabZone={right:80,bottom:80};
  if(left+mW>window.innerWidth-fabZone.right && top+mH>window.innerHeight-fabZone.bottom){
    top=Math.max(8,window.innerHeight-fabZone.bottom-mH-8);
    m.style.top=top+'px';
  }
  setTimeout(()=>document.addEventListener('click',clCtx,{once:true}),10);
}

function clCtx(){document.getElementById('ctx').classList.remove('open')}
function lateSMS(apId){
  clCtx();
  const ap=D.appointments.find(a=>a.id===apId);if(!ap)return;
  const p=ap.patientId?gp(ap.patientId):null;
  if(!p||!p.phone){toast('T√©l√©phone patient manquant');return}
  // modal simple
  const b=document.getElementById('mMB');
  document.getElementById('mMT').textContent='Signaler un retard';
  const opts=[5,10,15,20,30,60];
  b.innerHTML='<p style="font-size:13px;color:var(--text2);margin:0 0 10px 0">Choisissez la dur√©e du retard.</p>'+
    '<div style="display:flex;gap:8px;flex-wrap:wrap">'+opts.map(x=>'<button class="btn bs" style="min-width:70px" onclick="sendLateSMS(\''+esc(p.phone)+'\','+x+');clM(\'mM\')">'+x+' min</button>').join('')+'</div>'+
    '<div class="br"><button class="btn" onclick="clM(\'mM\')">Fermer</button></div>';
  opM('mM');
}
function sendLateSMS(phone,min){
  const practName=D.proName||'Votre kin√©sith√©rapeute';
  const msg='Bonjour,\n'+practName+' vous accueillera avec un retard de '+min+' minutes. Veuillez l\'excuser pour la g√™ne occasionn√©e.\n\nCordialement,\n'+practName;
  const uri='sms:'+encodeURIComponent(phone)+'?body='+encodeURIComponent(msg);
  window.location.href=uri;
}

// Absence SMS
let AbsSMS=null;
function absenceSMS(apId){
  clCtx();
  const ap=D.appointments.find(a=>a.id===apId); if(!ap) return;
  const p=ap.patientId?gp(ap.patientId):null;
  if(!p||!p.phone){toast('T√©l√©phone patient manquant');return}
  AbsSMS={apId:apId, phone:p.phone, motif:'', other:'', dates:{}};
  AbsSMS.dates={}; // map dateKey->true
  renderAbsSMSMotif();
}
function renderAbsSMSMotif(){
  const b=document.getElementById('mMB');
  document.getElementById('mMT').textContent='Signaler une absence';
  const motifs=[
    'Maladie/Probl√®me de sant√©',
    'Panne de V√©hicule',
    'Impossibilit√© Mat√©rielle de se d√©placer',
    'Urgence Professionnelle',
    'Urgence Personnelle',
    'Autre Motif'
  ];
  b.innerHTML =
    '<p style="font-size:13px;color:var(--text2);margin:0 0 10px 0">Choisissez le motif.</p>'+
    '<div style="display:flex;gap:8px;flex-wrap:wrap">'+
      motifs.map(function(x){
        return '<button class="btn bs" onclick="pickAbsMotif(\''+escA(x)+'\')">'+esc(x)+'</button>';
      }).join('')+
    '</div>'+
    '<div id="absOtherWrap" style="display:none;margin-top:10px"><div class="fg"><label>Pr√©cisez</label><input id="absOther" type="text" placeholder="Votre motif..."></div></div>'+
    '<div class="br"><button class="btn" onclick="clM(\'mM\')">Fermer</button></div>';
  opM('mM');
}
function escA(s){return String(s).replace(/\\/g,'\\\\').replace(/\'/g,"\\'");}
function pickAbsMotif(m){
  if(!AbsSMS)return;
  AbsSMS.motif=m;
  const ow=document.getElementById('absOtherWrap');
  if(ow){
    ow.style.display=(m==='Autre Motif')?'block':'none';
  }
  // Bouton continuer
  const b=document.getElementById('mMB');
  if(!document.getElementById('absNext')){
    b.innerHTML += '<div class="br"><button id="absNext" class="btn bs" onclick="renderAbsSMSDates()">Continuer</button></div>';
  }
}
function renderAbsSMSDates(){
  if(!AbsSMS)return;
  // r√©cup√©rer dates futures pr√©vues pour ce patient (hors bilans/absences/cancellations)
  const ap=D.appointments.find(a=>a.id===AbsSMS.apId);
  const pid=ap&&ap.patientId?ap.patientId:'';
  const t=todayKey();
  const futDates=[...new Set(D.appointments
    .filter(a=>a.patientId===pid && !a.cancelled && a.type!=='absence' && a.type!=='bilan' && a.date>t)
    .map(a=>a.date))].sort();
  // UI
  const b=document.getElementById('mMB');
  const isTodaySel=AbsSMS.dates[t]===true;
  b.innerHTML =
    '<p style="font-size:13px;color:var(--text2);margin:0 0 10px 0">S√©lectionnez la/les date(s) concern√©e(s).</p>'+
    '<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">'+
      '<button class="btn '+(isTodaySel?'bs':'')+'" onclick="togAbsDate(\''+t+'\')">Aujourd\'hui</button>'+
      (futDates.length?futDates.map(function(d){
        const on=AbsSMS.dates[d]===true;
        return '<button class="btn '+(on?'bs':'')+'" onclick="togAbsDate(\''+d+'\')">'+dKeyToFr(d)+'</button>';
      }).join(''):'<span style="font-size:12px;color:var(--text2)">Aucune autre s√©ance future pr√©vue.</span>')+
    '</div>'+
    '<div class="br">'+
      '<button class="btn" onclick="renderAbsSMSMotif()">Retour</button>'+
      '<button class="btn bs" onclick="sendAbsSMS()">Envoyer SMS</button>'+
      '<button class="btn" onclick="clM(\'mM\')">Fermer</button>'+
    '</div>';
}
function togAbsDate(d){
  if(!AbsSMS)return;
  AbsSMS.dates[d]=!AbsSMS.dates[d];
  renderAbsSMSDates();
}
function sendAbsSMS(){
  if(!AbsSMS)return;
  const t=todayKey();
  const sel=Object.keys(AbsSMS.dates).filter(k=>AbsSMS.dates[k]).sort();
  if(!sel.length){toast('S√©lectionne au moins une date');return}
  let motif=AbsSMS.motif||'';
  if(motif==='Autre Motif'){
    const v=(document.getElementById('absOther')?document.getElementById('absOther').value:'')||'';
    motif=v.trim()?v.trim():'Autre motif';
  }
  const hasToday=sel.includes(t);
  const others=sel.filter(d=>d!==t).map(dKeyToFr);
  let datePart='';
  if(hasToday && others.length){
    datePart="d'aujourd'hui ou du "+others.join(', ');
  }else if(hasToday){
    datePart="d'aujourd'hui";
  }else{
    datePart="du "+others.join(', ');
  }
  const practName=D.proName||'Votre kin√©sith√©rapeute';
  const practPhone=D.proPhone||'';
  const msg =
    "Bonjour,\n"+practName+" a le regret de vous informer que votre(vos) s√©ance(s) de kin√© "+datePart+
    " est(sont) malheureusement annul√©e(s).\nMotif : "+motif+".\n\n"+
    "Veuillez nous excuser pour la g√™ne occasionn√©e.\n\n"+
    (practPhone?("Merci de confirmer la bonne r√©ception de ce message. "):"")+"N'h√©sitez pas √† reprendre rendez-vous si n√©cessaire.\n\nCordialement,\n"+practName;
  const uri='sms:'+encodeURIComponent(AbsSMS.phone)+'?body='+encodeURIComponent(msg);
  window.location.href=uri;
  clM('mM');
}

function addBilanFromAp(apId){
  clCtx();
  const ap=D.appointments.find(a=>a.id===apId);
  if(!ap||!ap.patientId){toast('Patient introuvable');return}
  const d=ap.date||todayKey();
  if(!confirm('Ajouter un Bilan (üÖ±Ô∏è) sur la s√©ance du '+dKeyToFr(d)+' ?'))return;
  // On cr√©e un √©v√©nement "bilan" distinct, li√© √† la s√©ance (pour pouvoir compter + supprimer s√©par√©ment)
  D.appointments.push({
    id:uid(),
    type:'bilan',
    isBilan:true,
    parentApId: ap.id,
    motifId:ap.motifId||'',
    patientId:ap.patientId,
    date:d,
    time:ap.time||'12:00',
    duration:ap.duration||30,
    notes:'Bilan',
    cancelled:false,
    billed:false,
    billedAt:'',
    billedAmount:0
  });
  sv();R();toast('Bilan ajout√©');
}

function editAp(){clCtx();if(!selId)return;const ap=D.appointments.find(a=>a.id===selId);if(ap)openAF(ap)}
function delAp(){
  clCtx();if(!selId)return;
  var ap=D.appointments.find(function(a){return a.id===selId});if(!ap)return;
  var sid=ap.seriesId;
  if(!sid){
    if(!confirm('Supprimer ce rendez-vous ?'))return;
    D.appointments=D.appointments.filter(function(a){return a.id!==selId});
    sv();R();toast('Supprim√©');return;
  }
  // has series -> offer to delete future occurrences by weekday
  var base=ap.date;
  var fut=D.appointments.filter(function(a){return a.seriesId===sid && a.date>=base && a.id!==ap.id});
  if(!fut.length){
    if(!confirm('Supprimer ce rendez-vous ?'))return;
    D.appointments=D.appointments.filter(function(a){return a.id!==selId});
    sv();R();toast('Supprim√©');return;
  }
  openDelSeries(ap);
}
function cancelAp(){
  clCtx();if(!selId)return;
  const ap=D.appointments.find(a=>a.id===selId);if(!ap)return;
  const pat=ap.patientId?gp(ap.patientId):null;
  if(pat && pat.phone){
    const motifs=[
      'Maladie/Probl√®me de sant√©',
      'Panne de V√©hicule',
      'Impossibilit√© Mat√©rielle de se d√©placer',
      'Urgence Professionnelle',
      'Urgence Personnelle',
      'Autre Motif'
    ];
    const b=document.getElementById('mMB');
    document.getElementById('mMT').textContent='üö´ Annuler la s√©ance';
    var isCool=pat&&(pat.tutoie||pat.cool);
    b.innerHTML=
      '<p style="font-size:13px;color:var(--text2);margin:0 0 10px 0">Choisissez le motif d\'annulation.</p>'+
      '<div style="margin-bottom:12px"><label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer">'+
        '<input type="checkbox" id="cancelTutoie" '+(isCool?'checked':(D._cancelTutoie?'checked':''))+' onchange="D._cancelTutoie=this.checked"> üòé Tutoyer le patient</label></div>'+
      '<div style="display:flex;gap:8px;flex-wrap:wrap">'+
        motifs.map(function(x){
          return '<button class="btn bs" onclick="doCancelWithMotif(\''+selId+'\',\''+escA(x)+'\')">'+esc(x)+'</button>';
        }).join('')+
      '</div>'+
      '<div id="cancelOtherWrap" style="display:none;margin-top:10px"><div class="fg"><label>Pr√©cisez</label><input id="cancelOther" type="text" placeholder="Votre motif..."></div></div>'+
      '<div class="br"><button class="btn" onclick="doCancelNoSMS(\''+selId+'\')">Annuler sans SMS</button>'+
      '<button class="btn" onclick="clM(\'mM\')">Retour</button></div>';
    opM('mM');
  } else {
    ap.cancelled=true;sv();R();toast('S√©ance annul√©e');
  }
}
function doCancelNoSMS(apId){
  var ap=D.appointments.find(function(a){return a.id===apId});
  if(ap){ap.cancelled=true;ap.cancelledBy='pro';sv();R();toast('S√©ance annul√©e');fbPush();}
  clM('mM');
}
function doCancelWithMotif(apId,motif){
  var ap=D.appointments.find(function(a){return a.id===apId});if(!ap)return;
  if(motif==='Autre Motif'){
    var ow=document.getElementById('cancelOtherWrap');
    if(ow)ow.style.display='block';
    var b=document.getElementById('mMB');
    if(!document.getElementById('cancelConfirmBtn')){
      b.innerHTML+='<div class="br"><button id="cancelConfirmBtn" class="btn bp" onclick="doCancelConfirm(\''+apId+'\')">Confirmer l\'annulation</button></div>';
    }
    return;
  }
  finalizeCancelSMS(apId,motif);
}
function doCancelConfirm(apId){
  var v=(document.getElementById('cancelOther')?document.getElementById('cancelOther').value:'').trim()||'Autre motif';
  finalizeCancelSMS(apId,v);
}
/* Generate personalized cancel message */
function buildCancelMsg(pat,ap,motif,tutoie){
  var prenom=pat.firstName||'';
  var practName=D.proName||'Votre kin√©sith√©rapeute';
  var isToday=(ap.date===todayKey());
  var dFr=ap.date.split('-');var dateFr=(dFr[2]||'')+'/'+(dFr[1]||'')+'/'+(dFr[0]||'');
  var hasFuture=D.appointments.some(function(a){return a.patientId===ap.patientId && a.id!==ap.id && !a.cancelled && a.date>=todayKey()});
  /* Motif phrase adapted grammatically */
  var motifPhrases={};
  if(tutoie){
    motifPhrases={
      'Maladie/Probl√®me de sant√©':'pour raison de sant√©',
      'Panne de V√©hicule':'√† cause d\'une panne de v√©hicule',
      'Impossibilit√© Mat√©rielle de se d√©placer':'car je ne peux malheureusement pas me d√©placer',
      'Urgence Professionnelle':'en raison d\'une urgence professionnelle',
      'Urgence Personnelle':'pour une urgence personnelle'
    };
  } else {
    motifPhrases={
      'Maladie/Probl√®me de sant√©':'pour raison de sant√©',
      'Panne de V√©hicule':'en raison d\'une panne de v√©hicule',
      'Impossibilit√© Mat√©rielle de se d√©placer':'en raison d\'une impossibilit√© mat√©rielle de d√©placement',
      'Urgence Professionnelle':'en raison d\'une urgence professionnelle',
      'Urgence Personnelle':'en raison d\'une urgence personnelle'
    };
  }
  var motifPhrase=motifPhrases[motif]||('pour le motif suivant : '+motif);

  if(tutoie){
    var dateStr=isToday?"d'aujourd'hui":('du '+dateFr);
    var msg='Salut '+prenom+',\n\n'+
      'Malheureusement je dois annuler ta s√©ance de kin√© '+dateStr+' √† '+ap.time+' '+motifPhrase+'. Vraiment d√©sol√© !';
    if(!hasFuture){
      msg+='\n\nN\'h√©site pas √† reprendre un RDV sur PhysioFlow.';
    }
    msg+='\n\nJe te souhaite une belle journ√©e.\n'+practName;
  } else {
    var dateStr2=isToday?"d'aujourd'hui":('du '+dateFr);
    var msg='Bonjour,\n\n'+
      practName+' a le regret de vous informer que votre s√©ance '+dateStr2+' √† '+ap.time+
      ' est malheureusement annul√©e '+motifPhrase+'.'+
      '\nVeuillez nous excuser pour la g√™ne occasionn√©e.';
    if(!hasFuture){
      msg+='\n\nVous pouvez reprendre rendez-vous directement sur PhysioFlow.';
    }
    msg+='\n\nCordialement,\n'+practName;
  }
  return msg;
}
function finalizeCancelSMS(apId,motif){
  var ap=D.appointments.find(function(a){return a.id===apId});if(!ap)return;
  var pat=ap.patientId?gp(ap.patientId):null;
  var tutoie=!!(document.getElementById('cancelTutoie')&&document.getElementById('cancelTutoie').checked);
  D._cancelTutoie=tutoie;
  ap.cancelled=true;
  ap.cancelledBy='pro';
  ap.cancelReason=motif;
  sv();R();
  /* Push cancellation to Firebase */
  FB_REF.child('proCancellations').push({
    appointmentId:ap.id,
    date:ap.date,
    time:ap.time,
    reason:motif,
    patientId:ap.patientId||'',
    cancelledAt:new Date().toISOString()
  });
  /* Also notify patient via notifyPatient queue */
  if(ap.patientId){
    FB_REF.child('notifyPatient').push({
      type:'proCancelled',
      patientId:ap.patientId,
      date:ap.date,
      time:ap.time,
      reason:motif,
      createdAt:new Date().toISOString()
    });
  }
  fbPush();
  /* Open SMS */
  if(pat && pat.phone){
    var msg=buildCancelMsg(pat,ap,motif,tutoie);
    var uri='sms:'+encodeURIComponent(pat.phone)+'?body='+encodeURIComponent(msg);
    window.location.href=uri;
  }
  clM('mM');
  toast('S√©ance annul√©e ¬∑ SMS pr√©par√©');
}
function uncancelAp(){clCtx();if(!selId)return;const ap=D.appointments.find(a=>a.id===selId);if(ap){ap.cancelled=false;sv();R();toast('S√©ance r√©tablie')}}

function openDelSeries(ap){
  var b=document.getElementById('mDelRB');
  var dayN={0:'Dimanche',1:'Lundi',2:'Mardi',3:'Mercredi',4:'Jeudi',5:'Vendredi',6:'Samedi'};
  var sid=ap.seriesId;
  var base=ap.date;
  var days=(ap.seriesDays&&ap.seriesDays.length)?ap.seriesDays.slice():Array.from(new Set(D.appointments.filter(function(a){return a.seriesId===sid}).map(function(a){return new Date(a.date+'T00:00:00').getDay()})));
  days=sortDows(days);
  var apDow=new Date(ap.date+'T00:00:00').getDay();
  var cb=days.map(function(d){
    return '<label style="font-size:13px;display:flex;align-items:center;gap:8px"><input class="dsD" type="checkbox" data-dow="'+d+'"'+(d===apDow?' checked':'')+'> '+dayN[d]+'</label>';
  }).join('');
  b.innerHTML=
    '<p style="font-size:13px;color:var(--text2);margin:0 0 10px 0">Cette s√©ance fait partie d\'une planification. Voulez-vous supprimer seulement celle-ci, ou aussi les occurrences futures ?</p>'+
    '<div class="fg"><label>Jours √† supprimer (occurrences futures)</label><div style="display:flex;flex-wrap:wrap;gap:12px">'+cb+'</div></div>'+
    '<div class="br" style="display:flex;gap:10px;flex-wrap:wrap">'+
      '<button class="btn bp bw" onclick="delSeries(\''+ap.id+'\',0)">Supprimer seulement cette s√©ance</button>'+
      '<button class="btn bd" onclick="delSeries(\''+ap.id+'\',1)">Supprimer occurrences futures</button>'+
    '</div>'+
    '<div class="br"><button class="btn" onclick="clM(\'mDelR\')">Annuler</button></div>';
  opM('mDelR');
}

function delSeries(apId,mode){
  var ap=D.appointments.find(function(a){return a.id===apId});if(!ap){clM('mDelR');return;}
  var sid=ap.seriesId, base=ap.date;
  if(mode===0){
    D.appointments=D.appointments.filter(function(a){return a.id!==apId});
    sv();clM('mDelR');R();toast('Supprim√©');
    return;
  }
  var sel=Array.from(document.querySelectorAll('.dsD:checked')).map(function(x){return parseInt(x.dataset.dow)});
  if(!sel.length){toast('Choisissez au moins un jour');return;}
  D.appointments=D.appointments.filter(function(a){
    if(a.id===apId) return false; // always delete the selected session
    if(a.seriesId!==sid) return true;
    if(a.date<base) return true;
    var dow=new Date(a.date+'T00:00:00').getDay();
    return sel.indexOf(dow)===-1;
  });
  sv();clM('mDelR');R();toast('Occurrences supprim√©es');
}

/* ‚ïê‚ïê‚ïê APPT FORM ‚ïê‚ïê‚ïê */
function fabClick(){
  if(vM==='patients'){newPat();return;}
  newAp();
}
function newAp(){openAF(null)}
function openAF(ex){
  const b=document.getElementById('mAB');
  document.getElementById('mAT').textContent=ex?'Modifier le rendez-vous':'Nouveau rendez-vous';
  const isAbs=ex&&ex.type==='absence';
  const selMot=ex?ex.motifId:(D.motifs[0]?D.motifs[0].id:null);
  let ch=D.motifs.map(function(m){
    const c=CL[m.ci%6];
    return'<div class="chip'+(m.id===selMot&&!isAbs?' sel':'')+'" data-m="'+m.id+'" style="background:'+c.bg+';color:'+c.bd+'">'+esc(m.label)+'</div>'
  }).join('');
  ch+='<div class="chip'+(isAbs?' sel':'')+'" data-m="__abs" style="background:var(--absence);color:#fff">Absence</div>';
  const pat=ex&&ex.patientId?gp(ex.patientId):null;
  const dur=ex?ex.duration:(D.motifs.find(function(m){return m.id===selMot})||{duration:30}).duration;

  b.innerHTML='<div class="chips" id="mCh">'+ch+'</div>'+
    '<div id="typWrap" style="display:none;margin:-4px 0 10px"></div>'+

    '<div id="patB"'+(isAbs?' style="display:none"':'')+'>' +
    '<div class="fr">' +
    '<div class="fg acw"><label>Nom</label>'+
    '<input type="text" id="fPL" value="'+esc(pat?pat.lastName:'')+'" placeholder="Nom de famille" autocomplete="off" oninput="this.value=this.value.toUpperCase()">'+
    '<div class="acl" id="acl"></div>'+
    '</div>'+
    '<div class="fg"><label>Pr√©nom</label>'+
    '<input type="text" id="fPF" value="'+esc(pat?pat.firstName:'')+'" placeholder="Pr√©nom" autocomplete="off" oninput="this.value=toTitleCase(this.value)">'+
    '</div></div>'+
    '<input type="hidden" id="fPi" value="'+(ex&&ex.patientId?ex.patientId:'')+'">'+
    '</div>'+
    '<div id="absB"'+(isAbs?'':' style="display:none"')+'><div class="fg"><label>Libell√©</label><input type="text" id="fAL" value="'+esc(ex&&ex.label?ex.label:'Absence')+'"></div></div>'+
    '<div class="fr"><div class="fg"><label>Date</label><input type="date" id="fDt" value="'+(ex?ex.date:dk(cD))+'"></div>'+
    '<div class="fg"><label>Heure</label><input type="time" id="fTm" value="'+(ex?ex.time:'09:00')+'" step="300"></div></div>'+
    '<div class="fg"><label>Dur√©e (min)</label><input type="number" id="fDu" value="'+dur+'" min="5" max="240" step="5"></div>'+
    '<div class="fg"><label>Notes</label><textarea id="fNo" rows="2" placeholder="Notes...">'+(ex?esc(ex.notes||''):'')+'</textarea></div>'+
    '<div class="br">'+(ex?'<button class="btn bd" onclick="delAF(\''+ex.id+'\')">Supprimer</button>':'')+
    '<button class="btn bp bw" onclick="svAF(\''+(ex?ex.id:'')+'\')">'+(ex?'Enregistrer':'Ajouter')+'</button></div>';

  // chip logic
  document.querySelectorAll('#mCh .chip').forEach(function(c){c.onclick=function(){
    document.querySelectorAll('#mCh .chip').forEach(function(x){x.classList.remove('sel')});c.classList.add('sel');
    var mid=c.dataset.m;var isA=mid==='__abs';
    document.getElementById('patB').style.display=isA?'none':'block';
    document.getElementById('absB').style.display=isA?'block':'none';
    if(!isA){var m=D.motifs.find(function(x){return x.id===mid});if(m)document.getElementById('fDu').value=m.duration}
    updTyp(mid,isA)
  }});
  updTyp(selMot,isAbs);
  setupAC();opM('mA');
}

function setApTime(t){var tm=document.getElementById('fTm');if(tm)tm.value=t}
function updTyp(mid,isAbs){
  var w=document.getElementById('typWrap');if(!w)return;
  if(isAbs){w.style.display='none';w.innerHTML='';return}
  var m=gm(mid);var arr=(m&&Array.isArray(m.times))?m.times.filter(Boolean):[];
  if(!arr.length){w.style.display='none';w.innerHTML='';return}
  var times=arr.slice().sort(function(a,b){return t2m(a)-t2m(b)});
  var h='<div style="font-size:11px;font-weight:600;color:var(--text2);margin:4px 0 6px">Heures typiques (optionnel)</div><div class="chips">';
  for(var i=0;i<times.length;i++){var t=times[i];h+='<div class="chip" style="background:var(--bg);border:1.5px solid var(--border);color:var(--text)" onclick="setApTime(\''+t+'\')">'+t+'</div>'}
  h+='</div>';w.innerHTML=h;w.style.display='block';
}

function setupAC(){
  var inpL=document.getElementById('fPL'),inpF=document.getElementById('fPF'),list=document.getElementById('acl'),hid=document.getElementById('fPi');
  if(!inpL)return;var hl=-1;
  
  function doSearch(){
    var qL=(inpL.value||'').toLowerCase().trim();
    var qF=(inpF.value||'').toLowerCase().trim();
    var q=(qL+' '+qF).trim();
    hl=-1;
    if(q.length<1){list.classList.remove('open');return}
    /* Clear hidden patient id when user types */
    hid.value='';
    var matches=D.patients.filter(function(p){
      var full=(p.lastName+' '+p.firstName).toLowerCase();
      var rev=(p.firstName+' '+p.lastName).toLowerCase();
      return full.indexOf(q)>=0||rev.indexOf(q)>=0||
             (qL && p.lastName.toLowerCase().indexOf(qL)>=0) ||
             (qF && p.firstName.toLowerCase().indexOf(qF)>=0);
    }).slice(0,8);
    var h=matches.map(function(p){
      return'<div class="aci" data-pid="'+p.id+'"><span>'+esc(p.lastName)+' '+esc(p.firstName)+' '+alrt(p)+'</span><span class="acs">'+(p.dob?calcAge(p.dob)+'ans':'')+'</span></div>'
    }).join('');
    h+='<div class="aci acn" data-pid="__new">+ Cr√©er "'+esc(inpL.value+(inpF.value?' '+inpF.value:''))+'"</div>';
    list.innerHTML=h;list.classList.add('open');
    
    list.querySelectorAll('.aci').forEach(function(it){it.onmousedown=function(e){
      e.preventDefault(); /* prevent blur */
      var pid=it.dataset.pid;
      if(pid==='__new'){quickPat(inpL.value,inpF.value);return}
      var p=gp(pid);if(p){inpL.value=p.lastName;inpF.value=p.firstName;hid.value=p.id}
      list.classList.remove('open');
    }});
  }
  
  inpL.addEventListener('input',doSearch);
  inpF.addEventListener('input',doSearch);
  
  function handleKeydown(e){
    var items=list.querySelectorAll('.aci');if(!items.length)return;
    if(e.key==='ArrowDown'){e.preventDefault();hl=Math.min(hl+1,items.length-1);items.forEach(function(x,i){x.classList.toggle('hl',i===hl)})}
    else if(e.key==='ArrowUp'){e.preventDefault();hl=Math.max(hl-1,0);items.forEach(function(x,i){x.classList.toggle('hl',i===hl)})}
    else if(e.key==='Enter'&&hl>=0){e.preventDefault();if(items[hl])items[hl].onmousedown({preventDefault:function(){}})}
  }
  inpL.addEventListener('keydown',handleKeydown);
  inpF.addEventListener('keydown',handleKeydown);
  
  function hideList(){setTimeout(function(){list.classList.remove('open')},200)}
  inpL.addEventListener('blur',hideList);
  inpF.addEventListener('blur',hideList);
}

function quickPat(lastName,firstName){
  var ln=(lastName||'').trim();
  var fn=(firstName||'').trim();
  if(!ln && !fn){toast('Entrez un nom');return}
  /* If only last name entered, try to split it */
  if(ln && !fn){
    var parts=ln.split(/\s+/);
    if(parts.length>1){ln=parts[0];fn=parts.slice(1).join(' ')}
  }
  var p={id:uid(),lastName:ln,firstName:fn,dob:'',phone:'',needOrdo:false,needMut:false,documents:[]};
  D.patients.push(p);sv();
  document.getElementById('fPL').value=ln;
  document.getElementById('fPF').value=fn;
  document.getElementById('fPi').value=p.id;
  document.getElementById('acl').classList.remove('open');
  toast('Patient cr√©√© ‚úì');
}

function svAF(exId){
  var chip=document.querySelector('#mCh .chip.sel');if(!chip){toast('S√©lectionnez un motif');return}
  var mid=chip.dataset.m;var isAbs=mid==='__abs';
  var date=document.getElementById('fDt').value,time=document.getElementById('fTm').value;
  var dur=parseInt(document.getElementById('fDu').value)||30;
  var notes=document.getElementById('fNo').value.trim();
  if(!date||!time){toast('Date et heure requises');return}
  var d=new Date(date+'T00:00:00');if(!D.days.includes(d.getDay())){toast('Jour non activ√© (jours : '+daysLabel(D.days)+')');return}
  var patientId='',label='';
  if(isAbs){label=document.getElementById('fAL').value.trim()||'Absence'}
  else{
    patientId=document.getElementById('fPi').value;
    /* If no patient selected but names entered, create patient on the fly */
    if(!patientId){
      var ln=(document.getElementById('fPL').value||'').trim();
      var fn=(document.getElementById('fPF').value||'').trim();
      if(ln||fn){
        var newP={id:uid(),lastName:ln,firstName:fn,dob:'',phone:'',needOrdo:false,needMut:false,documents:[]};
        D.patients.push(newP);
        patientId=newP.id;
      } else {
        toast('S√©lectionnez ou cr√©ez un patient');return;
      }
    }
  }
  var ap={id:exId||uid(),type:isAbs?'absence':'rdv',motifId:isAbs?null:mid,patientId:isAbs?'':patientId,label:label,date:date,time:time,duration:dur,notes:notes,cancelled:false};
  if(exId){var i=D.appointments.findIndex(function(a){return a.id===exId});if(i>=0){ap.cancelled=D.appointments[i].cancelled;D.appointments[i]=ap}}
  else D.appointments.push(ap);
  sv();clM('mA');cD=new Date(date+'T00:00:00');R();toast(exId?'Modifi√© ‚úì':'Ajout√© ‚úì');
}
function delAF(id){D.appointments=D.appointments.filter(function(a){return a.id!==id});sv();clM('mA');R();toast('Supprim√©')}

/* ‚ïê‚ïê‚ïê RECURRENCE ‚ïê‚ïê‚ïê */
function recurAp(){
  clCtx();if(!selId)return;var ap=D.appointments.find(function(a){return a.id===selId});if(!ap||ap.type==='absence')return;
  var b=document.getElementById('mRB');
  var dow=new Date(ap.date+'T00:00:00').getDay();
  var days=sortDows(D.days);
  var dayN={0:'Dimanche',1:'Lundi',2:'Mardi',3:'Mercredi',4:'Jeudi',5:'Vendredi',6:'Samedi'};
  var cb=days.map(function(d){
    return'<label style="font-size:13px;display:flex;align-items:center;gap:4px"><input type="checkbox" class="rcD" data-dow="'+d+'"'+(d===dow?' checked':'')+'> '+dayN[d]+'</label>';
  }).join('');
  var pat=ap.patientId?gp(ap.patientId):null;
  var patName=pat?(esc(pat.lastName)+' '+esc(pat.firstName)):'Patient inconnu';
  b.innerHTML='<p style="font-size:13px;color:var(--text2);margin-bottom:12px">R√©p√©ter ce RDV ('+ap.time+', '+ap.duration+'min) pour <b>'+patName+'</b>.</p>'+
    '<div class="fg"><label>Jours</label><div style="display:flex;flex-wrap:wrap;gap:12px">'+cb+'</div></div>'+
    '<div class="fr"><div class="fg"><label>√Ä partir du</label><input type="date" id="rcS" value="'+ap.date+'"></div>'+
    '<div class="fg"><label>Jusqu\'au (vide=ind√©fini)</label><input type="date" id="rcE" value=""></div></div>'+
    '<div class="fg"><label>Nombre de semaines max</label><input type="number" id="rcW" value="12" min="1" max="104"></div>'+
    '<div class="br"><button class="btn bp bw" onclick="doRecur(\''+ap.id+'\')">Cr√©er les s√©ances</button></div>';
  opM('mR');
}

function doRecur(apId){
  var ap=D.appointments.find(function(a){return a.id===apId});if(!ap)return;
  var sel=Array.from(document.querySelectorAll('.rcD:checked')).map(function(x){return parseInt(x.dataset.dow)});
  var start=document.getElementById('rcS').value,end=document.getElementById('rcE').value;
  var maxW=parseInt(document.getElementById('rcW').value)||12;
  if(!sel.length){toast('Choisissez au moins un jour');return}
  if(!start){toast('Date de d√©but requise');return}
  var endD=end?new Date(end+'T00:00:00'):null;
  var startD=new Date(start+'T00:00:00');

  // series meta
  var seriesId=ap.seriesId||('s'+uid());
  ap.seriesId=seriesId;
  ap.seriesDays=sel.slice();
  ap.seriesStart=start;
  ap.seriesEnd=end||'';

  var count=0;
  var existing={};D.appointments.forEach(function(a){existing[a.date+'|'+a.time+'|'+a.patientId]=true});
  for(var w=0;w<=maxW;w++){
    sel.forEach(function(dow2){
      if(!D.days.includes(dow2))return;
      /* Calculate date for this dow in week w relative to start */
      var d=new Date(startD.getTime());
      var curDow=d.getDay();
      var diff=(dow2-curDow+7)%7; /* always 0-6 */
      if(w===0&&diff===0&&existing[dk(d)+'|'+ap.time+'|'+ap.patientId])return; /* skip original */
      d.setDate(d.getDate()+diff+w*7);
      if(d<startD)return;
      if(endD&&d>endD)return;
      var key=dk(d)+'|'+ap.time+'|'+ap.patientId;
      if(existing[key])return;
      D.appointments.push({
        id:uid(),type:'rdv',motifId:ap.motifId,patientId:ap.patientId,
        date:dk(d),time:ap.time,duration:ap.duration,notes:'',cancelled:false,
        seriesId:seriesId,seriesDays:sel.slice(),seriesStart:start,seriesEnd:(end||'')
      });
      existing[key]=true;count++;
    });
  }
  sv();clM('mR');R();toast(count+' s√©ance(s) cr√©√©e(s)');
}

/* ‚ïê‚ïê‚ïê PATIENT CARD ‚ïê‚ïê‚ïê */
function openPC(pid){
  var p=gp(pid);if(!p)return;
  document.getElementById('mPT').innerHTML='üë§ '+esc(p.lastName)+' '+esc(p.firstName)+' '+alrt(p);
  var ag=p.dob?calcAge(p.dob):'';
  var dobD=p.dob?new Date(p.dob+'T00:00:00').toLocaleDateString('fr-FR'):'Non renseign√©e';
  var docsH='';if(p.documents&&p.documents.length){
    docsH=p.documents.map(function(d,i){return'<div class="pdi"><span>üìé</span><a href="'+d.data+'" download="'+esc(d.name)+'">'+esc(d.name)+'</a><button style="font-size:12px;color:#e74c3c" onclick="rmDoc(\''+pid+'\','+i+')">√ó</button></div>'}).join('')}
  var b=document.getElementById('mPB');

  const ubN=unbilledCount(pid);
  const ubS=unbilledAmount(pid);
  const feeS=money(Number(p.sessionFee||18.20));
  const sc=getSessionCount(pid);
  const scHtml='<div class="ub">S√©ances : <b>'+sc.label+'</b>'+(sc.needsRenewal?' <span style="color:#e74c3c;font-weight:700">üìã Renouvellement recommand√©</span>':'')+'</div>';
  let rejHtml='';
  if(p.needMut||p.needSecu){
    const n=Math.max(0,parseInt(p.rejectCount)||0);
    const part=(p.needMut?0.4:0)+(p.needSecu?0.6:0);
    const unpaid=n*(Number(p.sessionFee||18.20))*part;
    rejHtml='<div style="margin-top:10px;padding:10px;border:1px solid var(--border);border-radius:12px;background:var(--bg)">'+
      '<div style="font-weight:700;margin-bottom:6px">‚ÄºÔ∏è Rejet de paiement</div>'+
      '<div style="font-size:12px;color:var(--text2)">'+(p.rejectReason?('Motif : '+esc(p.rejectReason)):'Motif : (non renseign√©)')+'</div>'+
      '<div style="font-size:12px;color:var(--text2)">S√©ances rejet√©es : '+n+' ¬∑ Montant non r√©gl√© estim√© : <b>'+money(unpaid)+'</b></div>'+
      '</div>';
  }

  b.innerHTML='<div class="pcard"><div class="pt"><div class="pav">'+ini(p)+'</div><div class="pinf">'+
    '<div class="pnm">'+allEmojis(pid)+esc(p.lastName)+' '+esc(p.firstName)+' '+alrt(p)+'</div>'+
    '<div class="pag">'+(ag?ag+' ans ¬∑ ':'')+'N√©(e) le '+dobD+'</div>'+
    '<div class="ub">Non factur√©es : <b>'+ubN+'</b> ¬∑ <b>'+money(ubS)+'</b></div>'+
    '<div class="ub">Montant s√©ance : <b>'+feeS+'</b></div>'+
    scHtml+
    '</div></div>'+
    '<div class="pacts">'+(p.phone?'<a href="tel:'+esc(p.phone)+'">üìû Appeler</a><a href="sms:'+esc(p.phone)+'">üí¨ SMS</a>':'')+
    '<button onclick="editPat(\''+pid+'\')">‚úèÔ∏è Modifier</button>'+
    '<button onclick="billPatient(\''+pid+'\',true)">üíµ Forcer facturation</button></div>'+
    '<div class="pcks"><label><input type="checkbox" '+(p.needOrdo?'checked':'')+' onchange="togFlag(\''+pid+'\',\'needOrdo\',this.checked)"> ‚ùó Ordonnance</label>'+
    '<label><input type="checkbox" '+(p.needMut?'checked':'')+' onchange="togFlag(\''+pid+'\',\'needMut\',this.checked)"> ‚ÄºÔ∏è Mutuelle</label>'+
    '<label><input type="checkbox" '+(p.needSecu?'checked':'')+' onchange="togFlag(\''+pid+'\',\'needSecu\',this.checked)"> ‚ÄºÔ∏è S√©cu</label></div>'+
    rejHtml+
    '<h3>üìé Documents</h3><div class="pdocs" id="pcD">'+(docsH||'<div style="font-size:12px;color:var(--text2);padding:4px 0">Aucun document</div>')+'</div>'+
    '<div style="display:flex;gap:6px;margin-top:8px"><button class="btn bs" style="flex:1;font-size:12px" onclick="addDoc(\''+pid+'\')">üìÅ Joindre</button>'+
    '<button class="btn bs" style="flex:1;font-size:12px" onclick="takePhoto(\''+pid+'\')">üì∑ Photo</button></div></div>'+
    '<div class="br"><button class="btn bs" style="flex:1" onclick="openHist(\''+pid+'\');clM(\'mP\')">üìã Historique</button>'+
    '<button class="btn bs" style="flex:1" onclick="recurFromPat(\''+pid+'\')">üîÅ R√©currence</button>'+
    '<button class="btn bd" onclick="delPat(\''+pid+'\')">üóë</button></div>';
  opM('mP');
}


function togFlag(pid,flag,val){var p=gp(pid);if(p){p[flag]=val;sv();R();openPC(pid)}}

/* Recurrence from patient list (find most recent apt) */
function recurFromPat(pid){
  var pApts=(D.appointments||[]).filter(function(a){return a.patientId===pid&&!a.cancelled&&a.type!=='absence'}).sort(function(a,b){return b.date>a.date?1:(b.date<a.date?-1:0)});
  if(!pApts.length){toast('Aucun RDV trouv√© pour ce patient');return}
  selId=pApts[0].id;
  clM('mP');
  recurAp();
}

function newPat(){
  const b=document.getElementById('mAB');
  document.getElementById('mAT').textContent='Nouveau patient';
  b.innerHTML='<div class="fr"><div class="fg"><label>Nom</label><input id="epL" value="" oninput="this.value=this.value.toUpperCase()"></div>'+
    '<div class="fg"><label>Pr√©nom</label><input id="epF" value="" oninput="this.value=toTitleCase(this.value)"></div></div>'+
    '<div class="fr"><div class="fg"><label>Date de naissance</label><input type="date" id="epD" value=""></div>'+
    '<div class="fg"><label>T√©l√©phone</label><input type="tel" id="epP" value=""></div></div>'+
    '<div class="fr"><div class="fg"><label>Montant des s√©ances (‚Ç¨)</label><input type="number" step="0.01" id="epFee" value="18.20"></div></div>'+
    '<div class="pcks" style="margin-top:8px"><label><input type="checkbox" id="epOr"> ‚ùó Ordonnance</label>'+
    '<label><input type="checkbox" id="epMut"> ‚ÄºÔ∏è Mutuelle</label>'+
    '<label><input type="checkbox" id="epSec"> ‚ÄºÔ∏è S√©cu</label></div>'+
    '<div id="rejBlk" style="display:none;margin-top:8px">'+
      '<div class="fr"><div class="fg"><label>Motif du rejet</label><input id="epRejR" value=""></div>'+
      '<div class="fg"><label>Nombre de s√©ances rejet√©es</label><input type="number" min="0" step="1" id="epRejN" value="0"></div></div>'+
    '</div>'+
    '<div class="br"><button class="btn bp bw" onclick="svNewPat()">Enregistrer</button></div>';
  // toggle reject block
  function t(){const on=document.getElementById('epMut').checked||document.getElementById('epSec').checked;document.getElementById('rejBlk').style.display=on?'block':'none'}
  document.getElementById('epMut').addEventListener('change',t);
  document.getElementById('epSec').addEventListener('change',t);
  opM('mA');
}

function svNewPat(){
  const ln=document.getElementById('epL').value.trim();
  const fn=document.getElementById('epF').value.trim();
  if(!ln && !fn){toast('Nom requis');return}
  const p={
    id:uid(),
    lastName:ln,firstName:fn,
    dob:document.getElementById('epD').value||'',
    phone:document.getElementById('epP').value.trim()||'',
    notes:'',
    needOrdo:document.getElementById('epOr').checked,
    needMut:document.getElementById('epMut').checked,
    needSecu:document.getElementById('epSec').checked,
    rejectReason:document.getElementById('epRejR')?document.getElementById('epRejR').value.trim():'',
    rejectCount:parseInt((document.getElementById('epRejN')&&document.getElementById('epRejN').value)||'0')||0,
    sessionFee:parseFloat(document.getElementById('epFee').value)||18.20,
    cool:document.getElementById('epCool')?document.getElementById('epCool').checked:false,
    lastBillAt:'',
    documents:[]
  };
  D.patients.push(p);sv();clM('mA');R();toast('Patient ajout√©');
}

function editPat(pid){
  var p=gp(pid);if(!p)return;clM('mP');
  var b=document.getElementById('mAB');
  document.getElementById('mAT').textContent='Modifier le patient';
  b.innerHTML='<div class="fr"><div class="fg"><label>Nom</label><input id="epL" value="'+esc(p.lastName)+'" oninput="this.value=this.value.toUpperCase()"></div>'+
    '<div class="fg"><label>Pr√©nom</label><input id="epF" value="'+esc(p.firstName)+'" oninput="this.value=toTitleCase(this.value)"></div>'+
    '<div style="display:flex;align-items:flex-end;padding-bottom:6px;gap:12px"><label style="display:flex;align-items:center;gap:3px;cursor:pointer;font-size:18px"><input type="checkbox" id="epCool" '+(p.cool?'checked':'')+'> üòé</label><label style="display:flex;align-items:center;gap:3px;cursor:pointer;font-size:12px"><input type="checkbox" id="epTutoie" '+(p.tutoie?'checked':'')+'> Tutoyer</label></div></div>'+
    '<div class="fr"><div class="fg"><label>Date de naissance</label><input type="date" id="epD" value="'+(p.dob||'')+'"></div>'+
    '<div class="fg"><label>T√©l√©phone</label><input type="tel" id="epP" value="'+esc(p.phone||'')+'"></div></div>'+
    '<div class="fr"><div class="fg"><label>Montant des s√©ances (‚Ç¨)</label><input type="number" step="0.01" id="epFee" value="'+(p.sessionFee!==undefined?Number(p.sessionFee).toFixed(2):'18.20')+'"></div>'+
    '<div class="fg"><label>Multiplicateur groupe</label><select id="epMultip">'+
      '<option value="0" '+(p.groupMultip===0?'selected':'')+'>0 (gratuit)</option>'+
      '<option value="1" '+(p.groupMultip===1?'selected':'')+'>√ó1</option>'+
      '<option value="2" '+((p.groupMultip===2||p.groupMultip===undefined)?'selected':'')+'>√ó2 (d√©faut)</option>'+
      '<option value="3" '+(p.groupMultip===3?'selected':'')+'>√ó3</option>'+
    '</select></div></div>'+
    '<div class="pcks" style="margin-top:8px"><label><input type="checkbox" '+(p.needOrdo?'checked':'')+' id="epOr"> ‚ùó Ordonnance</label>'+
    '<label><input type="checkbox" '+(p.needMut?'checked':'')+' id="epMut"> ‚ÄºÔ∏è Mutuelle</label>'+
    '<label><input type="checkbox" '+(p.needSecu?'checked':'')+' id="epSec"> ‚ÄºÔ∏è S√©cu</label></div>'+
    '<div style="margin-top:10px;padding:10px;border:1px solid var(--border2);border-radius:10px;background:var(--bg)">'+
      '<div style="font-weight:700;font-size:12px;margin-bottom:8px">üìã Ordonnance & S√©ances</div>'+
      '<div class="fr"><div class="fg"><label>S√©ances avant l\'appli</label><input type="number" min="0" id="epSessBefore" value="'+(p.sessionsBeforeApp||0)+'"></div>'+
      '<div class="fg"><label>S√©ances prescrites (0 = illimit√©)</label><input type="number" min="0" id="epPrescribed" value="'+(p.prescribedSessions||0)+'"></div></div>'+
      '<div class="fr"><div class="fg"><label>Renouveler apr√®s X s√©ances</label><input type="number" min="0" id="epRenewSess" value="'+(p.renewAfterSessions||0)+'" placeholder="0 = d√©sactiv√©"></div>'+
      '<div class="fg"><label>Renouveler apr√®s X mois</label><input type="number" min="0" id="epRenewMo" value="'+(p.renewAfterMonths||0)+'" placeholder="0 = d√©sactiv√©"></div></div>'+
      '<div style="font-size:10px;color:var(--text3);margin-top:4px">Si prescrit = 0, alerte bas√©e sur le seuil s√©ances/mois. Sinon alerte 2 s√©ances avant la fin.</div>'+
    '</div>'+
    '<div id="rejBlk" style="display:'+((p.needMut||p.needSecu)?'block':'none')+';margin-top:8px">'+
      '<div class="fr"><div class="fg"><label>Motif du rejet</label><input id="epRejR" value="'+esc(p.rejectReason||'')+'"></div>'+
      '<div class="fg"><label>Nombre de s√©ances rejet√©es</label><input type="number" min="0" step="1" id="epRejN" value="'+(p.rejectCount||0)+'"></div></div>'+
    '</div>'+
    '<div class="br"><button class="btn bp bw" onclick="svPat(\''+pid+'\')">Enregistrer</button></div>';
  function t(){const on=document.getElementById('epMut').checked||document.getElementById('epSec').checked;document.getElementById('rejBlk').style.display=on?'block':'none'}
  document.getElementById('epMut').addEventListener('change',t);
  document.getElementById('epSec').addEventListener('change',t);
  opM('mA');
}


function svPat(pid){
  var p=gp(pid);if(!p)return;
  p.lastName=document.getElementById('epL').value.trim();
  p.firstName=document.getElementById('epF').value.trim();
  p.dob=document.getElementById('epD').value;
  p.phone=document.getElementById('epP').value.trim();
  p.sessionFee=parseFloat(document.getElementById('epFee').value)||18.20;
  p.groupMultip=parseInt(document.getElementById('epMultip').value);
  if(isNaN(p.groupMultip))p.groupMultip=2;
  p.needOrdo=document.getElementById('epOr').checked;
  p.needMut=document.getElementById('epMut').checked;
  p.needSecu=document.getElementById('epSec').checked;
  p.cool=(document.getElementById('epCool')?document.getElementById('epCool').checked:false);
  p.tutoie=(document.getElementById('epTutoie')?document.getElementById('epTutoie').checked:false);
  p.rejectReason=document.getElementById('epRejR')?document.getElementById('epRejR').value.trim():'';
  p.rejectCount=parseInt((document.getElementById('epRejN')&&document.getElementById('epRejN').value)||'0')||0;
  p.sessionsBeforeApp=parseInt((document.getElementById('epSessBefore')&&document.getElementById('epSessBefore').value)||'0')||0;
  p.prescribedSessions=parseInt((document.getElementById('epPrescribed')&&document.getElementById('epPrescribed').value)||'0')||0;
  p.renewAfterSessions=parseInt((document.getElementById('epRenewSess')&&document.getElementById('epRenewSess').value)||'0')||0;
  p.renewAfterMonths=parseInt((document.getElementById('epRenewMo')&&document.getElementById('epRenewMo').value)||'0')||0;
  sv();clM('mA');R();toast('Patient modifi√©');
}


function delPat(pid){
  var p=gp(pid);var pName=p?(p.lastName+' '+p.firstName):'ce patient';
  if(!confirm('Supprimer '+pName+' et toutes ses s√©ances ?'))return;
  D.patients=D.patients.filter(function(p){return p.id!==pid});
  D.appointments=D.appointments.filter(function(a){return a.patientId!==pid});
  sv();clM('mP');R();toast('Patient supprim√©');
}

function addDoc(pid){
  var inp=document.createElement('input');inp.type='file';inp.accept='image/*,application/pdf,.doc,.docx';
  inp.onchange=function(e){var f=e.target.files[0];if(!f)return;var r=new FileReader();
    r.onload=function(ev){var p=gp(pid);if(p){if(!p.documents)p.documents=[];p.documents.push({name:f.name,data:ev.target.result});sv();openPC(pid);toast('Document ajout√©')}};
    r.readAsDataURL(f)};inp.click();
}

function takePhoto(pid){
  var inp=document.createElement('input');inp.type='file';inp.accept='image/*';inp.setAttribute('capture','environment');
  inp.onchange=function(e){var f=e.target.files[0];if(!f)return;var r=new FileReader();
    r.onload=function(ev){var p=gp(pid);if(p){if(!p.documents)p.documents=[];p.documents.push({name:'Photo_'+dk(new Date())+'.jpg',data:ev.target.result});sv();openPC(pid);toast('Photo ajout√©e')}};
    r.readAsDataURL(f)};inp.click();
}

function rmDoc(pid,idx){var p=gp(pid);if(p&&p.documents){p.documents.splice(idx,1);sv();openPC(pid)}}

/* ‚ïê‚ïê‚ïê HISTORY ‚ïê‚ïê‚ïê */
function openHist(pid){
  var p=gp(pid);if(!p)return;
  document.getElementById('mHT').innerHTML='üìã '+esc(p.lastName)+' '+esc(p.firstName);
  var all=D.appointments.filter(function(a){return a.patientId===pid}).sort(function(a,b){return(a.date+a.time).localeCompare(b.date+b.time)});
  var today=todayKey();
  var past=all.filter(function(a){return a.date<=today});
  var future=all.filter(function(a){return a.date>today});
  var done=past.filter(function(a){return!a.cancelled}).length;
  var cancelled=all.filter(function(a){return a.cancelled}).length;
  var total=past.length;
  var sc=getSessionCount(pid);

  const filt=(document.getElementById('hflt')&&document.getElementById('hflt').value)||'all';
  function passF(a){
    if(filt==='all')return true;
    if(filt==='billed')return !!a.billed;
    if(filt==='unbilled')return isBillable(a)&&!a.billed;
    return true;
  }

  var h='<div class="hs">'+
    '<div class="hst"><div class="hn">'+sc.label+'</div><div class="hl">S√©ances'+(sc.total>0?' / '+sc.total:'')+'</div></div>'+
    '<div class="hst"><div class="hn" style="color:var(--accent)">'+done+'</div><div class="hl">R√©alis√©es</div></div>'+
    '<div class="hst"><div class="hn" style="color:#e74c3c">'+cancelled+'</div><div class="hl">Annul√©es</div></div>'+
    '<div class="hst"><div class="hn" style="color:var(--c0)">'+future.length+'</div><div class="hl">Futures</div></div></div>'+
    (sc.needsRenewal?'<div style="padding:8px 10px;background:#fff3cd;border-radius:8px;font-size:12px;color:#8a6d3b;margin-bottom:8px">üìã <b>Renouvellement d\'ordonnance recommand√©</b></div>':'')+
    '<div style="display:flex;gap:10px;align-items:center;margin:10px 0">'+
      '<div style="font-size:12px;color:var(--text2)">Filtre :</div>'+
      '<select id="hflt" onchange="openHist(\''+pid+'\')" style="height:34px;border-radius:12px;border:1px solid var(--border);background:#fff;color:var(--text);padding:0 10px">'+
        '<option value="all" '+(filt==='all'?'selected':'')+'>Toutes</option>'+
        '<option value="billed" '+(filt==='billed'?'selected':'')+'>Factur√©es</option>'+
        '<option value="unbilled" '+(filt==='unbilled'?'selected':'')+'>Non factur√©es</option>'+
      '</select>'+
      '<button class="btn bs" style="margin-left:auto" onclick="billPatient(\''+pid+'\',true)">üíµ Forcer</button>'+
    '</div>';

  function hi(a,isFut){
    var m=gm(a.motifId);var ci=m?m.ci:0;
    const lab=(a.type==='bilan'||a.isBilan)?'üÖ±Ô∏è Bilan':(m?m.label:'?');
    const billedTag=(a.billed?'<span class="hib" style="background:#e6f7ee;color:#1e8e3e">Factur√©e</span>':'');
    const unbTag=(!a.billed && isBillable(a)?'<span class="hib" style="background:#fff3cd;color:#8a6d3b">Non factur√©e</span>':'');
    return '<div class="hi'+(isFut?' fut':'')+(a.cancelled?' cncl':'')+'" style="border-left-color:'+CL[ci%6].bd+'" onclick="showCtx(event,\''+a.id+'\')">'+
      '<div class="hid">'+fmtS(a.date)+' '+a.time+'</div>'+
      '<div class="him">'+esc(lab)+'</div>'+
      (a.cancelled?'<div class="hib" style="background:#fce0e8;color:#e74c3c">Annul√©e</div>':(billedTag||unbTag))+
      '</div>';
  }

  if(future.filter(passF).length){h+='<h3 style="font-size:12px;color:var(--text2);margin:8px 0 4px">√Ä venir</h3>';
    var fRev=future.slice().reverse().filter(passF);
    for(var i=0;i<fRev.length;i++){h+=hi(fRev[i],true)}}

  if(past.filter(passF).length){h+='<h3 style="font-size:12px;color:var(--text2);margin:8px 0 4px">Pass√©es</h3>';
    var pRev=past.slice().reverse().filter(passF);
    for(var j=0;j<pRev.length;j++){h+=hi(pRev[j],false)}}

  if(!all.filter(passF).length)h+='<div style="text-align:center;padding:20px;color:var(--text2)">Aucune s√©ance</div>';
  document.getElementById('mHB').innerHTML=h;
  opM('mH');
}


/* ‚ïê‚ïê‚ïê SETTINGS ‚ïê‚ïê‚ïê */
function openSet(){
  var b=document.getElementById('mSB');
  var dayN={0:'Dimanche',1:'Lundi',2:'Mardi',3:'Mercredi',4:'Jeudi',5:'Vendredi',6:'Samedi'};
  var dayShort={0:'Dim',1:'Lun',2:'Mar',3:'Mer',4:'Jeu',5:'Ven',6:'Sam'};

  var motH=D.motifs.map(function(m,i){
    var c=CL[m.ci%6];
    var slotsLabel=(m.slots&&m.slots>1)?(' ¬∑ '+m.slots+' places'):'';
    var visIcon=m.hiddenForPatient?'‚ùå':'üëÅÔ∏è';
    var visTitle=m.hiddenForPatient?'Invisible sur app Patient':'Visible sur app Patient';
    return'<div class="mi motDrag" draggable="true" data-motidx="'+i+'" style="cursor:grab"><span style="font-size:14px;color:var(--text3);cursor:grab;margin-right:4px" class="dragH">‚ò∞</span><span style="cursor:pointer;font-size:16px" title="'+visTitle+'" onclick="togMotVis('+i+')">'+visIcon+'</span><div class="md" style="background:'+c.bd+'"></div><div class="ml">'+esc(m.label)+'</div><div class="mu">'+m.duration+'min'+slotsLabel+'</div>'+
    '<button class="sb edt" onclick="editMot('+i+')">‚úè</button><button class="sb del" onclick="rmMot('+i+')">√ó</button></div>'}).join('');

  var opH=D.openings.map(function(o,i){
    return'<div class="si"><div class="sd">'+(dayN[o.day]||('J'+o.day))+'</div>'+
    '<input type="time" value="'+o.start+'" onchange="updOp('+i+',\'start\',this.value)" step="300">'+
    '<span class="sa2">‚Üí</span><input type="time" value="'+o.end+'" onchange="updOp('+i+',\'end\',this.value)" step="300">'+
    '<button class="sb del" onclick="rmOp('+i+')">√ó</button></div>'}).join('');

  var daysAll=[1,2,3,4,5,6,0];
  var daysCh=daysAll.map(function(d){
    return'<div class="chip'+(D.days.includes(d)?' sel':'')+'" data-dow="'+d+'" style="background:var(--bg)">'+dayShort[d]+'</div>';
  }).join('');

  var addBtns=sortDows(D.days).map(function(d){
    return'<button class="addb" style="flex:1;min-width:120px" onclick="addOp('+d+')">+ '+dayN[d]+'</button>';
  }).join('');

  b.innerHTML=
    '<div class="ss"><h3>üìÖ Jours de s√©ances</h3>'+
      '<div class="chips" id="dayCh">'+daysCh+'</div>'+
      '<div style="font-size:11px;color:var(--text2);margin-top:6px">Ces jours seront s√©lectionnables dans l\'agenda, dans les plages d\'ouverture et la r√©currence.</div>'+
    '</div>'+
    '<div class="ss"><h3>üìã Motifs de consultation</h3>'+
      '<div style="font-size:11px;color:var(--text2);margin-bottom:6px">‚ò∞ Glissez pour r√©ordonner l\'affichage sur l\'app patient.</div>'+
      '<div id="motifListDrag">'+motH+'</div>'+
      '<button class="addb" onclick="editMot(-1)">+ Ajouter un motif</button>'+
    '</div>'+
    '<div class="ss"><h3>üïê Plages d\'ouverture</h3>'+opH+
      '<div style="display:flex;flex-wrap:wrap;gap:6px">'+addBtns+'</div>'+
    '</div>'+
    '<div class="ss"><h3>üìè Amplitude horaire</h3>'+
      '<div class="si"><div class="sd">Grille</div>'+
        '<input type="time" id="sST" value="'+String(D.startH).padStart(2,'0')+':00" step="3600" onchange="updAmpT()">'+
        '<span class="sa2">‚Üí</span>'+
        '<input type="time" id="sET" value="'+String(D.endH).padStart(2,'0')+':00" step="3600" onchange="updAmpT()">'+
      '</div>'+
      '<div style="font-size:11px;color:var(--text2);margin-top:6px">La grille reste align√©e √† l\'heure (minutes ignor√©es).</div>'+
    '</div>'+
    '<div class="ss"><h3>üèãÔ∏è Groupe sp√©cial</h3>'+
      '<div class="fg"><label>Nom du groupe</label>'+
        '<input type="text" id="sGroupName" value="'+esc(D.groupName||'')+'" placeholder="ex: Groupe Sport, Pilates..." onchange="D.groupName=this.value.trim();sv();toast(\'Enregistr√©\')">'+
      '</div>'+
      '<div style="font-size:11px;color:var(--text2);margin-top:6px">Ce nom appara√Ætra dans l\'onglet Groupe et les statistiques.</div>'+
    '</div>'+
    '<div class="ss"><h3>üíµ Facturation quotidienne</h3>'+
      '<div style="font-size:11px;color:var(--text2);margin-bottom:8px">Nombre de patients √† facturer (üíµ) par jour d\'ouverture. Les patients avec ‚ùó ou ‚ÄºÔ∏è ne sont pas propos√©s.</div>'+
      '<div class="fg"><label>Facturations üíµ par jour</label>'+
        '<input type="number" id="sBillsDay" min="0" max="20" value="'+(D.billsPerDay||0)+'" onchange="D.billsPerDay=parseInt(this.value)||0;invalidateBillCache();sv();R();toast(\'Enregistr√©\')">'+
      '</div>'+
    '</div>'+
    '<div class="ss"><h3>üÖ±Ô∏è Montant des Bilans (‚Ç¨)</h3>'+
      '<div class="fr"><div class="fg"><label>Montant</label>'+
        '<input id="sBilanFee" type="number" step="0.01" value="'+(Number(D.bilanFee||0).toFixed(2))+'" onchange="setBilanFee(this.value)">' +
      '</div></div>'+
      '<div style="font-size:11px;color:var(--text2);margin-top:6px">Montant utilis√© pour les s√©ances üÖ±Ô∏è ajout√©es depuis l\'agenda.</div>'+
    '</div>'+
    '<div class="ss"><h3>üì± R√©servation Patient en ligne</h3>'+
      '<div style="font-size:11px;color:var(--text2);margin-bottom:8px">Param√®tres pour l\'application patient (PhysioFlow Patient).</div>'+
      '<div class="fg"><label>Nom du praticien (affich√© aux patients)</label>'+
        '<input type="text" id="sProName" value="'+esc(D.proName||'')+'" placeholder="Mr/Mme Dupont" onchange="updBookingRules()">'+
      '</div>'+
      '<div class="fg"><label>Votre num√©ro de t√©l√©phone (pour recevoir les notifications SMS)</label>'+
        '<input type="tel" id="sProPhone" value="'+(D.proPhone||'')+'" placeholder="06 xx xx xx xx" onchange="updBookingRules()">'+
      '</div>'+
      '<div class="fr"><div class="fg"><label>D√©lai min avant s√©ance (heures)</label>'+
        '<input type="number" id="sRuleMinH" min="0" max="168" value="'+(D.bookingRules?D.bookingRules.minHoursBefore:2)+'" onchange="updBookingRules()">'+
      '</div>'+
      '<div class="fg"><label>R√©servation max (jours √† l\'avance)</label>'+
        '<input type="number" id="sRuleMaxD" min="1" max="365" value="'+(D.bookingRules?D.bookingRules.maxDaysAhead:60)+'" onchange="updBookingRules()">'+
      '</div></div>'+
      '<div class="fg" style="margin-top:6px"><label>D√©lai min pour annuler (heures avant la s√©ance)</label>'+
        '<input type="number" id="sRuleCancelH" min="0" max="168" value="'+(D.bookingRules?D.bookingRules.minHoursCancel||24:24)+'" onchange="updBookingRules()">'+
      '</div>'+
      '<div class="pcks" style="margin-top:10px">'+
        '<label><input type="checkbox" id="sRefuseNew" '+(D.bookingRules&&D.bookingRules.refuseNewPatients?'checked':'')+' onchange="updBookingRules()"> üö´ Refuser les nouveaux patients</label>'+
        '<label><input type="checkbox" id="sRefuseTreat" '+(D.bookingRules&&D.bookingRules.refuseNewTreatments?'checked':'')+' onchange="updBookingRules()"> üö´ Refuser les nouveaux traitements</label>'+
      '</div>'+
      '<div id="sRefuseTreatOpt" style="display:'+(D.bookingRules&&D.bookingRules.refuseNewTreatments?'block':'none')+';margin-top:6px">'+
        '<div class="fg"><label>Inactif depuis (mois)</label>'+
          '<input type="number" id="sRefuseMonths" min="1" max="24" value="'+(D.bookingRules&&D.bookingRules.refuseInactiveMonths||3)+'" onchange="updBookingRules()">'+
        '</div>'+
      '</div>'+
      '<div class="pcks" style="margin-top:10px">'+
        '<label><input type="checkbox" id="sCarteVitaleSMS" '+(D.carteVitaleSMS!==false?'checked':'')+' onchange="D.carteVitaleSMS=this.checked;sv()"> üí≥ Rappel Carte Vitale auto (SMS aux patients üíµ √† l\'ouverture)</label>'+
      '</div>'+
      '<button class="btn bp bw" onclick="fbPush();toast(\'Synchronis√© ‚úì\')">üîÑ Forcer la synchronisation Firebase</button>'+
    '</div>'+
    '<div class="ss"><h3>üìä Donn√©es</h3>'+
      '<div style="font-size:11px;color:var(--text2);margin-bottom:8px">Sauvegarde auto quotidienne sur Firebase (30 jours). En cas de probl√®me, restaurez depuis Firebase ou un fichier local.</div>'+
      '<div class="br" style="margin-top:0"><button class="btn bs" style="flex:1" onclick="showRestoreBackups()">üîÑ Restaurer (Firebase)</button><button class="btn bs" style="flex:1" onclick="downloadBackup()">üíæ Sauvegarder sur t√©l√©phone</button></div>'+
      '<div class="br" style="margin-top:6px"><button class="btn bs" style="flex:1" onclick="impD()">üìÇ Charger un fichier local</button></div>'+
      '<div style="margin-top:8px"><button class="btn bd bw" onclick="rstD()">üóë R√©initialiser</button></div>'+
    '</div>';

  document.querySelectorAll('#dayCh .chip').forEach(function(c){
    c.onclick=function(){togDay(parseInt(c.dataset.dow))};
  });

  opM('mS');
  /* Init drag & drop for motifs (touch + mouse) */
  setTimeout(initMotifDrag,100);
}

var _motDragIdx=null;
function initMotifDrag(){
  var container=document.getElementById('motifListDrag');
  if(!container)return;
  var items=container.querySelectorAll('.motDrag');
  items.forEach(function(el){
    /* Desktop drag */
    el.addEventListener('dragstart',function(e){
      _motDragIdx=parseInt(el.dataset.motidx);
      el.style.opacity='0.4';
      e.dataTransfer.effectAllowed='move';
    });
    el.addEventListener('dragend',function(){el.style.opacity='1'});
    el.addEventListener('dragover',function(e){e.preventDefault();e.dataTransfer.dropEffect='move';el.style.borderTop='2px solid var(--accent)'});
    el.addEventListener('dragleave',function(){el.style.borderTop=''});
    el.addEventListener('drop',function(e){
      e.preventDefault();el.style.borderTop='';
      var toIdx=parseInt(el.dataset.motidx);
      if(_motDragIdx!==null && _motDragIdx!==toIdx)moveMotif(_motDragIdx,toIdx);
      _motDragIdx=null;
    });
    /* Touch drag */
    var touchStartY=0,touchIdx=null,placeholder=null;
    el.addEventListener('touchstart',function(e){
      var handle=e.target.closest('.dragH');
      if(!handle)return;
      touchIdx=parseInt(el.dataset.motidx);
      touchStartY=e.touches[0].clientY;
      el.style.opacity='0.5';
    },{passive:true});
    el.addEventListener('touchmove',function(e){
      if(touchIdx===null)return;
      e.preventDefault();
      var y=e.touches[0].clientY;
      var elems=container.querySelectorAll('.motDrag');
      elems.forEach(function(it){it.style.borderTop=''});
      /* Find which element we're over */
      elems.forEach(function(it){
        var r=it.getBoundingClientRect();
        if(y>=r.top && y<=r.bottom)it.style.borderTop='2px solid var(--accent)';
      });
    },{passive:false});
    el.addEventListener('touchend',function(e){
      if(touchIdx===null)return;
      el.style.opacity='1';
      var y=e.changedTouches[0].clientY;
      var elems=container.querySelectorAll('.motDrag');
      var toIdx=touchIdx;
      elems.forEach(function(it){
        it.style.borderTop='';
        var r=it.getBoundingClientRect();
        if(y>=r.top && y<=r.bottom)toIdx=parseInt(it.dataset.motidx);
      });
      if(touchIdx!==toIdx)moveMotif(touchIdx,toIdx);
      touchIdx=null;
    });
  });
}

function moveMotif(fromIdx,toIdx){
  if(fromIdx===toIdx)return;
  var m=D.motifs.splice(fromIdx,1)[0];
  D.motifs.splice(toIdx,0,m);
  sv();fbPush();openSet();
  toast('Ordre des motifs mis √† jour');
}

function updAmpT(){
  var s=(document.getElementById('sST').value||'08:00');
  var e=(document.getElementById('sET').value||'19:00');
  D.startH=parseInt((s.split(':')[0]||'8'),10)||8;
  D.endH=parseInt((e.split(':')[0]||'19'),10)||19;
  if(D.endH<=D.startH)D.endH=D.startH+1;
  sv();R();
}

function updBookingRules(){
  if(!D.bookingRules)D.bookingRules={};
  D.bookingRules.minHoursBefore=parseInt(document.getElementById('sRuleMinH').value)||2;
  D.bookingRules.maxDaysAhead=parseInt(document.getElementById('sRuleMaxD').value)||60;
  D.bookingRules.minHoursCancel=parseInt((document.getElementById('sRuleCancelH')&&document.getElementById('sRuleCancelH').value)||'24')||24;
  var refuseTreat=!!(document.getElementById('sRefuseTreat')&&document.getElementById('sRefuseTreat').checked);
  var refuseNew=!!(document.getElementById('sRefuseNew')&&document.getElementById('sRefuseNew').checked);
  /* If refuse treatments is on, also force refuse new patients */
  if(refuseTreat)refuseNew=true;
  D.bookingRules.refuseNewPatients=refuseNew;
  D.bookingRules.refuseNewTreatments=refuseTreat;
  D.bookingRules.refuseInactiveMonths=parseInt((document.getElementById('sRefuseMonths')&&document.getElementById('sRefuseMonths').value)||'3')||3;
  /* Update checkboxes state */
  if(document.getElementById('sRefuseNew'))document.getElementById('sRefuseNew').checked=refuseNew;
  if(document.getElementById('sRefuseTreatOpt'))document.getElementById('sRefuseTreatOpt').style.display=refuseTreat?'block':'none';
  D.proPhone=(document.getElementById('sProPhone').value||'').trim();
  D.proName=(document.getElementById('sProName').value||'').trim();
  sv();fbPush();toast('Param√®tres mis √† jour');
}

function togDay(dow){
  if(!Array.isArray(D.days))D.days=[1,4];
  if(D.days.includes(dow)){
    if(D.days.length<=1){toast('Gardez au moins 1 jour');return;}
    D.days=D.days.filter(function(x){return x!==dow});
  } else {
    D.days.push(dow);
    D.days=[...new Set(D.days.map(Number))].filter(d=>d>=0&&d<=6);
  }
  sv();
  ensureActiveDate(cD);
  openSet();
  R();
}
function updOp(i,f,v){D.openings[i][f]=v;sv()}
function rmOp(i){D.openings.splice(i,1);sv();openSet()}
function addOp(day){D.openings.push({day:day,start:'08:45',end:'12:35'});sv();openSet()}
function rmMot(i){D.motifs.splice(i,1);sv();openSet()}
function togMotVis(i){D.motifs[i].hiddenForPatient=!D.motifs[i].hiddenForPatient;sv();openSet();fbPush();toast(D.motifs[i].hiddenForPatient?'Motif masqu√© pour les patients':'Motif visible pour les patients')}

function editMot(idx){
  var isNew=idx<0;
  var m=isNew?{label:'',duration:30,ci:0,times:[],slots:1,allowSimul:false,simulWith:''}:(D.motifs[idx]||{label:'',duration:30,ci:0,times:[],slots:1,allowSimul:false,simulWith:''});
  if(!Array.isArray(m.times))m.times=[];
  if(!m.slots)m.slots=1;
  document.getElementById('mMT').textContent=isNew?'Nouveau motif':'Modifier le motif';
  var colH=CL.map(function(c,i){return'<div class="chip'+(m.ci===i?' sel':'')+'" data-ci="'+i+'" style="background:'+c.bg+';color:'+c.bd+'">'+c.lb+'</div>'}).join('');
  var tStr=m.times.slice().filter(Boolean).sort(function(a,b){return t2m(a)-t2m(b)}).join(',');
  /* Build simulWith options from other motifs */
  var simulOpts='<option value="">‚Äî Aucun ‚Äî</option>';
  D.motifs.forEach(function(om,oi){
    if(oi===idx)return;
    simulOpts+='<option value="'+om.id+'"'+(m.simulWith===om.id?' selected':'')+'>'+esc(om.label)+'</option>';
  });
  document.getElementById('mMB').innerHTML=
    '<div class="fg"><label>Nom</label><input id="emL" value="'+esc(m.label)+'"></div>'+
    '<div class="fg"><label>Description (visible par les patients)</label><textarea id="emDesc" rows="3" style="resize:vertical;min-height:60px;white-space:pre-wrap;word-wrap:break-word" placeholder="Ex: S√©ance de r√©√©ducation active de 45 minutes...">'+esc(m.description||'')+'</textarea></div>'+
    '<div class="fr"><div class="fg"><label>Dur√©e par d√©faut (min)</label><input type="number" id="emD" value="'+m.duration+'" min="5" max="240" step="5"></div>'+
    '<div class="fg"><label>Places par cr√©neau</label><input type="number" id="emSlots" value="'+m.slots+'" min="1" max="10" step="1"></div></div>'+
    '<div style="font-size:11px;color:var(--text2);margin:-6px 0 10px">Nombre de patients pouvant r√©server le m√™me horaire typique.</div>'+
    '<div class="pcks" style="margin-bottom:10px"><label><input type="checkbox" id="emSimul" '+(m.allowSimul?'checked':'')+' onchange="document.getElementById(\'emSimulW\').style.display=this.checked?\'block\':\'none\'"> Autoriser simultan√©it√© avec un autre motif</label></div>'+
    '<div id="emSimulW" style="display:'+(m.allowSimul?'block':'none')+';margin-bottom:10px"><div class="fg"><label>Simultan√© avec</label><select id="emSimulWith">'+simulOpts+'</select></div></div>'+
    '<h3>Heures typiques</h3>'+
    '<input type="hidden" id="emT" value="'+esc(tStr)+'">'+
    '<input type="hidden" id="emSlotEx" value="'+esc(JSON.stringify(m.slotExceptions||{}))+'">'+
    '<div class="chips" id="emTCh"></div>'+
    '<div class="si" style="margin-top:6px"><div class="sd">+ Heure</div>'+
      '<input type="time" id="emTN" value="09:00" step="300">'+
      '<button class="sb edt" onclick="addMotTime()">Ôºã</button>'+
    '</div>'+
    '<div id="slotExZone" style="margin-top:8px"></div>'+
    '<h3>Couleur</h3><div class="chips" id="emC">'+colH+'</div>'+
    '<div class="br"><button class="btn bp bw" onclick="svMot('+idx+')">Enregistrer</button></div>';

  document.querySelectorAll('#emC .chip').forEach(function(c){c.onclick=function(){
    document.querySelectorAll('#emC .chip').forEach(function(x){x.classList.remove('sel')});c.classList.add('sel')
  }});
  renderMotTimes();
  opM('mM');
}

function readMotTimes(){
  var v=((document.getElementById('emT')&&document.getElementById('emT').value)||'').trim();
  if(!v)return [];
  return v.split(',').map(function(x){return x.trim()}).filter(Boolean);
}
function writeMotTimes(arr){
  var u=[...new Set((arr||[]).map(function(x){return (x||'').trim()}).filter(Boolean))].sort(function(a,b){return t2m(a)-t2m(b)});
  var inp=document.getElementById('emT');if(inp)inp.value=u.join(',');
  renderMotTimes();
}
function renderMotTimes(){
  var box=document.getElementById('emTCh');if(!box)return;
  var arr=readMotTimes();
  var slotEx=readSlotExceptions();
  var defSlots=parseInt(document.getElementById('emSlots').value)||1;
  if(!arr.length){box.innerHTML='<div style="font-size:12px;color:var(--text2);padding:2px 0">Aucune heure typique</div>';renderSlotExceptions();return;}
  box.innerHTML=arr.map(function(t){
    var ex=slotEx[t];
    var badge=(ex&&ex!==defSlots)?(' <span style="font-size:9px;background:var(--accent);color:#fff;border-radius:4px;padding:0 3px">'+ex+'pl</span>'):'';
    return '<div class="chip" style="background:var(--bg);border:1.5px solid var(--border);color:var(--text)" onclick="rmMotTime(\''+t+'\')">'+t+badge+' √ó</div>';
  }).join('');
  renderSlotExceptions();
}
function readSlotExceptions(){
  try{return JSON.parse((document.getElementById('emSlotEx')&&document.getElementById('emSlotEx').value)||'{}');}catch(e){return{}}
}
function writeSlotExceptions(obj){
  var inp=document.getElementById('emSlotEx');if(inp)inp.value=JSON.stringify(obj||{});
}
function renderSlotExceptions(){
  var zone=document.getElementById('slotExZone');if(!zone)return;
  var arr=readMotTimes();var slotEx=readSlotExceptions();
  var defSlots=parseInt(document.getElementById('emSlots').value)||1;
  if(!arr.length){zone.innerHTML='';return;}
  var hasAny=arr.some(function(t){return slotEx[t]&&slotEx[t]!==defSlots});
  var h='<div style="font-size:11px;color:var(--text2);margin-bottom:4px">Exceptions de places par heure (d√©faut: '+defSlots+') :</div>';
  h+='<div style="display:flex;flex-wrap:wrap;gap:6px">';
  arr.forEach(function(t){
    var val=slotEx[t]||defSlots;
    h+='<div style="display:flex;align-items:center;gap:3px;font-size:11px;background:var(--bg);border-radius:6px;padding:3px 6px;border:1px solid var(--border2)">'+
      '<span>'+t+'</span>'+
      '<input type="number" min="1" max="10" value="'+val+'" style="width:40px;height:24px;border-radius:4px;border:1px solid var(--border);text-align:center;font-size:11px" onchange="updSlotEx(\''+t+'\',this.value)">'+
      '</div>';
  });
  h+='</div>';
  zone.innerHTML=h;
}
function updSlotEx(time,val){
  var ex=readSlotExceptions();
  var defSlots=parseInt(document.getElementById('emSlots').value)||1;
  var v=parseInt(val)||defSlots;
  if(v===defSlots){delete ex[time];}else{ex[time]=v;}
  writeSlotExceptions(ex);renderMotTimes();
}
function addMotTime(){
  var i=document.getElementById('emTN');if(!i)return;
  var t=i.value;
  if(!t){toast('Choisissez une heure');return;}
  var arr=readMotTimes();
  if(arr.indexOf(t)>=0){toast('D√©j√† ajout√©e');return;}
  arr.push(t);writeMotTimes(arr);toast('Heure ajout√©e');
}
function rmMotTime(t){
  var arr=readMotTimes().filter(function(x){return x!==t});
  writeMotTimes(arr);
}

function svMot(idx){
  var label=document.getElementById('emL').value.trim();if(!label){toast('Nom requis');return}
  var dur=parseInt(document.getElementById('emD').value)||30;
  var slots=parseInt(document.getElementById('emSlots').value)||1;
  if(slots<1)slots=1;if(slots>10)slots=10;
  var allowSimul=!!(document.getElementById('emSimul')&&document.getElementById('emSimul').checked);
  var simulWith=(document.getElementById('emSimulWith')&&document.getElementById('emSimulWith').value)||'';
  var selC=document.querySelector('#emC .chip.sel');var ci=selC?parseInt(selC.dataset.ci):0;
  var times=readMotTimes();
  var desc=(document.getElementById('emDesc')&&document.getElementById('emDesc').value||'').trim();
  var slotEx=readSlotExceptions();
  if(idx<0){D.motifs.push({id:uid(),label:label,duration:dur,ci:ci,times:times,slots:slots,allowSimul:allowSimul,simulWith:simulWith,description:desc,slotExceptions:slotEx})}
  else{D.motifs[idx].label=label;D.motifs[idx].duration=dur;D.motifs[idx].ci=ci;D.motifs[idx].times=times;D.motifs[idx].slots=slots;D.motifs[idx].allowSimul=allowSimul;D.motifs[idx].simulWith=simulWith;D.motifs[idx].description=desc;D.motifs[idx].slotExceptions=slotEx}
  sv();clM('mM');openSet();toast('Motif enregistr√©');
}

function expD(){var j=JSON.stringify(D,null,2);var b=new Blob([j],{type:'application/json'});var a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='physioflow_'+dk(new Date())+'.json';a.click();toast('Sauvegarde t√©l√©charg√©e')}
function impD(){var inp=document.createElement('input');inp.type='file';inp.accept='.json';inp.onchange=function(e){var f=e.target.files[0];if(!f)return;var r=new FileReader();r.onload=function(ev){try{var d=JSON.parse(ev.target.result);
  /* Handle backup format (from downloadBackup) */
  if(d.appData && d.appData.motifs){d=d.appData;}
  if(d.data && d.data.motifs){d=d.data;}
  if(d.motifs&&d.appointments){D=d;_loadedFromDefaults=false;if(!D.patients)D.patients=[];sv();clM('mS');R();toast('Donn√©es charg√©es ‚úì');}else{toast('Fichier non reconnu');}}catch(e2){toast('Erreur de lecture')}};r.readAsText(f)};inp.click()}
function rstD(){if(!confirm('Tout supprimer ?'))return;D=defD();sv();clM('mS');R();toast('R√©initialis√©')}

/* ‚ïê‚ïê‚ïê TAP ON GRID TO CREATE ‚ïê‚ïê‚ïê */
(function(){
  var sa=document.getElementById('sa');
  var tapTimer=null;
  sa.addEventListener('click',function(e){
    /* Only if clicking on empty space (not on an appointment) */
    if(e.target.closest('.ap'))return;
    var rect=sa.getBoundingClientRect();
    var y=e.clientY-rect.top+document.getElementById('pw').scrollTop;
    /* Compensate for the scroll position within the grid */
    var scrollTop=document.getElementById('pw').scrollTop;
    var saRect=sa.getBoundingClientRect();
    var pgRect=document.getElementById('pg').getBoundingClientRect();
    var relY=e.clientY-pgRect.top+scrollTop;
    var mins=Math.round((relY/80)*60+D.startH*60);
    var snap=Math.round(mins/5)*5;
    openAF(null);
    setTimeout(function(){
      var tmEl=document.getElementById('fTm');
      if(tmEl)tmEl.value=m2t(snap);
    },100);
  });
})();

/* ‚ïê‚ïê‚ïê FIXER LES PROCHAINS RDV ‚ïê‚ïê‚ïê */
var FIX_RDV={patientId:'',motifId:'',defaultTime:'',planned:[]};

function openFixNextRdv(apId){
  var ap=D.appointments.find(function(a){return a.id===apId});if(!ap)return;
  var pat=ap.patientId?gp(ap.patientId):null;if(!pat)return;
  FIX_RDV={patientId:ap.patientId,motifId:ap.motifId||'',defaultTime:ap.time||'09:00',planned:[]};
  FIX_RDV._calMonth=new Date();
  document.getElementById('mMT').textContent='üìÖ Fixer les prochains RDV ‚Äî '+esc(pat.lastName)+' '+esc(pat.firstName);
  renderFixRdv();
  opM('mM');
}

function renderFixRdv(){
  var b=document.getElementById('mMB');
  var cm=FIX_RDV._calMonth;
  var y=cm.getFullYear(),m=cm.getMonth();
  var _mn=['Jan','F√©v','Mar','Avr','Mai','Jun','Jul','Ao√ª','Sep','Oct','Nov','D√©c'];
  var _dl=['L','M','M','J','V','S','D'];
  var first=new Date(y,m,1);
  var start=(first.getDay()+6)%7;
  var dim=new Date(y,m+1,0).getDate();
  var today=new Date();today.setHours(0,0,0,0);

  /* Calendar header */
  var calH='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">'+
    '<button class="btn bs" onclick="FIX_RDV._calMonth.setMonth(FIX_RDV._calMonth.getMonth()-1);renderFixRdv()">‚Äπ</button>'+
    '<b>'+_mn[m]+' '+y+'</b>'+
    '<button class="btn bs" onclick="FIX_RDV._calMonth.setMonth(FIX_RDV._calMonth.getMonth()+1);renderFixRdv()">‚Ä∫</button>'+
  '</div>';
  calH+='<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px;text-align:center;font-size:11px;margin-bottom:4px">';
  _dl.forEach(function(d){calH+='<div style="font-weight:700;color:var(--text2)">'+d+'</div>'});
  for(var i=0;i<start;i++)calH+='<div></div>';
  for(var d=1;d<=dim;d++){
    var dt=new Date(y,m,d);
    var k=dk(dt);
    var dow=dt.getDay();
    var isOpen=D.days.includes(dow);
    var past=dt<today;
    var isPlanned=FIX_RDV.planned.some(function(p){return p.date===k});
    var hasExisting=D.appointments.some(function(a){return a.date===k&&a.patientId===FIX_RDV.patientId&&!a.cancelled});
    var cls='';
    if(!isOpen||past)cls='opacity:.3;pointer-events:none;';
    else if(isPlanned)cls='background:var(--accent);color:#fff;border-radius:50%;cursor:pointer;';
    else if(hasExisting)cls='background:var(--c1bg);border-radius:50%;cursor:pointer;';
    else cls='cursor:pointer;border-radius:50%;';
    calH+='<div style="width:28px;height:28px;display:flex;align-items:center;justify-content:center;margin:auto;font-size:12px;'+cls+'" '+((!isOpen||past)?'':'onclick="fixRdvSelectDate(\''+k+'\')"')+'>'+d+'</div>';
  }
  calH+='</div>';

  /* Planned list */
  var listH='';
  if(FIX_RDV.planned.length){
    listH='<div style="margin-top:12px"><div style="font-weight:700;font-size:13px;margin-bottom:6px">S√©ances pr√©vues ('+FIX_RDV.planned.length+') :</div>';
    FIX_RDV.planned.forEach(function(p,idx){
      var mot=D.motifs.find(function(mm){return mm.id===p.motifId});
      var dP=p.date.split('-');var dateFr=(dP[2]||'')+'/'+(dP[1]||'');
      listH+='<div style="display:flex;align-items:center;gap:6px;padding:4px 8px;background:var(--bg);border-radius:6px;margin-bottom:3px;font-size:12px">'+
        '<span style="flex:1">'+dateFr+' √† <b>'+p.time+'</b> ‚Äî '+(mot?esc(mot.label):'?')+'</span>'+
        '<button style="color:#e74c3c;font-size:14px" onclick="FIX_RDV.planned.splice('+idx+',1);renderFixRdv()">√ó</button></div>';
    });
    listH+='</div>';
  }

  b.innerHTML=calH+listH+
    '<div class="br" style="margin-top:12px">'+
      '<button class="btn bp" style="flex:2" onclick="confirmFixRdv()" '+(FIX_RDV.planned.length?'':'disabled')+'>‚úÖ Valider '+FIX_RDV.planned.length+' s√©ance(s)</button>'+
      '<button class="btn" onclick="clM(\'mM\')">Annuler</button>'+
    '</div>';
}

function fixRdvSelectDate(dateKey){
  /* Check if already planned -> remove */
  var idx=FIX_RDV.planned.findIndex(function(p){return p.date===dateKey});
  if(idx>=0){FIX_RDV.planned.splice(idx,1);renderFixRdv();return;}
  /* Show motif + time picker for this date */
  var motifOpts=D.motifs.map(function(mm){
    return '<option value="'+mm.id+'" '+(mm.id===FIX_RDV.motifId?'selected':'')+'>'+esc(mm.label)+' ('+mm.duration+'min)</option>';
  }).join('');
  var dP=dateKey.split('-');var dateFr=(dP[2]||'')+'/'+(dP[1]||'');
  var zone=document.getElementById('mMB');
  /* Append a mini form at the bottom */
  var existing=document.getElementById('fixRdvPicker');
  if(existing)existing.remove();
  var div=document.createElement('div');
  div.id='fixRdvPicker';
  div.style.cssText='margin-top:12px;padding:12px;background:var(--surface);border:1px solid var(--border);border-radius:10px';
  div.innerHTML='<div style="font-weight:700;font-size:13px;margin-bottom:8px">'+dateFr+'</div>'+
    '<div class="fr"><div class="fg"><label>Motif</label><select id="fixMotif">'+motifOpts+'</select></div>'+
    '<div class="fg"><label>Heure</label><input type="time" id="fixTime" value="'+FIX_RDV.defaultTime+'" step="300"></div></div>'+
    '<button class="btn bp bw" style="margin-top:8px" onclick="fixRdvAdd(\''+dateKey+'\')">+ Ajouter</button>';
  zone.appendChild(div);
}

function fixRdvAdd(dateKey){
  var motifId=document.getElementById('fixMotif').value;
  var time=document.getElementById('fixTime').value;
  if(!time){toast('Choisissez une heure');return;}
  FIX_RDV.planned.push({date:dateKey,time:time,motifId:motifId});
  FIX_RDV.defaultTime=time;FIX_RDV.motifId=motifId;
  var el=document.getElementById('fixRdvPicker');if(el)el.remove();
  renderFixRdv();
}

function confirmFixRdv(){
  if(!FIX_RDV.planned.length)return;
  var pat=gp(FIX_RDV.patientId);
  FIX_RDV.planned.forEach(function(p){
    var mot=D.motifs.find(function(mm){return mm.id===p.motifId});
    D.appointments.push({
      id:uid(),type:'rdv',motifId:p.motifId,
      patientId:FIX_RDV.patientId,label:'',
      date:p.date,time:p.time,duration:mot?mot.duration:30,
      notes:'',cancelled:false,billed:false,billedAt:'',billedAmount:0,
      source:'pro'
    });
  });
  sv();R();fbPush();
  toast(FIX_RDV.planned.length+' s√©ance(s) programm√©e(s) ‚úì');
  FIX_RDV.planned=[];
  clM('mM');
}

/* ‚ïê‚ïê‚ïê SHARE LINK ‚ïê‚ïê‚ïê */
function shareLink(){
  var url='https://physiquerush.github.io/PhysioFlow-Patient/';
  var practName=D.proName||'Votre kin√©sith√©rapeute';
  var msg='Bonjour,\nPrenez rendez-vous en ligne avec '+practName+' :\n'+url;
  var b=document.getElementById('mMB');
  document.getElementById('mMT').textContent='üîó Partager PhysioFlow Patient';
  /* Generate QR code using a canvas */
  b.innerHTML=
    '<div style="text-align:center;margin-bottom:14px">'+
      '<div style="font-size:13px;color:var(--text2);margin-bottom:10px">Scannez le QR code ou partagez le lien</div>'+
      '<div id="qrBox" style="display:inline-block;padding:12px;background:#fff;border-radius:12px;border:1px solid var(--border)"><canvas id="qrCanvas"></canvas></div>'+
    '</div>'+
    '<div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:center">'+
      '<button class="btn bp" onclick="doShareLink()">üì§ Partager</button>'+
      '<button class="btn bs" onclick="doShareSMS()">üí¨ Envoyer par SMS</button>'+
      '<button class="btn bs" onclick="navigator.clipboard.writeText(\''+url+'\');toast(\'Lien copi√© ‚úì\')">üìã Copier le lien</button>'+
    '</div>'+
    '<div class="br"><button class="btn" onclick="clM(\'mM\')">Fermer</button></div>';
  opM('mM');
  setTimeout(function(){drawQR('qrCanvas',url)},100);
}
function doShareLink(){
  var url='https://physiquerush.github.io/PhysioFlow-Patient/';
  var practName=D.proName||'Votre kin√©sith√©rapeute';
  var msg='Bonjour,\nPrenez rendez-vous en ligne avec '+practName+' :\n'+url;
  if(navigator.share){navigator.share({title:'PhysioFlow ‚Äî '+practName,text:msg}).catch(function(){});}
  else{navigator.clipboard.writeText(msg);toast('Message copi√© ‚úì');}
}
function doShareSMS(){
  var url='https://physiquerush.github.io/PhysioFlow-Patient/';
  var practName=D.proName||'Votre kin√©sith√©rapeute';
  var msg='Bonjour,\nPrenez rendez-vous en ligne avec '+practName+' :\n'+url;
  var phone=prompt('Num√©ro de t√©l√©phone du patient :','');
  if(phone){window.location.href='sms:'+encodeURIComponent(phone.trim())+'?body='+encodeURIComponent(msg);}
}
/* Simple QR Code generator (alphanumeric URLs) using canvas */
function drawQR(canvasId,text){
  var c=document.getElementById(canvasId);if(!c)return;
  /* Use a simple QR approach via an image from a public API-free method */
  /* We'll draw a stylized link representation + load QR from Google Charts API alternative */
  var img=new Image();
  img.crossOrigin='anonymous';
  img.onload=function(){
    c.width=180;c.height=180;
    var ctx=c.getContext('2d');
    ctx.drawImage(img,0,0,180,180);
  };
  img.onerror=function(){
    /* Fallback: just show URL text */
    c.width=180;c.height=180;
    var ctx=c.getContext('2d');
    ctx.fillStyle='#f2efe9';ctx.fillRect(0,0,180,180);
    ctx.fillStyle='#1a1a2e';ctx.font='bold 12px sans-serif';ctx.textAlign='center';
    ctx.fillText('QR indisponible',90,85);
    ctx.font='10px sans-serif';ctx.fillText('Utilisez le bouton Partager',90,105);
  };
  img.src='https://api.qrserver.com/v1/create-qr-code/?size=180x180&data='+encodeURIComponent(text);
}

function showCloseDialog(){
  var b=document.getElementById('mMB');
  document.getElementById('mMT').textContent='Fermer PhysioFlow ?';
  b.innerHTML='<div style="text-align:center;padding:12px 0"><div style="font-size:36px;margin-bottom:8px">üëã</div>'+
    '<div style="font-size:13px;color:var(--text2);margin-bottom:16px">Vos donn√©es sont sauvegard√©es automatiquement.</div>'+
    '<div style="display:flex;gap:10px;justify-content:center"><button class="btn bp" onclick="window.close()">Fermer</button><button class="btn bs" onclick="clM(\'mM\')">Annuler</button></div></div>';
  opM('mM');
}

/* ‚ïê‚ïê‚ïê VACATION MODE ‚ïê‚ïê‚ïê */
function openVacationMode(){
  var vac=D.vacationMode||{enabled:false,from:'',to:'',msg:''};
  var b=document.getElementById('mMB');
  document.getElementById('mMT').textContent='üèñÔ∏è Mode Vacances';
  b.innerHTML=
    '<div style="font-size:12px;color:var(--text2);margin-bottom:12px">Bloque les r√©servations patients pendant la p√©riode d√©finie.</div>'+
    '<div class="pcks"><label><input type="checkbox" id="vacOn" '+(vac.enabled?'checked':'')+' onchange="document.getElementById(\'vacDates\').style.display=this.checked?\'block\':\'none\'"> Activer le mode vacances</label></div>'+
    '<div id="vacDates" style="display:'+(vac.enabled?'block':'none')+'">'+
      '<div class="fr"><div class="fg"><label>Du</label><input type="date" id="vacFrom" value="'+(vac.from||'')+'"></div>'+
      '<div class="fg"><label>Au</label><input type="date" id="vacTo" value="'+(vac.to||'')+'"></div></div>'+
      '<div class="fg"><label>Message affich√© aux patients</label><input id="vacMsg" value="'+esc(vac.msg||'Le cabinet est ferm√© pour cong√©s.')+'" placeholder="Message personnalis√©"></div>'+
    '</div>'+
    '<div class="br"><button class="btn bp" onclick="saveVacation()">Enregistrer</button><button class="btn" onclick="clM(\'mM\')">Fermer</button></div>';
  opM('mM');
}
function saveVacation(){
  if(!D.vacationMode)D.vacationMode={};
  D.vacationMode.enabled=!!(document.getElementById('vacOn')&&document.getElementById('vacOn').checked);
  D.vacationMode.from=(document.getElementById('vacFrom')&&document.getElementById('vacFrom').value)||'';
  D.vacationMode.to=(document.getElementById('vacTo')&&document.getElementById('vacTo').value)||'';
  D.vacationMode.msg=(document.getElementById('vacMsg')&&document.getElementById('vacMsg').value)||'Le cabinet est ferm√© pour cong√©s.';
  sv();clM('mM');toast('Mode vacances '+(D.vacationMode.enabled?'activ√©':'d√©sactiv√©'));
}

/* ‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê */
function openDashboard(){
  var b=document.getElementById('mMB');
  document.getElementById('mMT').textContent='üìä Tableau de bord';
  var today=todayKey();
  var todayApts=(D.appointments||[]).filter(function(a){return a.date===today&&!a.cancelled&&a.type!=='absence'});
  var todayCount=todayApts.length;
  /* Billing stats */
  var unbilledTotal=0;var unbilledN=0;
  (D.patients||[]).forEach(function(p){var n=unbilledCount(p.id);var a=unbilledAmount(p.id);unbilledN+=n;unbilledTotal+=a});
  /* Ordonnance renewals */
  var renewals=[];
  (D.patients||[]).forEach(function(p){var sc=getSessionCount(p.id);if(sc.needsRenewal)renewals.push(p)});
  /* Week stats (current week Mon-Sun) */
  var now2=new Date();var dow2=now2.getDay();
  var mon2=new Date(now2);mon2.setDate(mon2.getDate()-(dow2===0?6:dow2-1));
  var weekCount=0;
  for(var wd=0;wd<7;wd++){var wfd=new Date(mon2);wfd.setDate(wfd.getDate()+wd);var wfk=dk(wfd);weekCount+=(D.appointments||[]).filter(function(a){return a.date===wfk&&!a.cancelled&&a.type!=='absence'}).length;}
  /* Billed today */
  var billedToday=(D.appointments||[]).filter(function(a){return a.billed&&a.billedAt===today}).length;
  /* Vacation status */
  var vac=D.vacationMode||{};
  var vacMsg='';
  if(vac.enabled)vacMsg='<div style="padding:8px 12px;background:#fff3cd;border-radius:8px;font-size:12px;color:#8a6d3b;margin-bottom:10px">üèñÔ∏è <b>Mode vacances actif</b> du '+vac.from+' au '+vac.to+'</div>';

  var h=vacMsg+
    '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:14px">'+
      '<div style="text-align:center;padding:14px;background:var(--accentbg);border-radius:12px"><div style="font-size:28px;font-weight:900;color:var(--accent)">'+todayCount+'</div><div style="font-size:11px;color:var(--text2)">Patients aujourd\'hui</div></div>'+
      '<div style="text-align:center;padding:14px;background:var(--c0bg);border-radius:12px"><div style="font-size:28px;font-weight:900;color:var(--c0)">'+weekCount+'</div><div style="font-size:11px;color:var(--text2)">RDV cette semaine</div></div>'+
      '<div style="text-align:center;padding:14px;background:#e6f7ee;border-radius:12px"><div style="font-size:28px;font-weight:900;color:#1e8e3e">'+billedToday+'</div><div style="font-size:11px;color:var(--text2)">üí∞ Factur√©es aujourd\'hui</div></div>'+
    '</div>'+
    '<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:14px">'+
      '<div style="text-align:center;padding:14px;background:var(--c1bg);border-radius:12px"><div style="font-size:28px;font-weight:900;color:var(--c1)">'+unbilledN+'</div><div style="font-size:11px;color:var(--text2)">Non factur√©es</div></div>'+
      '<div style="text-align:center;padding:14px;background:var(--c3bg);border-radius:12px"><div style="font-size:28px;font-weight:900;color:var(--c3)">'+money(unbilledTotal)+'</div><div style="font-size:11px;color:var(--text2)">Montant en attente</div></div>'+
    '</div>';
  if(renewals.length){
    h+='<div style="margin-bottom:10px"><div style="font-weight:700;font-size:13px;margin-bottom:6px">üìã Renouvellements d\'ordonnance ('+renewals.length+')</div>';
    renewals.forEach(function(p){
      var sc2=getSessionCount(p.id);
      h+='<div style="display:flex;align-items:center;gap:8px;padding:6px 8px;background:var(--bg);border-radius:6px;margin-bottom:3px;font-size:12px;cursor:pointer" onclick="clM(\'mM\');openPC(\''+p.id+'\')">'+
        '<span style="flex:1"><b>'+esc(p.lastName)+' '+esc(p.firstName)+'</b> ‚Äî '+sc2.label+'</span>'+
        '<span style="color:#e74c3c">üìã</span></div>';
    });
    h+='</div>';
  }
  /* Waitlist */
  var wl=D.waitlist||[];
  if(wl.length){
    h+='<div style="margin-bottom:10px"><div style="font-weight:700;font-size:13px;margin-bottom:6px">‚è≥ Liste d\'attente ('+wl.length+')</div>';
    wl.forEach(function(w,i){
      h+='<div style="display:flex;align-items:center;gap:6px;padding:6px 8px;background:var(--bg);border-radius:6px;margin-bottom:3px;font-size:12px">'+
        '<span style="flex:1">'+esc(w.patientName)+' ¬∑ '+esc(w.motifLabel||'?')+' ¬∑ inscrit le '+(w.addedDate||'?')+'</span>'+
        '<button style="color:#e74c3c;font-size:14px" onclick="removeWaitlist('+i+')">√ó</button></div>';
    });
    h+='</div>';
  }
  h+='<div class="br"><button class="btn" onclick="clM(\'mM\')">Fermer</button></div>';
  b.innerHTML=h;
  opM('mM');
}

/* ‚ïê‚ïê‚ïê WAITLIST ‚ïê‚ïê‚ïê */
function removeWaitlist(idx){
  if(!D.waitlist)D.waitlist=[];
  D.waitlist.splice(idx,1);
  sv();openDashboard();
}

/* ‚ïê‚ïê‚ïê BILLING HISTORY ‚ïê‚ïê‚ïê */
function openBillingHistory(){
  var b=document.getElementById('mMB');
  document.getElementById('mMT').textContent='üí∞ Historique de facturation';
  var billed=(D.appointments||[]).filter(function(a){return a.billed&&a.billedAt}).sort(function(a,b2){return(b2.billedAt+b2.time).localeCompare(a.billedAt+a.time)});
  /* Group by month */
  var months={};
  billed.forEach(function(a){
    var k=(a.billedAt||'').slice(0,7); /* yyyy-mm */
    if(!months[k])months[k]={items:[],total:0};
    months[k].items.push(a);
    months[k].total+=(a.billedAmount||0);
  });
  var keys=Object.keys(months).sort().reverse();
  var MN2=['Jan','F√©v','Mar','Avr','Mai','Juin','Juil','Ao√ª','Sep','Oct','Nov','D√©c'];
  var h='<div style="font-size:12px;color:var(--text2);margin-bottom:10px">'+billed.length+' s√©ances factur√©es au total ¬∑ '+money(billed.reduce(function(s,a){return s+(a.billedAmount||0)},0))+' total</div>';
  if(!keys.length){h+='<div style="font-size:13px;color:var(--text3);padding:20px 0;text-align:center">Aucune facturation enregistr√©e</div>';}
  keys.forEach(function(k){
    var m=months[k];
    var parts=k.split('-');var label=MN2[parseInt(parts[1])-1]+' '+parts[0];
    h+='<div style="margin-bottom:12px"><div style="display:flex;justify-content:space-between;font-weight:700;font-size:13px;padding:6px 0;border-bottom:1px solid var(--border2)">'+
      '<span>'+label+'</span><span>'+money(m.total)+' ('+m.items.length+' actes)</span></div>';
    m.items.slice(0,20).forEach(function(a){
      var pat=a.patientId?gp(a.patientId):null;
      var mot2=gm(a.motifId);
      h+='<div style="display:flex;gap:8px;padding:4px 0;font-size:11px;color:var(--text2)">'+
        '<span style="width:70px">'+fmtS(a.billedAt)+'</span>'+
        '<span style="flex:1">'+(pat?esc(pat.lastName)+' '+esc(pat.firstName):'?')+'</span>'+
        '<span>'+(mot2?esc(mot2.label):'')+'</span>'+
        '<span style="font-weight:600;color:var(--text)">'+money(a.billedAmount||0)+'</span></div>';
    });
    if(m.items.length>20)h+='<div style="font-size:11px;color:var(--text3)">... +'+(m.items.length-20)+' autres</div>';
    h+='</div>';
  });
  h+='<div class="br"><button class="btn bs" onclick="exportBillingCSV()">üìä Export CSV</button><button class="btn" onclick="clM(\'mM\')">Fermer</button></div>';
  b.innerHTML=h;
  opM('mM');
}

function exportBillingCSV(){
  var billed=(D.appointments||[]).filter(function(a){return a.billed&&a.billedAt}).sort(function(a,b2){return a.billedAt.localeCompare(b2.billedAt)});
  var csv='Date facturation;Date RDV;Heure;Patient;Motif;Montant\n';
  billed.forEach(function(a){
    var pat=a.patientId?gp(a.patientId):null;
    var mot2=gm(a.motifId);
    csv+='"'+(a.billedAt||'')+'";"'+(a.date||'')+'";"'+(a.time||'')+'";"'+(pat?(pat.lastName+' '+pat.firstName):'?')+'";"'+(mot2?mot2.label:'')+'";"'+(a.billedAmount||0)+'"\n';
  });
  var blob=new Blob([csv],{type:'text/csv;charset=utf-8'});
  var url=URL.createObjectURL(blob);
  var a=document.createElement('a');a.href=url;a.download='facturation_'+todayKey()+'.csv';a.click();
  URL.revokeObjectURL(url);
  toast('CSV export√© ‚úì');
}

/* ‚ïê‚ïê‚ïê GROUP SPECIAL DU JOUR ‚ïê‚ïê‚ïê */
function getGroups(){if(!D.groups)D.groups={};return D.groups;}
function getGroupKey(){return dk(cD)}
function getDayGroup(){var g=getGroups();var k=getGroupKey();if(!g[k])g[k]={title:'Groupe du jour',members:[]};return g[k]}

var GRP_OCR_CAND=[];
var GRP_ASSOC={};/* stored associations: normalizedName -> patientId */

function openGroup(){
  if(!D._grpAssoc)D._grpAssoc={};
  GRP_ASSOC=D._grpAssoc;
  var grp=getDayGroup();
  var dt=new Date(cD);
  var _dl=['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'];
  var _mn=['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'];
  var grpName=D.groupName?('Groupe '+D.groupName):'Groupe sp√©cial';
  document.getElementById('mGRPT').textContent='üèãÔ∏è '+grpName+' ‚Äî '+_dl[dt.getDay()]+' '+dt.getDate()+' '+_mn[dt.getMonth()];
  renderGroup();
  opM('mGRP');
}

function renderGroup(){
  var grp=getDayGroup();
  var b=document.getElementById('mGRPB');
  /* Members list */
  var membersH='';
  if(grp.members.length){
    membersH='<div style="margin-bottom:12px">';
    grp.members.forEach(function(m,i){
      var p=m.patientId?gp(m.patientId):null;
      var name=p?(p.lastName+' '+p.firstName):(m.name||'?');
      var multip=p?(p.groupMultip!==undefined?p.groupMultip:2):2;
      membersH+='<div style="display:flex;align-items:center;gap:8px;padding:6px 8px;background:var(--bg);border-radius:8px;margin-bottom:4px">'+
        '<div style="flex:1;font-size:13px;font-weight:600">'+esc(name)+(multip>0?' <span style="font-size:11px;color:var(--text2)">√ó'+multip+'</span>':'')+'</div>'+
        '<button style="font-size:16px;color:#e74c3c" onclick="removeGroupMember('+i+')">√ó</button></div>';
    });
    membersH+='</div>';
    /* Summary */
    var totalSessions=0;
    grp.members.forEach(function(m){
      var p=m.patientId?gp(m.patientId):null;
      var multip=(p&&p.groupMultip!==undefined)?p.groupMultip:2;
      totalSessions+=multip;
    });
    membersH+='<div style="font-size:12px;color:var(--text2);margin-bottom:12px">'+grp.members.length+' pr√©sent(s) ¬∑ '+totalSessions+' s√©ance(s) √† facturer</div>';
  } else {
    membersH='<div style="text-align:center;padding:16px;color:var(--text2);font-size:13px">Aucun membre pour l\'instant</div>';
  }

  /* Group history */
  var groups=D.groups||{};
  var grpDates=Object.keys(groups).filter(function(k){var g=groups[k];return g&&g.members&&g.members.length>0}).sort().reverse();
  var histH='';
  if(grpDates.length){
    histH='<div style="margin-top:16px;border-top:1px solid var(--border2);padding-top:12px">'+
      '<div style="font-weight:700;font-size:13px;margin-bottom:8px">üìÖ Historique des s√©ances ('+grpDates.length+')</div>';
    grpDates.slice(0,20).forEach(function(gk){
      var g=groups[gk];
      var dt=new Date(gk+'T00:00:00');
      var dayLabel=['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'][dt.getDay()]+' '+dt.getDate()+'/'+(dt.getMonth()+1)+'/'+dt.getFullYear();
      var names=g.members.map(function(m2){var p2=m2.patientId?gp(m2.patientId):null;return p2?(p2.lastName+' '+p2.firstName):(m2.name||'?')});
      histH+='<div style="margin-bottom:6px;padding:8px;background:var(--bg);border-radius:8px">'+
        '<div style="display:flex;justify-content:space-between;align-items:center">'+
          '<span style="font-weight:600;font-size:12px">'+dayLabel+' ‚Äî '+g.members.length+' participant(s)</span>'+
          '<button style="font-size:12px;color:#e74c3c;background:none;border:none;cursor:pointer" onclick="if(confirm(\'Supprimer cette s√©ance de groupe ?\')){delete D.groups[\''+gk+'\'];sv();renderGroup();}">üóë</button>'+
        '</div>'+
        '<div style="font-size:11px;color:var(--text2);margin-top:3px">'+names.map(function(n,ni){
          return '<span style="display:inline-flex;align-items:center;gap:2px;margin-right:6px">'+esc(n)+
            ' <button style="font-size:10px;color:#e74c3c;background:none;border:none;cursor:pointer;padding:0" onclick="event.stopPropagation();D.groups[\''+gk+'\'].members.splice('+ni+',1);if(!D.groups[\''+gk+'\'].members.length)delete D.groups[\''+gk+'\'];sv();renderGroup();">√ó</button></span>';
        }).join('')+'</div>'+
      '</div>';
    });
    if(grpDates.length>20)histH+='<div style="font-size:11px;color:var(--text3)">... +'+(grpDates.length-20)+' s√©ances plus anciennes</div>';
    histH+='</div>';
  }

  b.innerHTML=membersH+
    '<div style="display:flex;gap:6px;flex-wrap:wrap">'+
      '<button class="btn bp" style="flex:1" onclick="addGroupManual()">‚ûï Ajouter manuellement</button>'+
      '<button class="btn bs" style="flex:1" onclick="addGroupOCR()">üì∑ OCR WhatsApp</button>'+
    '</div>'+
    '<div id="grpAddZone" style="margin-top:12px"></div>'+
    histH+
    '<div class="br" style="margin-top:16px"><button class="btn bs" onclick="clM(\'mGRP\')">Fermer</button></div>';
}

function addGroupManual(){
  var zone=document.getElementById('grpAddZone');
  zone.innerHTML='<div class="fg"><label>Rechercher un patient</label><input id="grpSearch" type="text" placeholder="Nom ou pr√©nom..." oninput="searchGroupPat()"></div>'+
    '<div id="grpSearchRes"></div>';
  document.getElementById('grpSearch').focus();
}

function searchGroupPat(){
  var q=(document.getElementById('grpSearch').value||'').toLowerCase().trim();
  if(q.length<2){document.getElementById('grpSearchRes').innerHTML='';return;}
  var qn=normName(q);
  var results=D.patients.filter(function(p){
    return normName(p.lastName+' '+p.firstName).includes(qn) ||
           normName(p.firstName+' '+p.lastName).includes(qn);
  }).slice(0,8);
  var grp=getDayGroup();
  var alreadyIds=grp.members.map(function(m){return m.patientId});
  document.getElementById('grpSearchRes').innerHTML=results.map(function(p){
    var already=alreadyIds.indexOf(p.id)>=0;
    return '<div style="display:flex;align-items:center;gap:8px;padding:6px;cursor:pointer;border-radius:6px;background:'+(already?'var(--bg)':'var(--surface)')+'" '+
      (already?'':'onclick="addToGroup(\''+p.id+'\')"')+'>'+
      '<span style="font-size:13px;'+(already?'opacity:.5':'')+'">'+(already?'‚úì ':'')+esc(p.lastName)+' '+esc(p.firstName)+'</span></div>';
  }).join('')+
  '<div style="padding:6px;cursor:pointer;color:var(--accent);font-size:12px" onclick="addNewGroupMember()">+ Cr√©er un nouveau participant</div>';
}

function addToGroup(pid){
  var grp=getDayGroup();
  if(grp.members.some(function(m){return m.patientId===pid})){toast('D√©j√† dans le groupe');return;}
  var p=gp(pid);
  grp.members.push({patientId:pid,name:p?(p.lastName+' '+p.firstName):''});
  /* Add unbilled sessions according to multiplier */
  var multip=(p&&p.groupMultip!==undefined)?p.groupMultip:2;
  if(multip>0){
    for(var i=0;i<multip;i++){
      D.appointments.push({
        id:uid(),type:'group',motifId:'',
        patientId:pid,label:'Groupe sp√©cial',
        date:getGroupKey(),time:'00:00',duration:0,
        notes:'üèãÔ∏è Groupe sp√©cial',
        cancelled:false,billed:false,billedAt:'',billedAmount:0,
        source:'group'
      });
    }
  }
  sv();R();renderGroup();
}

function addNewGroupMember(){
  var q=(document.getElementById('grpSearch').value||'').trim();
  var parts=q.split(/\s+/);
  var ln=parts[0]||'';var fn=parts.slice(1).join(' ')||'';
  if(!ln){toast('Entrez un nom');return;}
  var p={id:uid(),lastName:ln.toUpperCase(),firstName:fn,dob:'',phone:'',needOrdo:false,needMut:false,documents:[],groupMultip:2};
  D.patients.push(p);
  addToGroup(p.id);
  toast('Patient cr√©√© et ajout√©');
}

function removeGroupMember(idx){
  var grp=getDayGroup();
  var m=grp.members[idx];
  if(m && m.patientId){
    /* Remove group appointments for this patient on this day */
    D.appointments=D.appointments.filter(function(a){
      return !(a.patientId===m.patientId && a.date===getGroupKey() && a.type==='group');
    });
  }
  grp.members.splice(idx,1);
  sv();R();renderGroup();
}

/* OCR from WhatsApp screenshots */
function addGroupOCR(){
  var zone=document.getElementById('grpAddZone');
  zone.innerHTML='<div class="fg"><label>üì∑ Importer captures WhatsApp</label>'+
    '<input type="file" id="grpOCRFiles" multiple accept="image/*"></div>'+
    '<div id="grpOCRProg" style="font-size:12px;color:var(--text2)"></div>'+
    '<div id="grpOCRRes"></div>'+
    '<button class="btn bp bw" style="margin-top:8px" onclick="runGroupOCR()" id="grpOCRBtn">Lancer l\'OCR</button>';
}

async function runGroupOCR(){
  var files=document.getElementById('grpOCRFiles').files;
  if(!files.length){toast('S√©lectionnez des images');return;}
  var prog=document.getElementById('grpOCRProg');
  var btn=document.getElementById('grpOCRBtn');
  btn.disabled=true;prog.textContent='OCR en cours...';
  GRP_OCR_CAND=[];
  
  for(var i=0;i<files.length;i++){
    prog.textContent='Analyse image '+(i+1)+'/'+files.length+'...';
    try{
      var result=await Tesseract.recognize(files[i],'fra',{logger:function(){}});
      var text=(result&&result.data&&result.data.text)||'';
      var names=extractWhatsAppNames(text);
      GRP_OCR_CAND=GRP_OCR_CAND.concat(names);
    }catch(e){console.error(e);toast('Erreur OCR image '+(i+1))}
  }
  /* Deduplicate */
  var seen={};GRP_OCR_CAND=GRP_OCR_CAND.filter(function(n){var k=normName(n);if(seen[k])return false;seen[k]=true;return true});
  prog.textContent='OCR termin√© : '+GRP_OCR_CAND.length+' nom(s) d√©tect√©(s).';
  btn.disabled=false;
  renderGroupOCRResults();
}

function extractWhatsAppNames(text){
  /* WhatsApp vote/poll screenshots have names like:
     "Philippe MARCHAND\n19 f√©vrier, 18:42"
     Pattern: Name line followed by date line */
  var lines=text.split(/\n/).map(function(l){return l.trim()}).filter(Boolean);
  var names=[];
  for(var i=0;i<lines.length;i++){
    var line=lines[i];
    /* Skip date lines, short lines, emoji-only lines */
    if(/^\d{1,2}\s+(janvier|f√©vrier|mars|avril|mai|juin|juillet|ao√ªt|septembre|octobre|novembre|d√©cembre)/i.test(line))continue;
    if(line.length<3)continue;
    if(/^[üî•üí™üëç‚ù§Ô∏è‚≠ê‚úÖüèãÔ∏èüíµüì±üö´‚è∞üìÖ]+$/.test(line))continue;
    /* Skip lines that look like timestamps */
    if(/^\d{1,2}:\d{2}/.test(line))continue;
    if(/^Votes?\s+du\s+sondage/i.test(line))continue;
    /* Check if next line is a date -> this line is a name */
    var next=lines[i+1]||'';
    if(/\d{1,2}\s+(janvier|f√©vrier|mars|avril|mai|juin|juillet|ao√ªt|septembre|octobre|novembre|d√©cembre)/i.test(next)){
      /* Clean the name */
      var name=line.replace(/[^a-zA-Z√Ä-√ø\s\-']/g,'').trim();
      if(name.length>=2)names.push(name);
    }
  }
  return names;
}

function renderGroupOCRResults(){
  var box=document.getElementById('grpOCRRes');
  if(!GRP_OCR_CAND.length){box.innerHTML='<div style="font-size:12px;color:var(--text2)">Aucun nom d√©tect√©</div>';return;}
  var grp=getDayGroup();
  var alreadyIds=grp.members.map(function(m){return m.patientId});
  
  var h='<div style="font-weight:700;margin:8px 0;font-size:13px">Noms d√©tect√©s :</div>';
  GRP_OCR_CAND.forEach(function(name,idx){
    var nk=normName(name);
    /* Check stored association first */
    var assocPid=D._grpAssoc[nk]||null;
    if(assocPid && gp(assocPid)){
      var p=gp(assocPid);
      var already=alreadyIds.indexOf(assocPid)>=0;
      h+='<div style="display:flex;align-items:center;gap:6px;padding:6px;border-radius:6px;background:var(--bg);margin-bottom:4px">'+
        '<span style="flex:1;font-size:12px">'+(already?'‚úì ':'')+esc(name)+' ‚Üí <b>'+esc(p.lastName)+' '+esc(p.firstName)+'</b></span>'+
        (already?'':'<button class="btn bp" style="font-size:11px;padding:3px 8px" onclick="grpOCRAdd('+idx+',\''+assocPid+'\')">Ajouter</button>')+
        '</div>';
    } else {
      /* Fuzzy match: try each word of scanned name against each patient's first/last name */
      var words=name.trim().split(/\s+/).map(function(w){return normName(w)}).filter(function(w){return w.length>=2});
      var candidates=[];
      D.patients.forEach(function(p){
        var pLn=normName(p.lastName);
        var pFn=normName(p.firstName);
        var score=0;
        words.forEach(function(w){
          if(pLn===w||pFn===w)score+=10; /* exact match on one name */
          else if(pLn.indexOf(w)>=0||w.indexOf(pLn)>=0||pFn.indexOf(w)>=0||w.indexOf(pFn)>=0)score+=5; /* partial */
          else{/* Levenshtein-like: close enough (1-2 chars diff) */
            var d1=Math.abs(pLn.length-w.length),d2=Math.abs(pFn.length-w.length);
            if(d1<=2 && pLn.length>=3){var common=0;for(var ci=0;ci<Math.min(pLn.length,w.length);ci++)if(pLn[ci]===w[ci])common++;if(common>=pLn.length*0.6)score+=3}
            if(d2<=2 && pFn.length>=3){var common2=0;for(var ci2=0;ci2<Math.min(pFn.length,w.length);ci2++)if(pFn[ci2]===w[ci2])common2++;if(common2>=pFn.length*0.6)score+=3}
          }
        });
        if(score>=3)candidates.push({p:p,score:score});
      });
      candidates.sort(function(a,b){return b.score-a.score});
      var match=candidates.length?candidates[0].p:null;
      
      if(match){
        var already2=alreadyIds.indexOf(match.id)>=0;
        h+='<div style="display:flex;align-items:center;gap:6px;padding:6px;border-radius:6px;background:var(--bg);margin-bottom:4px">'+
          '<span style="flex:1;font-size:12px">'+esc(name)+' ‚Üí <b>'+esc(match.lastName)+' '+esc(match.firstName)+'</b> ?</span>'+
          (already2?'<span style="font-size:11px;color:var(--text3)">‚úì d√©j√†</span>':
          '<button class="btn bp" style="font-size:11px;padding:3px 8px" onclick="grpOCRConfirm('+idx+',\''+match.id+'\')">‚úì Oui</button>'+
          '<button class="btn bs" style="font-size:11px;padding:3px 8px" onclick="grpOCRNew('+idx+')">‚â† Non</button>')+
          '</div>';
      } else {
        h+='<div style="display:flex;align-items:center;gap:6px;padding:6px;border-radius:6px;background:var(--bg);margin-bottom:4px">'+
          '<span style="flex:1;font-size:12px">'+esc(name)+' <span style="color:var(--text3)">(inconnu)</span></span>'+
          '<button class="btn bp" style="font-size:11px;padding:3px 8px" onclick="grpOCRNew('+idx+')">+ Cr√©er</button></div>';
      }
    }
  });
  h+='<button class="btn bp bw" style="margin-top:8px" onclick="grpOCRAddAll()">Ajouter tous les reconnus</button>';
  box.innerHTML=h;
}

function grpOCRConfirm(idx,pid){
  var name=GRP_OCR_CAND[idx]||'';
  D._grpAssoc[normName(name)]=pid;
  addToGroup(pid);
  renderGroupOCRResults();
}
function grpOCRAdd(idx,pid){
  addToGroup(pid);
  renderGroupOCRResults();
}
function grpOCRNew(idx){
  var name=GRP_OCR_CAND[idx]||'';
  var parts=name.trim().split(/\s+/);
  var fn=parts[0]||'';var ln=parts.slice(1).join(' ')||fn;
  if(parts.length===1){ln=fn;fn='';}
  var p={id:uid(),lastName:ln.toUpperCase(),firstName:fn,dob:'',phone:'',needOrdo:false,needMut:false,documents:[],groupMultip:2};
  D.patients.push(p);
  D._grpAssoc[normName(name)]=p.id;
  addToGroup(p.id);
  toast('Patient cr√©√© et ajout√©');
  renderGroupOCRResults();
}
function grpOCRAddAll(){
  var grp=getDayGroup();
  var alreadyIds=grp.members.map(function(m){return m.patientId});
  GRP_OCR_CAND.forEach(function(name){
    var nk=normName(name);
    var pid=D._grpAssoc[nk];
    if(pid && gp(pid) && alreadyIds.indexOf(pid)<0){
      addToGroup(pid);
      alreadyIds.push(pid);
    }
  });
  renderGroupOCRResults();
}

/* ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê */
function scrollNow(){var w=document.getElementById('pw');var h=new Date().getHours();w.scrollTop=Math.max(0,((h-D.startH)-1)*80)}
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js').then(function(reg){
    window._swReg=reg;
  }).catch(function(e){console.warn('SW register failed',e)});
}
if(!D.bookingRules)D.bookingRules={minHoursBefore:2,maxDaysAhead:60};
if(!D.proPhone)D.proPhone='';
if(!D.proName)D.proName='';
if(!D.billsPerDay && D.billsPerDay!==0)D.billsPerDay=3;
if(!D.billsPerDay && D.billsPerDay!==0)D.billsPerDay=3;
D.motifs.forEach(function(m){if(!m.slots)m.slots=1;if(!m.allowSimul)m.allowSimul=false;if(!m.simulWith)m.simulWith='';});
D.patients.forEach(function(p){if(p.groupMultip===undefined)p.groupMultip=2;});
if(!D.groups)D.groups={};
if(!D._grpAssoc)D._grpAssoc={};
checkBillCarryOver();
R();scrollNow();
/* Show dashboard on first load of the day */
try{var _lastDash=localStorage.getItem('pf_last_dash')||'';if(_lastDash!==todayKey()){localStorage.setItem('pf_last_dash',todayKey());setTimeout(openDashboard,800);setTimeout(sendCarteVitaleSMS,2000);}}catch(e){}

/* ‚îÄ‚îÄ Carte Vitale SMS auto ‚îÄ‚îÄ */
function sendCarteVitaleSMS(){
  if(D.carteVitaleSMS===false)return;
  var today=todayKey();
  /* Only on opening days */
  if(!D.days.includes(new Date().getDay()))return;
  /* Already sent today? */
  try{if(localStorage.getItem('pf_cv_sms')===today)return;localStorage.setItem('pf_cv_sms',today)}catch(e){}
  /* Find üíµ patients for today */
  var billSet=computeDayBills(today);
  if(!billSet.size)return;
  var phones=[];
  billSet.forEach(function(pid){
    var p=gp(pid);
    if(p&&p.phone){
      var ph=p.phone.replace(/\s/g,'');
      if(ph.length>=8&&phones.indexOf(ph)<0)phones.push(ph);
    }
  });
  if(!phones.length)return;
  var proName=D.proName||'votre kin√©sith√©rapeute';
  var msg='[Rappel auto PhysioFlow] Bonjour, pourriez-vous apporter votre Carte Vitale √† la s√©ance d\'aujourd\'hui ? Merci ! ‚Äî '+proName;
  window.open('sms:'+phones.join(',')+'?body='+encodeURIComponent(msg));
  toast('üí≥ SMS Carte Vitale envoy√© √† '+phones.length+' patient(s)');
}
/* Request notification permission */
setTimeout(requestNotifPermission,2000);
/* Initial push to Firebase ‚Äî only if we have real data */
setTimeout(function(){
  if(D.patients.length>0 || D.appointments.length>0){
    fbPush();
  }
},1500);
setInterval(function(){if(same(new Date(),cD)&&vM==='grid'){rGrid();rAps()}},60000);
document.addEventListener('keydown',function(e){if(e.key==='Escape'){document.querySelectorAll('.mo.open').forEach(function(m){m.classList.remove('open')});clCtx()}});


/* ===== Calendrier global + Statistiques (v13) ===== */
(function(){
  function parseKey(k){
  if(!k) return new Date(NaN);
  if(typeof k!=='string') k=String(k);
  if(k.includes('-')){ // yyyy-mm-dd
    const a=k.split('-');
    return new Date(parseInt(a[0],10), parseInt(a[1],10)-1, parseInt(a[2],10));
  }
  const p=k.split('/');
  return new Date(parseInt(p[2],10), parseInt(p[1],10)-1, parseInt(p[0],10));
}
function keyToISO(k){
  if(!k) return '';
  if(typeof k!=='string') k=String(k);
  if(k.includes('-')) return k.slice(0,10);
  const p=k.split('/');
  return (p[2]||'').padStart(4,'0')+'-'+(p[1]||'').padStart(2,'0')+'-'+(p[0]||'').padStart(2,'0');
}
function isoToKey(iso){
  if(!iso) return '';
  if(typeof iso!=='string') iso=String(iso);
  if(iso.includes('/')) return iso;
  const a=iso.split('-');
  return (a[2]||'').padStart(2,'0')+'/'+(a[1]||'').padStart(2,'0')+'/'+(a[0]||'').padStart(4,'0');
}

  window.openCalModal = function(){
    const b=document.getElementById('mCALB');
    if(!b){toast('Calendrier indisponible');return;}
    let mode='month';
    let view=new Date(cD.getTime());
    const MONTHS=['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'];
    const W=['L','M','M','J','V','S','D'];

    function render(){
      const y=view.getFullYear(), m=view.getMonth();
      let h='';
      h+='<div class="ss"><div style="display:flex;justify-content:space-between;gap:10px;align-items:center">';
      h+='<div style="display:flex;gap:8px;align-items:center">';
      h+='<button class="btn" onclick="__calPrev()">‚Äπ</button>';
      h+='<button class="btn" onclick="__calNext()">‚Ä∫</button>';
      h+='<div style="font-weight:900">'+(mode==='month'?(MONTHS[m]+' '+y):('Ann√©e '+y))+'</div>';
      h+='</div>';
      h+='<div style="display:flex;gap:8px;align-items:center">';
      h+='<button class="btn '+(mode==='month'?'pri':'')+'" onclick="__calMode(\'month\')">Mois</button>';
      h+='<button class="btn '+(mode==='year'?'pri':'')+'" onclick="__calMode(\'year\')">Ann√©e</button>';
      h+='</div></div></div>';

      h+='<div class="ss"><div class="row"><div class="lbl">Aller √† une date</div><input id="calNative" type="date" class="in"></div>';
      h+='<div style="display:flex;gap:10px;margin-top:10px"><button class="btn pri" onclick="__calGo()">Afficher</button><button class="btn" onclick="clM(\'mCAL\')">Fermer</button></div></div>';

      if(mode==='month'){
        const first=new Date(y,m,1);
        const start=(first.getDay()+6)%7;
        const dim=new Date(y,m+1,0).getDate();
        h+='<div class="ss"><div style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px;font-weight:800;opacity:.85;margin-bottom:6px">';
        for(const x of W)h+='<div style="text-align:center">'+x+'</div>';
        h+='</div><div style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px">';
        for(let i=0;i<start;i++)h+='<div></div>';
        for(let d=1;d<=dim;d++){
          const k=dk(new Date(y,m,d));
          const isSel=(k===dk(cD));
          const isToday=(k===todayKey());
          // s√©ances du jour (les bilans comptent comme une seule s√©ance => on ignore les objets type 'bilan')
const aps=(D.appointments||[]).filter(a=>a && a.date===k && a.type!=='bilan');
const cnt=aps.length;

let coolCnt=0;
if(cnt){
  for(const a of aps){
    const pp=gp(a.patientId||a.pid);
    if(pp && pp.cool) coolCnt++;
  }
}

// couleur (violet -> rouge fonc√©). Rouge fonc√© √† partir de 45 s√©ances.
let bg='';
if(cnt>0){
  const c=Math.min(cnt,45);
  const t=(c-1)/44;           // 0..1
  const hue=270 - t*270;      // 270(violet) -> 0(rouge)
  bg='background:hsla('+hue+',85%,55%,0.28);border-color:hsla('+hue+',85%,55%,0.55);';
}

const badge = (cnt>0)
  ? ('<span class="calN">üë•'+cnt+'</span>' + (coolCnt>0?('<span class="calCool">üòé'+coolCnt+'</span>'):''))
  : '';

h+='<button class="chip calBtn calBtn '+(isSel?'sel':'')+'" style="justify-content:center;'+(isToday?'border:1px solid rgba(255,255,255,.35);':'')+bg+'" onclick="__calPick(\''+k+'\')">'+'<span class="calD">'+d+'</span>'+badge+'</button>';
        }
        h+='</div></div>';
      }else{
        const mn=['Jan','F√©v','Mar','Avr','Mai','Juin','Juil','Ao√ª','Sep','Oct','Nov','D√©c'];
        h+='<div class="ss"><div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px">';
        for(let i=0;i<12;i++){
          h+='<button class="chip" style="justify-content:center" onclick="__calPickMonth('+i+')">'+mn[i]+'</button>';
        }
        h+='</div></div>';
      }

      b.innerHTML=h;
      const inp=document.getElementById('calNative');
      if(inp) inp.value = keyToISO(dk(cD));
    }

    window.__calMode=function(m){mode=m;render();};
    window.__calPrev=function(){ if(mode==='month'){view.setMonth(view.getMonth()-1);} else {view.setFullYear(view.getFullYear()-1);} render(); };
    window.__calNext=function(){ if(mode==='month'){view.setMonth(view.getMonth()+1);} else {view.setFullYear(view.getFullYear()+1);} render(); };
    window.__calPick=function(k){ const d=parseKey(k); cD=new Date(d.getFullYear(), d.getMonth(), d.getDate()); sv(); R(); scrollNow(); clM('mCAL'); };
    window.__calPickMonth=function(mm){ mode='month'; view.setMonth(mm); render(); };
    window.__calGo=function(){
      const inp=document.getElementById('calNative');
      if(!inp || !inp.value){toast('Choisis une date');return;}
      const d=parseKey(isoToKey(inp.value));
      cD=new Date(d.getFullYear(), d.getMonth(), d.getDate());
      sv(); R(); scrollNow(); clM('mCAL');
    };

    opM('mCAL');
    render();
  };

  window.openStats = function(){
    const b=document.getElementById('mSTB');
    if(!b){toast('Stats indisponibles');return;}
    const t=todayKey();

    function calc(fromKey,toKey){
      const from=parseKey(fromKey); from.setHours(0,0,0,0);
      const to=parseKey(toKey); to.setHours(23,59,59,999);
      let sum=0, n=0;
      for(const a of D.appointments){
        if(!a.billed || !a.billedAt) continue;
        const d=parseKey(a.billedAt); d.setHours(12,0,0,0);
        if(d<from || d>to) continue;
        sum += (a.billedAmount||0);
        n++;
      }
      return {sum,n};
    }

    function run(){
      const f=document.getElementById('stFrom');
      const t2=document.getElementById('stTo');
      if(!f||!t2||!f.value||!t2.value){toast('Choisis une p√©riode');return;}
      const r=calc(isoToKey(f.value), isoToKey(t2.value));
      const el=document.getElementById('stRes');
      if(el) el.innerHTML =
        '<div style="font-size:34px;font-weight:900;margin:6px 0">'+money(r.sum)+'</div>'+
        '<div class="mut">√âl√©ments factur√©s comptabilis√©s : '+r.n+'</div>';
    }

    b.innerHTML =
      '<div class="ss">'+
        '<div class="row"><div class="lbl">D√©but</div><input id="stFrom" type="date" class="in"></div>'+
        '<div class="row"><div class="lbl">Fin</div><input id="stTo" type="date" class="in"></div>'+
        '<div style="display:flex;gap:10px;margin-top:10px">'+
          '<button class="btn pri" onclick="__stRun()">Calculer</button>'+
          '<button class="btn" onclick="clM(\'mST\')">Fermer</button>'+
        '</div>'+
        '<div class="hr"></div><div id="stRes"></div>'+
      '</div>';

    document.getElementById('stFrom').value = keyToISO(t);
    document.getElementById('stTo').value = keyToISO(t);
    window.__stRun = run;

    opM('mST');
    run();
  };
})();




/* ===== Hotfix Statistiques robuste (v13.3) + Courbe gains mensuels (v22) ===== */
window.openStats = function(){
  try{
    const b=document.getElementById('mSTB');
    if(!b){toast('Stats indisponibles');return;}

    function keyToISO_any(k){
      if(!k) return '';if(typeof k !== 'string') k = String(k);
      if(k.includes('-') && k.length>=10)return k.slice(0,10);
      const p=k.split('/');return (p[2]||'').padStart(4,'0')+'-'+(p[1]||'').padStart(2,'0')+'-'+(p[0]||'').padStart(2,'0');
    }
    function parseKey_any(k){const iso=keyToISO_any(k);if(!iso)return new Date(NaN);const a=iso.split('-');return new Date(parseInt(a[0],10),parseInt(a[1],10)-1,parseInt(a[2],10))}

    const tKey = (typeof todayKey==='function') ? todayKey() : (typeof dk==='function'?dk(new Date()):'');
    const tIso = keyToISO_any(tKey);

    function calc(fromIso,toIso){
      const from=parseKey_any(fromIso);from.setHours(0,0,0,0);
      const to=parseKey_any(toIso);to.setHours(23,59,59,999);
      let sum=0,n=0;
      for(const a of (D.appointments||[])){
        if(!a||!a.billed||!a.billedAt)continue;
        const d=parseKey_any(a.billedAt);d.setHours(12,0,0,0);
        if(d<from||d>to)continue;
        sum+=(a.billedAmount||0);n++;
      }
      return {sum,n};
    }

    /* Get all years with billed data */
    var allYears={};
    (D.appointments||[]).forEach(function(a){
      if(!a||!a.billed||!a.billedAt)return;
      var iso=keyToISO_any(a.billedAt);
      var y=parseInt(iso.slice(0,4));
      if(y>2000)allYears[y]=true;
    });
    var years=Object.keys(allYears).map(Number).sort();
    var curYear=new Date().getFullYear();
    if(!allYears[curYear])years.push(curYear);
    years.sort();

    function run(){
      const f=document.getElementById('stFrom');const t2=document.getElementById('stTo');
      if(!f||!t2||!f.value||!t2.value){toast('Choisis une p√©riode');return;}
      const r=calc(f.value,t2.value);
      const el=document.getElementById('stRes');
      if(el)el.innerHTML='<div style="font-size:34px;font-weight:900;margin:6px 0">'+money(r.sum)+'</div>'+
        '<div class="mut">√âl√©ments factur√©s : '+r.n+'</div>';
    }

    function drawChart(){
      var canvas=document.getElementById('stChart');if(!canvas)return;
      var ctx=canvas.getContext('2d');
      var W=canvas.width=canvas.parentElement.offsetWidth-10;
      var H=canvas.height=220;
      ctx.clearRect(0,0,W,H);
      
      /* Get selected years */
      var checks=document.querySelectorAll('.stYearCb:checked');
      var selYears=[];checks.forEach(function(c){selYears.push(parseInt(c.value))});
      if(!selYears.length)return;
      
      var colors=['#2a7c6f','#e07a3a','#7b5bbf','#c44a6a','#3aad5c','#c4a030'];
      var months=['Jan','F√©v','Mar','Avr','Mai','Jun','Jul','Ao√ª','Sep','Oct','Nov','D√©c'];
      
      /* Compute monthly totals per year */
      var data={};var maxVal=0;
      selYears.forEach(function(y){
        data[y]=[];
        for(var m=0;m<12;m++){
          var from=y+'-'+(m+1<10?'0':'')+(m+1)+'-01';
          var lastDay=new Date(y,m+1,0).getDate();
          var to=y+'-'+(m+1<10?'0':'')+(m+1)+'-'+lastDay;
          var r=calc(from,to);
          data[y].push(r.sum);
          if(r.sum>maxVal)maxVal=r.sum;
        }
      });
      if(maxVal===0)maxVal=100;
      
      var padL=50,padR=10,padT=20,padB=30;
      var cW=W-padL-padR,cH=H-padT-padB;
      
      /* Grid */
      ctx.strokeStyle='#ddd';ctx.lineWidth=0.5;
      for(var i=0;i<=4;i++){
        var y2=padT+cH*(1-i/4);
        ctx.beginPath();ctx.moveTo(padL,y2);ctx.lineTo(W-padR,y2);ctx.stroke();
        ctx.fillStyle='#999';ctx.font='10px sans-serif';ctx.textAlign='right';
        ctx.fillText(Math.round(maxVal*i/4)+'‚Ç¨',padL-4,y2+3);
      }
      /* Month labels */
      ctx.textAlign='center';ctx.fillStyle='#666';
      for(var m2=0;m2<12;m2++){
        var x2=padL+cW*m2/11;
        ctx.fillText(months[m2],x2,H-6);
      }
      
      /* Lines */
      selYears.forEach(function(yr,yi){
        ctx.strokeStyle=colors[yi%colors.length];
        ctx.lineWidth=2.5;ctx.beginPath();
        var pts=data[yr];
        for(var m3=0;m3<12;m3++){
          var x3=padL+cW*m3/11;
          var y3=padT+cH*(1-pts[m3]/maxVal);
          if(m3===0)ctx.moveTo(x3,y3);else ctx.lineTo(x3,y3);
        }
        ctx.stroke();
        /* Dots */
        for(var m4=0;m4<12;m4++){
          var x4=padL+cW*m4/11;
          var y4=padT+cH*(1-pts[m4]/maxVal);
          ctx.fillStyle=colors[yi%colors.length];
          ctx.beginPath();ctx.arc(x4,y4,3,0,Math.PI*2);ctx.fill();
        }
      });
      
      /* Legend */
      var legY=padT;
      selYears.forEach(function(yr,yi){
        ctx.fillStyle=colors[yi%colors.length];
        ctx.fillRect(W-padR-60,legY+yi*16,12,10);
        ctx.fillStyle='#333';ctx.font='11px sans-serif';ctx.textAlign='left';
        ctx.fillText(yr,W-padR-44,legY+yi*16+9);
      });
    }

    var yearsCheckboxes=years.map(function(y){
      return '<label style="font-size:12px;display:inline-flex;align-items:center;gap:3px;margin-right:8px">'+
        '<input type="checkbox" class="stYearCb" value="'+y+'" '+(y===curYear?'checked':'')+' onchange="__stDrawChart()"> '+y+'</label>';
    }).join('');

    b.innerHTML =
      '<div class="ss">'+
        '<div class="row"><div class="lbl">D√©but</div><input id="stFrom" type="date" class="in"></div>'+
        '<div class="row"><div class="lbl">Fin</div><input id="stTo" type="date" class="in"></div>'+
        '<div style="display:flex;gap:10px;margin-top:10px">'+
          '<button class="btn pri" onclick="__stRun()">Calculer</button>'+
          '<button class="btn" onclick="clM(\'mST\')">Fermer</button>'+
        '</div>'+
        '<div class="hr"></div><div id="stRes"></div>'+
      '</div>'+
      '<div class="ss" style="margin-top:16px">'+
        '<h3>üìà Gains mensuels</h3>'+
        '<div style="margin-bottom:8px">'+yearsCheckboxes+'</div>'+
        '<canvas id="stChart" style="width:100%;border:1px solid var(--border);border-radius:8px"></canvas>'+
      '</div>'+
      '<div class="ss" style="margin-top:16px">'+
        '<h3>ü•ß R√©partition par motif</h3>'+
        '<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px">'+
          '<button class="btn bs pieBtn" data-pie="day" onclick="__stPieMode(\'day\')">Jour</button>'+
          '<button class="btn bs pieBtn" data-pie="week" onclick="__stPieMode(\'week\')">Semaine</button>'+
          '<button class="btn bs pieBtn" data-pie="month" onclick="__stPieMode(\'month\')">Mois</button>'+
          '<button class="btn bs pieBtn" data-pie="year" onclick="__stPieMode(\'year\')">Ann√©e</button>'+
        '</div>'+
        '<div id="pieNav" style="display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:8px">'+
          '<button class="btn" id="piePrev" onclick="__stPieNav(-1)" style="font-size:16px;padding:4px 10px">‚Äπ</button>'+
          '<div id="pieLabel" style="font-weight:700;font-size:13px;min-width:160px;text-align:center"></div>'+
          '<button class="btn" id="pieNext" onclick="__stPieNav(1)" style="font-size:16px;padding:4px 10px">‚Ä∫</button>'+
        '</div>'+
        '<canvas id="stPie" style="width:100%;border:1px solid var(--border);border-radius:8px"></canvas>'+
        '<div id="pieLegend" style="margin-top:8px"></div>'+
      '</div>';

    var elFrom=document.getElementById('stFrom');
    var elTo=document.getElementById('stTo');
    if(elFrom)elFrom.value=tIso;
    if(elTo)elTo.value=tIso;

    window.__stRun=run;
    window.__stDrawChart=drawChart;

    /* Pie chart with navigation */
    var _pieMode='day';
    var _pieRef=new Date(); /* reference date for navigation */
    var MNF=['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'];
    var DNF=['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'];

    function pieRange(){
      var d=new Date(_pieRef);var fromD,toD,label;
      if(_pieMode==='day'){
        fromD=toD=dk(d);
        label=DNF[d.getDay()]+' '+d.getDate()+' '+MNF[d.getMonth()]+' '+d.getFullYear();
      }else if(_pieMode==='week'){
        var dow=d.getDay();var mon=new Date(d);mon.setDate(mon.getDate()-(dow===0?6:dow-1));
        var sun=new Date(mon);sun.setDate(sun.getDate()+6);
        fromD=dk(mon);toD=dk(sun);
        label='Sem. '+mon.getDate()+' '+MNF[mon.getMonth()]+' ‚Üí '+sun.getDate()+' '+MNF[sun.getMonth()]+' '+sun.getFullYear();
      }else if(_pieMode==='month'){
        fromD=d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-01';
        var lastD=new Date(d.getFullYear(),d.getMonth()+1,0).getDate();
        toD=d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+lastD;
        label=MNF[d.getMonth()]+' '+d.getFullYear();
      }else{
        fromD=d.getFullYear()+'-01-01';toD=d.getFullYear()+'-12-31';
        label='Ann√©e '+d.getFullYear();
      }
      return{fromD:fromD,toD:toD,label:label};
    }

    function updatePieNav(){
      var r=pieRange();
      var el=document.getElementById('pieLabel');if(el)el.textContent=r.label;
      /* Hide next arrow if we're at current period */
      var nowR=new Date();var isCurrent=false;
      if(_pieMode==='day')isCurrent=(dk(_pieRef)===dk(nowR));
      else if(_pieMode==='week'){var dw1=nowR.getDay();var m1=new Date(nowR);m1.setDate(m1.getDate()-(dw1===0?6:dw1-1));var dw2=_pieRef.getDay();var m2=new Date(_pieRef);m2.setDate(m2.getDate()-(dw2===0?6:dw2-1));isCurrent=(dk(m1)===dk(m2));}
      else if(_pieMode==='month')isCurrent=(_pieRef.getMonth()===nowR.getMonth()&&_pieRef.getFullYear()===nowR.getFullYear());
      else isCurrent=(_pieRef.getFullYear()===nowR.getFullYear());
      var nextBtn=document.getElementById('pieNext');if(nextBtn)nextBtn.style.visibility=isCurrent?'hidden':'visible';
      document.querySelectorAll('.pieBtn').forEach(function(b2){b2.style.fontWeight=b2.dataset.pie===_pieMode?'700':'400'});
    }

    function drawPie(){
      var canvas=document.getElementById('stPie');if(!canvas)return;
      var ctx2=canvas.getContext('2d');
      var W2=canvas.width=canvas.parentElement.offsetWidth-10;
      var H2=canvas.height=220;
      ctx2.clearRect(0,0,W2,H2);
      var range=pieRange();
      var fromD=range.fromD,toD=range.toD;
      /* Count per motif */
      var counts={};var total2=0;
      (D.appointments||[]).forEach(function(a){
        if(!a||a.cancelled||a.type==='absence')return;
        if(a.date<fromD||a.date>toD)return;
        var mid=a.motifId||'other';
        if(!counts[mid])counts[mid]=0;
        counts[mid]++;total2++;
      });
      /* Add group member presences (count individual members present, not days) */
      var grpName=D.groupName?('Groupe '+D.groupName):'Groupe sp√©cial';
      var grpPresences=0;
      var groups=D.groups||{};
      Object.keys(groups).forEach(function(gk){
        if(gk<fromD||gk>toD)return;
        var g=groups[gk];
        if(g&&g.members&&g.members.length>0)grpPresences+=g.members.length;
      });
      if(grpPresences>0){counts['_group']=grpPresences;total2+=grpPresences;}
      
      if(total2===0){ctx2.fillStyle='#999';ctx2.font='13px sans-serif';ctx2.textAlign='center';ctx2.fillText('Aucune donn√©e sur cette p√©riode',W2/2,H2/2);document.getElementById('pieLegend').innerHTML='';updatePieNav();return;}
      var cx=W2/2,cy=H2/2,r=Math.min(cx,cy)-10;
      var colors2=['#2a7c6f','#e07a3a','#7b5bbf','#c44a6a','#3aad5c','#c4a030','#4a80c4','#9b59b6','#e67e22','#1abc9c'];
      var angle=0;var entries=Object.entries(counts).sort(function(a2,b3){return b3[1]-a2[1]});
      var legH='';
      entries.forEach(function(e,i){
        var mid=e[0],cnt=e[1];
        var pct=cnt/total2;
        var sliceAngle=pct*Math.PI*2;
        var col=colors2[i%colors2.length];
        ctx2.beginPath();ctx2.moveTo(cx,cy);ctx2.arc(cx,cy,r,angle,angle+sliceAngle);ctx2.closePath();
        ctx2.fillStyle=col;ctx2.fill();
        ctx2.strokeStyle='#fff';ctx2.lineWidth=2;ctx2.stroke();
        if(pct>0.05){
          var mid2=angle+sliceAngle/2;
          var lx=cx+Math.cos(mid2)*(r*0.65);
          var ly=cy+Math.sin(mid2)*(r*0.65);
          ctx2.fillStyle='#fff';ctx2.font='bold 11px sans-serif';ctx2.textAlign='center';
          ctx2.fillText(Math.round(pct*100)+'%',lx,ly+4);
        }
        angle+=sliceAngle;
        var lbl;
        if(mid==='_group'){lbl=grpName;}
        else{var mot3=(D.motifs||[]).find(function(m2){return m2.id===mid});lbl=mot3?esc(mot3.label):'Autre';}
        legH+='<div style="display:inline-flex;align-items:center;gap:4px;margin-right:12px;font-size:11px;margin-bottom:2px"><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:'+col+'"></span>'+lbl+' ('+cnt+')</div>';
      });
      document.getElementById('pieLegend').innerHTML=legH;
      updatePieNav();
    }

    window.__stPieMode=function(mode){
      _pieMode=mode;_pieRef=new Date();
      drawPie();
    };
    window.__stPieNav=function(dir){
      if(_pieMode==='day')_pieRef.setDate(_pieRef.getDate()+dir);
      else if(_pieMode==='week')_pieRef.setDate(_pieRef.getDate()+dir*7);
      else if(_pieMode==='month')_pieRef.setMonth(_pieRef.getMonth()+dir);
      else _pieRef.setFullYear(_pieRef.getFullYear()+dir);
      drawPie();
    };

    opM('mST');
    run();
    setTimeout(drawChart,100);
    setTimeout(drawPie,150);
  }catch(e){
    console.error(e);
    try{toast('Erreur Stats : '+(e&&e.message?e.message:e));}catch(_){}
  }
};


/* ===== Override Calendrier (dimanche-first + aujourd'hui persistant + sans "Aller √† une date") (v14.7) ===== */
(function(){
  function parseKeyAny(k){
    if(!k) return new Date(NaN);
    if(typeof k!=='string') k=String(k);
    if(k.includes('-')){
      const a=k.split('-'); return new Date(parseInt(a[0],10), parseInt(a[1],10)-1, parseInt(a[2],10));
    }
    const p=k.split('/');
    return new Date(parseInt(p[2],10), parseInt(p[1],10)-1, parseInt(p[0],10));
  }
  function monthName(m){
    return ['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'][m];
  }
  function heatColor(cnt){
    if(!cnt || cnt<=0) return null;
    const t=Math.max(0, Math.min(1, cnt/45));
    const h = 270*(1-t);
    const s = 85;
    const l = 22 + (1-t)*18;
    return {css:'hsl('+h.toFixed(0)+', '+s+'%, '+l.toFixed(0)+'%)', h, s, l};
  }

  function hslToRgb(h,s,l){
    s/=100; l/=100;
    const c=(1-Math.abs(2*l-1))*s;
    const x=c*(1-Math.abs((h/60)%2-1));
    const m=l-c/2;
    let r=0,g=0,b=0;
    if(h<60){r=c;g=x;b=0;}
    else if(h<120){r=x;g=c;b=0;}
    else if(h<180){r=0;g=c;b=x;}
    else if(h<240){r=0;g=x;b=c;}
    else if(h<300){r=x;g=0;b=c;}
    else {r=c;g=0;b=x;}
    return {
      r:Math.round((r+m)*255),
      g:Math.round((g+m)*255),
      b:Math.round((b+m)*255)
    };
  }
  function luminance(rgb){
    // perceived luminance (0-255)
    return 0.2126*rgb.r + 0.7152*rgb.g + 0.0722*rgb.b;
  }
  function badgeTextColor(h,s,l){
    const rgb=hslToRgb(h,s,l);
    return (luminance(rgb) > 150) ? 'rgba(0,0,0,.92)' : 'rgba(255,255,255,.95)';
  }
  

  window.openCalModal = function(){
    const b=document.getElementById('mCALB');
    if(!b){toast('Calendrier indisponible');return;}
    let mode='month';
    let view=new Date(cD.getTime());

    function render(){
      const y=view.getFullYear(), m=view.getMonth();
      let h='';
      h+='<div class="ss"><div style="display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap">';
      h+='<div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">';
      h+='<button class="btn" onclick="__calPrev()">‚Äπ</button>';
      h+='<button class="btn" onclick="__calNext()">‚Ä∫</button>';
      h+='<button class="btn" onclick="__calToday()">Aujourd\'hui</button>';
      h+='<div style="font-weight:900">'+(mode==='month'?(monthName(m)+' '+y):('Ann√©e '+y))+'</div>';
      h+='</div>';
      h+='<div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">';
      h+='<button class="btn '+(mode==='month'?'pri':'')+'" onclick="__calMode(\'month\')">Mois</button>';
      h+='<button class="btn '+(mode==='year'?'pri':'')+'" onclick="__calMode(\'year\')">Ann√©e</button>';
      h+='<button class="btn" onclick="clM(\'mCAL\')">Fermer</button>';
      h+='</div></div></div>';

      if(mode==='month'){
        const first=new Date(y,m,1);
        const start=first.getDay(); // dimanche=0
        const dim=new Date(y,m+1,0).getDate();
        const w=['D','L','M','M','J','V','S'];

        h+='<div class="ss"><div style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px;font-weight:800;opacity:.85;margin-bottom:6px">';
        for(const x of w)h+='<div style="text-align:center">'+x+'</div>';
        h+='</div><div style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px">';
        for(let i=0;i<start;i++)h+='<div></div>';

        for(let d=1;d<=dim;d++){
          const k=dk(new Date(y,m,d));
          const isSel=(k===dk(cD));
          const isToday=(k===todayKey());

          const aps=(D.appointments||[]).filter(a=>a && a.date===k && a.type!=='bilan' && !a.hiddenInAgenda);
          const cnt=aps.length;

          let coolCnt=0;
          for(const a of aps){
            const pp=gp(a.patientId||a.pid);
            if(pp && pp.cool) coolCnt++;
          }

          const col=heatColor(cnt);
          const st = col ? ('background:'+col.css+';') : '';
          const tc = col ? badgeTextColor(col.h, col.s, col.l) : null;
          const badge =
            (cnt?('<span class="calN"'+(tc?(' style="color:'+tc+'"'):'')+'>üë•'+cnt+'</span>'):'')+
            (coolCnt?('<span class="calCool"'+(tc?(' style="color:'+tc+'"'):'')+'>üòé'+coolCnt+'</span>'):'');
          h+='<button class="chip calBtn '+(isSel?'sel':'')+' '+(isToday?'today':'')+'" style="justify-content:center;'+st+(isToday?'border:1px solid rgba(255,255,255,.35)':'')+'" onclick="__calPick(\''+k+'\')">'+
              '<span class="calD">'+d+'</span>'+badge+
              '</button>';
        }
        h+='</div></div>';
      }else{
        const mn=['Jan','F√©v','Mar','Avr','Mai','Juin','Juil','Ao√ª','Sep','Oct','Nov','D√©c'];
        h+='<div class="ss"><div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px">';
        for(let i=0;i<12;i++){
          h+='<button class="chip" style="justify-content:center" onclick="__calPickMonth('+i+')">'+mn[i]+'</button>';
        }
        h+='</div></div>';
      }

      b.innerHTML=h;
    }

    window.__calMode=function(mo){ mode=mo; render(); };
    window.__calPrev=function(){ if(mode==='month'){view.setMonth(view.getMonth()-1);} else {view.setFullYear(view.getFullYear()-1);} render(); };
    window.__calNext=function(){ if(mode==='month'){view.setMonth(view.getMonth()+1);} else {view.setFullYear(view.getFullYear()+1);} render(); };
    window.__calPick=function(k){
      const d=parseKeyAny(k);
      cD=new Date(d.getFullYear(), d.getMonth(), d.getDate());
      sv(); R(); scrollNow();
      clM('mCAL');
    };
    window.__calPickMonth=function(mm){ mode='month'; view.setMonth(mm); render(); };
    window.__calToday=function(){
      const d=parseKeyAny(todayKey());
      cD=new Date(d.getFullYear(), d.getMonth(), d.getDate());
      mode='month';
      view=new Date(cD.getTime());
      sv(); R(); scrollNow();
      render();
    };

    opM('mCAL');
    render();
  };
})();


/* ===== FIX: calendrier (aujourd'hui correct + bouton persistant + contraste badges) (v14.8) ===== */
(function(){
  function parseKeyAny(k){
    if(!k) return new Date(NaN);
    if(typeof k!=='string') k=String(k);
    if(k.includes('-')){
      const a=k.split('-'); return new Date(+a[0], +a[1]-1, +a[2]);
    }
    const p=k.split('/'); return new Date(+p[2], +p[1]-1, +p[0]);
  }
  const MN=['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'];
  function heatColor(cnt){
    if(!cnt || cnt<=0) return null;
    const t=Math.max(0, Math.min(1, cnt/45));
    const h = 270*(1-t);
    const l = 22 + (1-t)*18;
    return { h, s:85, l, css:`hsl(${h.toFixed(0)}, 85%, ${l.toFixed(0)}%)` };
  }
  function hslToRgb(h,s,l){
    s/=100; l/=100;
    const c=(1-Math.abs(2*l-1))*s;
    const x=c*(1-Math.abs((h/60)%2-1));
    const m=l-c/2;
    let r=0,g=0,b=0;
    if(h<60){r=c;g=x;b=0}
    else if(h<120){r=x;g=c;b=0}
    else if(h<180){r=0;g=c;b=x}
    else if(h<240){r=0;g=x;b=c}
    else if(h<300){r=x;g=0;b=c}
    else {r=c;g=0;b=x}
    return {r:Math.round((r+m)*255), g:Math.round((g+m)*255), b:Math.round((b+m)*255)};
  }
  function luminance(rgb){
    const srgb=[rgb.r,rgb.g,rgb.b].map(v=>{
      v/=255;
      return v<=0.03928? v/12.92 : Math.pow((v+0.055)/1.055,2.4);
    });
    return 0.2126*srgb[0]+0.7152*srgb[1]+0.0722*srgb[2];
  }
  function bestTextOn(bgHsl){
    if(!bgHsl) return '';
    const rgb=hslToRgb(bgHsl.h,bgHsl.s,bgHsl.l);
    const lum=luminance(rgb);
    return (lum<0.45)? '#fff' : '#111';
  }

  window.openCalModal = function(){
    const b=document.getElementById('mCALB');
    if(!b){toast('Calendrier indisponible');return;}
    let mode='month';
    let view=new Date(cD.getTime());

    function render(){
      const y=view.getFullYear(), m=view.getMonth();
      let h = '';
      h += `<div class="ss"><div style="display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button class="btn" onclick="__calPrev()">‚Äπ</button>
          <button class="btn" onclick="__calNext()">‚Ä∫</button>
          <button class="btn" onclick="__calToday()">Aujourd&#39;hui</button>
          <div style="font-weight:900">${mode==='month'?(MN[m]+' '+y):('Ann√©e '+y)}</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button class="btn ${mode==='month'?'pri':''}" onclick="__calMode('month')">Mois</button>
          <button class="btn ${mode==='year'?'pri':''}" onclick="__calMode('year')">Ann√©e</button>
          <button class="btn" onclick="clM('mCAL')">Fermer</button>
        </div>
      </div></div>`;

      if(mode==='month'){
        const first=new Date(y,m,1);
        const start=first.getDay(); // dimanche=0
        const dim=new Date(y,m+1,0).getDate();
        const w=['D','L','M','M','J','V','S'];

        h += `<div class="ss">
          <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px;font-weight:800;opacity:.85;margin-bottom:6px">
            ${w.map(x=>`<div style="text-align:center">${x}</div>`).join('')}
          </div>
          <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px">`;

        for(let i=0;i<start;i++) h += `<div></div>`;

        for(let d=1;d<=dim;d++){
          const k=dk(new Date(y,m,d));
          const isSel=(k===dk(cD));
          const isToday=(k===todayKey());
          const aps=(D.appointments||[]).filter(a=>a && a.date===k && a.type!=='bilan' && !a.hiddenInAgenda);
          const cnt=aps.length;

          let coolCnt=0;
          for(const a of aps){
            const pp=gp(a.patientId||a.pid);
            if(pp && pp.cool) coolCnt++;
          }

          const col=heatColor(cnt);
          const tc=bestTextOn(col);
          const st = col ? `background:${col.css};` : '';
          const badge =
            (cnt?(`<span class="calN" ${tc?`style="color:${tc}"`:''}>üë•${cnt}</span>`):'')+
            (coolCnt?(`<span class="calCool" ${tc?`style="color:${tc}"`:''}>üòé${coolCnt}</span>`):'');

          h += `<button class="chip calBtn ${isSel?'sel':''} ${isToday?'today':''}" style="justify-content:center;${st}${isToday?'border:1px solid rgba(255,255,255,.35)':''}" onclick="__calPick('${k}')">
              <span class="calD">${d}</span>${badge}
            </button>`;
        }

        h += `</div></div>`;
      }else{
        const mn=['Jan','F√©v','Mar','Avr','Mai','Juin','Juil','Ao√ª','Sep','Oct','Nov','D√©c'];
        h += `<div class="ss"><div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px">
          ${mn.map((lab,i)=>`<button class="chip" style="justify-content:center" onclick="__calPickMonth(${i})">${lab}</button>`).join('')}
        </div></div>`;
      }

      b.innerHTML=h;
    }

    window.__calMode=function(mo){ mode=mo; render(); };
    window.__calPrev=function(){ if(mode==='month'){view.setMonth(view.getMonth()-1);} else {view.setFullYear(view.getFullYear()-1);} render(); };
    window.__calNext=function(){ if(mode==='month'){view.setMonth(view.getMonth()+1);} else {view.setFullYear(view.getFullYear()+1);} render(); };
    window.__calPick=function(k){
      const d=parseKeyAny(k);
      cD=new Date(d.getFullYear(), d.getMonth(), d.getDate());
      sv(); R(); scrollNow();
      clM('mCAL');
    };
    window.__calPickMonth=function(mm){ mode='month'; view.setMonth(mm); render(); };
    window.__calToday=function(){
      const d=parseKeyAny(todayKey());
      cD=new Date(d.getFullYear(), d.getMonth(), d.getDate());
      mode='month';
      view=new Date(cD.getTime());
      sv(); R(); scrollNow();
      render();
    };

    opM('mCAL');
    render();
  };
})();


/* ===== FIX: cr√©ation patient üòé + svAF merge (v14.8) ===== */
(function(){
  // Override newPat to include üòé checkbox
  if(typeof window.newPat==='function'){
    const _newPat = window.newPat;
    window.newPat = function(){
      _newPat();
      try{
        if(document.getElementById('epCool')) return;
        const pren=document.getElementById('epF');
        if(!pren || !pren.parentElement) return;
        const wrap=document.createElement('label');
        wrap.style.display='inline-flex';
        wrap.style.alignItems='center';
        wrap.style.gap='6px';
        wrap.style.marginLeft='10px';
        wrap.innerHTML='<input type="checkbox" id="epCool"> üòé';
        pren.parentElement.appendChild(wrap);
      }catch(e){console.error(e);}
    };
  }

  // Wrap svNewPat to persist cool
  if(typeof window.svNewPat==='function'){
    const _sv = window.svNewPat;
    window.svNewPat = function(){
      const wantCool = !!(document.getElementById('epCool') && document.getElementById('epCool').checked);
      _sv();
      try{
        if(wantCool && D.patients && D.patients.length){
          const p=D.patients[D.patients.length-1];
          if(p){ p.cool=true; sv(); }
        }
      }catch(e){console.error(e);}
    };
  }

  // Merge appointment fields on edit (do not lose billing/bilan/series fields)
  if(typeof window.svAF==='function'){
    const _orig = window.svAF;
    window.svAF = function(editingId){
      try{
        const id = editingId || window._editingApId || null;
        if(id && D.appointments){
          const idx = D.appointments.findIndex(a=>a && a.id===id);
          const old = (idx>=0)? D.appointments[idx] : null;
          _orig(editingId);
          if(old){
            const idx2 = D.appointments.findIndex(a=>a && a.id===id);
            if(idx2>=0){
              D.appointments[idx2] = Object.assign({}, old, D.appointments[idx2]);
              sv(); R();
            }
          }
          return;
        }
        _orig(editingId);
      }catch(e){
        console.error(e);
        _orig(editingId);
      }
    };
  }
})();
</script>
</body>
</html>
