<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#ffffff">
<link rel="manifest" href="manifest.json">
<title>PhysioFlow</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root{
  /* Contrastes renforc√©s pour une meilleure lisibilit√© */
  --bg:#f0eeeb;
  --bg2:#e4e0d9;
  --surface:#ffffff;
  --surface2:#f9f8f6;
  
  --text:#111122;        /* Plus noir */
  --text2:#444455;       /* Gris plus fonc√© pour meilleure lecture */
  --text3:#777788;
  
  --accent:#1f6b5f;      /* Vert un peu plus profond */
  --accent2:#3bb5a0;
  --accentbg:rgba(31,107,95,0.08);
  
  --border:#c0bab0;      /* Bordures plus visibles */
  --border2:#dcd6ce;
  
  --shadow:0 4px 12px rgba(0,0,0,.08);
  --shadowlg:0 8px 32px rgba(0,0,0,.15);
  --radius:8px;
  --radiuslg:14px;
  --radiusxl:24px;
  
  --c0:#3b72b8; --c0bg:#e3ecf6; --c0t:#162e4a;
  --c1:#d66a2a; --c1bg:#fce8d8; --c1t:#572608;
  --c2:#6d4cbd; --c2bg:#ece4f8; --c2t:#301860;
  --c3:#c42e56; --c3bg:#fce0e8; --c3t:#5c0820;
  --c4:#2e9e4d; --c4bg:#d8f2e0; --c4t:#0b471d;
  --c5:#b89520; --c5bg:#f8f2d8; --c5t:#4d3d05;
  --absence:#455a64;

  --grid-line:#bdb8ad;   /* Lignes d'heures plus visibles */
  --grid-half:#dcd8d0;
  --grid-quarter:#ebe8e2;
}

*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;outline:none;-webkit-tap-highlight-color:transparent}
html,body{height:100%;font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);overflow:hidden}
button{font-family:inherit;cursor:pointer;border:none;background:none;color:inherit;font-size:inherit;user-select:none}
input,select,textarea{font-family:inherit;color:var(--text);font-size:14px;background:var(--surface)}

#app{display:flex;flex-direction:column;height:100dvh;height:100vh;overflow:hidden}

/* ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê */
.hdr{background:var(--surface);border-bottom:1px solid var(--border);padding:10px 16px;display:flex;align-items:center;gap:12px;flex-shrink:0;z-index:100;box-shadow:0 1px 2px rgba(0,0,0,0.03)}
.logo{font-family:'JetBrains Mono',monospace;font-weight:700;font-size:17px;color:var(--accent);letter-spacing:-.5px}
.logo b{color:var(--text)}
.hdr-c{flex:1;display:flex;align-items:center;justify-content:center;gap:8px}
.hdr-c span{font-weight:700;font-size:15px;min-width:130px;text-align:center;text-transform:capitalize}
.nb{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:var(--bg2);color:var(--text);font-size:18px;font-weight:700;transition:.1s}
.nb:active{background:var(--border);transform:scale(0.95)}
.ha{display:flex;gap:8px}
.ib{width:36px;height:36px;border-radius:var(--radius);display:flex;align-items:center;justify-content:center;background:var(--bg2);color:var(--text2);font-size:18px}
.ib:active{background:var(--border)}
.ib.on{background:var(--accent);color:#fff}

/* ‚ïê‚ïê‚ïê WEEK BAR ‚ïê‚ïê‚ïê */
.wbar{display:flex;background:var(--surface);border-bottom:1px solid var(--border);flex-shrink:0;padding:4px 4px}
.wd{flex:1;text-align:center;padding:8px 2px 10px;cursor:pointer;position:relative;border-radius:6px;margin:0 1px;transition:background 0.1s}
.wd.act{background:var(--accentbg)}
.wd.act .wl{color:var(--accent);font-weight:700}
.wd.act .wn{background:var(--accent);color:#fff;box-shadow:0 2px 5px rgba(31,107,95,0.3)}
.wd.dis{opacity:.3;pointer-events:none;filter:grayscale(1)}
.wd:active{background:var(--bg2)} /* Feedback tactile imm√©diat */
.wd .wl{font-size:11px;font-weight:600;color:var(--text3);text-transform:uppercase;margin-bottom:3px}
.wd .wn{font-size:15px;font-weight:700;width:28px;height:28px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;transition:0.2s}
.wd.tod .wn{border:2px solid var(--accent);color:var(--accent);line-height:24px}
.wd.tod.act .wn{border:none;color:#fff}

/* ‚ïê‚ïê‚ïê GRID ‚ïê‚ïê‚ïê */
.pw{flex:1;overflow-y:auto;overflow-x:hidden;background:var(--bg);position:relative}
.pg{position:relative}

/* Time Column */
.tc{position:absolute;left:0;top:0;bottom:0;width:50px;z-index:2;pointer-events:none;background:var(--bg);border-right:1px solid var(--border2)}
.tl{position:absolute;left:0;width:48px;text-align:right;padding-right:6px;font-size:11px;font-weight:700;color:var(--text2);font-family:'JetBrains Mono',monospace;transform:translateY(-50%)}

/* Grid Lines */
.gl-w{position:absolute;left:50px;right:0;top:0;bottom:0}
.gl{position:absolute;left:0;right:0;border-top-style:solid}
.gl.full{border-top-width:1px;border-top-color:var(--grid-line)}
.gl.half{border-top-width:1px;border-top-color:var(--grid-half)}
.gl.quarter{border-top-width:1px;border-top-color:var(--grid-quarter);border-top-style:dashed}

/* Slots */
.sa{position:absolute;left:51px;right:4px;top:0;bottom:0}
.op{position:absolute;left:0;right:0;background:#ffffff;border:1px solid var(--border2);border-width:0 1px;z-index:1}
.nl{position:absolute;left:0;right:0;height:2px;background:#e74c3c;z-index:8;pointer-events:none}
.nl::before{content:'';position:absolute;left:-5px;top:-4px;width:10px;height:10px;background:#e74c3c;border-radius:50%}

/* Appointments */
.ap{position:absolute;border-radius:5px;padding:3px 6px;overflow:hidden;cursor:pointer;border-left:4px solid;font-size:11px;line-height:1.2;display:flex;flex-direction:column;z-index:5;box-shadow:0 1px 3px rgba(0,0,0,0.1);transition:transform 0.1s}
.ap:active{transform:scale(0.97);z-index:10}
.ap .an{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:flex;align-items:center;gap:3px;color:var(--text)}
.ap .am{font-size:10px;opacity:.85;margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ap .at{font-size:9px;opacity:.7;font-family:'JetBrains Mono',monospace;margin-top:auto}
.ap.cncl{opacity:.6;background:#eee!important;border-color:#999!important;color:#777!important}
.ap.cncl .an{text-decoration:line-through}
.ap.abs{background:var(--absence)!important;border-left-color:#263238!important;color:#fff;opacity:.95}
.ap.abs .an{color:#fff}
.bo{color:var(--c1);font-size:12px}.bm{color:var(--c3);font-size:12px}

/* Classes couleurs dynamiques */
.mc0{background:var(--c0bg);border-left-color:var(--c0);color:var(--c0t)}
.mc1{background:var(--c1bg);border-left-color:var(--c1);color:var(--c1t)}
.mc2{background:var(--c2bg);border-left-color:var(--c2);color:var(--c2t)}
.mc3{background:var(--c3bg);border-left-color:var(--c3);color:var(--c3t)}
.mc4{background:var(--c4bg);border-left-color:var(--c4);color:var(--c4t)}
.mc5{background:var(--c5bg);border-left-color:var(--c5);color:var(--c5t)}

/* ‚ïê‚ïê‚ïê LISTE & PATIENTS ‚ïê‚ïê‚ïê */
.lv,.plw{flex:1;overflow-y:auto;padding:12px;display:none}
.lv.on,.plw.on{display:block}
.pw.off{display:none}

.li{display:flex;align-items:center;gap:12px;padding:12px 14px;background:var(--surface);border-radius:var(--radius);margin-bottom:8px;border-left:4px solid var(--border);cursor:pointer;box-shadow:0 2px 5px rgba(0,0,0,0.03)}
.li:active{transform:scale(0.98)}
.li .lt{font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:700;color:var(--text2);min-width:46px}
.li .lb{flex:1;min-width:0}
.li .ln{font-weight:700;font-size:14px;display:flex;align-items:center;gap:5px}
.li .lm{font-size:12px;color:var(--text2);margin-top:2px}

.pls{margin-bottom:12px;position:sticky;top:0;z-index:10;background:var(--bg);padding-bottom:5px}
.pls input{width:100%;padding:10px 12px 10px 36px;border:1px solid var(--border);border-radius:var(--radius);font-size:14px;box-shadow:0 2px 8px rgba(0,0,0,0.05)}
.pls::before{content:'üîç';position:absolute;left:12px;top:19px;transform:translateY(-50%);font-size:14px;pointer-events:none;opacity:.6}

.pi{display:flex;align-items:center;gap:12px;padding:10px 14px;background:var(--surface);border-radius:var(--radius);margin-bottom:6px;cursor:pointer;border:1px solid var(--border2)}
.pi:active{background:var(--surface2)}
.pi .pa{width:40px;height:40px;border-radius:50%;background:var(--accentbg);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--accent);font-size:14px;flex-shrink:0}
.pi .pn{font-weight:700;font-size:14px;margin-bottom:2px}
.pi .pd{font-size:12px;color:var(--text2)}

.fab{position:fixed;bottom:24px;right:20px;width:56px;height:56px;border-radius:50%;background:var(--text);color:#fff;font-size:28px;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 20px rgba(0,0,0,.25);z-index:90;transition:transform 0.1s}
.fab:active{transform:scale(0.9)}

/* ‚ïê‚ïê‚ïê MODALS & UI ‚ïê‚ïê‚ïê */
.mo{position:fixed;inset:0;background:rgba(0,0,5,.5);backdrop-filter:blur(2px);z-index:200;display:flex;align-items:flex-end;justify-content:center;opacity:0;pointer-events:none;transition:.2s}
.mo.open{opacity:1;pointer-events:all}
.mop{background:var(--surface);border-radius:var(--radiusxl) var(--radiusxl) 0 0;width:100%;max-width:500px;max-height:85vh;overflow-y:auto;transform:translateY(100%);transition:transform .3s cubic-bezier(.2,1,.3,1);padding:0 20px 30px}
.mo.open .mop{transform:translateY(0)}
.moh{width:40px;height:5px;background:var(--border);border-radius:4px;margin:12px auto 20px;opacity:.5}

.fg{margin-bottom:15px}
.fg label{display:block;font-size:12px;font-weight:700;color:var(--text2);margin-bottom:5px;text-transform:uppercase;letter-spacing:.5px}
.fg input,.fg select,.fg textarea{width:100%;padding:11px 12px;border:1px solid var(--border);border-radius:var(--radius);background:var(--bg);font-size:15px;outline:none;transition:border .1s}
.fg input:focus{border-color:var(--accent);background:#fff;box-shadow:0 0 0 2px var(--accentbg)}

.btn{padding:12px 16px;border-radius:var(--radius);font-size:14px;font-weight:600;display:inline-flex;align-items:center;justify-content:center;gap:6px;transition:.1s}
.btn:active{transform:scale(0.97)}
.bp{background:var(--accent);color:#fff;box-shadow:0 4px 10px rgba(31,107,95,0.2)}
.bd{background:#e74c3c;color:#fff}
.bs{background:var(--surface);border:1px solid var(--border);color:var(--text)}

.chips{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px}
.chip{padding:8px 14px;border-radius:20px;font-size:13px;font-weight:600;cursor:pointer;border:2px solid transparent;transition:.1s}
.chip.sel{border-color:var(--text);transform:scale(1.05);box-shadow:0 4px 12px rgba(0,0,0,0.1)}

.acw{position:relative}
.acl{position:absolute;top:100%;left:0;right:0;background:var(--surface);border:1px solid var(--border);border-radius:0 0 var(--radius) var(--radius);max-height:200px;overflow-y:auto;z-index:50;display:none;box-shadow:var(--shadowlg)}
.acl.open{display:block}
.aci{padding:10px 14px;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border2)}
.aci:active,.aci.hl{background:var(--bg2)}
.aci .acs{font-size:12px;color:var(--text3)}
.acn{color:var(--accent);font-weight:700;background:var(--accentbg);justify-content:center}

.ctx{position:fixed;background:var(--surface);border-radius:var(--radiuslg);box-shadow:var(--shadowlg);z-index:300;min-width:180px;padding:6px;opacity:0;pointer-events:none;transform:scale(0.9);transition:.1s cubic-bezier(0.2,0.8,0.2,1)}
.ctx.open{opacity:1;pointer-events:all;transform:scale(1)}
.ci{padding:10px 14px;border-radius:var(--radius);font-size:13px;font-weight:600;display:flex;align-items:center;gap:10px;cursor:pointer;color:var(--text2)}
.ci:active{background:var(--bg2);color:var(--text)}
.ci.dng{color:#e74c3c}

.toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--text);color:#fff;padding:10px 20px;border-radius:30px;font-size:13px;font-weight:600;z-index:400;opacity:0;transition:.25s;pointer-events:none;box-shadow:0 4px 12px rgba(0,0,0,0.2)}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

@media(min-width:600px){.mop{border-radius:var(--radiusxl);margin-bottom:auto;top:50%;transform:translateY(-50%)!important}}
</style>
</head>
<body>
<div id="app">
  <div class="hdr">
    <div class="logo"><b>Physio</b>Flow</div>
    <div class="hdr-c"><button class="nb" onclick="navW(-1)">‚Äπ</button><span id="hd"></span><button class="nb" onclick="navW(1)">‚Ä∫</button></div>
    <div class="ha">
      <button class="ib" id="bL" onclick="togV('list')" title="Liste">‚ò∞</button>
      <button class="ib" id="bP" onclick="togV('patients')" title="Patients">üë•</button>
      <button class="ib" onclick="openSet()" title="Param√®tres">‚öô</button>
    </div>
  </div>
  <div class="wbar" id="wb"></div>
  
  <div class="pw" id="pw"><div class="pg" id="pg"><div class="tc" id="tc"></div><div class="gl-w" id="glw"></div><div class="sa" id="sa"></div></div></div>
  <div class="lv" id="lv"></div>
  <div class="plw" id="plw"></div>
  <button class="fab" onclick="newAp()">+</button>
</div>

<div class="toast" id="tst"></div>
<div class="ctx" id="ctx"></div>

<div class="mo" id="mA"><div class="mop"><div class="moh"></div><h2 id="mAT"></h2><div id="mAB"></div></div></div>
<div class="mo" id="mS"><div class="mop"><div class="moh"></div><h2>‚öô Param√®tres</h2><div id="mSB"></div></div></div>
<div class="mo" id="mP"><div class="mop"><div class="moh"></div><h2 id="mPT">Patient</h2><div id="mPB"></div></div></div>
<div class="mo" id="mH"><div class="mop"><div class="moh"></div><h2 id="mHT">Historique</h2><div id="mHB"></div></div></div>
<div class="mo" id="mM"><div class="mop"><div class="moh"></div><h2 id="mMT">Motif</h2><div id="mMB"></div></div></div>
<div class="mo" id="mR"><div class="mop"><div class="moh"></div><h2>üîÅ Planifier r√©currence</h2><div id="mRB"></div></div></div>

<script>
/* ‚ïê‚ïê‚ïê 1. CORE & DATA ‚ïê‚ïê‚ïê */
const SK='physioflow_v3';
const CL=[
  {css:'mc0',bg:'var(--c0bg)',bd:'var(--c0)',lb:'Bleu'},
  {css:'mc1',bg:'var(--c1bg)',bd:'var(--c1)',lb:'Orange'},
  {css:'mc2',bg:'var(--c2bg)',bd:'var(--c2)',lb:'Violet'},
  {css:'mc3',bg:'var(--c3bg)',bd:'var(--c3)',lb:'Rose'},
  {css:'mc4',bg:'var(--c4bg)',bd:'var(--c4)',lb:'Vert'},
  {css:'mc5',bg:'var(--c5bg)',bd:'var(--c5)',lb:'Jaune'}
];

function defD(){return{motifs:[
  {id:'reeduc',label:'R√©√©ducation',duration:30,ci:0},
  {id:'domicile',label:'Domicile',duration:45,ci:1},
  {id:'uro',label:'Uro-Gyn√©co',duration:20,ci:2},
  {id:'onde',label:'Ondes de choc',duration:15,ci:3}
],openings:[
  {day:1,start:'08:00',end:'12:00'},{day:1,start:'13:00',end:'19:00'},
  {day:4,start:'08:00',end:'12:00'},{day:4,start:'13:00',end:'19:00'}
],appointments:[],patients:[],startH:8,endH:20}}

let D;
try{const r=localStorage.getItem(SK);D=r?JSON.parse(r):defD();if(!D.patients)D.patients=[];if(!D.motifs)D.motifs=defD().motifs;}catch(e){D=defD()}
function sv(){localStorage.setItem(SK,JSON.stringify(D))}

/* ‚ïê‚ïê‚ïê 2. DATE & UTILS (CORRECTED) ‚ïê‚ïê‚ïê */
// FIX: Utiliser la date locale pour l'affichage (YYYY-MM-DD) au lieu de toISOString (UTC)
const dk = d => {
  const year = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
};
const t2m=t=>{const p=t.split(':').map(Number);return p[0]*60+(p[1]||0)};
const m2t=m=>String(Math.floor(m/60)).padStart(2,'0')+':'+String(m%60).padStart(2,'0');
const uid=()=>Date.now().toString(36)+Math.random().toString(36).slice(2,6);
const esc=s=>(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;');
const gMon=d=>{const t=new Date(d);const w=t.getDay();t.setDate(t.getDate()-(w===0?6:w-1));return t};
const same=(a,b)=>dk(a)===dk(b);
const fmt=d=>d.toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'long'});
const fmtS=s=>{const d=new Date(s+'T00:00:00');return d.toLocaleDateString('fr-FR',{weekday:'short',day:'numeric',month:'numeric'})};
const calcAge=d=>{if(!d)return'';const b=new Date(d),n=new Date();let a=n.getFullYear()-b.getFullYear();if(n.getMonth()<b.getMonth()||(n.getMonth()===b.getMonth()&&n.getDate()<b.getDate()))a--;return a};
const toast=m=>{const t=document.getElementById('tst');t.textContent=m;t.classList.add('show');clearTimeout(t._t);t._t=setTimeout(()=>t.classList.remove('show'),2000)};
const opM=id=>document.getElementById(id).classList.add('open');
const clM=id=>document.getElementById(id).classList.remove('open');
const gp=id=>D.patients.find(p=>p.id===id);
const gm=id=>D.motifs.find(m=>m.id===id);
const alrt=p=>{if(!p)return'';let h='';if(p.needOrdo)h+=' ‚ùó';if(p.needMut)h+=' ‚ÄºÔ∏è';return h};
const ini=p=>((p.lastName||'')[0]+(p.firstName||'')[0]).toUpperCase();

/* ‚ïê‚ïê‚ïê 3. STATE & NAVIGATION ‚ïê‚ïê‚ïê */
let cD=new Date(),vM='grid',selId=null;
// Force Lundi/Jeudi start if needed
{const w=cD.getDay();if(w!==1&&w!==4){if(w===0)cD.setDate(cD.getDate()+1);else if(w>4)cD.setDate(cD.getDate()+(8-w));else cD.setDate(cD.getDate()+(w<4?1-w:4-w));}}

function R(){
  rWB();
  document.getElementById('pw').classList.toggle('off',vM!=='grid');
  document.getElementById('lv').classList.toggle('on',vM==='list');
  document.getElementById('plw').classList.toggle('on',vM==='patients');
  document.getElementById('bL').classList.toggle('on',vM==='list');
  document.getElementById('bP').classList.toggle('on',vM==='patients');
  if(vM==='grid'){rGrid();rAps()}else if(vM==='list')rList();else if(vM==='patients')rPats();
}

/* ‚ïê‚ïê‚ïê 4. RENDERERS ‚ïê‚ïê‚ïê */
function rWB(){
  const mon=gMon(cD);const today=new Date();const L=['L','M','M','J','V','S','D'];
  let h='';
  for(let i=0;i<7;i++){
    const d=new Date(mon); d.setDate(mon.getDate()+i);
    const w=d.getDay(); const ok=(w===1||w===4);
    const k=dk(d);
    // Utilisation de classes simplifi√©es
    const cls=`wd${same(d,cD)?' act':''}${ok?'':' dis'}${same(d,today)?' tod':''}`;
    // Le onclick appelle selD avec la string format√©e YYYY-MM-DD
    h+=`<div class="${cls}" onclick="selD('${k}')"><div class="wl">${L[i]}</div><div class="wn">${d.getDate()}</div></div>`;
  }
  document.getElementById('wb').innerHTML=h;
  document.getElementById('hd').textContent=fmt(cD);
}

function selD(k){
  // Parsing manuel pour √©viter les probl√®mes de timezone
  const p=k.split('-').map(Number);
  const n=new Date(p[0],p[1]-1,p[2]); // Heure locale 00:00:00
  if(n.getDay()!==1 && n.getDay()!==4) return;
  cD=n; R();
}

function navW(dir){
  const m=gMon(cD); m.setDate(m.getDate()+dir*7);
  // Re-cibler Lundi ou Jeudi
  const cur=cD.getDay();
  if(cur===4) m.setDate(m.getDate()+3); // Rester Jeudi
  cD=m; R();
}

function togV(v){vM=vM===v?'grid':v;R()}

/* Swipe Nav */
(function(){
  let sx=0,sy=0,ip=false;
  const wb=document.getElementById('wb');
  wb.addEventListener('touchstart',e=>{sx=e.touches[0].clientX;sy=e.touches[0].clientY;ip=true},{passive:true});
  wb.addEventListener('touchend',e=>{
    if(!ip)return; ip=false;
    const dx=e.changedTouches[0].clientX-sx;
    const dy=e.changedTouches[0].clientY-sy;
    // Seuil augment√© pour ne pas bloquer le clic
    if(Math.abs(dx)>60 && Math.abs(dx)>Math.abs(dy)*1.5){
      if(dx>0) navW(-1); else navW(1);
    }
  },{passive:true});
})();

/* Grid Renderer */
function rGrid(){
  const sh=D.startH,eh=D.endH,th=eh-sh,gh=th*80;
  const pg=document.getElementById('pg');
  pg.style.minHeight=gh+'px';
  
  let tH='',lH='';
  for(let h=sh;h<=eh;h++){
    const top=(h-sh)*80;
    tH+=`<div class="tl" style="top:${top}px">${h}:00</div>`;
    lH+=`<div class="gl full" style="top:${top}px"></div>`;
    if(h<eh){
      lH+=`<div class="gl half" style="top:${top+40}px"></div>
           <div class="gl quarter" style="top:${top+20}px"></div>
           <div class="gl quarter" style="top:${top+60}px"></div>`;
    }
  }
  document.getElementById('tc').innerHTML=tH;
  document.getElementById('glw').innerHTML=lH;
  
  // Openings
  const dow=cD.getDay(),ops=D.openings.filter(o=>o.day===dow);
  let oH='';
  ops.forEach(o=>{
    const s=t2m(o.start),e=t2m(o.end);
    const top=((s/60)-sh)*80, ht=((e-s)/60)*80;
    oH+=`<div class="op" style="top:${top}px;height:${ht}px"></div>`;
  });
  // Now Line
  const now=new Date();
  if(same(now,cD)){
    const nm=now.getHours()*60+now.getMinutes();
    const top=((nm/60)-sh)*80;
    if(top>=0&&top<=gh) oH+=`<div class="nl" style="top:${top}px"></div>`;
  }
  document.getElementById('sa').innerHTML=oH;
}

function rAps(){
  const area=document.getElementById('sa');
  // Clean old
  area.querySelectorAll('.ap').forEach(e=>e.remove());
  
  const key=dk(cD);
  const dayA=D.appointments.filter(a=>a.date===key).sort((a,b)=>t2m(a.time)-t2m(b.time));
  
  // Overlap Logic
  const cols=[];
  dayA.forEach(ap=>{
    const s=t2m(ap.time),e=s+ap.duration;
    let placed=false;
    for(let i=0;i<cols.length;i++){
      // Check collision in column i
      if(!cols[i].some(x=>Math.max(s,t2m(x.time)) < Math.min(e,t2m(x.time)+x.duration))){
        cols[i].push(ap); ap._col=i; placed=true; break;
      }
    }
    if(!placed){cols.push([ap]); ap._col=cols.length-1;}
  });
  const totalCols=cols.length;

  const sh=D.startH;
  dayA.forEach(ap=>{
    const s=t2m(ap.time);
    const top=((s/60)-sh)*80, ht=Math.max((ap.duration/60)*80, 24);
    const w=100/totalCols, l=ap._col*w;
    
    const mot=gm(ap.motifId),pat=ap.patientId?gp(ap.patientId):null;
    const isAbs=ap.type==='absence';
    const cc=isAbs?'abs':(mot?CL[mot.ci%6].css:'mc0');
    const txt=isAbs?(ap.label||'Absence'):(pat?`${pat.lastName} ${pat.firstName}`:'?');
    const sub=isAbs?'':(mot?mot.label:'');
    
    const el=document.createElement('div');
    el.className=`ap ${cc} ${ap.cancelled?'cncl':''}`;
    el.style.cssText=`top:${top}px;height:${ht}px;left:${l}%;width:${w-1}%`;
    el.innerHTML=`<div class="an">${esc(txt)}${alrt(pat)}</div>${ht>30?`<div class="am">${esc(sub)}</div>`:''}<div class="at">${ap.time}</div>`;
    el.onclick=e=>showCtx(e,ap.id);
    area.appendChild(el);
  });
}

function rList(){
  const el=document.getElementById('lv');
  const key=dk(cD);
  const dayA=D.appointments.filter(a=>a.date===key).sort((a,b)=>t2m(a.time)-t2m(b.time));
  if(!dayA.length){el.innerHTML='<div style="text-align:center;padding:50px;color:var(--text3)">Aucun rendez-vous</div>';return}
  let h='';
  dayA.forEach(ap=>{
    const mot=gm(ap.motifId),pat=ap.patientId?gp(ap.patientId):null;
    const isAbs=ap.type==='absence';
    const col=isAbs?'var(--absence)':(mot?CL[mot.ci%6].bd:'var(--border)');
    const txt=isAbs?(ap.label||'Absence'):(pat?`${pat.lastName} ${pat.firstName}`:'?');
    h+=`<div class="li ${ap.cancelled?'cncl':''}" style="border-left-color:${col}" onclick="showCtx(event,'${ap.id}')">
      <div class="lt">${ap.time}</div>
      <div class="lb"><div class="ln">${esc(txt)}${alrt(pat)}</div><div class="lm">${isAbs?'Absence':(mot?mot.label:'')}</div></div>
    </div>`;
  });
  el.innerHTML=h;
}

function rPats(){
  const w=document.getElementById('plw');
  const ps=D.patients.slice().sort((a,b)=>a.lastName.localeCompare(b.lastName));
  let h='<div class="pls"><input id="psch" placeholder="Rechercher..." oninput="fPats()"></div><div id="plst">';
  ps.forEach(p=>{
    h+=`<div class="pi" onclick="openPC('${p.id}')">
      <div class="pa">${ini(p)}</div>
      <div style="flex:1"><div class="pn">${esc(p.lastName)} ${esc(p.firstName)} ${alrt(p)}</div><div class="pd">${p.phone||'Sans t√©l.'}</div></div>
    </div>`;
  });
  w.innerHTML=h+'</div>';
}
function fPats(){
  const q=document.getElementById('psch').value.toLowerCase();
  document.querySelectorAll('#plst .pi').forEach(e=>e.style.display=e.textContent.toLowerCase().includes(q)?'flex':'none');
}

/* ‚ïê‚ïê‚ïê 5. INTERACTIONS & FORMS ‚ïê‚ïê‚ïê */
/* Click Grid to Create */
document.getElementById('sa').addEventListener('click',e=>{
  if(e.target.closest('.ap'))return;
  const rect=e.currentTarget.getBoundingClientRect();
  const y=e.clientY - rect.top + document.getElementById('pw').scrollTop;
  const mins=Math.round((y/80)*60 + D.startH*60);
  const snap=Math.round(mins/5)*5;
  openAF(null);
  setTimeout(()=>document.getElementById('fTm').value=m2t(snap),50);
});

function showCtx(e,id){
  e.stopPropagation(); selId=id;
  const ap=D.appointments.find(a=>a.id===id); if(!ap)return;
  const pat=ap.patientId?gp(ap.patientId):null;
  const m=document.getElementById('ctx');
  let h=`<div class="ci" onclick="editAp()">‚úèÔ∏è Modifier</div>`;
  if(pat){
    h+=`<div class="ci" onclick="openPC('${pat.id}');clCtx()">üë§ Patient</div>
        <div class="ci" onclick="openHist('${pat.id}');clCtx()">üìã Historique</div>`;
  }
  if(!ap.cancelled) h+=`<div class="ci dng" onclick="cancelAp()">üö´ Annuler</div>`;
  else h+=`<div class="ci" onclick="uncancelAp()">‚Ü©Ô∏è R√©tablir</div>`;
  
  if(ap.type!=='absence') h+=`<div class="ci" onclick="recurAp()">üîÅ R√©currence</div>`;
  h+=`<div class="ci dng" onclick="delAp()">üóë Supprimer</div>`;
  
  m.innerHTML=h; m.classList.add('open');
  // Smart positioning
  let x=e.clientX, y=e.clientY;
  if(x+180>window.innerWidth) x=window.innerWidth-190;
  if(y+220>window.innerHeight) y=y-220;
  m.style.left=x+'px'; m.style.top=y+'px';
  setTimeout(()=>document.addEventListener('click',clCtx,{once:true}),50);
}
function clCtx(){document.getElementById('ctx').classList.remove('open')}

/* Appointment Form */
function newAp(){openAF(null)}
function editAp(){clCtx(); const ap=D.appointments.find(a=>a.id===selId); if(ap) openAF(ap)}
function openAF(ex){
  const t=document.getElementById('mAT'), b=document.getElementById('mAB');
  t.textContent=ex?'Modifier':'Nouveau RDV';
  const isAbs=ex&&ex.type==='absence';
  const selMot=ex?ex.motifId:(D.motifs[0]?.id);
  const pat=ex&&ex.patientId?gp(ex.patientId):null;
  const dur=ex?ex.duration:(gm(selMot)?.duration||30);
  
  // Chips
  let ch=D.motifs.map(m=>`<div class="chip ${(!isAbs&&m.id===selMot)?'sel':''}" data-m="${m.id}" style="background:${CL[m.ci%6].bg};color:${CL[m.ci%6].bd}">${esc(m.label)}</div>`).join('');
  ch+=`<div class="chip ${isAbs?'sel':''}" data-m="__abs" style="background:var(--absence);color:#fff">Absence</div>`;
  
  b.innerHTML=`<div class="chips" id="mCh">${ch}</div>
    <div id="patB" style="${isAbs?'display:none':''}">
      <div class="fr">
        <div class="fg acw"><label>Nom</label><input id="fPL" value="${esc(pat?pat.lastName:'')}" placeholder="Nom"></div>
        <div class="fg"><label>Pr√©nom</label><input id="fPF" value="${esc(pat?pat.firstName:'')}" placeholder="Pr√©nom"></div>
      </div>
      <input type="hidden" id="fPi" value="${ex?ex.patientId:''}">
      <div class="acl" id="acl"></div>
    </div>
    <div id="absB" style="${isAbs?'':'display:none'}"><div class="fg"><label>Titre</label><input id="fAL" value="${esc(ex?.label||'Absence')}"></div></div>
    <div class="fr">
      <div class="fg"><label>Date</label><input type="date" id="fDt" value="${ex?ex.date:dk(cD)}"></div>
      <div class="fg"><label>Heure</label><input type="time" id="fTm" value="${ex?ex.time:'09:00'}" step="300"></div>
    </div>
    <div class="fg"><label>Dur√©e</label><input type="number" id="fDu" value="${dur}" step="5"></div>
    <div class="fg"><label>Note</label><textarea id="fNo" rows="2">${esc(ex?.notes)}</textarea></div>
    <div class="br"><button class="btn bp bw" onclick="svAF('${ex?ex.id:''}')">Enregistrer</button></div>`;
  
  // Events
  document.querySelectorAll('#mCh .chip').forEach(c=>c.onclick=()=>{
    document.querySelectorAll('#mCh .chip').forEach(x=>x.classList.remove('sel')); c.classList.add('sel');
    const m=c.dataset.m, isA=(m==='__abs');
    document.getElementById('patB').style.display=isA?'none':'block';
    document.getElementById('absB').style.display=isA?'block':'none';
    if(!isA) document.getElementById('fDu').value=gm(m)?.duration||30;
  });
  setupAC(); opM('mA');
}

/* Autocomplete Logic */
function setupAC(){
  const iL=document.getElementById('fPL'), iF=document.getElementById('fPF'), l=document.getElementById('acl'), h=document.getElementById('fPi');
  if(!iL)return;
  const srch=()=>{
    const qL=iL.value.toLowerCase(), qF=iF.value.toLowerCase();
    if(qL.length<1 && qF.length<1){l.classList.remove('open');return}
    h.value=''; // Reset hidden ID if typing
    const res=D.patients.filter(p=>p.lastName.toLowerCase().includes(qL) && p.firstName.toLowerCase().includes(qF)).slice(0,6);
    let ht=res.map(p=>`<div class="aci" onclick="fillP('${p.id}')"><span>${esc(p.lastName)} ${esc(p.firstName)}</span></div>`).join('');
    ht+=`<div class="aci acn" onclick="addQuickP()">+ Cr√©er "${esc(iL.value)} ${esc(iF.value)}"</div>`;
    l.innerHTML=ht; l.classList.add('open');
  };
  iL.oninput=srch; iF.oninput=srch;
  window.fillP=id=>{const p=gp(id); iL.value=p.lastName; iF.value=p.firstName; h.value=id; l.classList.remove('open');};
  window.addQuickP=()=>{
    const np={id:uid(),lastName:iL.value,firstName:iF.value,dob:'',phone:'',needOrdo:false,needMut:false};
    D.patients.push(np); sv(); fillP(np.id); toast('Patient cr√©√©');
  };
  // Close AC on delay
  iL.onblur=iF.onblur=()=>setTimeout(()=>l.classList.remove('open'),200);
}

function svAF(eid){
  const mid=document.querySelector('#mCh .chip.sel').dataset.m;
  const isAbs=mid==='__abs';
  const pid=document.getElementById('fPi').value;
  const dt=document.getElementById('fDt').value, tm=document.getElementById('fTm').value;
  
  if(!isAbs && !pid){toast('Patient requis');return}
  if(!dt||!tm){toast('Date/Heure requises');return}
  
  const dat=new Date(dt);
  if(dat.getDay()!==1 && dat.getDay()!==4){toast('Lundi ou Jeudi uniquement');return}

  const ap={
    id:eid||uid(), type:isAbs?'absence':'rdv', motifId:isAbs?null:mid, patientId:isAbs?null:pid,
    label:isAbs?document.getElementById('fAL').value:'', date:dt, time:tm, 
    duration:parseInt(document.getElementById('fDu').value)||30, notes:document.getElementById('fNo').value, cancelled:false
  };
  
  if(eid){
    const idx=D.appointments.findIndex(a=>a.id===eid);
    if(idx>=0) D.appointments[idx]={...D.appointments[idx],...ap};
  } else D.appointments.push(ap);
  
  sv(); clM('mA'); cD=new Date(dt+'T00:00:00'); R(); toast('Enregistr√©');
}

function cancelAp(){const a=D.appointments.find(x=>x.id===selId);if(a){a.cancelled=true;sv();R();clCtx();toast('Annul√©')}}
function uncancelAp(){const a=D.appointments.find(x=>x.id===selId);if(a){a.cancelled=false;sv();R();clCtx();toast('R√©tabli')}}
function delAp(){if(confirm('Supprimer ?')){D.appointments=D.appointments.filter(x=>x.id!==selId);sv();R();clCtx();toast('Supprim√©')}}

/* Recurrence */
function recurAp(){
  clCtx(); const ap=D.appointments.find(a=>a.id===selId); if(!ap)return;
  document.getElementById('mRB').innerHTML=`<p style="color:var(--text2);margin-bottom:10px">R√©p√©ter ${ap.time} (${ap.duration}min)</p>
    <div class="fg"><label>Semaines</label><input type="number" id="rw" value="5"></div>
    <div class="br"><button class="btn bp bw" onclick="doRec('${ap.id}')">Valider</button></div>`;
  opM('mR');
}
function doRec(id){
  const src=D.appointments.find(a=>a.id===id);
  const w=parseInt(document.getElementById('rw').value)||1;
  const d=new Date(src.date+'T00:00:00');
  let c=0;
  for(let i=1;i<=w;i++){
    const nd=new Date(d); nd.setDate(d.getDate()+i*7);
    const k=dk(nd);
    if(!D.appointments.some(x=>x.date===k && x.time===src.time)){
      D.appointments.push({...src, id:uid(), date:k}); c++;
    }
  }
  sv(); clM('mR'); R(); toast(`${c} cr√©√©s`);
}

/* Patient Card */
function openPC(id){
  clCtx(); const p=gp(id); if(!p)return;
  document.getElementById('mPT').innerHTML=esc(p.lastName)+' '+esc(p.firstName);
  document.getElementById('mPB').innerHTML=`<div class="pcard">
    <div style="margin-bottom:10px"><b>${p.phone||'Pas de tel'}</b></div>
    <div class="pcks">
      <label><input type="checkbox" ${p.needOrdo?'checked':''} onchange="togF('${id}','needOrdo')"> Ordonnance</label>
      <label><input type="checkbox" ${p.needMut?'checked':''} onchange="togF('${id}','needMut')"> Mutuelle</label>
    </div>
    <div class="br"><button class="btn bs" onclick="editPat('${id}')">Modifier</button><button class="btn bs" onclick="openHist('${id}');clM('mP')">Historique</button></div>
  </div>`;
  opM('mP');
}
function togF(id,k){const p=gp(id);if(p){p[k]=!p[k];sv();R();}}
function editPat(id){
  clM('mP'); const p=gp(id);
  document.getElementById('mAT').textContent='Modifier Patient';
  document.getElementById('mAB').innerHTML=`<div class="fg"><label>Nom</label><input id="epL" value="${esc(p.lastName)}"></div>
    <div class="fg"><label>Pr√©nom</label><input id="epF" value="${esc(p.firstName)}"></div>
    <div class="fg"><label>Tel</label><input id="epP" value="${esc(p.phone)}"></div>
    <div class="br"><button class="btn bp bw" onclick="svPat('${id}')">Valider</button></div>`;
  opM('mA');
}
function svPat(id){const p=gp(id); p.lastName=document.getElementById('epL').value; p.firstName=document.getElementById('epF').value; p.phone=document.getElementById('epP').value; sv(); clM('mA'); R(); toast('Modifi√©');}
function openHist(id){
  const p=gp(id); document.getElementById('mHT').textContent=p.lastName;
  const as=D.appointments.filter(a=>a.patientId===id).sort((a,b)=>a.date.localeCompare(b.date));
  let h=as.map(a=>`<div class="hi ${a.cancelled?'cncl':''}">
    <div class="hid">${fmtS(a.date)}</div><div class="him">${a.time} - ${gm(a.motifId)?.label||'Abs'}</div>
  </div>`).join('');
  document.getElementById('mHB').innerHTML=h||'Rien'; opM('mH');
}

/* Settings */
function openSet(){
  document.getElementById('mSB').innerHTML=`
    <div class="ss"><h3>Plages</h3>
    <div class="fr"><div class="fg"><label>D√©but</label><input type="number" id="sS" value="${D.startH}" onchange="ucfg()"></div>
    <div class="fg"><label>Fin</label><input type="number" id="sE" value="${D.endH}" onchange="ucfg()"></div></div></div>
    <div class="br"><button class="btn bd bw" onclick="rst()">Reset Total</button></div>`;
  opM('mS');
}
function ucfg(){D.startH=Number(document.getElementById('sS').value); D.endH=Number(document.getElementById('sE').value); sv(); R();}
function rst(){if(confirm('Effacer tout ?')){localStorage.removeItem(SK); location.reload();}}

/* Init */
function scrollNow(){document.getElementById('pw').scrollTop=((new Date().getHours()-D.startH)*80)-40}
if('serviceWorker' in navigator)navigator.serviceWorker.register('sw.js').catch(()=>{});
R(); scrollNow();
</script>
</body>
</html>