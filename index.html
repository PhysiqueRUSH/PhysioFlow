<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0f1923">
<link rel="manifest" href="manifest.json">
<title>PhysioFlow</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f2efe9;--bg2:#e8e4dc;--surface:#fff;--surface2:#faf9f6;
  --text:#1a1a2e;--text2:#6a6a7e;--text3:#8a8a9a;
  --accent:#2a7c6f;--accent2:#3bb5a0;--accentbg:rgba(42,124,111,.07);
  --border:#ccc8bf;--border2:#ddd8cf;
  --shadow:0 4px 16px rgba(0,0,0,.08);--shadowlg:0 8px 32px rgba(0,0,0,.12);
  --radius:8px;--radiuslg:14px;--radiusxl:20px;
  --c0:#4a80c4;--c0bg:#dce7f5;--c0t:#1e3a5c;
  --c1:#e07a3a;--c1bg:#fce8d8;--c1t:#6b3210;
  --c2:#7b5bbf;--c2bg:#ece4f8;--c2t:#3a2070;
  --c3:#c44a6a;--c3bg:#fce0e8;--c3t:#6b1030;
  --c4:#3aad5c;--c4bg:#d8f2e0;--c4t:#105c28;
  --c5:#c4a030;--c5bg:#f8f2d8;--c5t:#5c4a08;
  --absence:#546e7a;
  --grid-line:#c5c0b5;
  --grid-half:#d5d0c8;
  --grid-quarter:#e0dcd5;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);overflow:hidden;-webkit-tap-highlight-color:transparent}
button{font-family:inherit;cursor:pointer;border:none;background:none;color:inherit;font-size:inherit}
input,select,textarea{font-family:inherit;color:var(--text);font-size:14px}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
#app{display:flex;flex-direction:column;height:100dvh;height:100vh;overflow:hidden}

/* ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê */
.hdr{background:var(--surface);border-bottom:1px solid var(--border);padding:10px 14px;display:flex;align-items:center;gap:10px;flex-shrink:0;z-index:100}
.logo{font-family:'JetBrains Mono',monospace;font-weight:600;font-size:16px;color:var(--accent);letter-spacing:-.5px;white-space:nowrap}
.logo b{color:var(--text)}
.logoWrap{display:flex;flex-direction:column;line-height:1}
.ver{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text3);margin-top:2px;letter-spacing:-.2px}
.hdr-c{flex:1;display:flex;align-items:center;justify-content:center;gap:6px}
.hdr-c span{font-weight:600;font-size:14px;min-width:140px;text-align:center}
.nb{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:var(--accentbg);color:var(--accent);font-size:18px;font-weight:700;-webkit-tap-highlight-color:transparent;touch-action:manipulation}
.nb:active{transform:scale(.9);background:var(--accent);color:#fff}
.ha{display:flex;gap:5px}
.ib{width:34px;height:34px;border-radius:var(--radius);display:flex;align-items:center;justify-content:center;background:var(--accentbg);color:var(--accent);font-size:16px}
.ib:active{transform:scale(.92)}
.ib.on{background:var(--accent);color:#fff}

/* ‚ïê‚ïê‚ïê WEEK BAR - IMPROVED TOUCH TARGETS ‚ïê‚ïê‚ïê */
.wbar{display:flex;background:var(--surface);border-bottom:1px solid var(--border);flex-shrink:0;padding:4px 0}
.wd{flex:1;text-align:center;padding:10px 2px 12px;cursor:pointer;position:relative;-webkit-tap-highlight-color:transparent;touch-action:manipulation;border-radius:8px;margin:0 2px;transition:background .15s,transform .1s}
.wd.act{background:var(--accentbg)}
.wd.act::after{content:'';position:absolute;bottom:2px;left:20%;right:20%;height:3px;background:var(--accent);border-radius:2px}
.wd.dis{opacity:.2;pointer-events:none}
.wd:not(.dis):active{transform:scale(.95);background:rgba(42,124,111,.12)}
.wd .wl{font-size:11px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.5px}
.wd .wn{font-size:16px;font-weight:700;margin-top:2px;display:inline-flex;align-items:center;justify-content:center;width:30px;height:30px;border-radius:50%;transition:all .15s}
.wd.tod .wn{background:var(--accent);color:#fff}
.wd.act:not(.tod) .wn{color:var(--accent)}

/* ‚ïê‚ïê‚ïê GRID VIEW ‚ïê‚ïê‚ïê */
.pw{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;touch-action:pan-y}
.pg{position:relative}

/* Time column - HIGH CONTRAST */
.tc{position:absolute;left:0;top:0;bottom:0;width:54px;z-index:2;pointer-events:none;background:linear-gradient(to right,var(--bg) 48px,transparent)}
.tl{position:absolute;left:0;width:52px;text-align:right;padding-right:6px;font-size:12px;font-weight:700;color:var(--text2);font-family:'JetBrains Mono',monospace;transform:translateY(-50%)}

/* Grid lines - HIGH CONTRAST */
.gl-w{position:absolute;left:54px;right:4px;top:0;bottom:0}
.gl{position:absolute;left:0;right:0;border-top-style:solid}
.gl.full{border-top-width:1.5px;border-top-color:var(--grid-line)}
.gl.half{border-top-width:1px;border-top-color:var(--grid-half)}
.gl.quarter{border-top-width:1px;border-top-color:var(--grid-quarter);border-top-style:dashed}

/* Hour labels on grid */
.gl-label{position:absolute;right:4px;font-size:9px;font-weight:600;color:var(--text3);font-family:'JetBrains Mono',monospace;transform:translateY(-50%);pointer-events:none;opacity:.6}

/* Slots area */
.sa{position:absolute;left:54px;right:4px;top:0;bottom:0}
.op{position:absolute;left:0;right:0;background:rgba(42,124,111,.05);border-left:3px solid rgba(42,124,111,.18);z-index:1;pointer-events:none;border-radius:0 4px 4px 0}
.nl{position:absolute;left:0;right:0;height:2px;background:var(--accent);z-index:8;pointer-events:none}
.nl::before{content:'';position:absolute;left:-5px;top:-4px;width:10px;height:10px;background:var(--accent);border-radius:50%}
.nl-time{position:absolute;left:14px;top:-8px;font-size:9px;font-weight:700;color:#fff;background:var(--accent);padding:1px 5px;border-radius:4px;font-family:'JetBrains Mono',monospace}

/* Appointments */
.ap{position:absolute;border-radius:6px;padding:4px 7px;overflow:hidden;cursor:pointer;border-left:3px solid;font-size:11px;line-height:1.25;display:flex;flex-direction:column;z-index:5;transition:box-shadow .15s}
.ap:active{box-shadow:var(--shadow);z-index:10;transform:scale(.98)}
.ap .an{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:flex;align-items:center;gap:3px}
.ap .am{font-size:9px;opacity:.7;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ap .at{font-size:9px;opacity:.5;font-family:'JetBrains Mono',monospace}
.ap.cncl .an{text-decoration:line-through;opacity:.6}
.ap.cncl{opacity:.5}
.ap.abs{background:var(--absence)!important;border-left-color:#37474f!important;color:#fff;opacity:.8}
.bo{color:var(--c1);font-size:10px;flex-shrink:0}
.bm{color:var(--c3);font-size:10px;flex-shrink:0}
.ap.mc0{background:var(--c0bg);border-left-color:var(--c0);color:var(--c0t)}
.ap.mc1{background:var(--c1bg);border-left-color:var(--c1);color:var(--c1t)}
.ap.mc2{background:var(--c2bg);border-left-color:var(--c2);color:var(--c2t)}
.ap.mc3{background:var(--c3bg);border-left-color:var(--c3);color:var(--c3t)}
.ap.mc4{background:var(--c4bg);border-left-color:var(--c4);color:var(--c4t)}
.ap.mc5{background:var(--c5bg);border-left-color:var(--c5);color:var(--c5t)}

/* ‚ïê‚ïê‚ïê LIST VIEW ‚ïê‚ïê‚ïê */
.lv{flex:1;overflow-y:auto;padding:8px 12px;display:none}
.lv.on{display:block}
.pw.off{display:none}
.li{display:flex;align-items:center;gap:10px;padding:12px 14px;background:var(--surface);border-radius:var(--radius);margin-bottom:6px;border-left:3px solid var(--border);cursor:pointer}
.li:active{background:var(--bg2)}
.li.cncl{opacity:.5}
.li.cncl .ln{text-decoration:line-through}
.li .lt{font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:600;color:var(--text2);min-width:44px}
.li .lb{flex:1;min-width:0}
.li .ln{font-weight:600;font-size:14px;display:flex;align-items:center;gap:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.li .lm{font-size:11px;color:var(--text2);margin-top:1px}

/* ‚ïê‚ïê‚ïê PATIENTS LIST ‚ïê‚ïê‚ïê */
.plw{flex:1;overflow-y:auto;padding:8px 12px;display:none}
.plw.on{display:block}
.pls{margin-bottom:8px;position:relative}
.pls input{width:100%;padding:9px 11px 9px 34px;border:1.5px solid var(--border);border-radius:var(--radius);background:var(--surface);font-size:13px;outline:none}
.pls input:focus{border-color:var(--accent)}
.pls::before{content:'üîç';position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:13px;pointer-events:none}
.pi{display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--surface);border-radius:var(--radius);margin-bottom:4px;cursor:pointer}
.pi:active{background:var(--bg2)}
.pi .pa{width:36px;height:36px;border-radius:50%;background:var(--accentbg);display:flex;align-items:center;justify-content:center;font-weight:600;color:var(--accent);font-size:13px;flex-shrink:0}
.pi .pif{flex:1;min-width:0}
.pi .pn{font-weight:600;font-size:13px;display:flex;align-items:center;gap:3px}
.pi .pd{font-size:11px;color:var(--text2)}

/* ‚ïê‚ïê‚ïê FAB ‚ïê‚ïê‚ïê */
.fab{position:fixed;bottom:20px;right:16px;width:52px;height:52px;border-radius:50%;background:var(--accent);color:#fff;font-size:26px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 16px rgba(42,124,111,.35);z-index:50}
.fab:active{transform:scale(.92)}

/* ‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê */
.mo{position:fixed;inset:0;background:rgba(10,15,30,.4);backdrop-filter:blur(3px);z-index:200;display:flex;align-items:flex-end;justify-content:center;opacity:0;pointer-events:none;transition:.2s}
.mo.open{opacity:1;pointer-events:all}
.mop{background:var(--surface);border-radius:var(--radiusxl) var(--radiusxl) 0 0;width:100%;max-width:460px;max-height:88vh;overflow-y:auto;transform:translateY(100%);transition:transform .28s cubic-bezier(.22,1,.36,1);padding:0 18px 28px}
.mo.open .mop{transform:translateY(0)}
.moh{width:32px;height:4px;background:var(--border);border-radius:4px;margin:10px auto 14px}
.mop h2{font-size:17px;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.mop h3{font-size:13px;font-weight:600;margin:14px 0 6px;color:var(--text2)}
.fg{margin-bottom:12px}
.fg label{display:block;font-size:11px;font-weight:600;color:var(--text2);margin-bottom:3px;text-transform:uppercase;letter-spacing:.5px}
.fg input,.fg select,.fg textarea{width:100%;padding:9px 11px;border:1.5px solid var(--border);border-radius:var(--radius);background:var(--bg);outline:none}
.fg input:focus,.fg select:focus,.fg textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(42,124,111,.1)}
.fr{display:flex;gap:8px}
.fr .fg{flex:1}
.btn{padding:10px 16px;border-radius:var(--radius);font-size:13px;font-weight:600;display:inline-flex;align-items:center;justify-content:center;gap:5px}
.btn:active{transform:scale(.97)}
.bp{background:var(--accent);color:#fff}
.bd{background:#e74c3c;color:#fff}
.bs{background:var(--bg);border:1.5px solid var(--border)}
.bw{width:100%}
.br{display:flex;gap:6px;margin-top:16px}
.br .btn{flex:1}
.chips{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:12px}
.chip{padding:5px 11px;border-radius:16px;font-size:11px;font-weight:600;cursor:pointer;border:2px solid transparent}
.chip.sel{border-color:var(--text);transform:scale(1.05)}

/* Autocomplete */
.acw{position:relative}
.acl{position:absolute;top:100%;left:0;right:0;background:var(--surface);border:1.5px solid var(--border);border-top:none;border-radius:0 0 var(--radius) var(--radius);max-height:180px;overflow-y:auto;z-index:10;display:none;box-shadow:var(--shadow)}
.acl.open{display:block}
.aci{padding:8px 11px;cursor:pointer;font-size:13px;display:flex;align-items:center;gap:6px}
.aci:hover,.aci.hl{background:var(--accentbg)}
.aci .acs{font-size:11px;color:var(--text2)}
.acn{color:var(--accent);font-weight:600}

/* Context menu */
.ctx{position:fixed;background:var(--surface);border-radius:var(--radiuslg);box-shadow:var(--shadowlg);z-index:250;min-width:170px;padding:4px;opacity:0;pointer-events:none;transition:.08s}
.ctx.open{opacity:1;pointer-events:all}
.ci{padding:9px 13px;border-radius:var(--radius);font-size:12px;font-weight:500;display:flex;align-items:center;gap:7px;cursor:pointer}
.ci:active{background:var(--accentbg)}
.ci.dng{color:#e74c3c}

/* Toast */
.toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(60px);background:var(--text);color:#fff;padding:9px 18px;border-radius:var(--radius);font-size:12px;font-weight:500;z-index:300;opacity:0;transition:.25s;pointer-events:none;white-space:nowrap}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* History */
.hs{display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap}
.hst{background:var(--bg);border-radius:var(--radius);padding:8px 12px;text-align:center;flex:1;min-width:60px}
.hst .hn{font-size:20px;font-weight:700;font-family:'JetBrains Mono',monospace}
.hst .hl{font-size:10px;color:var(--text2);margin-top:2px}
.hi{display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--surface);border-radius:var(--radius);margin-bottom:4px;border-left:3px solid var(--border);font-size:12px}
.hi.cncl{opacity:.5}.hi.cncl .him{text-decoration:line-through}
.hi.fut{opacity:.7;border-style:dashed}
.hi .hid{font-family:'JetBrains Mono',monospace;min-width:80px;color:var(--text2);font-size:11px}
.hi .him{flex:1}
.hi .hib{font-size:10px;padding:2px 6px;border-radius:8px;font-weight:600}

/* Settings */
.ss{margin-bottom:16px;padding-bottom:14px;border-bottom:1px solid var(--border2)}
.ss:last-child{border:none}
.si{display:flex;align-items:center;gap:6px;padding:7px 9px;background:var(--bg);border-radius:var(--radius);margin-bottom:5px;font-size:13px}
.si input[type=time]{padding:4px 6px;border:1.5px solid var(--border);border-radius:6px;font-size:12px;background:var(--surface)}
.si .sd{font-weight:600;min-width:48px;font-size:12px}
.si .sa2{color:var(--text3);font-size:11px}
.si .sb{margin-left:auto;width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.si .sb.del{background:#fce0e8;color:var(--c3)}
.si .sb.edt{background:var(--accentbg);color:var(--accent)}
.mi{display:flex;align-items:center;gap:8px;padding:7px 9px;background:var(--bg);border-radius:var(--radius);margin-bottom:5px}
.mi .md{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.mi .ml{flex:1;font-size:13px;font-weight:500}
.mi .mu{font-size:11px;color:var(--text2);font-family:'JetBrains Mono',monospace}
.addb{display:flex;align-items:center;gap:5px;padding:7px 10px;border:1.5px dashed var(--border);border-radius:var(--radius);width:100%;font-size:12px;font-weight:500;color:var(--text2);justify-content:center}
.addb:active{border-color:var(--accent);color:var(--accent)}

/* Patient card */
.pcard{background:var(--surface);border-radius:var(--radiuslg);padding:16px;margin-bottom:12px;border:1px solid var(--border2)}
.pcard .pt{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.pcard .pav{width:44px;height:44px;border-radius:50%;background:var(--accentbg);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--accent);font-size:16px;flex-shrink:0}
.pcard .pinf{flex:1;min-width:0}
.pcard .pnm{font-weight:700;font-size:15px;display:flex;align-items:center;gap:4px;flex-wrap:wrap}
.pcard .pag{font-size:12px;color:var(--text2)}
.pcard .pacts{display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap}
.pcard .pacts a,.pcard .pacts button{padding:7px 12px;border-radius:var(--radius);font-size:12px;font-weight:600;background:var(--bg);border:1px solid var(--border);display:inline-flex;align-items:center;gap:4px;text-decoration:none;color:var(--text)}
.pcks{display:flex;gap:14px;margin-bottom:10px}
.pcks label{display:flex;align-items:center;gap:5px;font-size:12px;font-weight:500;cursor:pointer}
.pcks input[type=checkbox]{width:16px;height:16px;accent-color:var(--accent)}
.pdocs{margin-top:8px}
.pdi{display:flex;align-items:center;gap:6px;padding:5px 0;font-size:12px;border-bottom:1px solid var(--border2)}
.pdi:last-child{border:none}
.pdi a{color:var(--accent);font-weight:500;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-decoration:none}

/* Empty state */
.empty-grid{position:absolute;left:54px;right:4px;top:50%;transform:translateY(-50%);text-align:center;color:var(--text3);font-size:13px;z-index:0;pointer-events:none}
.empty-grid .eg-icon{font-size:32px;margin-bottom:6px}



/* Responsive header: keep action buttons visible on narrow screens */
@media(max-width:430px){
  .hdr{flex-wrap:wrap;padding:8px 10px}
  .hdr-c{order:3;flex:1 1 100%;justify-content:space-between}
  .hdr-c span{min-width:0;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:13px}
  .ha{margin-left:auto}
  .nb{width:34px;height:34px}
  .ib{width:32px;height:32px}
}

@media(min-width:500px){.mop{border-radius:var(--radiusxl);margin-bottom:32px;max-height:82vh}}

.bill{margin-left:6px;cursor:pointer}
.tri{margin-right:6px}
.ub{font-size:11px;color:var(--text2);margin-top:2px}

</style>
<link rel="icon" href="PhysioFlow.png">
<link rel="apple-touch-icon" href="PhysioFlow.png">
</head>
<body>
<div id="app">
  <div class="hdr">
    <div class="logoWrap"><div class="logo"><b>Physio</b>Flow</div><div class="ver">version 6</div></div>
    <div class="hdr-c"><button class="nb" onclick="navW(-1)">‚Äπ</button><span id="hd"></span><button class="nb" onclick="navW(1)">‚Ä∫</button></div>
    <div class="ha">
      <button class="ib" id="bL" onclick="togV('list')" title="Liste du jour">‚ò∞</button>
      <button class="ib" id="bP" onclick="togV('patients')" title="Patients">üë•</button>
      <button class="ib" onclick="openSet()" title="Param√®tres">‚öô</button>
    </div>
  </div>
  <div class="wbar" id="wb"></div>
  <div class="pw" id="pw"><div class="pg" id="pg"><div class="tc" id="tc"></div><div class="gl-w" id="glw"></div><div class="sa" id="sa"></div></div></div>
  <div class="lv" id="lv"></div>
  <div class="plw" id="plw"></div>
  <button class="fab" onclick="fabClick()">+</button>
</div>
<div class="toast" id="tst"></div>
<div class="ctx" id="ctx"></div>
<div class="mo" id="mA"><div class="mop"><div class="moh"></div><h2 id="mAT"></h2><div id="mAB"></div></div></div>
<div class="mo" id="mS"><div class="mop"><div class="moh"></div><h2>‚öô Param√®tres</h2><div id="mSB"></div></div></div>
<div class="mo" id="mP"><div class="mop"><div class="moh"></div><h2 id="mPT">Patient</h2><div id="mPB"></div></div></div>
<div class="mo" id="mH"><div class="mop"><div class="moh"></div><h2 id="mHT">Historique</h2><div id="mHB"></div></div></div>
<div class="mo" id="mM"><div class="mop"><div class="moh"></div><h2 id="mMT">Motif</h2><div id="mMB"></div></div></div>
<div class="mo" id="mR"><div class="mop"><div class="moh"></div><h2>üîÅ Planifier r√©currence</h2><div id="mRB"></div></div></div>

<div class="mo" id="mDelR"><div class="mop"><div class="moh"></div><h2>üóë Supprimer et occurrences</h2><div id="mDelRB"></div></div></div>
<div class="mo" id="mOCR"><div class="mop"><div class="moh"></div><h2>üì∑ Import patients OCR</h2><div id="mOCRB"></div></div></div>

<script src="https://unpkg.com/tesseract.js@5/dist/tesseract.min.js"></script>

<script>
/* ‚ïê‚ïê‚ïê STORAGE ‚ïê‚ïê‚ïê */
const SK='physioflow_v3';
const CL=[
  {css:'mc0',bg:'var(--c0bg)',bd:'var(--c0)',lb:'Bleu'},
  {css:'mc1',bg:'var(--c1bg)',bd:'var(--c1)',lb:'Orange'},
  {css:'mc2',bg:'var(--c2bg)',bd:'var(--c2)',lb:'Violet'},
  {css:'mc3',bg:'var(--c3bg)',bd:'var(--c3)',lb:'Rose'},
  {css:'mc4',bg:'var(--c4bg)',bd:'var(--c4)',lb:'Vert'},
  {css:'mc5',bg:'var(--c5bg)',bd:'var(--c5)',lb:'Jaune'}
];
function defD(){return{days:[1,4],motifs:[
  {id:'reeduc',label:'R√©√©ducation Active',duration:45,ci:0,times:[]},
  {id:'premiere',label:'Premi√®re S√©ance',duration:30,ci:1,times:[]},
  {id:'soin',label:'Soin Kin√© Classique',duration:20,ci:2,times:[]},
  {id:'ondes',label:'Ondes de Choc',duration:10,ci:3,times:[]}
],openings:[
  {day:1,start:'08:45',end:'12:35'},{day:1,start:'13:15',end:'18:40'},
  {day:4,start:'08:45',end:'12:35'},{day:4,start:'13:15',end:'18:40'}
],appointments:[],patients:[],bilanFee:30,startH:8,endH:19}}

let D;
try{const r=localStorage.getItem(SK);D=r?JSON.parse(r):defD();
    // migrations / defaults
    if(D.bilanFee===undefined)D.bilanFee=30;
    if(!Array.isArray(D.patients))D.patients=[];
    D.patients.forEach(function(p){
      if(p.sessionFee===undefined)p.sessionFee=18.20;
      if(!p.billMode)p.billMode='each'; // 'each' or 'every'
      if(p.billEvery===undefined)p.billEvery=3;
      if(!p.lastBillAt)p.lastBillAt='';
      if(p.needSecu===undefined)p.needSecu=false;
      if(p.rejectReason===undefined)p.rejectReason='';
      if(p.rejectCount===undefined)p.rejectCount=0;
    });
    if(!Array.isArray(D.appointments))D.appointments=[];
    D.appointments.forEach(function(a){
      if(a.billed===undefined)a.billed=false;
      if(a.billedAt===undefined)a.billedAt='';
      if(a.billedAmount===undefined)a.billedAmount=0;
      if(a.isBilan===undefined)a.isBilan=(a.type==='bilan');
      if(a.type==='bilan')a.isBilan=true;
    });
if(!D.patients)D.patients=[];if(!D.startH)D.startH=8;if(!D.endH)D.endH=19;if(!Array.isArray(D.days)||!D.days.length)D.days=[1,4];D.days=[...new Set(D.days.map(Number))].filter(d=>d>=0&&d<=6);if(!D.days.length)D.days=[1,4];D.motifs.forEach((m,i)=>{if(m.ci===undefined)m.ci=i%6;if(!Array.isArray(m.times))m.times=[];m.times=m.times.filter(Boolean)})}catch(e){D=defD()}
function sv(){localStorage.setItem(SK,JSON.stringify(D))}

/* ‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê */
let cD=new Date(),vM='grid',selId=null;

function monIndex(dow){return (dow+6)%7} /* Monday=0 ... Sunday=6 */
function sortDows(arr){return (arr||[]).slice().sort((a,b)=>monIndex(a)-monIndex(b))}
const DAY_S=['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'];
const DAY_L=['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'];
function daysLabel(arr){return sortDows(arr).map(d=>DAY_L[d]).join(', ')}

function ensureActiveDate(base){
  if(!Array.isArray(D.days)||!D.days.length)D.days=[1,4];
  const b=base?new Date(base):new Date(cD);
  if(D.days.includes(b.getDay())){cD=b;return}
  for(let i=0;i<14;i++){
    const t=new Date(b);t.setDate(b.getDate()+i);
    if(D.days.includes(t.getDay())){cD=t;return}
  }
  cD=b;
}
ensureActiveDate();

/* ‚ïê‚ïê‚ïê UTILS ‚ïê‚ïê‚ïê */
const dk=d=>{const y=d.getFullYear();const m=String(d.getMonth()+1).padStart(2,'0');const da=String(d.getDate()).padStart(2,'0');return y+'-'+m+'-'+da};
const t2m=t=>{const p=t.split(':').map(Number);return p[0]*60+(p[1]||0)};
const m2t=m=>String(Math.floor(m/60)).padStart(2,'0')+':'+String(m%60).padStart(2,'0');
const uid=()=>Date.now().toString(36)+Math.random().toString(36).slice(2,7);
const esc=s=>(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
const gMon=d=>{const t=new Date(d);const w=t.getDay();t.setDate(t.getDate()-(w===0?6:w-1));return t};
const same=(a,b)=>dk(a)===dk(b);
function fmt(d){const ds=['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'],ms=['janv.','f√©vr.','mars','avr.','mai','juin','juil.','ao√ªt','sept.','oct.','nov.','d√©c.'];return ds[d.getDay()]+' '+d.getDate()+' '+ms[d.getMonth()]+' '+d.getFullYear()}
function fmtS(s){const d=new Date(s+'T00:00:00');return['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'][d.getDay()]+' '+d.getDate()+'/'+(d.getMonth()+1)}
function calcAge(dob){if(!dob)return'';const b=new Date(dob),n=new Date();let a=n.getFullYear()-b.getFullYear();if(n.getMonth()<b.getMonth()||(n.getMonth()===b.getMonth()&&n.getDate()<b.getDate()))a--;return a}
function toast(m){const t=document.getElementById('tst');t.textContent=m;t.classList.add('show');clearTimeout(t._t);t._t=setTimeout(()=>t.classList.remove('show'),2200)}
function opM(id){document.getElementById(id).classList.add('open');document.getElementById(id).onclick=e=>{if(e.target.classList.contains('mo'))clM(id)}}
function clM(id){document.getElementById(id).classList.remove('open')}
const gp=id=>D.patients.find(p=>p.id===id);
const gm=id=>D.motifs.find(m=>m.id===id);
function alrt(p){
  if(!p)return'';
  let h='';
  if(p.needOrdo)h+='<span class="bm" title="Ordonnance manquante">‚ùó</span>';
  if(p.needMut||p.needSecu){
    const t=(p.needMut&&p.needSecu)?'Mutuelle + S√©cu (rejet)':(p.needMut?'Mutuelle (rejet)':'S√©cu (rejet)');
    h+='<span class="bm" title="'+t+'">‚ÄºÔ∏è</span>';
  }
  return h;
}

/* ‚ïê‚ïê‚ïê BILLING ‚ïê‚ïê‚ïê */
function setBilanFee(v){D.bilanFee=parseFloat(v)||0;sv();R();toast('Montant bilan enregistr√©')}
function money(v){return (Math.round((v+Number.EPSILON)*100)/100).toFixed(2).replace('.',',')+'‚Ç¨'}
function todayKey(){return dk(new Date())}
function dKeyToFr(k){
  if(!k||typeof k!=='string')return '';
  // k: YYYY-MM-DD
  const p=k.split('-'); if(p.length!==3)return k;
  return (p[2]+'/'+p[1]+'/'+p[0]);
}
function apHasBilan(ap){
  if(!ap||!ap.id||!ap.patientId)return false;
  return D.appointments.some(a=>a.type==='bilan' && (a.parentApId===ap.id) && !a.cancelled);
}
function isBillable(ap){
  if(!ap)return false;
  if(ap.cancelled)return false;
  if(ap.type==='absence')return false;
  // only past and today
  return ap.date<=todayKey();
}
function apAmount(ap,pat){
  if(ap.isBilan||ap.type==='bilan')return Number(D.bilanFee||0);
  return Number((pat&&pat.sessionFee!==undefined)?pat.sessionFee:18.20);
}
function unbilledApps(pid){
  const t=todayKey();
  return D.appointments.filter(a=>a.patientId===pid && !a.billed && !a.cancelled && a.type!=='absence' && a.date<=t);
}
function unbilledCount(pid){return unbilledApps(pid).length}
function unbilledAmount(pid){
  const p=gp(pid);if(!p)return 0;
  return unbilledApps(pid).reduce((s,a)=>s+apAmount(a,p),0);
}
function billDue(pid){
  const p=gp(pid);if(!p)return false;
  const n=unbilledCount(pid);
  if(n<=0)return false;
  if(p.billMode==='each')return true;
  const every=Math.max(1,parseInt(p.billEvery)||1);
  return n>=every;
}
function billEmoji(pid,force){
  if(!pid)return '';
  const p=gp(pid);if(!p)return '';
  const due=force? (unbilledCount(pid)>0) : billDue(pid);
  if(!due)return '';
  const txt=(p.billMode==='each')?'√† chaque s√©ance':('toutes les '+(parseInt(p.billEvery)||1)+' s√©ances');
  return '<span class="bill" title="Facturation : '+esc(txt)+'" onclick="event.stopPropagation();billPatient(\''+pid+'\',false)">üíµ</span>';
}
function triEmoji(pid){
  const n=unbilledCount(pid);
  return n>0?'<span class="tri" title="S√©ances non factur√©es" onclick="event.stopPropagation();openPC(\''+pid+'\')">üî∫</span>':'';
}
function billPatient(pid,force){
  const p=gp(pid);if(!p)return;
  const aps=unbilledApps(pid);
  if(!aps.length){toast('Aucune s√©ance √† facturer');return}
  if(!force && !billDue(pid)){toast('Pas encore d√ª (fr√©quence : '+(p.billMode==='each'?'√† chaque s√©ance':'toutes les '+(parseInt(p.billEvery)||1)+' s√©ances')+')');return}
  const sum=aps.reduce((s,a)=>s+apAmount(a,p),0);
  if(!confirm('Facturer '+aps.length+' s√©ance(s) pour '+esc(p.lastName)+' '+esc(p.firstName)+' : '+money(sum)+' ?'))return;
  const t=todayKey();
  aps.forEach(a=>{a.billed=true;a.billedAt=t;a.billedAmount=apAmount(a,p)});
  p.lastBillAt=t;
  sv();R();
  toast('Factur√© : '+money(sum));
}
function toggleBillOne(apId){
  const ap=D.appointments.find(a=>a.id===apId);if(!ap)return;
  const p=ap.patientId?gp(ap.patientId):null;
  if(!p){toast('Patient introuvable');return}
  if(!isBillable(ap)){toast('S√©ance non facturable');return}
  ap.billed=!ap.billed;
  ap.billedAt=ap.billed?todayKey():'';
  ap.billedAmount=ap.billed?apAmount(ap,p):0;
  sv();R();
}
function totalUnbilledAmount(){
  return D.patients.reduce((s,p)=>s+unbilledAmount(p.id),0);
}

function ini(p){return((p.lastName||'?')[0]+(p.firstName||'?')[0]).toUpperCase()}

/* ‚ïê‚ïê‚ïê RENDER ‚ïê‚ïê‚ïê */
function R(){rWB();
  document.getElementById('pw').classList.toggle('off',vM!=='grid');
  document.getElementById('lv').classList.toggle('on',vM==='list');
  document.getElementById('plw').classList.toggle('on',vM==='patients');
  document.getElementById('bL').classList.toggle('on',vM==='list');
  document.getElementById('bP').classList.toggle('on',vM==='patients');
  if(vM==='grid'){rGrid();rAps()}else if(vM==='list')rList();else if(vM==='patients')rPats();}

function rWB(){
  const mon=gMon(cD);const today=new Date();const L=['L','M','M','J','V','S','D'];
  let h='';for(let i=0;i<7;i++){const d=new Date(mon);d.setDate(d.getDate()+i);const w=d.getDay();const ok=D.days.includes(w);
    h+='<div class="wd'+(same(d,cD)?' act':'')+(ok?'':' dis')+(same(d,today)?' tod':'')+'" data-date="'+dk(d)+'" onclick="selD(\''+dk(d)+'\')"><div class="wl">'+L[i]+'</div><div class="wn">'+d.getDate()+'</div></div>'}
  document.getElementById('wb').innerHTML=h;
  document.getElementById('hd').textContent=fmt(cD);
}
function selD(k){const p=k.split('-').map(Number);const n=new Date(p[0],p[1]-1,p[2]);if(!D.days.includes(n.getDay()))return;cD=n;R();scrollNow()}
function navW(dir){
  const base=new Date(cD);base.setDate(base.getDate()+dir*7);
  const mon=gMon(base);
  const allowed=sortDows(D.days);
  const curDow=cD.getDay();
  const chosen=D.days.includes(curDow)?curDow:(allowed.length?allowed[0]:1);
  const target=new Date(mon);
  target.setDate(mon.getDate()+monIndex(chosen));
  cD=target;R();scrollNow();
}
function togV(v){vM=vM===v?'grid':v;R()}

/* ‚ïê‚ïê‚ïê SWIPE NAVIGATION ‚ïê‚ïê‚ïê */
(function(){
  var startX=0,startY=0,swiping=false;
  var pw=document.getElementById('pw');
  var wb=document.getElementById('wb');
  
  function handleTouchStart(e){
    startX=e.touches[0].clientX;
    startY=e.touches[0].clientY;
    swiping=true;
  }
  function handleTouchEnd(e){
    if(!swiping)return;
    swiping=false;
    var dx=e.changedTouches[0].clientX-startX;
    var dy=e.changedTouches[0].clientY-startY;
    if(Math.abs(dx)>60 && Math.abs(dx)>Math.abs(dy)*1.5){
      if(dx>0) navW(-1);
      else navW(1);
    }
  }
  wb.addEventListener('touchstart',handleTouchStart,{passive:true});
  wb.addEventListener('touchend',handleTouchEnd,{passive:true});
})();

/* ‚îÄ‚îÄ GRID ‚îÄ‚îÄ */
function rGrid(){
  const sh=D.startH,eh=D.endH,th=eh-sh,gh=th*80;
  document.getElementById('pg').style.minHeight=gh+'px';
  
  /* Time labels - LEFT COLUMN */
  let tH='';
  for(let h=sh;h<=eh;h++){
    const top=(h-sh)*80;
    tH+='<div class="tl" style="top:'+top+'px">'+String(h).padStart(2,'0')+':00</div>';
  }
  document.getElementById('tc').innerHTML=tH;
  
  /* Grid lines - STRONG CONTRAST */
  let lH='';
  for(let h=sh;h<=eh;h++){
    const top=(h-sh)*80;
    lH+='<div class="gl full" style="top:'+top+'px"></div>';
    if(h<eh){
      lH+='<div class="gl half" style="top:'+(top+40)+'px"></div>';
      lH+='<div class="gl quarter" style="top:'+(top+20)+'px"></div>';
      lH+='<div class="gl quarter" style="top:'+(top+60)+'px"></div>';
    }
  }
  document.getElementById('glw').innerHTML=lH;
  
  /* Openings + now line */
  const dow=cD.getDay(),ops=D.openings.filter(o=>o.day===dow);
  let oH='';for(const o of ops){const s=t2m(o.start),e=t2m(o.end),top=((s/60)-sh)*80,ht=((e-s)/60)*80;oH+='<div class="op" style="top:'+top+'px;height:'+ht+'px"></div>'}
  const now=new Date();
  if(same(now,cD)){
    const nm=now.getHours()*60+now.getMinutes(),top=((nm/60)-sh)*80;
    if(top>=0&&top<=gh){
      oH+='<div class="nl" style="top:'+top+'px"><span class="nl-time">'+m2t(nm)+'</span></div>';
    }
  }
  document.getElementById('sa').innerHTML=oH;
}

function rAps(){
  const area=document.getElementById('sa');
  const key=dk(cD),dayA=D.appointments.filter(a=>a.date===key).sort((a,b)=>t2m(a.time)-t2m(b.time));
  
  /* Remove any existing appointment elements */
  area.querySelectorAll('.ap').forEach(el=>el.remove());
  
  if(!dayA.length)return;
  
  /* overlap columns */
  const grps=[];
  for(const ap of dayA){const s=t2m(ap.time),e=s+ap.duration;let placed=false;
    for(const g of grps){if(s<g.end){g.items.push(ap);g.end=Math.max(g.end,e);placed=true;break}}
    if(!placed)grps.push({items:[ap],end:e})}
  for(const g of grps){const cols=[];for(const ap of g.items){const s=t2m(ap.time),e=s+ap.duration;let c=0;while(cols[c]&&cols[c]>s)c++;cols[c]=e;ap._c=c}const tc=cols.length;g.items.forEach(a=>a._tc=tc)}
  
  const sh=D.startH;
  for(const ap of dayA){
    const s=t2m(ap.time),top=((s/60)-sh)*80,ht=Math.max((ap.duration/60)*80,24);
    const cw=100/(ap._tc||1),left=(ap._c||0)*cw;
    const mot=gm(ap.motifId),pat=ap.patientId?gp(ap.patientId):null;
    const isAbs=ap.type==='absence';
    const cc=isAbs?'abs':(mot?CL[mot.ci%6].css:'mc0');
    let name=isAbs?(ap.label||'Absence'):(pat?(pat.lastName+' '+pat.firstName):(ap.label||'?'));if(ap.type==='bilan'||ap.isBilan)name+=' üÖ±Ô∏è'; else if(apHasBilan(ap))name+=' üÖ±Ô∏è';
    const al=pat?alrt(pat):'';const mL=mot?mot.label:'';
    const el=document.createElement('div');
    el.className='ap '+cc+(ap.cancelled?' cncl':'');
    el.style.cssText='top:'+top+'px;height:'+ht+'px;left:'+left+'%;width:'+(cw-.4)+'%';
    el.dataset.id=ap.id;
    el.innerHTML='<span class="an">'+(pat?triEmoji(pat.id):'')+esc(name)+al+(pat?billEmoji(pat.id,false):'')+'</span>'+(mL&&ht>22?'<span class="am">'+esc(mL)+'</span>':'')+(ht>=36?'<span class="at">'+ap.time+'‚Äì'+m2t(s+ap.duration)+'</span>':'');
    el.onclick=function(e){showCtx(e,ap.id)};
    area.appendChild(el);
  }
}

/* ‚îÄ‚îÄ LIST ‚îÄ‚îÄ */
function rList(){
  const el=document.getElementById('lv');const key=dk(cD);
  const dayA=D.appointments.filter(a=>a.date===key).sort((a,b)=>t2m(a.time)-t2m(b.time));
  if(!dayA.length){el.innerHTML='<div style="text-align:center;padding:40px;color:var(--text2)"><div style="font-size:32px;margin-bottom:8px">üìã</div>Aucun rendez-vous</div>';return}
  let h='';for(const ap of dayA){
    const mot=gm(ap.motifId),pat=ap.patientId?gp(ap.patientId):null;
    const isAbs=ap.type==='absence';const ci2=mot?mot.ci:0;
    const cv=isAbs?'var(--absence)':CL[ci2%6].bd;
    let name=isAbs?(ap.label||'Absence'):(pat?(pat.lastName+' '+pat.firstName):(ap.label||'?'));if(ap.type==='bilan'||ap.isBilan)name+=' üÖ±Ô∏è'; else if(apHasBilan(ap))name+=' üÖ±Ô∏è';
    const al=pat?alrt(pat):'';const mL=mot?mot.label:'';
    h+='<div class="li'+(ap.cancelled?' cncl':'')+(isAbs?' abs':'')+'" style="border-left-color:'+cv+'" onclick="showCtx(event,\''+ap.id+'\')">';
    h+='<div class="lt">'+ap.time+'</div><div class="lb"><div class="ln">'+(pat?triEmoji(pat.id):'')+esc(name)+al+(pat?billEmoji(pat.id,false):'')+'</div><div class="lm">'+esc(mL)+' ¬∑ '+ap.duration+'min</div></div></div>'}
  el.innerHTML=h;
}

/* ‚îÄ‚îÄ PATIENTS ‚îÄ‚îÄ */
function rPats(){
  const w=document.getElementById('plw');
  const mode=(document.getElementById('psort')&&document.getElementById('psort').value)||'az';
  let arr=D.patients.slice();
  function key(p){return (p.lastName+' '+p.firstName).toLowerCase()}
  if(mode==='az')arr.sort((a,b)=>key(a).localeCompare(key(b)));
  if(mode==='za')arr.sort((a,b)=>key(b).localeCompare(key(a)));
  if(mode==='new')arr.sort((a,b)=>(b.id||'').localeCompare(a.id||'')); // uid is time-ish
  if(mode==='unb')arr.sort((a,b)=>unbilledCount(b.id)-unbilledCount(a.id));

  let h='<div class="pls" style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">'+
        '<input type="text" id="psrch" placeholder="Rechercher un patient." oninput="fPats()" style="flex:1;min-width:180px">'+
        '<select id="psort" onchange="rPats()" style="height:40px;border-radius:12px;border:1px solid var(--border);background:var(--card);color:var(--text);padding:0 10px">'+
          '<option value="az" '+(mode==='az'?'selected':'')+'>A ‚Üí Z</option>'+
          '<option value="za" '+(mode==='za'?'selected':'')+'>Z ‚Üí A</option>'+
          '<option value="new" '+(mode==='new'?'selected':'')+'>Ajout r√©cent</option>'+
          '<option value="unb" '+(mode==='unb'?'selected':'')+'>Non factur√©es (‚Üì)</option>'+
        '</select>'+
        '<button class="btn bp bw" onclick="openOCR()">Importer OCR</button>'+
        '</div>'+
        '<div class="ub" style="padding:6px 2px">Total non factur√© (tous patients) : <b>'+money(totalUnbilledAmount())+'</b></div>'+
        '<div id="pres">';
  for(const p of arr){
    const ag=p.dob?calcAge(p.dob)+'ans':'';
    const al=alrt(p);
    const ub=unbilledCount(p.id);
    const ua=unbilledAmount(p.id);
    h+='<div class="pi" onclick="openPC(\''+p.id+'\')">'+
        '<div class="pa">'+ini(p)+'</div>'+
        '<div class="pif">'+
          '<div class="pn">'+triEmoji(p.id)+esc(p.lastName)+' '+esc(p.firstName)+' '+al+billEmoji(p.id,false)+'</div>'+
          '<div class="pd">'+ag+(p.phone?' ¬∑ '+esc(p.phone):'')+'</div>'+
          '<div class="ub">Non factur√©es : <b>'+ub+'</b> ¬∑ <b>'+money(ua)+'</b></div>'+
        '</div>'+
      '</div>';
  }
  h+='</div>';
  w.innerHTML=h;
  fPats();
}

/* ‚ïê‚ïê‚ïê OCR IMPORT PATIENTS ‚ïê‚ïê‚ïê */
let OCR_FILES=[], OCR_CAND=[];

function openOCR(){
  const b=document.getElementById('mOCRB');
  OCR_FILES=[];OCR_CAND=[];
  b.innerHTML=
    '<p style="font-size:13px;color:var(--text2);margin:0 0 10px 0">Ajoutez une ou plusieurs captures Doctolib (liste patients). L\'OCR va d√©tecter Nom, Pr√©nom et T√©l√©phone, puis vous pourrez corriger/d√©cocher avant d\'enregistrer.</p>'+
    '<div class="fg"><label>Captures d\'√©cran</label><input type="file" id="ocrIn" accept="image/*" multiple></div>'+
    '<div id="ocrPrev" style="display:flex;gap:10px;flex-wrap:wrap;margin:8px 0"></div>'+
    '<div class="br" style="display:flex;gap:10px;flex-wrap:wrap">'+
      '<button class="btn bp bw" onclick="runOCR()">Lancer OCR</button>'+
      '<button class="btn bd" onclick="saveOCR()" disabled id="ocrSave">Valider & enregistrer</button>'+
      '<button class="btn" onclick="clM(\'mOCR\')">Fermer</button>'+
    '</div>'+
    '<div id="ocrProg" style="font-size:12px;color:var(--text2);margin-top:10px"></div>'+
    '<div id="ocrRes" style="margin-top:10px"></div>';
  opM('mOCR');
  setTimeout(function(){
    const inp=document.getElementById('ocrIn');
    inp.addEventListener('change', function(){
      OCR_FILES=[...inp.files];
      renderOCRPreviews();
    });
  },0);
}

function renderOCRPreviews(){
  const p=document.getElementById('ocrPrev'); if(!p) return;
  p.innerHTML='';
  OCR_FILES.slice(0,12).forEach(function(f){
    const r=new FileReader();
    r.onload=function(){
      const img=document.createElement('img');
      img.src=r.result;
      img.style.width='64px';img.style.height='64px';img.style.objectFit='cover';
      img.style.borderRadius='12px';img.style.border='1px solid var(--border2)';
      p.appendChild(img);
    };
    r.readAsDataURL(f);
  });
  if(OCR_FILES.length>12){
    const s=document.createElement('div');
    s.textContent='+'+(OCR_FILES.length-12);
    s.style.fontSize='13px';s.style.color='var(--text2)';
    p.appendChild(s);
  }
}

function normPhoneDigits(s){
  const d=(s||'').replace(/\D+/g,'');
  if(d.length===10 && d.startsWith('0')) return d;
  if(d.length===11 && d.startsWith('33')) return '0'+d.slice(2);
  return d.length>=9?d.slice(-10):d;
}
function fmtPhone(d){
  const x=normPhoneDigits(d);
  if(x.length!==10) return d||'';
  return x.replace(/(\d\d)(?=\d)/g,'$1 ').trim();
}
function splitLines(t){
  return (t||'').split(/\r?\n/).map(function(l){return l.replace(/\s+/g,' ').trim()}).filter(Boolean);
}
function parseNameLine(line){
  // last name = consecutive ALLCAPS tokens at start
  const toks=line.split(' ').filter(Boolean);
  if(toks.length<2) return null;
  let i=0;
  while(i<toks.length && /^[A-Z√Ä-√ñ√ò-√ù'\-]+$/.test(toks[i])) i++;
  if(i===0) return null;
  const last=toks.slice(0,i).join(' ');
  const first=toks.slice(i).join(' ');
  if(!first) return null;
  return {last:last, first:first};
}
function mergeCand(arr){
  const map={};
  arr.forEach(function(c){
    const k=(c.last+'|'+c.first+'|'+normPhoneDigits(c.phone)).toLowerCase();
    if(!map[k]) map[k]=c;
  });
  return Object.values(map);
}

async function runOCR(){
  if(!OCR_FILES.length){toast('Ajoutez au moins une image');return;}
  const prog=document.getElementById('ocrProg'); const res=document.getElementById('ocrRes');
  const saveBtn=document.getElementById('ocrSave'); if(saveBtn) saveBtn.disabled=true;
  OCR_CAND=[];
  if(typeof Tesseract==='undefined'){toast('OCR indisponible (Tesseract.js non charg√©)');return;}
  prog.textContent='OCR en cours...';
  for(let i=0;i<OCR_FILES.length;i++){
    const f=OCR_FILES[i];
    prog.textContent='OCR '+(i+1)+'/'+OCR_FILES.length+' : '+f.name;
    try{
      const out=await Tesseract.recognize(f,'fra',{
        logger:m=>{
          if(m && m.status && (m.status==='recognizing text' || m.status==='loading tesseract core')){
            prog.textContent='OCR '+(i+1)+'/'+OCR_FILES.length+' : '+Math.round((m.progress||0)*100)+'%';
          }
        }
      });
      const text=(out && out.data && out.data.text)||'';
      OCR_CAND=OCR_CAND.concat(extractPatients(text));
    }catch(e){
      console.error(e);
      toast('Erreur OCR sur une image');
    }
  }
  OCR_CAND=mergeCand(OCR_CAND);
  renderOCRResults();
  prog.textContent='OCR termin√© : '+OCR_CAND.length+' patient(s) d√©tect√©(s).';
  if(saveBtn) saveBtn.disabled = OCR_CAND.length===0;
}

function extractPatients(text){
  const lines=splitLines(text);
  const out=[];
  for(let i=0;i<lines.length;i++){
    const l=lines[i];
    // phone line
    if(/0\d(?:[ .-]?\d\d){4}/.test(l) || /\b33\s?\d/.test(l)){
      const m=l.match(/(\+?33\s?\d(?:[ .-]?\d\d){4}|0\d(?:[ .-]?\d\d){4})/);
      if(!m) continue;
      const phone=fmtPhone(m[1]);
      // name likely previous line
      const prev=lines[i-1]||'';
      const nm=parseNameLine(prev);
      if(nm){
        out.push({last:nm.last, first:nm.first, phone:phone});
      }
    }
  }
  return out;
}

function renderOCRResults(){
  const res=document.getElementById('ocrRes'); if(!res) return;
  if(!OCR_CAND.length){res.innerHTML='<div style="font-size:13px;color:var(--text2)">Aucun patient d√©tect√©.</div>';return;}
  let h='<div style="font-weight:800;margin:6px 0">V√©rifier avant enregistrement</div>';
  h+='<div style="display:flex;flex-direction:column;gap:10px">';
  OCR_CAND.forEach(function(c,idx){
    h+='<div class="card" style="padding:10px;border:1px solid var(--border2);border-radius:14px">'+
        '<div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">'+
          '<label style="display:flex;align-items:center;gap:8px"><input type="checkbox" class="ocrOk" data-i="'+idx+'" checked> Importer</label>'+
          '<input class="inp ocrLast" data-i="'+idx+'" placeholder="Nom" value="'+esc(c.last)+'" style="flex:1;min-width:140px">'+
          '<input class="inp ocrFirst" data-i="'+idx+'" placeholder="Pr√©nom" value="'+esc(c.first)+'" style="flex:1;min-width:140px">'+
          '<input class="inp ocrPhone" data-i="'+idx+'" placeholder="T√©l√©phone" value="'+esc(c.phone)+'" style="min-width:150px">'+
        '</div>'+
      '</div>';
  });
  h+='</div>';
  res.innerHTML=h;
}

function saveOCR(){
  const okEls=[...document.querySelectorAll('.ocrOk')];
  if(!okEls.length){toast('Rien √† importer');return;}
  let added=0, skipped=0;
  okEls.forEach(function(cb){
    if(!cb.checked) return;
    const i=parseInt(cb.dataset.i);
    const last=(document.querySelector('.ocrLast[data-i="'+i+'"]')||{}).value||'';
    const first=(document.querySelector('.ocrFirst[data-i="'+i+'"]')||{}).value||'';
    const phone=fmtPhone((document.querySelector('.ocrPhone[data-i="'+i+'"]')||{}).value||'');
    const ln=last.trim(), fn=first.trim();
    if(!ln || !fn){skipped++;return;}
    const ph=normPhoneDigits(phone);
    const exists=D.patients.some(function(p){
      if(ph && normPhoneDigits(p.phone)===ph) return true;
      return (p.lastName||'').toLowerCase()===ln.toLowerCase() && (p.firstName||'').toLowerCase()===fn.toLowerCase();
    });
    if(exists){skipped++;return;}
    D.patients.push({id:uid(),lastName:ln,firstName:fn,phone:phone,dob:'',notes:''});
    added++;
  });
  sv();R();toast(added+' ajout√©(s)'+(skipped?(' ¬∑ '+skipped+' ignor√©(s)'):''));
  clM('mOCR');
}

function fPats(){const q=document.getElementById('psrch').value.toLowerCase();document.querySelectorAll('#pres .pi').forEach(el=>{el.style.display=el.textContent.toLowerCase().includes(q)?'':'none'})}

/* ‚ïê‚ïê‚ïê CTX MENU ‚ïê‚ïê‚ïê */
function showCtx(e,id){
  e.stopPropagation();selId=id;const ap=D.appointments.find(a=>a.id===id);if(!ap)return;
  const pat=ap.patientId?gp(ap.patientId):null;
  const isAbs=(ap.type==='absence');
  const m=document.getElementById('ctx');
  let it='<div class="ci" onclick="editAp()">‚úèÔ∏è Modifier</div>';
  if(pat)it+='<div class="ci" onclick="openPC(\''+pat.id+'\');clCtx()">üë§ Fiche patient</div>';
  if(pat)it+='<div class="ci" onclick="openHist(\''+pat.id+'\');clCtx()">üìã Historique</div>';
  if(pat && !isAbs)it+='<div class="ci" onclick="addBilanFromAp(\''+ap.id+'\')">üÖ±Ô∏è Ajouter Bilan</div>';
  if(pat && !isAbs)it+='<div class="ci" onclick="lateSMS(\''+ap.id+'\')">‚è±Ô∏è Signaler un retard</div>';
  if(pat && !isAbs)it+='<div class="ci" onclick="absenceSMS(\''+ap.id+'\')">üö´üì© Signaler une absence</div>';
  if(pat)it+='<div class="ci" onclick="billPatient(\''+pat.id+'\',true);clCtx()">üíµ Forcer facturation</div>';
  if(!isAbs && isBillable(ap))it+='<div class="ci" onclick="toggleBillOne(\''+ap.id+'\');clCtx()">'+(ap.billed?'‚Ü©Ô∏è Annuler facturation':'üíµ Marquer factur√©e')+'</div>';
  if(!ap.cancelled)it+='<div class="ci dng" onclick="cancelAp()">üö´ Annuler s√©ance</div>';
  else it+='<div class="ci" onclick="uncancelAp()">‚Ü©Ô∏è R√©tablir</div>';
  if(ap.type!=='absence')it+='<div class="ci" onclick="recurAp()">üîÅ R√©currence</div>';
  it+='<div class="ci dng" onclick="delAp()">üóë Supprimer</div>';
  m.innerHTML=it;
  let left=e.clientX||100,top=e.clientY||100;
  if(left+200>window.innerWidth)left=window.innerWidth-205;
  if(top+260>window.innerHeight)top=Math.max(4,top-260);
  m.style.left=Math.max(4,left)+'px';m.style.top=Math.max(4,top)+'px';m.classList.add('open');
  setTimeout(()=>document.addEventListener('click',clCtx,{once:true}),10);
}

function clCtx(){document.getElementById('ctx').classList.remove('open')}
function lateSMS(apId){
  clCtx();
  const ap=D.appointments.find(a=>a.id===apId);if(!ap)return;
  const p=ap.patientId?gp(ap.patientId):null;
  if(!p||!p.phone){toast('T√©l√©phone patient manquant');return}
  // modal simple
  const b=document.getElementById('mMB');
  document.getElementById('mMT').textContent='Signaler un retard';
  const opts=[5,10,15,20,30,60];
  b.innerHTML='<p style="font-size:13px;color:var(--text2);margin:0 0 10px 0">Choisissez la dur√©e du retard.</p>'+
    '<div style="display:flex;gap:8px;flex-wrap:wrap">'+opts.map(x=>'<button class="btn bs" style="min-width:70px" onclick="sendLateSMS(\''+esc(p.phone)+'\','+x+');clM(\'mM\')">'+x+' min</button>').join('')+'</div>'+
    '<div class="br"><button class="btn" onclick="clM(\'mM\')">Fermer</button></div>';
  opM('mM');
}
function sendLateSMS(phone,min){
  const msg='Info RDV Kin√© : Mr J√©r√¥me Malbranque vous accueillera avec un retard de '+min+' minutes. Veuillez l\'excuser pour la g√™ne occasionn√©e.';
  const uri='sms:'+encodeURIComponent(phone)+'?&body='+encodeURIComponent(msg);
  window.location.href=uri;
}

// Absence SMS
let AbsSMS=null;
function absenceSMS(apId){
  clCtx();
  const ap=D.appointments.find(a=>a.id===apId); if(!ap) return;
  const p=ap.patientId?gp(ap.patientId):null;
  if(!p||!p.phone){toast('T√©l√©phone patient manquant');return}
  AbsSMS={apId:apId, phone:p.phone, motif:'', other:'', dates:{}};
  AbsSMS.dates={}; // map dateKey->true
  renderAbsSMSMotif();
}
function renderAbsSMSMotif(){
  const b=document.getElementById('mMB');
  document.getElementById('mMT').textContent='Signaler une absence';
  const motifs=[
    'Maladie/Probl√®me de sant√©',
    'Panne de V√©hicule',
    'Impossibilit√© Mat√©rielle de se d√©placer',
    'Urgence Professionnelle',
    'Urgence Personnelle',
    'Autre Motif'
  ];
  b.innerHTML =
    '<p style="font-size:13px;color:var(--text2);margin:0 0 10px 0">Choisissez le motif.</p>'+
    '<div style="display:flex;gap:8px;flex-wrap:wrap">'+
      motifs.map(function(x){
        return '<button class="btn bs" onclick="pickAbsMotif(\''+escA(x)+'\')">'+esc(x)+'</button>';
      }).join('')+
    '</div>'+
    '<div id="absOtherWrap" style="display:none;margin-top:10px"><div class="fg"><label>Pr√©cisez</label><input id="absOther" type="text" placeholder="Votre motif..."></div></div>'+
    '<div class="br"><button class="btn" onclick="clM(\'mM\')">Fermer</button></div>';
  opM('mM');
}
function escA(s){return String(s).replace(/\\/g,'\\\\').replace(/\'/g,"\\'");}
function pickAbsMotif(m){
  if(!AbsSMS)return;
  AbsSMS.motif=m;
  const ow=document.getElementById('absOtherWrap');
  if(ow){
    ow.style.display=(m==='Autre Motif')?'block':'none';
  }
  // Bouton continuer
  const b=document.getElementById('mMB');
  if(!document.getElementById('absNext')){
    b.innerHTML += '<div class="br"><button id="absNext" class="btn bs" onclick="renderAbsSMSDates()">Continuer</button></div>';
  }
}
function renderAbsSMSDates(){
  if(!AbsSMS)return;
  // r√©cup√©rer dates futures pr√©vues pour ce patient (hors bilans/absences/cancellations)
  const ap=D.appointments.find(a=>a.id===AbsSMS.apId);
  const pid=ap&&ap.patientId?ap.patientId:'';
  const t=todayKey();
  const futDates=[...new Set(D.appointments
    .filter(a=>a.patientId===pid && !a.cancelled && a.type!=='absence' && a.type!=='bilan' && a.date>t)
    .map(a=>a.date))].sort();
  // UI
  const b=document.getElementById('mMB');
  const isTodaySel=AbsSMS.dates[t]===true;
  b.innerHTML =
    '<p style="font-size:13px;color:var(--text2);margin:0 0 10px 0">S√©lectionnez la/les date(s) concern√©e(s).</p>'+
    '<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">'+
      '<button class="btn '+(isTodaySel?'bs':'')+'" onclick="togAbsDate(\''+t+'\')">Aujourd\'hui</button>'+
      (futDates.length?futDates.map(function(d){
        const on=AbsSMS.dates[d]===true;
        return '<button class="btn '+(on?'bs':'')+'" onclick="togAbsDate(\''+d+'\')">'+dKeyToFr(d)+'</button>';
      }).join(''):'<span style="font-size:12px;color:var(--text2)">Aucune autre s√©ance future pr√©vue.</span>')+
    '</div>'+
    '<div class="br">'+
      '<button class="btn" onclick="renderAbsSMSMotif()">Retour</button>'+
      '<button class="btn bs" onclick="sendAbsSMS()">Envoyer SMS</button>'+
      '<button class="btn" onclick="clM(\'mM\')">Fermer</button>'+
    '</div>';
}
function togAbsDate(d){
  if(!AbsSMS)return;
  AbsSMS.dates[d]=!AbsSMS.dates[d];
  renderAbsSMSDates();
}
function sendAbsSMS(){
  if(!AbsSMS)return;
  const t=todayKey();
  const sel=Object.keys(AbsSMS.dates).filter(k=>AbsSMS.dates[k]).sort();
  if(!sel.length){toast('S√©lectionne au moins une date');return}
  let motif=AbsSMS.motif||'';
  if(motif==='Autre Motif'){
    const v=(document.getElementById('absOther')?document.getElementById('absOther').value:'')||'';
    motif=v.trim()?v.trim():'Autre motif';
  }
  const hasToday=sel.includes(t);
  const others=sel.filter(d=>d!==t).map(dKeyToFr);
  let datePart='';
  if(hasToday && others.length){
    datePart="d'aujourd'hui ou du "+others.join(', ');
  }else if(hasToday){
    datePart="d'aujourd'hui";
  }else{
    datePart="du "+others.join(', ');
  }
  const msg =
    "Info RDV Kin√© : Mr J√©r√¥me Malbranque a le regret de vous informer que votre(ou vos) s√©ance(s) de kin√© "+datePart+
    " est(ou sont) malheureusement annul√©e(s) pour le motif suivant : "+motif+".\n\n"+
    "Il vous pr√©sente ses plus sinc√®res excuses pour la g√™ne occasionn√©e.\n\n"+
    "Pourriez-vous confirmer √† Mr J√©r√¥me Malbranque la bonne r√©ception de ce message (0623475196) ? Et pr√©voir les s√©ances futures si ce n'est pas d√©j√† fait. Merci d'avance.";
  const uri='sms:'+encodeURIComponent(AbsSMS.phone)+'?&body='+encodeURIComponent(msg);
  window.location.href=uri;
  clM('mM');
}

function addBilanFromAp(apId){
  clCtx();
  const ap=D.appointments.find(a=>a.id===apId);
  if(!ap||!ap.patientId){toast('Patient introuvable');return}
  const d=ap.date||todayKey();
  if(!confirm('Ajouter un Bilan (üÖ±Ô∏è) sur la s√©ance du '+dKeyToFr(d)+' ?'))return;
  // On cr√©e un √©v√©nement "bilan" distinct, li√© √† la s√©ance (pour pouvoir compter + supprimer s√©par√©ment)
  D.appointments.push({
    id:uid(),
    type:'bilan',
    isBilan:true,
    parentApId: ap.id,
    motifId:ap.motifId||'',
    patientId:ap.patientId,
    date:d,
    time:ap.time||'12:00',
    duration:ap.duration||30,
    notes:'Bilan',
    cancelled:false,
    billed:false,
    billedAt:'',
    billedAmount:0
  });
  sv();R();toast('Bilan ajout√©');
}

function editAp(){clCtx();if(!selId)return;const ap=D.appointments.find(a=>a.id===selId);if(ap)openAF(ap)}
function delAp(){
  clCtx();if(!selId)return;
  var ap=D.appointments.find(function(a){return a.id===selId});if(!ap)return;
  var sid=ap.seriesId;
  if(!sid){
    if(!confirm('Supprimer ce rendez-vous ?'))return;
    D.appointments=D.appointments.filter(function(a){return a.id!==selId});
    sv();R();toast('Supprim√©');return;
  }
  // has series -> offer to delete future occurrences by weekday
  var base=ap.date;
  var fut=D.appointments.filter(function(a){return a.seriesId===sid && a.date>=base && a.id!==ap.id});
  if(!fut.length){
    if(!confirm('Supprimer ce rendez-vous ?'))return;
    D.appointments=D.appointments.filter(function(a){return a.id!==selId});
    sv();R();toast('Supprim√©');return;
  }
  openDelSeries(ap);
}
function cancelAp(){clCtx();if(!selId)return;const ap=D.appointments.find(a=>a.id===selId);if(ap){ap.cancelled=true;sv();R();toast('S√©ance annul√©e')}}
function uncancelAp(){clCtx();if(!selId)return;const ap=D.appointments.find(a=>a.id===selId);if(ap){ap.cancelled=false;sv();R();toast('S√©ance r√©tablie')}}

function openDelSeries(ap){
  var b=document.getElementById('mDelRB');
  var dayN={0:'Dimanche',1:'Lundi',2:'Mardi',3:'Mercredi',4:'Jeudi',5:'Vendredi',6:'Samedi'};
  var sid=ap.seriesId;
  var base=ap.date;
  var days=(ap.seriesDays&&ap.seriesDays.length)?ap.seriesDays.slice():Array.from(new Set(D.appointments.filter(function(a){return a.seriesId===sid}).map(function(a){return new Date(a.date+'T00:00:00').getDay()})));
  days=sortDows(days);
  var apDow=new Date(ap.date+'T00:00:00').getDay();
  var cb=days.map(function(d){
    return '<label style="font-size:13px;display:flex;align-items:center;gap:8px"><input class="dsD" type="checkbox" data-dow="'+d+'"'+(d===apDow?' checked':'')+'> '+dayN[d]+'</label>';
  }).join('');
  b.innerHTML=
    '<p style="font-size:13px;color:var(--text2);margin:0 0 10px 0">Cette s√©ance fait partie d\'une planification. Voulez-vous supprimer seulement celle-ci, ou aussi les occurrences futures ?</p>'+
    '<div class="fg"><label>Jours √† supprimer (occurrences futures)</label><div style="display:flex;flex-wrap:wrap;gap:12px">'+cb+'</div></div>'+
    '<div class="br" style="display:flex;gap:10px;flex-wrap:wrap">'+
      '<button class="btn bp bw" onclick="delSeries(\''+ap.id+'\',0)">Supprimer seulement cette s√©ance</button>'+
      '<button class="btn bd" onclick="delSeries(\''+ap.id+'\',1)">Supprimer occurrences futures</button>'+
    '</div>'+
    '<div class="br"><button class="btn" onclick="clM(\'mDelR\')">Annuler</button></div>';
  opM('mDelR');
}

function delSeries(apId,mode){
  var ap=D.appointments.find(function(a){return a.id===apId});if(!ap){clM('mDelR');return;}
  var sid=ap.seriesId, base=ap.date;
  if(mode===0){
    D.appointments=D.appointments.filter(function(a){return a.id!==apId});
    sv();clM('mDelR');R();toast('Supprim√©');
    return;
  }
  var sel=Array.from(document.querySelectorAll('.dsD:checked')).map(function(x){return parseInt(x.dataset.dow)});
  if(!sel.length){toast('Choisissez au moins un jour');return;}
  D.appointments=D.appointments.filter(function(a){
    if(a.id===apId) return false; // always delete the selected session
    if(a.seriesId!==sid) return true;
    if(a.date<base) return true;
    var dow=new Date(a.date+'T00:00:00').getDay();
    return sel.indexOf(dow)===-1;
  });
  sv();clM('mDelR');R();toast('Occurrences supprim√©es');
}

/* ‚ïê‚ïê‚ïê APPT FORM ‚ïê‚ïê‚ïê */
function fabClick(){
  if(vM==='patients'){newPat();return;}
  newAp();
}
function newAp(){openAF(null)}
function openAF(ex){
  const b=document.getElementById('mAB');
  document.getElementById('mAT').textContent=ex?'Modifier le rendez-vous':'Nouveau rendez-vous';
  const isAbs=ex&&ex.type==='absence';
  const selMot=ex?ex.motifId:(D.motifs[0]?D.motifs[0].id:null);
  let ch=D.motifs.map(function(m){
    const c=CL[m.ci%6];
    return'<div class="chip'+(m.id===selMot&&!isAbs?' sel':'')+'" data-m="'+m.id+'" style="background:'+c.bg+';color:'+c.bd+'">'+esc(m.label)+'</div>'
  }).join('');
  ch+='<div class="chip'+(isAbs?' sel':'')+'" data-m="__abs" style="background:var(--absence);color:#fff">Absence</div>';
  const pat=ex&&ex.patientId?gp(ex.patientId):null;
  const dur=ex?ex.duration:(D.motifs.find(function(m){return m.id===selMot})||{duration:30}).duration;

  b.innerHTML='<div class="chips" id="mCh">'+ch+'</div>'+
    '<div id="typWrap" style="display:none;margin:-4px 0 10px"></div>'+

    '<div id="patB"'+(isAbs?' style="display:none"':'')+'>' +
    '<div class="fr">' +
    '<div class="fg acw"><label>Nom</label>'+
    '<input type="text" id="fPL" value="'+esc(pat?pat.lastName:'')+'" placeholder="Nom de famille" autocomplete="off">'+
    '</div>'+
    '<div class="fg"><label>Pr√©nom</label>'+
    '<input type="text" id="fPF" value="'+esc(pat?pat.firstName:'')+'" placeholder="Pr√©nom" autocomplete="off">'+
    '</div></div>'+
    '<input type="hidden" id="fPi" value="'+(ex&&ex.patientId?ex.patientId:'')+'">'+
    '<div class="acl" id="acl"></div>'+
    '</div>'+
    '<div id="absB"'+(isAbs?'':' style="display:none"')+'><div class="fg"><label>Libell√©</label><input type="text" id="fAL" value="'+esc(ex&&ex.label?ex.label:'Absence')+'"></div></div>'+
    '<div class="fr"><div class="fg"><label>Date</label><input type="date" id="fDt" value="'+(ex?ex.date:dk(cD))+'"></div>'+
    '<div class="fg"><label>Heure</label><input type="time" id="fTm" value="'+(ex?ex.time:'09:00')+'" step="300"></div></div>'+
    '<div class="fg"><label>Dur√©e (min)</label><input type="number" id="fDu" value="'+dur+'" min="5" max="240" step="5"></div>'+
    '<div class="fg"><label>Notes</label><textarea id="fNo" rows="2" placeholder="Notes...">'+(ex?esc(ex.notes||''):'')+'</textarea></div>'+
    '<div class="br">'+(ex?'<button class="btn bd" onclick="delAF(\''+ex.id+'\')">Supprimer</button>':'')+
    '<button class="btn bp bw" onclick="svAF(\''+(ex?ex.id:'')+'\')">'+(ex?'Enregistrer':'Ajouter')+'</button></div>';

  // chip logic
  document.querySelectorAll('#mCh .chip').forEach(function(c){c.onclick=function(){
    document.querySelectorAll('#mCh .chip').forEach(function(x){x.classList.remove('sel')});c.classList.add('sel');
    var mid=c.dataset.m;var isA=mid==='__abs';
    document.getElementById('patB').style.display=isA?'none':'block';
    document.getElementById('absB').style.display=isA?'block':'none';
    if(!isA){var m=D.motifs.find(function(x){return x.id===mid});if(m)document.getElementById('fDu').value=m.duration}
    updTyp(mid,isA)
  }});
  updTyp(selMot,isAbs);
  setupAC();opM('mA');
}

function setApTime(t){var tm=document.getElementById('fTm');if(tm)tm.value=t}
function updTyp(mid,isAbs){
  var w=document.getElementById('typWrap');if(!w)return;
  if(isAbs){w.style.display='none';w.innerHTML='';return}
  var m=gm(mid);var arr=(m&&Array.isArray(m.times))?m.times.filter(Boolean):[];
  if(!arr.length){w.style.display='none';w.innerHTML='';return}
  var times=arr.slice().sort(function(a,b){return t2m(a)-t2m(b)});
  var h='<div style="font-size:11px;font-weight:600;color:var(--text2);margin:4px 0 6px">Heures typiques (optionnel)</div><div class="chips">';
  for(var i=0;i<times.length;i++){var t=times[i];h+='<div class="chip" style="background:var(--bg);border:1.5px solid var(--border);color:var(--text)" onclick="setApTime(\''+t+'\')">'+t+'</div>'}
  h+='</div>';w.innerHTML=h;w.style.display='block';
}

function setupAC(){
  var inpL=document.getElementById('fPL'),inpF=document.getElementById('fPF'),list=document.getElementById('acl'),hid=document.getElementById('fPi');
  if(!inpL)return;var hl=-1;
  
  function doSearch(){
    var qL=(inpL.value||'').toLowerCase().trim();
    var qF=(inpF.value||'').toLowerCase().trim();
    var q=(qL+' '+qF).trim();
    hl=-1;
    if(q.length<1){list.classList.remove('open');return}
    /* Clear hidden patient id when user types */
    hid.value='';
    var matches=D.patients.filter(function(p){
      var full=(p.lastName+' '+p.firstName).toLowerCase();
      var rev=(p.firstName+' '+p.lastName).toLowerCase();
      return full.indexOf(q)>=0||rev.indexOf(q)>=0||
             (qL && p.lastName.toLowerCase().indexOf(qL)>=0) ||
             (qF && p.firstName.toLowerCase().indexOf(qF)>=0);
    }).slice(0,8);
    var h=matches.map(function(p){
      return'<div class="aci" data-pid="'+p.id+'"><span>'+esc(p.lastName)+' '+esc(p.firstName)+' '+alrt(p)+'</span><span class="acs">'+(p.dob?calcAge(p.dob)+'ans':'')+'</span></div>'
    }).join('');
    h+='<div class="aci acn" data-pid="__new">+ Cr√©er "'+esc(inpL.value+(inpF.value?' '+inpF.value:''))+'"</div>';
    list.innerHTML=h;list.classList.add('open');
    /* Position list under the name fields */
    list.style.position='fixed';
    var rect=inpL.parentElement.parentElement.getBoundingClientRect();
    list.style.left=rect.left+'px';
    list.style.right=(window.innerWidth-rect.right)+'px';
    list.style.top=rect.bottom+'px';
    list.style.width=rect.width+'px';
    
    list.querySelectorAll('.aci').forEach(function(it){it.onmousedown=function(e){
      e.preventDefault(); /* prevent blur */
      var pid=it.dataset.pid;
      if(pid==='__new'){quickPat(inpL.value,inpF.value);return}
      var p=gp(pid);if(p){inpL.value=p.lastName;inpF.value=p.firstName;hid.value=p.id}
      list.classList.remove('open');
    }});
  }
  
  inpL.addEventListener('input',doSearch);
  inpF.addEventListener('input',doSearch);
  
  function handleKeydown(e){
    var items=list.querySelectorAll('.aci');if(!items.length)return;
    if(e.key==='ArrowDown'){e.preventDefault();hl=Math.min(hl+1,items.length-1);items.forEach(function(x,i){x.classList.toggle('hl',i===hl)})}
    else if(e.key==='ArrowUp'){e.preventDefault();hl=Math.max(hl-1,0);items.forEach(function(x,i){x.classList.toggle('hl',i===hl)})}
    else if(e.key==='Enter'&&hl>=0){e.preventDefault();if(items[hl])items[hl].onmousedown({preventDefault:function(){}})}
  }
  inpL.addEventListener('keydown',handleKeydown);
  inpF.addEventListener('keydown',handleKeydown);
  
  function hideList(){setTimeout(function(){list.classList.remove('open')},200)}
  inpL.addEventListener('blur',hideList);
  inpF.addEventListener('blur',hideList);
}

function quickPat(lastName,firstName){
  var ln=(lastName||'').trim();
  var fn=(firstName||'').trim();
  if(!ln && !fn){toast('Entrez un nom');return}
  /* If only last name entered, try to split it */
  if(ln && !fn){
    var parts=ln.split(/\s+/);
    if(parts.length>1){ln=parts[0];fn=parts.slice(1).join(' ')}
  }
  var p={id:uid(),lastName:ln,firstName:fn,dob:'',phone:'',needOrdo:false,needMut:false,documents:[]};
  D.patients.push(p);sv();
  document.getElementById('fPL').value=ln;
  document.getElementById('fPF').value=fn;
  document.getElementById('fPi').value=p.id;
  document.getElementById('acl').classList.remove('open');
  toast('Patient cr√©√© ‚úì');
}

function svAF(exId){
  var chip=document.querySelector('#mCh .chip.sel');if(!chip){toast('S√©lectionnez un motif');return}
  var mid=chip.dataset.m;var isAbs=mid==='__abs';
  var date=document.getElementById('fDt').value,time=document.getElementById('fTm').value;
  var dur=parseInt(document.getElementById('fDu').value)||30;
  var notes=document.getElementById('fNo').value.trim();
  if(!date||!time){toast('Date et heure requises');return}
  var d=new Date(date+'T00:00:00');if(!D.days.includes(d.getDay())){toast('Jour non activ√© (jours : '+daysLabel(D.days)+')');return}
  var patientId='',label='';
  if(isAbs){label=document.getElementById('fAL').value.trim()||'Absence'}
  else{
    patientId=document.getElementById('fPi').value;
    /* If no patient selected but names entered, create patient on the fly */
    if(!patientId){
      var ln=(document.getElementById('fPL').value||'').trim();
      var fn=(document.getElementById('fPF').value||'').trim();
      if(ln||fn){
        var newP={id:uid(),lastName:ln,firstName:fn,dob:'',phone:'',needOrdo:false,needMut:false,documents:[]};
        D.patients.push(newP);
        patientId=newP.id;
      } else {
        toast('S√©lectionnez ou cr√©ez un patient');return;
      }
    }
  }
  var ap={id:exId||uid(),type:isAbs?'absence':'rdv',motifId:isAbs?null:mid,patientId:isAbs?'':patientId,label:label,date:date,time:time,duration:dur,notes:notes,cancelled:false};
  if(exId){var i=D.appointments.findIndex(function(a){return a.id===exId});if(i>=0){ap.cancelled=D.appointments[i].cancelled;D.appointments[i]=ap}}
  else D.appointments.push(ap);
  sv();clM('mA');cD=new Date(date+'T00:00:00');R();toast(exId?'Modifi√© ‚úì':'Ajout√© ‚úì');
}
function delAF(id){D.appointments=D.appointments.filter(function(a){return a.id!==id});sv();clM('mA');R();toast('Supprim√©')}

/* ‚ïê‚ïê‚ïê RECURRENCE ‚ïê‚ïê‚ïê */
function recurAp(){
  clCtx();if(!selId)return;var ap=D.appointments.find(function(a){return a.id===selId});if(!ap||ap.type==='absence')return;
  var b=document.getElementById('mRB');
  var dow=new Date(ap.date+'T00:00:00').getDay();
  var days=sortDows(D.days);
  var dayN={0:'Dimanche',1:'Lundi',2:'Mardi',3:'Mercredi',4:'Jeudi',5:'Vendredi',6:'Samedi'};
  var cb=days.map(function(d){
    return'<label style="font-size:13px;display:flex;align-items:center;gap:4px"><input type="checkbox" class="rcD" data-dow="'+d+'"'+(d===dow?' checked':'')+'> '+dayN[d]+'</label>';
  }).join('');
  b.innerHTML='<p style="font-size:13px;color:var(--text2);margin-bottom:12px">R√©p√©ter ce RDV ('+ap.time+', '+ap.duration+'min) pour le m√™me patient.</p>'+
    '<div class="fg"><label>Jours</label><div style="display:flex;flex-wrap:wrap;gap:12px">'+cb+'</div></div>'+
    '<div class="fr"><div class="fg"><label>√Ä partir du</label><input type="date" id="rcS" value="'+ap.date+'"></div>'+
    '<div class="fg"><label>Jusqu\'au (vide=ind√©fini)</label><input type="date" id="rcE" value=""></div></div>'+
    '<div class="fg"><label>Nombre de semaines max</label><input type="number" id="rcW" value="12" min="1" max="104"></div>'+
    '<div class="br"><button class="btn bp bw" onclick="doRecur(\''+ap.id+'\')">Cr√©er les s√©ances</button></div>';
  opM('mR');
}

function doRecur(apId){
  var ap=D.appointments.find(function(a){return a.id===apId});if(!ap)return;
  var sel=Array.from(document.querySelectorAll('.rcD:checked')).map(function(x){return parseInt(x.dataset.dow)});
  var start=document.getElementById('rcS').value,end=document.getElementById('rcE').value;
  var maxW=parseInt(document.getElementById('rcW').value)||12;
  if(!sel.length){toast('Choisissez au moins un jour');return}
  if(!start){toast('Date de d√©but requise');return}
  var endD=end?new Date(end+'T00:00:00'):null;
  var startD=new Date(start+'T00:00:00');

  // series meta
  var seriesId=ap.seriesId||('s'+uid());
  ap.seriesId=seriesId;
  ap.seriesDays=sel.slice();
  ap.seriesStart=start;
  ap.seriesEnd=end||'';

  var count=0;
  var existing={};D.appointments.forEach(function(a){existing[a.date+'|'+a.time+'|'+a.patientId]=true});
  for(var w=0;w<=maxW;w++){
    sel.forEach(function(dow2){
      if(!D.days.includes(dow2))return;
      var d=new Date(startD);
      var curDow=d.getDay();var diff=dow2-curDow;if(diff<0)diff+=7;
      d.setDate(startD.getDate()+diff+w*7);
      if(d<startD)return;
      if(endD&&d>endD)return;
      var key=dk(d)+'|'+ap.time+'|'+ap.patientId;
      if(existing[key])return;
      D.appointments.push({
        id:uid(),type:'rdv',motifId:ap.motifId,patientId:ap.patientId,
        date:dk(d),time:ap.time,duration:ap.duration,notes:'',cancelled:false,
        seriesId:seriesId,seriesDays:sel.slice(),seriesStart:start,seriesEnd:(end||'')
      });
      existing[key]=true;count++;
    });
  }
  sv();clM('mR');R();toast(count+' s√©ance(s) cr√©√©e(s)');
}

/* ‚ïê‚ïê‚ïê PATIENT CARD ‚ïê‚ïê‚ïê */
function openPC(pid){
  var p=gp(pid);if(!p)return;
  document.getElementById('mPT').innerHTML='üë§ '+esc(p.lastName)+' '+esc(p.firstName)+' '+alrt(p);
  var ag=p.dob?calcAge(p.dob):'';
  var dobD=p.dob?new Date(p.dob+'T00:00:00').toLocaleDateString('fr-FR'):'Non renseign√©e';
  var docsH='';if(p.documents&&p.documents.length){
    docsH=p.documents.map(function(d,i){return'<div class="pdi"><span>üìé</span><a href="'+d.data+'" download="'+esc(d.name)+'">'+esc(d.name)+'</a><button style="font-size:12px;color:#e74c3c" onclick="rmDoc(\''+pid+'\','+i+')">√ó</button></div>'}).join('')}
  var b=document.getElementById('mPB');

  const ubN=unbilledCount(pid);
  const ubS=unbilledAmount(pid);
  const freq=(p.billMode==='each')?'√† chaque s√©ance':('toutes les '+(parseInt(p.billEvery)||1)+' s√©ances');
  const feeS=money(Number(p.sessionFee||18.20));
  let rejHtml='';
  if(p.needMut||p.needSecu){
    const n=Math.max(0,parseInt(p.rejectCount)||0);
    const part=(p.needMut?0.4:0)+(p.needSecu?0.6:0);
    const unpaid=n*(Number(p.sessionFee||18.20))*part;
    rejHtml='<div style="margin-top:10px;padding:10px;border:1px solid var(--border);border-radius:12px;background:var(--bg)">'+
      '<div style="font-weight:700;margin-bottom:6px">‚ÄºÔ∏è Rejet de paiement</div>'+
      '<div style="font-size:12px;color:var(--text2)">'+(p.rejectReason?('Motif : '+esc(p.rejectReason)):'Motif : (non renseign√©)')+'</div>'+
      '<div style="font-size:12px;color:var(--text2)">S√©ances rejet√©es : '+n+' ¬∑ Montant non r√©gl√© estim√© : <b>'+money(unpaid)+'</b></div>'+
      '</div>';
  }

  b.innerHTML='<div class="pcard"><div class="pt"><div class="pav">'+ini(p)+'</div><div class="pinf">'+
    '<div class="pnm">'+triEmoji(pid)+esc(p.lastName)+' '+esc(p.firstName)+' '+alrt(p)+billEmoji(pid,true)+'</div>'+
    '<div class="pag">'+(ag?ag+' ans ¬∑ ':'')+'N√©(e) le '+dobD+'</div>'+
    '<div class="ub">Non factur√©es : <b>'+ubN+'</b> ¬∑ <b>'+money(ubS)+'</b></div>'+
    '<div class="ub">Montant s√©ance : <b>'+feeS+'</b> ¬∑ Facturation : <b>'+esc(freq)+'</b></div>'+
    '</div></div>'+
    '<div class="pacts">'+(p.phone?'<a href="tel:'+esc(p.phone)+'">üìû Appeler</a><a href="sms:'+esc(p.phone)+'">üí¨ SMS</a>':'')+
    '<button onclick="editPat(\''+pid+'\')">‚úèÔ∏è Modifier</button>'+
    '<button onclick="billPatient(\''+pid+'\',true)">üíµ Forcer facturation</button></div>'+
    '<div class="pcks"><label><input type="checkbox" '+(p.needOrdo?'checked':'')+' onchange="togFlag(\''+pid+'\',\'needOrdo\',this.checked)"> ‚ùó Ordonnance</label>'+
    '<label><input type="checkbox" '+(p.needMut?'checked':'')+' onchange="togFlag(\''+pid+'\',\'needMut\',this.checked)"> ‚ÄºÔ∏è Mutuelle</label>'+
    '<label><input type="checkbox" '+(p.needSecu?'checked':'')+' onchange="togFlag(\''+pid+'\',\'needSecu\',this.checked)"> ‚ÄºÔ∏è S√©cu</label></div>'+
    rejHtml+
    '<h3>üìé Documents</h3><div class="pdocs" id="pcD">'+(docsH||'<div style="font-size:12px;color:var(--text2);padding:4px 0">Aucun document</div>')+'</div>'+
    '<div style="display:flex;gap:6px;margin-top:8px"><button class="btn bs" style="flex:1;font-size:12px" onclick="addDoc(\''+pid+'\')">üìÅ Joindre</button>'+
    '<button class="btn bs" style="flex:1;font-size:12px" onclick="takePhoto(\''+pid+'\')">üì∑ Photo</button></div></div>'+
    '<div class="br"><button class="btn bs" style="flex:1" onclick="openHist(\''+pid+'\');clM(\'mP\')">üìã Historique</button>'+
    '<button class="btn bd" onclick="delPat(\''+pid+'\')">üóë</button></div>';
  opM('mP');
}


function togFlag(pid,flag,val){var p=gp(pid);if(p){p[flag]=val;sv();R();openPC(pid)}}

function newPat(){
  const b=document.getElementById('mAB');
  document.getElementById('mAT').textContent='Nouveau patient';
  b.innerHTML='<div class="fr"><div class="fg"><label>Nom</label><input id="epL" value=""></div>'+
    '<div class="fg"><label>Pr√©nom</label><input id="epF" value=""></div></div>'+
    '<div class="fr"><div class="fg"><label>Date de naissance</label><input type="date" id="epD" value=""></div>'+
    '<div class="fg"><label>T√©l√©phone</label><input type="tel" id="epP" value=""></div></div>'+
    '<div class="fr"><div class="fg"><label>Montant des s√©ances (‚Ç¨)</label><input type="number" step="0.01" id="epFee" value="18.20"></div>'+
    '<div class="fg"><label>Facturation</label><select id="epBM" onchange="document.getElementById(\'epBEw\').style.display=(this.value===\'every\'?\'block\':\'none\')">'+
      '<option value="each">√Ä chaque s√©ance</option><option value="every">Toutes les x s√©ances</option></select>'+
      '<div id="epBEw" style="display:none;margin-top:6px"><input type="number" min="1" step="1" id="epBE" value="3" placeholder="x"></div></div></div>'+
    '<div class="pcks" style="margin-top:8px"><label><input type="checkbox" id="epOr"> ‚ùó Ordonnance</label>'+
    '<label><input type="checkbox" id="epMut"> ‚ÄºÔ∏è Mutuelle</label>'+
    '<label><input type="checkbox" id="epSec"> ‚ÄºÔ∏è S√©cu</label></div>'+
    '<div id="rejBlk" style="display:none;margin-top:8px">'+
      '<div class="fr"><div class="fg"><label>Motif du rejet</label><input id="epRejR" value=""></div>'+
      '<div class="fg"><label>Nombre de s√©ances rejet√©es</label><input type="number" min="0" step="1" id="epRejN" value="0"></div></div>'+
    '</div>'+
    '<div class="br"><button class="btn bp bw" onclick="svNewPat()">Enregistrer</button></div>';
  // toggle reject block
  function t(){const on=document.getElementById('epMut').checked||document.getElementById('epSec').checked;document.getElementById('rejBlk').style.display=on?'block':'none'}
  document.getElementById('epMut').addEventListener('change',t);
  document.getElementById('epSec').addEventListener('change',t);
  opM('mA');
}

function svNewPat(){
  const ln=document.getElementById('epL').value.trim();
  const fn=document.getElementById('epF').value.trim();
  if(!ln && !fn){toast('Nom requis');return}
  const p={
    id:uid(),
    lastName:ln,firstName:fn,
    dob:document.getElementById('epD').value||'',
    phone:document.getElementById('epP').value.trim()||'',
    notes:'',
    needOrdo:document.getElementById('epOr').checked,
    needMut:document.getElementById('epMut').checked,
    needSecu:document.getElementById('epSec').checked,
    rejectReason:document.getElementById('epRejR')?document.getElementById('epRejR').value.trim():'',
    rejectCount:parseInt((document.getElementById('epRejN')&&document.getElementById('epRejN').value)||'0')||0,
    sessionFee:parseFloat(document.getElementById('epFee').value)||18.20,
    billMode:document.getElementById('epBM').value,
    billEvery:parseInt(document.getElementById('epBE').value)||3,
    lastBillAt:'',
    documents:[]
  };
  D.patients.push(p);sv();clM('mA');R();toast('Patient ajout√©');
}

function editPat(pid){
  var p=gp(pid);if(!p)return;clM('mP');
  var b=document.getElementById('mAB');
  document.getElementById('mAT').textContent='Modifier le patient';
  b.innerHTML='<div class="fr"><div class="fg"><label>Nom</label><input id="epL" value="'+esc(p.lastName)+'"></div>'+
    '<div class="fg"><label>Pr√©nom</label><input id="epF" value="'+esc(p.firstName)+'"></div></div>'+
    '<div class="fr"><div class="fg"><label>Date de naissance</label><input type="date" id="epD" value="'+(p.dob||'')+'"></div>'+
    '<div class="fg"><label>T√©l√©phone</label><input type="tel" id="epP" value="'+esc(p.phone||'')+'"></div></div>'+
    '<div class="fr"><div class="fg"><label>Montant des s√©ances (‚Ç¨)</label><input type="number" step="0.01" id="epFee" value="'+(p.sessionFee!==undefined?Number(p.sessionFee).toFixed(2):'18.20')+'"></div>'+
    '<div class="fg"><label>Facturation</label><select id="epBM" onchange="document.getElementById(\'epBEw\').style.display=(this.value===\'every\'?\'block\':\'none\')">'+
      '<option value="each" '+(p.billMode==='each'?'selected':'')+'>√Ä chaque s√©ance</option>'+
      '<option value="every" '+(p.billMode==='every'?'selected':'')+'>Toutes les x s√©ances</option></select>'+
      '<div id="epBEw" style="display:'+(p.billMode==='every'?'block':'none')+';margin-top:6px"><input type="number" min="1" step="1" id="epBE" value="'+(p.billEvery||3)+'"></div></div></div>'+
    '<div class="pcks" style="margin-top:8px"><label><input type="checkbox" '+(p.needOrdo?'checked':'')+' id="epOr"> ‚ùó Ordonnance</label>'+
    '<label><input type="checkbox" '+(p.needMut?'checked':'')+' id="epMut"> ‚ÄºÔ∏è Mutuelle</label>'+
    '<label><input type="checkbox" '+(p.needSecu?'checked':'')+' id="epSec"> ‚ÄºÔ∏è S√©cu</label></div>'+
    '<div id="rejBlk" style="display:'+((p.needMut||p.needSecu)?'block':'none')+';margin-top:8px">'+
      '<div class="fr"><div class="fg"><label>Motif du rejet</label><input id="epRejR" value="'+esc(p.rejectReason||'')+'"></div>'+
      '<div class="fg"><label>Nombre de s√©ances rejet√©es</label><input type="number" min="0" step="1" id="epRejN" value="'+(p.rejectCount||0)+'"></div></div>'+
    '</div>'+
    '<div class="br"><button class="btn bp bw" onclick="svPat(\''+pid+'\')">Enregistrer</button></div>';
  function t(){const on=document.getElementById('epMut').checked||document.getElementById('epSec').checked;document.getElementById('rejBlk').style.display=on?'block':'none'}
  document.getElementById('epMut').addEventListener('change',t);
  document.getElementById('epSec').addEventListener('change',t);
  opM('mA');
}


function svPat(pid){
  var p=gp(pid);if(!p)return;
  p.lastName=document.getElementById('epL').value.trim();
  p.firstName=document.getElementById('epF').value.trim();
  p.dob=document.getElementById('epD').value;
  p.phone=document.getElementById('epP').value.trim();
  p.sessionFee=parseFloat(document.getElementById('epFee').value)||18.20;
  p.billMode=document.getElementById('epBM').value;
  p.billEvery=parseInt(document.getElementById('epBE').value)||3;
  p.needOrdo=document.getElementById('epOr').checked;
  p.needMut=document.getElementById('epMut').checked;
  p.needSecu=document.getElementById('epSec').checked;
  p.rejectReason=document.getElementById('epRejR')?document.getElementById('epRejR').value.trim():'';
  p.rejectCount=parseInt((document.getElementById('epRejN')&&document.getElementById('epRejN').value)||'0')||0;
  sv();clM('mA');R();toast('Patient modifi√©');
}


function delPat(pid){
  if(!confirm('Supprimer ce patient et toutes ses s√©ances ?'))return;
  D.patients=D.patients.filter(function(p){return p.id!==pid});
  D.appointments=D.appointments.filter(function(a){return a.patientId!==pid});
  sv();clM('mP');R();toast('Patient supprim√©');
}

function addDoc(pid){
  var inp=document.createElement('input');inp.type='file';inp.accept='image/*,application/pdf,.doc,.docx';
  inp.onchange=function(e){var f=e.target.files[0];if(!f)return;var r=new FileReader();
    r.onload=function(ev){var p=gp(pid);if(p){if(!p.documents)p.documents=[];p.documents.push({name:f.name,data:ev.target.result});sv();openPC(pid);toast('Document ajout√©')}};
    r.readAsDataURL(f)};inp.click();
}

function takePhoto(pid){
  var inp=document.createElement('input');inp.type='file';inp.accept='image/*';inp.setAttribute('capture','environment');
  inp.onchange=function(e){var f=e.target.files[0];if(!f)return;var r=new FileReader();
    r.onload=function(ev){var p=gp(pid);if(p){if(!p.documents)p.documents=[];p.documents.push({name:'Photo_'+dk(new Date())+'.jpg',data:ev.target.result});sv();openPC(pid);toast('Photo ajout√©e')}};
    r.readAsDataURL(f)};inp.click();
}

function rmDoc(pid,idx){var p=gp(pid);if(p&&p.documents){p.documents.splice(idx,1);sv();openPC(pid)}}

/* ‚ïê‚ïê‚ïê HISTORY ‚ïê‚ïê‚ïê */
function openHist(pid){
  var p=gp(pid);if(!p)return;
  document.getElementById('mHT').innerHTML='üìã '+esc(p.lastName)+' '+esc(p.firstName);
  var all=D.appointments.filter(function(a){return a.patientId===pid}).sort(function(a,b){return(a.date+a.time).localeCompare(b.date+b.time)});
  var today=todayKey();
  var past=all.filter(function(a){return a.date<=today});
  var future=all.filter(function(a){return a.date>today});
  var done=past.filter(function(a){return!a.cancelled}).length;
  var cancelled=all.filter(function(a){return a.cancelled}).length;
  var total=past.length;

  const filt=(document.getElementById('hflt')&&document.getElementById('hflt').value)||'all';
  function passF(a){
    if(filt==='all')return true;
    if(filt==='billed')return !!a.billed;
    if(filt==='unbilled')return isBillable(a)&&!a.billed;
    return true;
  }

  var h='<div class="hs">'+
    '<div class="hst"><div class="hn">'+total+'</div><div class="hl">Total</div></div>'+
    '<div class="hst"><div class="hn" style="color:var(--accent)">'+done+'</div><div class="hl">R√©alis√©es</div></div>'+
    '<div class="hst"><div class="hn" style="color:#e74c3c">'+cancelled+'</div><div class="hl">Annul√©es</div></div>'+
    '<div class="hst"><div class="hn" style="color:var(--c0)">'+future.length+'</div><div class="hl">Futures</div></div></div>'+
    '<div style="display:flex;gap:10px;align-items:center;margin:10px 0">'+
      '<div style="font-size:12px;color:var(--text2)">Filtre :</div>'+
      '<select id="hflt" onchange="openHist(\''+pid+'\')" style="height:34px;border-radius:12px;border:1px solid var(--border);background:var(--card);color:var(--text);padding:0 10px">'+
        '<option value="all" '+(filt==='all'?'selected':'')+'>Toutes</option>'+
        '<option value="billed" '+(filt==='billed'?'selected':'')+'>Factur√©es</option>'+
        '<option value="unbilled" '+(filt==='unbilled'?'selected':'')+'>Non factur√©es</option>'+
      '</select>'+
      '<button class="btn bs" style="margin-left:auto" onclick="billPatient(\''+pid+'\',true)">üíµ Forcer</button>'+
    '</div>';

  function hi(a,isFut){
    var m=gm(a.motifId);var ci=m?m.ci:0;
    const lab=(a.type==='bilan'||a.isBilan)?'üÖ±Ô∏è Bilan':(m?m.label:'?');
    const billedTag=(a.billed?'<span class="hib" style="background:#e6f7ee;color:#1e8e3e">Factur√©e</span>':'');
    const unbTag=(!a.billed && isBillable(a)?'<span class="hib" style="background:#fff3cd;color:#8a6d3b">Non factur√©e</span>':'');
    return '<div class="hi'+(isFut?' fut':'')+(a.cancelled?' cncl':'')+'" style="border-left-color:'+CL[ci%6].bd+'" onclick="showCtx(event,\''+a.id+'\')">'+
      '<div class="hid">'+fmtS(a.date)+' '+a.time+'</div>'+
      '<div class="him">'+esc(lab)+'</div>'+
      (a.cancelled?'<div class="hib" style="background:#fce0e8;color:#e74c3c">Annul√©e</div>':(billedTag||unbTag))+
      '</div>';
  }

  if(future.filter(passF).length){h+='<h3 style="font-size:12px;color:var(--text2);margin:8px 0 4px">√Ä venir</h3>';
    var fRev=future.slice().reverse().filter(passF);
    for(var i=0;i<fRev.length;i++){h+=hi(fRev[i],true)}}

  if(past.filter(passF).length){h+='<h3 style="font-size:12px;color:var(--text2);margin:8px 0 4px">Pass√©es</h3>';
    var pRev=past.slice().reverse().filter(passF);
    for(var j=0;j<pRev.length;j++){h+=hi(pRev[j],false)}}

  if(!all.filter(passF).length)h+='<div style="text-align:center;padding:20px;color:var(--text2)">Aucune s√©ance</div>';
  document.getElementById('mHB').innerHTML=h;
  opM('mH');
}


/* ‚ïê‚ïê‚ïê SETTINGS ‚ïê‚ïê‚ïê */
function openSet(){
  var b=document.getElementById('mSB');
  var dayN={0:'Dimanche',1:'Lundi',2:'Mardi',3:'Mercredi',4:'Jeudi',5:'Vendredi',6:'Samedi'};
  var dayShort={0:'Dim',1:'Lun',2:'Mar',3:'Mer',4:'Jeu',5:'Ven',6:'Sam'};

  var motH=D.motifs.map(function(m,i){
    var c=CL[m.ci%6];
    return'<div class="mi"><div class="md" style="background:'+c.bd+'"></div><div class="ml">'+esc(m.label)+'</div><div class="mu">'+m.duration+'min</div>'+
    '<button class="sb edt" onclick="editMot('+i+')">‚úè</button><button class="sb del" onclick="rmMot('+i+')">√ó</button></div>'}).join('');

  var opH=D.openings.map(function(o,i){
    return'<div class="si"><div class="sd">'+(dayN[o.day]||('J'+o.day))+'</div>'+
    '<input type="time" value="'+o.start+'" onchange="updOp('+i+',\'start\',this.value)" step="300">'+
    '<span class="sa2">‚Üí</span><input type="time" value="'+o.end+'" onchange="updOp('+i+',\'end\',this.value)" step="300">'+
    '<button class="sb del" onclick="rmOp('+i+')">√ó</button></div>'}).join('');

  var daysAll=[1,2,3,4,5,6,0];
  var daysCh=daysAll.map(function(d){
    return'<div class="chip'+(D.days.includes(d)?' sel':'')+'" data-dow="'+d+'" style="background:var(--bg)">'+dayShort[d]+'</div>';
  }).join('');

  var addBtns=sortDows(D.days).map(function(d){
    return'<button class="addb" style="flex:1;min-width:120px" onclick="addOp('+d+')">+ '+dayN[d]+'</button>';
  }).join('');

  b.innerHTML=
    '<div class="ss"><h3>üìÖ Jours de s√©ances</h3>'+
      '<div class="chips" id="dayCh">'+daysCh+'</div>'+
      '<div style="font-size:11px;color:var(--text2);margin-top:6px">Ces jours seront s√©lectionnables dans l\'agenda, dans les plages d\'ouverture et la r√©currence.</div>'+
    '</div>'+
    '<div class="ss"><h3>üìã Motifs de consultation</h3>'+motH+
      '<button class="addb" onclick="editMot(-1)">+ Ajouter un motif</button>'+
    '</div>'+
    '<div class="ss"><h3>üïê Plages d\'ouverture</h3>'+opH+
      '<div style="display:flex;flex-wrap:wrap;gap:6px">'+addBtns+'</div>'+
    '</div>'+
    '<div class="ss"><h3>üìè Amplitude horaire</h3>'+
      '<div class="si"><div class="sd">Grille</div>'+
        '<input type="time" id="sST" value="'+String(D.startH).padStart(2,'0')+':00" step="3600" onchange="updAmpT()">'+
        '<span class="sa2">‚Üí</span>'+
        '<input type="time" id="sET" value="'+String(D.endH).padStart(2,'0')+':00" step="3600" onchange="updAmpT()">'+
      '</div>'+
      '<div style="font-size:11px;color:var(--text2);margin-top:6px">La grille reste align√©e √† l\'heure (minutes ignor√©es).</div>'+
    '</div>'+
    '<div class="ss"><h3>üÖ±Ô∏è Montant des Bilans (‚Ç¨)</h3>'+
      '<div class="fr"><div class="fg"><label>Montant</label>'+
        '<input id="sBilanFee" type="number" step="0.01" value="'+(Number(D.bilanFee||0).toFixed(2))+'" onchange="setBilanFee(this.value)">' +
      '</div></div>'+
      '<div style="font-size:11px;color:var(--text2);margin-top:6px">Montant utilis√© pour les s√©ances üÖ±Ô∏è ajout√©es depuis l\'agenda.</div>'+
    '</div>'+
    '<div class="ss"><h3>üìä Donn√©es</h3>'+

      '<div class="br" style="margin-top:0"><button class="btn bs" style="flex:1" onclick="expD()">üì§ Exporter</button><button class="btn bs" style="flex:1" onclick="impD()">üì• Importer</button></div>'+
      '<div style="margin-top:8px"><button class="btn bd bw" onclick="rstD()">üóë R√©initialiser</button></div>'+
    '</div>';

  document.querySelectorAll('#dayCh .chip').forEach(function(c){
    c.onclick=function(){togDay(parseInt(c.dataset.dow))};
  });

  opM('mS');
}

function updAmpT(){
  var s=(document.getElementById('sST').value||'08:00');
  var e=(document.getElementById('sET').value||'19:00');
  D.startH=parseInt((s.split(':')[0]||'8'),10)||8;
  D.endH=parseInt((e.split(':')[0]||'19'),10)||19;
  if(D.endH<=D.startH)D.endH=D.startH+1;
  sv();R();
}

function togDay(dow){
  if(!Array.isArray(D.days))D.days=[1,4];
  if(D.days.includes(dow)){
    if(D.days.length<=1){toast('Gardez au moins 1 jour');return;}
    D.days=D.days.filter(function(x){return x!==dow});
  } else {
    D.days.push(dow);
    D.days=[...new Set(D.days.map(Number))].filter(d=>d>=0&&d<=6);
  }
  sv();
  ensureActiveDate(cD);
  openSet();
  R();
}
function updOp(i,f,v){D.openings[i][f]=v;sv()}
function rmOp(i){D.openings.splice(i,1);sv();openSet()}
function addOp(day){D.openings.push({day:day,start:'08:45',end:'12:35'});sv();openSet()}
function rmMot(i){D.motifs.splice(i,1);sv();openSet()}

function editMot(idx){
  var isNew=idx<0;
  var m=isNew?{label:'',duration:30,ci:0,times:[]}:(D.motifs[idx]||{label:'',duration:30,ci:0,times:[]});
  if(!Array.isArray(m.times))m.times=[];
  document.getElementById('mMT').textContent=isNew?'Nouveau motif':'Modifier le motif';
  var colH=CL.map(function(c,i){return'<div class="chip'+(m.ci===i?' sel':'')+'" data-ci="'+i+'" style="background:'+c.bg+';color:'+c.bd+'">'+c.lb+'</div>'}).join('');
  var tStr=m.times.slice().filter(Boolean).sort(function(a,b){return t2m(a)-t2m(b)}).join(',');
  document.getElementById('mMB').innerHTML=
    '<div class="fg"><label>Nom</label><input id="emL" value="'+esc(m.label)+'"></div>'+
    '<div class="fg"><label>Dur√©e par d√©faut (min)</label><input type="number" id="emD" value="'+m.duration+'" min="5" max="240" step="5"></div>'+
    '<h3>Heures typiques</h3>'+
    '<input type="hidden" id="emT" value="'+esc(tStr)+'">'+
    '<div class="chips" id="emTCh"></div>'+
    '<div class="si" style="margin-top:6px"><div class="sd">+ Heure</div>'+
      '<input type="time" id="emTN" value="09:00" step="300">'+
      '<button class="sb edt" onclick="addMotTime()">Ôºã</button>'+
    '</div>'+
    '<h3>Couleur</h3><div class="chips" id="emC">'+colH+'</div>'+
    '<div class="br"><button class="btn bp bw" onclick="svMot('+idx+')">Enregistrer</button></div>';

  document.querySelectorAll('#emC .chip').forEach(function(c){c.onclick=function(){
    document.querySelectorAll('#emC .chip').forEach(function(x){x.classList.remove('sel')});c.classList.add('sel')
  }});
  renderMotTimes();
  opM('mM');
}

function readMotTimes(){
  var v=((document.getElementById('emT')&&document.getElementById('emT').value)||'').trim();
  if(!v)return [];
  return v.split(',').map(function(x){return x.trim()}).filter(Boolean);
}
function writeMotTimes(arr){
  var u=[...new Set((arr||[]).map(function(x){return (x||'').trim()}).filter(Boolean))].sort(function(a,b){return t2m(a)-t2m(b)});
  var inp=document.getElementById('emT');if(inp)inp.value=u.join(',');
  renderMotTimes();
}
function renderMotTimes(){
  var box=document.getElementById('emTCh');if(!box)return;
  var arr=readMotTimes();
  if(!arr.length){box.innerHTML='<div style="font-size:12px;color:var(--text2);padding:2px 0">Aucune heure typique</div>';return;}
  box.innerHTML=arr.map(function(t){
    return '<div class="chip" style="background:var(--bg);border:1.5px solid var(--border);color:var(--text)" onclick="rmMotTime(\''+t+'\')">'+t+' √ó</div>';
  }).join('');
}
function addMotTime(){
  var i=document.getElementById('emTN');if(!i)return;
  var t=i.value;
  if(!t){toast('Choisissez une heure');return;}
  var arr=readMotTimes();
  if(arr.indexOf(t)>=0){toast('D√©j√† ajout√©e');return;}
  arr.push(t);writeMotTimes(arr);toast('Heure ajout√©e');
}
function rmMotTime(t){
  var arr=readMotTimes().filter(function(x){return x!==t});
  writeMotTimes(arr);
}

function svMot(idx){
  var label=document.getElementById('emL').value.trim();if(!label){toast('Nom requis');return}
  var dur=parseInt(document.getElementById('emD').value)||30;
  var selC=document.querySelector('#emC .chip.sel');var ci=selC?parseInt(selC.dataset.ci):0;
  var times=readMotTimes();
  if(idx<0){D.motifs.push({id:uid(),label:label,duration:dur,ci:ci,times:times})}
  else{D.motifs[idx].label=label;D.motifs[idx].duration=dur;D.motifs[idx].ci=ci;D.motifs[idx].times=times}
  sv();clM('mM');openSet();toast('Motif enregistr√©');
}

function expD(){var j=JSON.stringify(D,null,2);var b=new Blob([j],{type:'application/json'});var a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='physioflow_'+dk(new Date())+'.json';a.click();toast('Export t√©l√©charg√©')}
function impD(){var inp=document.createElement('input');inp.type='file';inp.accept='.json';inp.onchange=function(e){var f=e.target.files[0];if(!f)return;var r=new FileReader();r.onload=function(ev){try{var d=JSON.parse(ev.target.result);if(d.motifs&&d.appointments){D=d;if(!D.patients)D.patients=[];sv();clM('mS');R();toast('Import r√©ussi ‚úì')}}catch(e2){toast('Erreur')}};r.readAsText(f)};inp.click()}
function rstD(){if(!confirm('Tout supprimer ?'))return;D=defD();sv();clM('mS');R();toast('R√©initialis√©')}

/* ‚ïê‚ïê‚ïê TAP ON GRID TO CREATE ‚ïê‚ïê‚ïê */
(function(){
  var sa=document.getElementById('sa');
  var tapTimer=null;
  sa.addEventListener('click',function(e){
    /* Only if clicking on empty space (not on an appointment) */
    if(e.target.closest('.ap'))return;
    var rect=sa.getBoundingClientRect();
    var y=e.clientY-rect.top+document.getElementById('pw').scrollTop;
    /* Compensate for the scroll position within the grid */
    var scrollTop=document.getElementById('pw').scrollTop;
    var saRect=sa.getBoundingClientRect();
    var pgRect=document.getElementById('pg').getBoundingClientRect();
    var relY=e.clientY-pgRect.top+scrollTop;
    var mins=Math.round((relY/80)*60+D.startH*60);
    var snap=Math.round(mins/5)*5;
    openAF(null);
    setTimeout(function(){
      var tmEl=document.getElementById('fTm');
      if(tmEl)tmEl.value=m2t(snap);
    },100);
  });
})();

/* ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê */
function scrollNow(){var w=document.getElementById('pw');var h=new Date().getHours();w.scrollTop=Math.max(0,((h-D.startH)-1)*80)}
if('serviceWorker' in navigator)navigator.serviceWorker.register('sw.js').catch(function(){});
R();scrollNow();
setInterval(function(){if(same(new Date(),cD)&&vM==='grid'){rGrid();rAps()}},60000);
document.addEventListener('keydown',function(e){if(e.key==='Escape'){document.querySelectorAll('.mo.open').forEach(function(m){m.classList.remove('open')});clCtx()}});
</script>
</body>
</html>
